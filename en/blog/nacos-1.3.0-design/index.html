<!doctype html>
<html lang="en-US" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Nacos 1.3.0 new kernel construction process | Nacos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://nacos.io/en/img/nacos_colorful.png"><meta data-rh="true" name="twitter:image" content="https://nacos.io/en/img/nacos_colorful.png"><meta data-rh="true" property="og:url" content="https://nacos.io/en/blog/nacos-1.3.0-design"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Nacos 1.3.0 new kernel construction process | Nacos"><meta data-rh="true" name="description" content="Nacos 1.3.0 new kernel construction process"><meta data-rh="true" property="og:description" content="Nacos 1.3.0 new kernel construction process"><meta data-rh="true" name="keywords" content="nacos1.3.0,kernel"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-02-12T00:00:00.000Z"><link data-rh="true" rel="icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"><link data-rh="true" rel="canonical" href="https://nacos.io/en/blog/nacos-1.3.0-design"><link data-rh="true" rel="alternate" href="https://nacos.io/en/blog/nacos-1.3.0-design" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://nacos.io/zh-cn/blog/nacos-1.3.0-design" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://nacos.io/blog/nacos-1.3.0-design" hreflang="default"><link data-rh="true" rel="alternate" href="https://nacos.io/blog/nacos-1.3.0-design" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://1QV814950M-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="Nacos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="Nacos Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Nacos" href="/en/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=nacos">
<meta name="referrer" content="no-referrer">
<link rel="stylesheet" href="//g.alicdn.com/mamba/mse-arc-ui/0.0.21/umd/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/mse-arc-ui/0.0.21/umd/mse-arc-ui.min.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-0YDFJ7LX7F" async></script><link rel="stylesheet" href="/en/assets/css/styles.627d44a2.css">
<link rel="preload" href="/en/assets/js/runtime~main.f1cec763.js" as="script">
<link rel="preload" href="/en/assets/js/main.02fbd811.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>



<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="//hm.baidu.com/hm.js?e3a5cec56ef8619cf9d7c2abebd509e3"></script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a href="https://nacos.io/zh-cn/docs/v2/quickstart/quick-start.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"> </a><a class="navbar__item navbar__link" href="/en/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="what-is-nacos" href="/en/docs/what-is-nacos">2.X</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/docs/next/what-is-nacos">Next</a></li><li><a class="dropdown__link" href="/en/docs/what-is-nacos">2.X</a></li><li><a class="dropdown__link" href="/en/docs/1.X/what-is-nacos">1.X</a></li></ul></div><a class="navbar__item navbar__link" href="/en/cloud">NACOS CLOUD</a><a href="https://developer.aliyun.com/ebook/36?spm=a2c6h.20345107.ebook-index.18.152c2984fsi5ST" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">E-BOOK-NACOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/blog">BLOG</a><a class="navbar__item navbar__link" href="/en/community">COMMUNITY</a><a href="http://console.nacos.io/nacos/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">DEMO-CONSOLE<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>En</a><ul class="dropdown__menu"><li><a href="/en/blog/nacos-1.3.0-design" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-US">En</a></li><li><a href="/zh-cn/blog/nacos-1.3.0-design" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2.3.0-beta-release">Oct 24, 2023  Nacos 荣获GLCC优秀社区，同时2.3.0-BETA发布，欢迎试用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/iscas2023">May 11, 2023  Nacos开源之夏2023，贡献社区赢取12000奖金</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2.2.2-release">Apr 11, 2023  Nacos 2.2.2发布，优化启动体验和鉴权提示</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2.2.1-release">Mar 20, 2023  Nacos 多个新版本发布，rust-sdk完全适配完成</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/announcement-token-secret-key">Mar 2nd, 2023  关于Nacos默认token.secret.key及server.identity风险说明及解决方案公告</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/higress">Jan 10, 2023  Higress + Nacos 微服务网关最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos-reigster-mechanism">What happens to a registration request from Nacos?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2.2.0-release">Dec 16, 2022  Nacos 2.2.0 版本发布，新增多种插件支持</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/212-and-220beta-release">Oct 28, 2022  Nacos 2.1.2、2.2.0-BETA及go-sdk 2.1.1 版本同时发布，多语言生态再添大将</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2.1.1-release">August 10, 2022  Nacos 四周年，2.1.1 及 1.4.4 版本同时发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos3.0-is-coming">我们总结了3大使用建议，并首次公开 Nacos3.0 规划图 | Nacos 开源4周年</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/xiaomi-scale">August 5, 2022  小米Nacos2.0扩缩容最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/iscas2022">Nacos开源之夏，贡献社区赢取12000奖金</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2.1.0-release">Nacos 2.1.0版本发布，支持鉴权及加解密插件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/use-nacos-with-rainbond">Install the HA Nacos cluster in Rainbond with one-click</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/apisix">Apache APISIX Realizes Service Discovery Based on Nacos</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/up-to-2w-star">Singles&#x27; Day Gift | Review and outlook of Nacos Star breaking 20,000</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2.0.3-release">Nacos 2.0.3 Release, continue to improve stability.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/performance-compare">Performance comparison between Nacos 2.0 upgrading or not.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/springboot-0.2.10">Nacos-spring-boot 0.2.10 is released, fully supporting Nacos 2.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/iscas2021">Nacos ISCAS 2021 start to apply</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2.0.1-release">Nacos 2.0.1 + 1.4.2 Release</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/1.4.0-release">Nacos 1.4.0 + Go SDK 1.0.1 Release</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos-distro-mechanism">Nacos&#x27; Distro conformance protocol</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/csharp-0.5.0">v0.5.0 of Nacos-sdk-csharp was released! Capabilities aligned with Java SDK！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos-2nd-anniversary">Nacos 两周年献礼，Nacos 1.3.2 + Go SDK 1.0.0发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/feeling-of-ASoC-2019">参与开源，Offer拿到手软 -- 来自一名2019阿里巴巴编程之夏同学的亲述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos 1.2.0 guide">Nacos 1.2.0权限控制介绍和使用</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/en/blog/nacos-1.3.0-design">Nacos 1.3.0 new kernel construction process</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/namespace-endpoint-best-practices">Namespace,endpoint 最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/pilot mcp">Pilot MCP协议介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos 1.1.4">Nacos 1.1.4发布，业界率先支持Istio MCP协议</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos-confd">Nacos整合Confd，支持nginx配置管理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/eureka2">Eureka 2.0 开源工作宣告停止？别担心，ANS 即将 C位强势出道！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos 1.1.0">Nacos 1.1.0发布，支持灰度配置和地址服务器模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos-roadmap">Nacos GA后的整体规划</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/cmdb">Nacos打通CMDB实现就近访问</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/address-server">阿里巴巴基于 Nacos 实现环境隔离的实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos1.0.0">Nacos 1.0.0 发布，正式大规模生产可用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos0.9.0">Nacos 0.9.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos0.9-intro">Nacos 0.9.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/huya-practice">虎牙直播在微服务改造方面的实践和总结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos0.8">Nacos 0.8.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/huya-nacos">虎牙直播共建Nacos生态</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/5w1h-where">Nacos 有哪些典型的应用场景？—— 配置管理篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/dynamic-route-zuul-nacos">使用Nacos实现Spring Cloud Zuul的动态路由</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos0.6">Nacos 0.6版本发布，支持Dubbo生态并且支持Docker部署</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos0.5">Nacos0.5发布，支持DNS-based Service Discovery，JAVA 11</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos">Nacos 0.1.0 版本Review 活动设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/cncf">Nacos 进入CNCF landscape</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/5w1h-what">What problems does Nacos help us solve? —— Configuration Management</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/discovery-console">Nacos服务发现控制台预览</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/chengdu-dubbo">Nacos 计划发布v0.2版本，进一步融合Dubbo和SpringCloud生态</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/consul-k8s">Consul与kubernetes整合公告[翻译]</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/dns-sd">微服务架构中基于DNS的服务注册与发现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/nacos-is-coming">支持Dubbo生态发展，阿里巴巴启动新的开源项目 Nacos</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/alibaba-configserver">阿里巴巴服务注册中心产品ConfigServer 10年技术发展回顾</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Nacos 1.3.0 new kernel construction process</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-02-12T00:00:00.000Z" itemprop="datePublished">February 12, 2020</time> · <!-- -->26 min read</div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><a name="0YIG0"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="summarize">Summarize<a href="#summarize" class="hash-link" aria-label="Direct link to Summarize" title="Direct link to Summarize">​</a></h2><p>This 1.3.0 is implanted to a great extent, involving the modification of two large modules and the addition of a core module</p><ol><li>nacos-core module modification<ol><li>nacos</li><li>nacos internal event mechanism</li><li>nacos consistency protocol layer</li></ol></li><li>nacos-config module modification<ol><li>Add embedded distributed data storage components</li><li>Separation of embedded storage and external storage</li><li>Simple operation and maintenance of embedded storage</li></ol></li><li>Add nacos-consistency module<ol><li>Unified abstraction for AP protocol and CP protocol</li></ol></li></ol><a name="rnkDY"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="system-parameters-changes">System parameters changes<a href="#system-parameters-changes" class="hash-link" aria-label="Direct link to System parameters changes" title="Direct link to System parameters changes">​</a></h2><a name="1Gmg9"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="updates">Updates<a href="#updates" class="hash-link" aria-label="Direct link to Updates" title="Direct link to Updates">​</a></h3><table><thead><tr><th align="center"><strong>core</strong></th><th>nacos.watch-file.max-dirs</th><th>JVM parameter</th><th>Maximum number of monitored directories</th></tr></thead><tbody><tr><td align="center"></td><td>nacos.core.notify.ring-buffer-size</td><td>JVM parameter</td><td>Quick notification of the maximum length of the queue</td></tr><tr><td align="center"></td><td>nacos.core.notify.share-buffer-size</td><td>JVM parameter</td><td>The maximum length of the slow notification queue</td></tr><tr><td align="center"></td><td>nacos.core.member.fail-access-cnt</td><td>JVM parameter.properties</td><td>Maximum number of failed visits to cluster member nodes</td></tr><tr><td align="center"></td><td>nacos.core.address-server.retry</td><td>JVM parameter、application.properties</td><td>Address server addressing mode, first start request retry times</td></tr></tbody></table><br><a name="kxo8O"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-future-overall-logical-architecture-of-nacos-and-its-components">The future overall logical architecture of Nacos and its components<a href="#the-future-overall-logical-architecture-of-nacos-and-its-components" class="hash-link" aria-label="Direct link to The future overall logical architecture of Nacos and its components" title="Direct link to The future overall logical architecture of Nacos and its components">​</a></h2><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1587129046320-5a286f38-8db4-4e76-9b42-8bd859f51a60.png#align=left&amp;display=inline&amp;height=1184&amp;margin=%5Bobject%20Object%5D&amp;name=1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png&amp;originHeight=1184&amp;originWidth=1608&amp;size=279074&amp;status=done&amp;style=none&amp;width=1608" alt="1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png" class="img_ev3q"></p><a name="Hyc6u"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-cluster-member-node-addressing-mode">Nacos cluster member node addressing mode<a href="#nacos-cluster-member-node-addressing-mode" class="hash-link" aria-label="Direct link to Nacos cluster member node addressing mode" title="Direct link to Nacos cluster member node addressing mode">​</a></h2><p>Before 1.3.0, nacos&#x27; naming module and config module had their own member list management tasks. In order to unify the replacement mode of nacos assigning the next member list, the implementation of merge management is replaced from the named module and the config module, unified to the addressing module of the core module, and the command line parameters are added at the same time -Dnacos.member.list **To set the list listed by nacos, this parameter can be called an alternative to the cluster.conf file. The current nacos addressing mode categories are as follows</p><ol><li>In stand-alone mode: StandaloneMemberLookup</li><li>Play mode<ol><li>The cluster.conf file exists: FileConfigMemberLookup</li><li>The cluster.conf file does not exist or -Dnacos.member.list is not set: AddressServerMemberLookup</li></ol></li></ol><p>If you want to specify an addressing mode, set this parameter：<strong>nacos.core.member.lookup.type=<!-- -->[file,address-server]</strong></p><p>The logical diagram is as follows
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/e209a677aa8b5ffce23589e987ee5129.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJMb29rdXBGYWN0b3J5LmluaXQoKVwiXG5cbmlmIFwic3RhbmRhbG9uZSBtb2RlXCIgdGhlblxuICAtLT5bdHJ1ZV0gXCJyZXR1cm4gU3RhbmRhbG9uZU1lbWJlckxvb2t1cFwiXG4gIC0tPiBMb29rdXAucnVuKClcbmVsc2VcbiBpZiBcImNsdXN0ZXIuY29uZiBleGlzdHNcIiB0aGVuXG4gICAgLS0-W3RydWVdIFwicmV0dXJuIEZpbGVDb25maWdNZW1iZXJMb29rdXBcIlxuICAgIC0tPiBMb29rdXAucnVuKClcbiBlbHNlXG4gICAgLT5bZmFsc2VdIFwicmV0dXJuIEFkZHJlc3NTZXJ2ZXJNZW1iZXJMb29rdXBcIlxuICAgIC0tPiBMb29rdXAucnVuKClcbiBlbmRpZlxuZW5kaWZcblxuLS0-ICgqKVxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJpZCI6IlplWGtkIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC9lMjA5YTY3N2FhOGI1ZmZjZTIzNTg5ZTk4N2VlNTEyOS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" class="img_ev3q"></p><a name="wqkMp"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="addressing-mode-details">Addressing mode details<a href="#addressing-mode-details" class="hash-link" aria-label="Direct link to Addressing mode details" title="Direct link to Addressing mode details">​</a></h3><p>Next, I introduce two other addressing modes in addition to the addressing mode in stand-alone mode<br></p><a name="egl3H"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fileconfigmemberlookup">FileConfigMemberLookup<a href="#fileconfigmemberlookup" class="hash-link" aria-label="Direct link to FileConfigMemberLookup" title="Direct link to FileConfigMemberLookup">​</a></h4><p>This addressing mode is managed based on the cluster.conf file, and each node will read the list of member nodes in the cluster.conf file under their respective ${nacos.home}/conf and then form a cluster. And after reading the cluster.conf file under ${nacos.home}/conf for the first time, it will automatically register a directory listener with the operating system&#x27;s <em><strong>inotify</strong></em> mechanism to monitor ${nacos.home}/ All file changes in the conf directory (note that only files will be monitored here, and file changes in subdirectories cannot be monitored)<br>When you need to expand or shrink the cluster nodes, you need to manually modify the content of the member node list of cluster.conf under ${nacos.home}/conf for each node.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private FileWatcher watcher = new FileWatcher() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void onChange(FileChangeEvent event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            readClusterConfFromDisk();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public boolean interest(String context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return StringUtils.contains(context, &quot;cluster.conf&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void start() throws NacosException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readClusterConfFromDisk();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (memberManager.getServerList().isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NacosException(NacosException.SERVER_ERROR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;Failed to initialize the member node, is empty&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Use the inotify mechanism to monitor file changes and automatically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // trigger the reading of cluster.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WatchFileCenter.registerWatcher(ApplicationUtils.getConfFilePath(), watcher);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Loggers.CLUSTER.error(&quot;An exception occurred in the launch file monitor : {}&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The first time you directly read the node list information in the cluster.conf file, then register a directory listener with WatchFileCenter, and automatically trigger <em><strong>readClusterConfFromDisk()</strong></em> to re-read cluster.conf when the cluster.conf file changes file<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014354207-49c1e934-2aa5-465a-8a2b-0b09902814f8.png#align=left&amp;display=inline&amp;height=531&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=531&amp;originWidth=1169&amp;size=105696&amp;status=done&amp;style=none&amp;width=1169" alt="image.png" class="img_ev3q"></p><a name="yFTCl"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="addressservermemberlookup">AddressServerMemberLookup<a href="#addressservermemberlookup" class="hash-link" aria-label="Direct link to AddressServerMemberLookup" title="Direct link to AddressServerMemberLookup">​</a></h4><p>This addressing mode is based on an additional web server to manage cluster.conf. Each node periodically requests the content of the cluster.conf file from the web server, and then implements addressing between cluster nodes and expansion and contraction. <br>When you need to expand or shrink the cluster, you only need to modify the cluster.conf file, and then each node will automatically get the latest cluster.conf file content when it requests the address server.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void start() throws NacosException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (start.compareAndSet(false, true)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.maxFailCount = Integer.parseInt(ApplicationUtils.getProperty(&quot;maxHealthCheckFailCount&quot;, &quot;12&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        initAddressSys();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void initAddressSys() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String envDomainName = System.getenv(&quot;address_server_domain&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isBlank(envDomainName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        domainName = System.getProperty(&quot;address.server.domain&quot;, &quot;jmenv.tbsite.net&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        domainName = envDomainName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String envAddressPort = System.getenv(&quot;address_server_port&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isBlank(envAddressPort)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addressPort = System.getProperty(&quot;address.server.port&quot;, &quot;8080&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addressPort = envAddressPort;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addressUrl = System.getProperty(&quot;address.server.url&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ApplicationUtils.getContextPath() + &quot;/&quot; + &quot;serverlist&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addressServerUrl = &quot;http://&quot; + domainName + &quot;:&quot; + addressPort + addressUrl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    envIdUrl = &quot;http://&quot; + domainName + &quot;:&quot; + addressPort + &quot;/env&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Loggers.CORE.info(&quot;ServerListService address-server port:&quot; + addressPort);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Loggers.CORE.info(&quot;ADDRESS_SERVER_URL:&quot; + addressServerUrl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SuppressWarnings(&quot;PMD.UndefineMagicConstantRule&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void run() throws NacosException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // With the address server, you need to perform a synchronous member node pull at startup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Repeat three times, successfully jump out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean success = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Throwable ex = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int maxRetry = ApplicationUtils.getProperty(&quot;nacos.core.address-server.retry&quot;, Integer.class, 5);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; maxRetry; i ++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            syncFromAddressUrl();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            success = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ex = e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Loggers.CLUSTER.error(&quot;[serverlist] exception, error : {}&quot;, ExceptionUtil.getAllExceptionMsg(ex));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!success) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NacosException(NacosException.SERVER_ERROR, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GlobalExecutor.scheduleByCommon(new AddressServerSyncTask(), 5_000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>During initialization, it will take the initiative to synchronize the current cluster member list information with the address server, and if it fails, retry, the maximum number of retries can be controlled by setting <em><strong>nacos.core.address-server.retry</strong></em>, The default is 5 times, and then after success, a scheduled task will be created to synchronize the cluster member node information to the address server<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014362972-004f5338-af0d-4d0d-b769-4f3d5118c08a.png#align=left&amp;display=inline&amp;height=846&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=846&amp;originWidth=1149&amp;size=188886&amp;status=done&amp;style=none&amp;width=1149" alt="image.png" class="img_ev3q"></p><a name="sgOTI"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-node-management-and-addressing-modes-are-combined">How node management and addressing modes are combined<a href="#how-node-management-and-addressing-modes-are-combined" class="hash-link" aria-label="Direct link to How node management and addressing modes are combined" title="Direct link to How node management and addressing modes are combined">​</a></h3><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014400580-39b83aa0-c548-4241-a49e-0d72abda2a95.png#align=left&amp;display=inline&amp;height=715&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=715&amp;originWidth=1189&amp;size=131826&amp;status=done&amp;style=none&amp;width=1189" alt="image.png" class="img_ev3q"><br>After MemberLookup starts, it will perform addressing tasks according to different addressing modes, will collect cluster node list information, call memberChange, trigger cluster node changes, and then publish node change events</p><a name="idHpC"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-consensus-protocol-protocol-layer-abstraction">Nacos consensus protocol protocol layer abstraction<a href="#nacos-consensus-protocol-protocol-layer-abstraction" class="hash-link" aria-label="Direct link to Nacos consensus protocol protocol layer abstraction" title="Direct link to Nacos consensus protocol protocol layer abstraction">​</a></h2><p>From the overall architecture of nacos in the future, it can be seen that the consistency protocol layer will be the core module of nacos, and will serve each functional module built on the core module, or the service and core module itself. The consistency protocol needs to choose between availability and consistency because of the existence of partition fault tolerance, so there are two major types of consistency: final consistency and strong consistency. In nacos, both types of consistency protocols are possible. For example, the naming module uses AP and CP for data management of service instances, respectively. For the config module, it will involve the use of CP. At the same time, there are the following functional demand points</p><ol><li>At present, the persistence service uses a variant version of raft, and the business and the raft protocol are coupled. Therefore, it needs to be decoupled and decoupled. At the same time, a standard Java version of Raft is selected for implementation.</li><li>For small and medium-sized users, the configuration is basically not super much. An independent mysql is relatively heavy and requires a light-weight storage solution. It also supports 2.0 not dependent on mysql and 3.0 dependent on mysql configurability</li><li>Due to CP or AP, there are many implementations, how to make a good abstraction of the consistency protocol layer, so that in the future can quickly achieve the specific implementation of the underlying consistency protocol replacement, such as the Raft protocol, the current selection of nacos It is JRaft, it is not excluded that in the future nacos will implement a standard raft protocol or Paxos protocol by itself</li><li>Since there are multiple function modules working independently in Nacos, there can be no influence between each function module. For example, when the A module processes the request too slowly or an exception occurs, it cannot affect the normal operation of the B module, that is, each function module is in use. How to isolate the data processing of each module when using a consistent protocol?</li></ol><p>According to the consensus protocol and the above functional requirements, this time an abstract consensus protocol layer and related interfaces were made</p><a name="3w8xM"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="consensus-agreement-abstraction">Consensus agreement abstraction<a href="#consensus-agreement-abstraction" class="hash-link" aria-label="Direct link to Consensus agreement abstraction" title="Direct link to Consensus agreement abstraction">​</a></h3><a name="p7zRo"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="consistencyprotocol">ConsistencyProtocol<a href="#consistencyprotocol" class="hash-link" aria-label="Direct link to ConsistencyProtocol" title="Direct link to ConsistencyProtocol">​</a></h4><p>The so-called consistency is the characteristic of whether multiple copies can maintain consistency, and the essence of the copy is data, and the operation of the data is either acquisition or modification. At the same time, the consensus protocol is actually for distributed situations, and this necessarily involves multiple nodes. Therefore, there is a need for a corresponding interface to be able to adjust the coordination protocol of the collaborative work node. What if we want to observe the operation of the consistency agreement? For example, the Raft protocol, we want to know who is the leader in the current cluster, the term of office, and who are the member nodes in the current cluster? Therefore, it is also necessary to provide a consistent protocol metadata acquisition. <br>In summary, the general design of ConsistencyProtcol can come out</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface ConsistencyProtocol&lt;T extends Config, P extends LogProcessor&gt; extends CommandOperations {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Consistency protocol initialization: perform initialization operations based on the incoming Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 一致性协议初始化，根据 Config 实现类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param config {@link Config}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void init(T config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Add a log handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param processors {@link LogProcessor}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void addLogProcessors(Collection&lt;P&gt; processors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Copy of metadata information for this consensus protocol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 该一致性协议的元数据信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return metaData {@link ProtocolMetaData}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ProtocolMetaData protocolMetaData();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Obtain data according to the request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return data {@link Response}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Response getData(GetRequest request) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Get data asynchronously</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return data {@link CompletableFuture&lt;Response&gt;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CompletableFuture&lt;Response&gt; aGetData(GetRequest request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Data operation, returning submission results synchronously</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 同步数据提交，在 Datum 中已携带相应的数据操作信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data {@link Log}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return submit operation result {@link Response}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Response submit(Log data) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Data submission operation, returning submission results asynchronously</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 异步数据提交，在 Datum 中已携带相应的数据操作信息，返回一个Future，自行操作，提交发生的异常会在CompleteFuture中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data {@link Log}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return {@link CompletableFuture&lt;Response&gt;} submit result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception when submit throw Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CompletableFuture&lt;Response&gt; submitAsync(Log data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * New member list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 新的成员节点列表，一致性协议自行处理相应的成员节点是加入还是离开</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param addresses [ip:port, ip:port, ...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void memberChange(Set&lt;String&gt; addresses);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Consistency agreement service shut down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 一致性协议服务关闭</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For the CP protocol, due to the concept of Leader, it is necessary to provide a method for obtaining who is the current Leader of the CP protocol.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface CPProtocol&lt;C extends Config&gt; extends ConsistencyProtocol&lt;C&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Returns whether this node is a leader node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param group business module info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return is leader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isLeader(String group) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="oJFpB"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="data-operation-request-submission-objectloggetrequest">Data operation request submission object：Log、GetRequest<a href="#data-operation-request-submission-objectloggetrequest" class="hash-link" aria-label="Direct link to Data operation request submission object：Log、GetRequest" title="Direct link to Data operation request submission object：Log、GetRequest">​</a></h4><p>As mentioned above, the consistency protocol is actually for data operations. Data operations are basically divided into two categories: data query and data modification, and at the same time, data isolation between different functional modules must be satisfied. Therefore, the data modification operations and data query operations are explained separately here.</p><ol><li>Data modification<ol><li>Data modification operation, you must know which functional module this request belongs to</li><li>For data modification operations, you must first know what kind of modification operation this data modification operation is for, so that the function module can perform corresponding logical operations for the real data modification operation</li><li>For data modification operations, you must know what the modified data is, that is, the request body. In order to make the consistency protocol layer more general, here for the data structure of the request body, the byte[] array is selected</li><li>The type of data, because we serialize the real data into a byte[] array, in order to be able to serialize normally, we may also need to record what the type of this data is</li><li>The information summary or identification information of this request</li><li>The additional information for this request is used to expand the data to be transmitted in the future</li></ol></li></ol><p>In summary, it can be concluded that the design of the Log object is as follows</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message Log {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Function module grouping information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string group = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Abstract or logo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string key = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Specific request data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes data = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // type of data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string type = 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // More specific data manipulation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string operation = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // extra information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map&lt;string, string&gt; extendInfo = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Data query<ol><li>For data query operations, you must know which function module initiated the request</li><li>What are the conditions for data query? In order to be compatible with data query operations of various storage structures, here byte[] is used for storage</li><li>The additional information for this request is used to expand the data to be transmitted in the future</li></ol></li></ol><p>In summary, the design of the GetRequest object is as follows</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">message GetRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Function module grouping information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string group = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Specific request data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes data = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // extra information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map&lt;string, string&gt; extendInfo = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="vBig4"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="function-modules-use-consistency-protocollogprocessor">Function modules use consistency protocol：LogProcessor<a href="#function-modules-use-consistency-protocollogprocessor" class="hash-link" aria-label="Direct link to Function modules use consistency protocol：LogProcessor" title="Direct link to Function modules use consistency protocol：LogProcessor">​</a></h4><p>After the data operation is submitted through the consistency protocol, each node needs to process the Log or GetRequest object. Therefore, we need to abstract a Log and GetRequest object Processor. Different functional modules implement the processor. ConsistencyProtocol will internally According to the group attributes of Log and GetRequest, the Log and GetRequest objects are routed to a specific Processor. Of course, the Processor also needs to indicate which functional module it belongs to.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class LogProcessor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * get data by key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request request {@link GetRequest}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return target type data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract Response onRequest(GetRequest request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Process Submitted Log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param log {@link Log}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return {@link boolean}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract Response onApply(Log log);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Irremediable errors that need to trigger business price cuts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param error {@link Throwable}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onError(Throwable error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * In order for the state machine that handles the transaction to be able to route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * the Log to the correct LogProcessor, the LogProcessor needs to have an identity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return Business unique identification name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract String group();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For the CP protocol, such as the Raft protocol, there is a snapshot design, so we need to separately extend a method for the CP protocol</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class LogProcessor4CP extends LogProcessor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Discovery snapshot handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * It is up to LogProcessor to decide which SnapshotOperate should be loaded and saved by itself</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return {@link List &lt;SnapshotOperate&gt;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;SnapshotOperation&gt; loadSnapshotOperate() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Collections.emptyList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="zbsAE"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h4><p>As can be seen from the above points, ConsistencyProtocol is the use interface exposed to the upper layer functional modules. Each ConsistencyProtocol has a backend implemented by a specific consistency protocol. Because Backend cannot be well compatible with nacos existing architecture design, so The additional LogProcessor is designed to solve this problem.<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015048030-8a4bff4a-20ed-46dd-a7f7-98655b22946f.png#align=left&amp;display=inline&amp;height=591&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=591&amp;originWidth=886&amp;size=93327&amp;status=done&amp;style=none&amp;width=886" alt="image.png" class="img_ev3q"><br>同At the time, because the backend inside the consistency protocol layer needs to implement the isolation processing of the data of different business modules, and this piece of logic is implemented by the request object and the group attribute of the LogProcessor<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015155835-a897262e-8e57-409c-bf94-d57bf765c80b.png#align=left&amp;display=inline&amp;height=591&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=591&amp;originWidth=910&amp;size=118083&amp;status=done&amp;style=none&amp;width=910" alt="image.png" class="img_ev3q"></p><a name="C1yU6"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="consistent-protocol-layer-workflow">Consistent protocol layer workflow<a href="#consistent-protocol-layer-workflow" class="hash-link" aria-label="Direct link to Consistent protocol layer workflow" title="Direct link to Consistent protocol layer workflow">​</a></h3><p>We can take a look at a sequence diagram, the general workflow of the consistency protocol layer
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/30b7e270e7aef8bb63136aaffbe5bfbf.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbnBhcnRpY2lwYW50IFwiTWVtYmVyTWFuYWdlclwiIGFzIE5hY29zQ2x1c3RlclxucGFydGljaXBhbnQgXCJCdXNpbmVzc01vZHVsZVwiIGFzIEJpelxucGFydGljaXBhbnQgXCJDb25zaXN0ZW5jeVByb3RvY29sXCIgYXMgUHJvdG9jb2xcbnBhcnRpY2lwYW50IFwiQ0FQQmFja2VuZFwiIGFzIEJhY2tlbmRcbnBhcnRpY2lwYW50IFwiQ29uZmlnXCIgYXMgQ29uZmlnXG5wYXJ0aWNpcGFudCBcIkxvZ1Byb2Nlc3NvclwiIGFzIFByb2Nlc3NvclxucGFydGljaXBhbnQgXCJMb2dcIiBhcyBMb2dcblxuYWN0aXZhdGUgTmFjb3NDbHVzdGVyXG5OYWNvc0NsdXN0ZXIgLT4gTmFjb3NDbHVzdGVyOiBpbml0KCkg5Yid5aeL5YyWTmFjb3Ppm4bnvqRcblxuTmFjb3NDbHVzdGVyIC0-IENvbmZpZzog6I635Y-WQ29uZmln5a-56LGhXG5hY3RpdmF0ZSBDb25maWdcbkNvbmZpZyAtPiBDb25maWc6IOaUtumbhkxvZ1Byb2Nlc3NvcueahOS_oeaBr1xuQ29uZmlnIC0-IE5hY29zQ2x1c3RlclxuZGVhY3RpdmF0ZSBDb25maWdcblxuXG5OYWNvc0NsdXN0ZXIgLT4gUHJvdG9jb2w6IOiOt-WPluaJgOaciUNvbnNpc3RlbmN5UHJvdG9jb2zlrp7njrBcbmFjdGl2YXRlIFByb3RvY29sXG5cbk5hY29zQ2x1c3RlciAtPiBQcm90b2NvbDogaW5pdChDb25maWcpIOaWueazleaJp-ihjFxuXG5kZWFjdGl2YXRlIFByb3RvY29sXG5kZWFjdGl2YXRlIE5hY29zQ2x1c3RlclxuXG5cbkJpeiAtPiBMb2c6IOWIm-W7uuS4gOS4quS6i-WKoeWvueixoVxuYWN0aXZhdGUgQml6XG5hY3RpdmF0ZSBMb2dcblxuXG5Mb2cgLT4gTG9nOiDorr7nva5kYXRhXG5Mb2cgLT4gTG9nOiDorr7nva5rZXlcbkxvZyAtPiBMb2c6IOiuvue9rmNsYXNzTmFtZVxuTG9nIC0-IExvZzog6K6-572uZXh0ZW5kSW5mb1xuTG9nIC0-IEJpelxuZGVhY3RpdmF0ZSBMb2dcblxuQml6IC0-IFByb3RvY29sOiBzdWJtaXQoTG9nKSDosIPnlKjkuIDoh7TmgKfljY_orq7ov5vooYzkuovliqHmj5DkuqRcbmFjdGl2YXRlIFByb3RvY29sXG5cblByb3RvY29sIC0-IEJhY2tlbmQ6IOWGhemDqOS4gOiHtOaAp-WNj-iuruW3peS9nFxuYWN0aXZhdGUgQmFja2VuZFxuXG5CYWNrZW5kIC0-IFByb3RvY29sOiDov5Tlm57lt6XkvZzlpITnkIbnu5PmnpxcbmRlYWN0aXZhdGUgQmFja2VuZFxuXG5Qcm90b2NvbCAtPiBQcm9jZXNzb3I6IOWwhkxvZ-WIhuWPkeWIsOWvueW6lOeahFByb2Nlc3Nvcu-8jOiwg-eUqCBvbkFwcGx5IOaWueazlVxuYWN0aXZhdGUgUHJvdG9jb2xcbmRlYWN0aXZhdGUgUHJvdG9jb2xcblxuUHJvY2Vzc29yIC0-IEJpejog5LqL5Yqh5o-Q5Lqk57uT5p6cXG5cbmRlYWN0aXZhdGUgUHJvY2Vzc29yXG5kZWFjdGl2YXRlIEJpelxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiNFZpMkwiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzMwYjdlMjcwZTdhZWY4YmI2MzEzNmFhZmZiZTViZmJmLnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=" class="img_ev3q"></p><a name="xtBNU"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-implementation-option-of-cp-protocol-in-nacos-consistency-protocol-layerjraft">The implementation option of CP protocol in Nacos consistency protocol layer——JRaft<a href="#the-implementation-option-of-cp-protocol-in-nacos-consistency-protocol-layerjraft" class="hash-link" aria-label="Direct link to The implementation option of CP protocol in Nacos consistency protocol layer——JRaft" title="Direct link to The implementation option of CP protocol in Nacos consistency protocol layer——JRaft">​</a></h3><p>After the consistency protocol layer is abstracted, the rest is the choice of concrete consistency protocol implementation. Here we have chosen Ant Financial&#x27;s open source JRaft, so how can we use JRaf as a backend of the CP protocol? The following simple flow chart describes the initialization process when JRaft is used as a Backend of the CP protocol</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * A concrete implementation of CP protocol: JRaft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;pre&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                                           ┌──────────────────────┐               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                                           │                      │               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *            ┌──────────────────────┐       │                      ▼               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *            │   ProtocolManager    │       │        ┌───────────────────────────┐ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *            └──────────────────────┘       │        │for p in [LogProcessor4CP] │ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │        └───────────────────────────┘ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │                      │               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      ┌──────────────────────────────────┐ │                      ▼               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      │    discovery LogProcessor4CP     │ │             ┌─────────────────┐      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      └──────────────────────────────────┘ │             │  get p.group()  │      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │             └─────────────────┘      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │                      │               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                 ┌─────────────┐           │                      │               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                 │ RaftConfig  │           │                      ▼               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                 └─────────────┘           │      ┌──────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │      │  create raft group service   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │      └──────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *              ┌──────────────────┐         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *              │  JRaftProtocol   │         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *              └──────────────────┘         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                     init()                │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *               ┌─────────────────┐         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *               │   JRaftServer   │         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *               └─────────────────┘         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *             ┌────────────────────┐        │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *             │JRaftServer.start() │        │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *             └────────────────────┘        │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        └──────────────────┘                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;/pre&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author &lt;a href=&quot;mailto:liaochuntao@live.com&quot;&gt;liaochuntao&lt;/a&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>JRaftProtocol is a concrete implementation of a ConsistencyProtocol when JRaft is used as the backend of the CP protocol. It has a JRaftServer member attribute inside. JRaftServer distributes various API operations of JRaft, such as data operation submission, data query, and member node changes. , Leader node query, etc.</p><p><em><strong>Note: The data generated during JRaft operation is in the ${nacos.home}/data/protocol/raft file directory. Different business modules have different file groupings. If the node crashes or shuts down abnormally, clear the files in the directory and restart the node</strong></em></p><p>Since JRaft implements the concept of raft group, it is possible to use the design of raft group to create a raft group for each function module. Here is part of the code, which shows how to embed LogProcessor in the state machine and create a Raft Group for each LogPrcessor</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">synchronized void createMultiRaftGroup(Collection&lt;LogProcessor4CP&gt; processors) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // There is no reason why the LogProcessor cannot be processed because of the synchronization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!this.isStarted) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.processors.addAll(processors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String parentPath = Paths</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .get(ApplicationUtils.getNacosHome(), &quot;data/protocol/raft&quot;).toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (LogProcessor4CP processor : processors) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String groupName = processor.group();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (multiRaftGroup.containsKey(groupName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new DuplicateRaftGroupException(groupName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Ensure that each Raft Group has its own configuration and NodeOptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Configuration configuration = conf.copy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NodeOptions copy = nodeOptions.copy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JRaftUtils.initDirectory(parentPath, groupName, copy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Here, the LogProcessor is passed into StateMachine, and when the StateMachine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // triggers onApply, the onApply of the LogProcessor is actually called</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NacosStateMachine machine = new NacosStateMachine(this, processor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        copy.setFsm(machine);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        copy.setInitialConf(configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Set snapshot interval, default 1800 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int doSnapshotInterval = ConvertUtils.toInt(raftConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getVal(RaftSysConstants.RAFT_SNAPSHOT_INTERVAL_SECS),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    RaftSysConstants.DEFAULT_RAFT_SNAPSHOT_INTERVAL_SECS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If the business module does not implement a snapshot processor, cancel the snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doSnapshotInterval = CollectionUtils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .isEmpty(processor.loadSnapshotOperate()) ? 0 : doSnapshotInterval;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        copy.setSnapshotIntervalSecs(doSnapshotInterval);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Loggers.RAFT.info(&quot;create raft group : {}&quot;, groupName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RaftGroupService raftGroupService = new RaftGroupService(groupName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    localPeerId, copy, rpcServer, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Because RpcServer has been started before, it is not allowed to start again here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Node node = raftGroupService.start(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        machine.setNode(node);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RouteTable.getInstance().updateConfiguration(groupName, configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RaftExecutor.executeByCommon(() -&gt; registerSelfToCluster(groupName, localPeerId, configuration));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Turn on the leader auto refresh for this group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Random random = new Random();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long period = nodeOptions.getElectionTimeoutMs() + random.nextInt(5 * 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RaftExecutor.scheduleRaftMemberRefreshJob(() -&gt; refreshRouteTable(groupName),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    nodeOptions.getElectionTimeoutMs(), period, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        multiRaftGroup.put(groupName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new RaftGroupTuple(node, processor, raftGroupService, machine));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="4czvB"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="qa-why-do-you-want-to-create-multiple-raft-groups">Q&amp;A: Why do you want to create multiple raft groups<a href="#qa-why-do-you-want-to-create-multiple-raft-groups" class="hash-link" aria-label="Direct link to Q&amp;A: Why do you want to create multiple raft groups" title="Direct link to Q&amp;A: Why do you want to create multiple raft groups">​</a></h4><p>Some people may have doubts. Since the LogProcessor has been designed before, you can use a Raft Group. When the state machine is appl, you can route to different LogProcessors according to the Log group attribute. Each function module creates a Raft group, will it consume a lot of resources? <br>As mentioned before, we hope that the modules that work independently do not affect each other. For example, the A module processing Log may cause the application speed to be slow because of the Block operation, or an exception may occur halfway. For the Raft protocol , When the log apply fails, the state machine will not be able to continue to move forward, because if you continue to move forward, due to the previous step of the apply failure, all subsequent applications may fail, which will cause the data of this node and other nodes Data is never consistent. If we put all the modules that work independently in the same raft group, that is, a state machine, for the data processing request processing, the above-mentioned problems will inevitably occur, and a module will be uncontrollable in the apply log. Factors will affect the normal operation of other modules.</p><a name="2GyRw"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="jraft-operation-and-maintenance">JRaft operation and maintenance<a href="#jraft-operation-and-maintenance" class="hash-link" aria-label="Direct link to JRaft operation and maintenance" title="Direct link to JRaft operation and maintenance">​</a></h3><p>In order to allow users to perform simple operation and maintenance of JRaft, such as leader switching, resetting the current Raft cluster members, triggering a node to perform Snapshot operations, etc., a simple HTTP interface is provided for operation, and the interface has certain Limit, that is, only one operation instruction can be executed at a time</p><p>1、Switch the leader node of a certain Raft Group</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;transferLeader&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port} or ip:{raft_port},ip:{raft_port},ip:{raft_port}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="Fs7VE"></a><p>2、Reset a Raft Group cluster member</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;resetRaftCluster&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port},ip:{raft_port},ip:{raft_port},ip:{raft_port}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that this operation is a high-risk operation. This operation and maintenance command can only be used when the n/2 + 1 node of the Raft cluster fails to meet the requirements of more than half of the vote after the crash. It is used to quickly reorganize the remaining nodes to the Raft cluster to provide external Service, but this operation will greatly cause the loss of data<br></p><a name="VfG5T"></a><p>3、Trigger a Raft Group to perform a snapshot operation</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;doSnapshot&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="m9LfI"></a><p>4、Remove a member of a Raft Group</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;removePeer&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="ev3MW"></a><p>5、Remove multiple members of a Raft Group in batches</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;removePeers&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port},ip:{raft_port},ip:{raft_port},...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="GzMuP"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="jraft-protocol-related-configuration-parameters">JRaft protocol related configuration parameters<a href="#jraft-protocol-related-configuration-parameters" class="hash-link" aria-label="Direct link to JRaft protocol related configuration parameters" title="Direct link to JRaft protocol related configuration parameters">​</a></h3><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">### Sets the Raft cluster election timeout, default value is 5 second</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.election_timeout_ms=5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### Sets the amount of time the Raft snapshot will execute periodically, default is 30 minute</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.snapshot_interval_secs=30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### Requested retries, default value is 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.request_failoverRetries=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### raft internal worker threads</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.core_thread_num=8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### Number of threads required for raft business request processing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.cli_service_thread_num=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### raft linear read strategy, defaults to index</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.read_index_type=ReadOnlySafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### rpc request timeout, default 5 seconds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.rpc_request_timeout_ms=5000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="linear-reading-parameter-analysis">Linear reading parameter analysis<a href="#linear-reading-parameter-analysis" class="hash-link" aria-label="Direct link to Linear reading parameter analysis" title="Direct link to Linear reading parameter analysis">​</a></h4><ol><li><strong>ReadOnlySafe</strong><ol><li>In this linear read mode, every time a Follower makes a read request, it needs to synchronize with the Leader to submit the site information, and the Leader needs to initiate a lightweight RPC request to prove that it is the Leader to more than half of the Follower, which is equivalent to a Follower read, at least 1 + (n/2) + 1 RPC request is required.</li></ol></li><li><strong>ReadOnlyLeaseBased</strong><ol><li>In this linear read mode, each time the Follower makes a read request, the Leader only needs to determine whether its Leader lease has expired. If it does not expire, it can directly reply that the Follower is the Leader, but the mechanism has strict requirements on the machine clock. For clock synchronization, consider using this linear read mode.</li></ol></li></ol><a name="WiLDa"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-embedded-distributed-id">Nacos embedded distributed ID<a href="#nacos-embedded-distributed-id" class="hash-link" aria-label="Direct link to Nacos embedded distributed ID" title="Direct link to Nacos embedded distributed ID">​</a></h2><p>The distributed ID embedded in nacos is Snakeflower, the dataCenterId defaults to 1, and the value of workerId is calculated as follows</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">InetAddress address;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">try </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    address = InetAddress.getLocalHost();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> catch (final UnknownHostException e) </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new IllegalStateException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;Cannot get LocalHost InetAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> please check your network</span><span class="token tag" style="color:#00009f">!</span><span class="token plain">&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> ipAddressByteArray = address.getAddress();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">workerId = (((ipAddressByteArray</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ipAddressByteArray.length </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> &amp; 0B11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;&lt; Byte.SIZE) + (ipAddressByteArray</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ipAddressByteArray.length </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &amp; 0xFF));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you need to manually specify dataCenterId and workerId, add command line parameters in application.properties or startup</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">### set the dataCenterID manually</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># nacos.core.snowflake.data-center=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### set the WorkerID manually</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># nacos.core.snowflake.worker-id=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="ZLp5w"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-embedded-lightweight-derby-based-distributed-relational-storage">Nacos embedded lightweight Derby-based distributed relational storage<a href="#nacos-embedded-lightweight-derby-based-distributed-relational-storage" class="hash-link" aria-label="Direct link to Nacos embedded lightweight Derby-based distributed relational storage" title="Direct link to Nacos embedded lightweight Derby-based distributed relational storage">​</a></h2><a name="1B5KV"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="background">Background<a href="#background" class="hash-link" aria-label="Direct link to Background" title="Direct link to Background">​</a></h3><ol><li>If the number of configuration files is small, the cost of supporting a highly available database cluster in the cluster mode is too large, and it is expected to have a lightweight distributed relational storage to solve</li><li>Some metadata information storage inside nacos, such as user information, namespace information</li><li>Source of ideas:<a href="https://github.com/rqlite/rqlite" target="_blank" rel="noopener noreferrer">https://github.com/rqlite/rqlite</a></li></ol><a name="Du2qc"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="design-ideas">Design ideas<a href="#design-ideas" class="hash-link" aria-label="Direct link to Design ideas" title="Direct link to Design ideas">​</a></h3><a name="NzxHa"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="aims">aims<a href="#aims" class="hash-link" aria-label="Direct link to aims" title="Direct link to aims">​</a></h4><p>The design goal is to expect nacos to have two data storage modes, one is the current way, the data is stored in an external data source (relational database); the second way is the embedded storage data source (Apache Derby). Users can use the command line parameter configuration to freely use these two data storage modes<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015542106-f14d2579-229f-4bfb-a432-e40854e65d6d.png#align=left&amp;display=inline&amp;height=903&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=903&amp;originWidth=1514&amp;size=237497&amp;status=done&amp;style=none&amp;width=1514" alt="image.png" class="img_ev3q"></p><a name="LqUtU"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="overall">overall<a href="#overall" class="hash-link" aria-label="Direct link to overall" title="Direct link to overall">​</a></h4><p>Save the SQL context involved in a request operation in order. Then synchronize the SQL context involved in this request through the consensus protocol layer, and then each node parses it and executes it again in a database session in sequence.<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1587204104465-2270480a-de25-4c84-a11b-6edd2de99e66.png#align=left&amp;display=inline&amp;height=814&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20%281%29.png&amp;originHeight=814&amp;originWidth=1149&amp;size=130886&amp;status=done&amp;style=none&amp;width=1149" alt="未命名文件 (1).png" class="img_ev3q"></p><a name="yxFYn"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="related-data-bearing-objects">Related data bearing objects<a href="#related-data-bearing-objects" class="hash-link" aria-label="Direct link to Related data bearing objects" title="Direct link to Related data bearing objects">​</a></h4><p>The DML statements of the database are select, insert, update, and delete. According to the nature of SQL statements for data operations, they can be divided into two categories: query and update. The select statement corresponds to data query, and the insert, update, and delete statements correspond to Data modification. At the same time, when performing database operations, in order to avoid SQL injection, PreparedStatement is used, so SQL statements + parameters are required, so two Request objects about database operations can be obtained</p><ol><li>SelectRequest</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectRequest implements Serializable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final long serialVersionUID = 2212052574976898602L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Query category, because currently using JdbcTemplate, query a single, multiple queries, whether to use RowMapper into an object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private byte queryType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // sql语句</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // select * from config_info where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String sql;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Object[] args;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String className;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>ModifyRequest</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ModifyRequest implements Serializable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final long serialVersionUID = 4548851816596520564L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int executeNo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String sql;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Object[] args;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="moKl7"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="configure-publishing">Configure publishing<a href="#configure-publishing" class="hash-link" aria-label="Direct link to Configure publishing" title="Direct link to Configure publishing">​</a></h4><p>The configuration release operation involves three transactions:</p><ol><li>config_info saves configuration information</li><li>config_tags_relation saves the association relationship between configuration and tags</li><li>his_config_info saves a history of configuration operations</li></ol><p>These three transactions are all configured and released under this big transaction. If we say that we perform a Raft protocol submission for each transaction operation, assume that 1, 2 transactions are successfully applied after being submitted through Raft, and the third transaction is in Raft. Apply fails after submission, then for the big transaction released by this configuration, it needs to be rolled back as a whole, otherwise it will violate the atomicity, then it may be necessary to say that the transaction rollback operation is again Raft submitted, then the overall complexity Rise, and directly introduce the management of distributed transactions, so in order to avoid this problem, we integrate the SQL contexts involved in these three transactions into a large SQL context, and submit the Raft protocol to this large SQL context. It ensures that the three sub-transactions successfully solve the atomicity problem in the same database session. At the same time, because the Raft protocol processes the transaction log serially, it is equivalent to adjusting the transaction isolation level of the database to serialization.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void addConfigInfo(final String srcIp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String srcUser, final ConfigInfo configInfo, final Timestamp time,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Map&lt;String, Object&gt; configAdvanceInfo, final boolean notify) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String tenantTmp = StringUtils.isBlank(configInfo.getTenant()) ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StringUtils.EMPTY :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    configInfo.getTenant();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configInfo.setTenant(tenantTmp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Obtain the database primary key through the snowflake ID algorithm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long configId = idGeneratorManager.nextId(RESOURCE_CONFIG_INFO_ID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long hisId = idGeneratorManager.nextId(RESOURCE_CONFIG_HISTORY_ID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addConfigInfoAtomic(configId, srcIp, srcUser, configInfo, time,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    configAdvanceInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String configTags = configAdvanceInfo == null ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    null :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    (String) configAdvanceInfo.get(&quot;config_tags&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addConfigTagsRelation(configId, configTags, configInfo.getDataId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    configInfo.getGroup(), configInfo.getTenant());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        insertConfigHistoryAtomic(hisId, configInfo, srcIp, srcUser, time, &quot;I&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EmbeddedStorageContextUtils.onModifyConfigInfo(configInfo, srcIp, time);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        databaseOperate.blockUpdate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EmbeddedStorageContextUtils.cleanAllContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public long addConfigInfoAtomic(final long id, final String srcIp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String srcUser, final ConfigInfo configInfo, final Timestamp time,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, Object&gt; configAdvanceInfo) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 参数处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String sql =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;INSERT INTO config_info(id, data_id, group_id, tenant_id, app_name, content, md5, src_ip, src_user, gmt_create,&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        + &quot;gmt_modified, c_desc, c_use, effect, type, c_schema) VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Object[] args = new Object[] { id, configInfo.getDataId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                configInfo.getGroup(), tenantTmp, appNameTmp, configInfo.getContent(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                md5Tmp, srcIp, srcUser, time, time, desc, use, effect, type, schema, };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SqlContextUtils.addSqlContext(sql, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void addConfigTagRelationAtomic(long configId, String tagName, String dataId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String group, String tenant) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String sql =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;INSERT INTO config_tags_relation(id,tag_name,tag_type,data_id,group_id,tenant_id) &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        + &quot;VALUES(?,?,?,?,?,?)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Object[] args = new Object[] { configId, tagName, null, dataId, group,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tenant };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SqlContextUtils.addSqlContext(sql, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void insertConfigHistoryAtomic(long configHistoryId, ConfigInfo configInfo,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String srcIp, String srcUser, final Timestamp time, String ops) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 参数处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String sql =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;INSERT INTO his_config_info (id,data_id,group_id,tenant_id,app_name,content,md5,&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        + &quot;src_ip,src_user,gmt_modified,op_type) VALUES(?,?,?,?,?,?,?,?,?,?,?)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Object[] args = new Object[] { configHistoryId, configInfo.getDataId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                configInfo.getGroup(), tenantTmp, appNameTmp, configInfo.getContent(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                md5Tmp, srcIp, srcUser, time, ops };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SqlContextUtils.addSqlContext(sql, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Temporarily saves all insert, update, and delete statements under</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * a transaction in the order in which they occur</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author &lt;a href=&quot;mailto:liaochuntao@live.com&quot;&gt;liaochuntao&lt;/a&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SqlContextUtils {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ThreadLocal&lt;ArrayList&lt;ModifyRequest&gt;&gt; SQL_CONTEXT =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadLocal.withInitial(ArrayList::new);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void addSqlContext(String sql, Object... args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ArrayList&lt;ModifyRequest&gt; requests = SQL_CONTEXT.get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ModifyRequest context = new ModifyRequest();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setExecuteNo(requests.size());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setSql(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setArgs(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requests.add(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SQL_CONTEXT.set(requests);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static List&lt;ModifyRequest&gt; getCurrentSqlContext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return SQL_CONTEXT.get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void cleanCurrentSqlContext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SQL_CONTEXT.remove();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A more intuitive understanding through a timing diagram
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/618e8997395fbc74433ac4a60f67b6b4.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmF1dG9udW1iZXJcblxuYWN0b3IgXCJVc2VyXCIgYXMgVXNlclxuXG5wYXJ0aWNpcGFudCBcIkNvbmZpZ1NlcnZpY2VcIiBhcyBTZXJ2aWNlXG5wYXJ0aWNpcGFudCBcIlBlcnNpc3RlbmNlU2VydmljZVwiIGFzIFJlcG9zaXRvcnlcbnBhcnRpY2lwYW50IFwiRGVyYnlcIiBhcyBEQlxucGFydGljaXBhbnQgXCJTUUxDb250ZXh0VXRpbHNcIiBhcyBTUUxDb250ZXh0XG5wYXJ0aWNpcGFudCBcIkxvZ1Byb2Nlc3NvclwiIGFzIFByb2Nlc3NvclxucGFydGljaXBhbnQgXCJDb25zaXN0ZW5jeVByb3RvY29sXCIgYXMgUHJvdG9jb2xcbnBhcnRpY2lwYW50IFwiTG9nXCIgYXMgTG9nXG5cbmFjdGl2YXRlIFVzZXJcblxuVXNlciAtPiBTZXJ2aWNlOiDlj5HotbfphY3nva7lj5HluIPor7fmsYJcbmFjdGl2YXRlIFNlcnZpY2VcblxuU2VydmljZSAtPiBSZXBvc2l0b3J5OiDphY3nva7lj5HluINcbmFjdGl2YXRlIFJlcG9zaXRvcnlcblxuUmVwb3NpdG9yeSAtPiBTUUxDb250ZXh0OiDmi6bmiKrlvZPliY1TUUzkuIrkuIvmlodcbmFjdGl2YXRlIFNRTENvbnRleHRcblxuUmVwb3NpdG9yeSAtPiBSZXBvc2l0b3J5OiBjb21taXQg5pON5L2cXG5cblNRTENvbnRleHQgLT4gUmVwb3NpdG9yeTog5b2T5YmN6K-35rGC5raJ5Y-K55qE5omA5pyJU1FM5LiK5LiL5paHXG5cbmRlYWN0aXZhdGUgU1FMQ29udGV4dFxuXG5SZXBvc2l0b3J5IC0-IExvZzog5p6E5bu66K-35rGC5L2TXG5cbmFjdGl2YXRlIExvZ1xuZGVhY3RpdmF0ZSBMb2dcblxuUmVwb3NpdG9yeSAtPiBQcm90b2NvbDogc3VibWl0KCkg6L-b6KGM6K-35rGC5o-Q5LqkXG5hY3RpdmF0ZSBQcm90b2NvbFxuZGVhY3RpdmF0ZSBSZXBvc2l0b3J5XG5cblByb3RvY29sIC0-IFByb2Nlc3Nvcjogb25BcHBseSgpIOaWueazle-8jOeKtuaAgeacuuWkjeWItkxvZ1xuYWN0aXZhdGUgUHJvY2Vzc29yXG5cblByb2Nlc3NvciAtPiBSZXBvc2l0b3J5OiDmiafooYzmiYDmnInnmoRTUUzkuIrkuIvmlodcbmFjdGl2YXRlIFJlcG9zaXRvcnlcblxuUmVwb3NpdG9yeSAtPiBEQjog5pWw5o2u6JC95bqTXG5hY3RpdmF0ZSBEQlxuXG5EQiAtPiBSZXBvc2l0b3J5OiDnu5PmnZ_lubbov5Tlm57nu5PmnpxcbmRlYWN0aXZhdGUgREJcblxuUmVwb3NpdG9yeSAtPiBQcm9jZXNzb3I6IOi_lOWbnkxvZ0Z1dHVyZeW5tuiuvue9ruacrOasoeaJp-ihjOeahOe7k-aenFxuZGVhY3RpdmF0ZSBSZXBvc2l0b3J5XG5cblByb2Nlc3NvciAtPiBQcm90b2NvbDog6L-U5ZueTG9nRnV0dXJlXG5kZWFjdGl2YXRlIFByb2Nlc3NvclxuXG5Qcm90b2NvbCAtPiBTZXJ2aWNlOiDmnKzmrKHor7fmsYLnmoTnu5PmnpxcbmRlYWN0aXZhdGUgUHJvdG9jb2xcblxuU2VydmljZSAtPiBVc2VyXG5kZWFjdGl2YXRlIFNlcnZpY2VcbmRlYWN0aXZhdGUgVXNlclxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiVnQxNzciLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzYxOGU4OTk3Mzk1ZmJjNzQ0MzNhYzRhNjBmNjdiNmI0LnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=" class="img_ev3q"></p><a name="AAJTE"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-use-new-features">How to use new features<a href="#how-to-use-new-features" class="hash-link" aria-label="Direct link to How to use new features" title="Direct link to How to use new features">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./startup.sh -p embedded</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Whether to enable the embedded distributed relational storage activity diagram
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/1fd656ba3b39fe5de8fea78efdf98dd1.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJDb25maWcuc3RhcnQoKVwiXG5cbmlmIFwi5Y2V5py65qih5byPXCIgdGhlblxuICAtcmlnaHQtPlt0cnVlXSBcInJldHVybiDpu5jorqTljZXmnLrlrZjlgqjooYzkuLpcIlxuICAtLT4gKCopXG5lbHNlXG4gaWYgXCLlt7LphY3nva7lpJbnva7lrZjlgqhcIiB0aGVuXG4gICAgLS0-W3RydWVdIFwicmV0dXJuIOWklue9ruaVsOaNruWtmOWCqOihjOS4ulwiXG4gICAgLS0-ICgqKVxuIGVsc2VcbiAgICBpZiBcIuW8gOWQr-WGheW1jOWtmOWCqFwiIHRoZW5cbiAgICAgICAgLS0-W3RydWVdIFwicmV0dXJuIOi9u-mHj-WGheW1jOWIhuW4g-W8j-WtmOWCqOihjOS4ulwiXG4gICAgICAgIC0tPiAoKilcbiAgICBlbHNlXG4gICAgICAgIC0-W2ZhbHNlXSBcInJldHVybiDpu5jorqTlpJbnva7mlbDmja7lrZjlgqjooYzkuLpcIlxuICAgICAgICAtLT4gKCopXG5cdFx0ZW5kaWZcbiBlbmRpZlxuZW5kaWZcblxuQGVuZHVtbCIsInR5cGUiOiJwdW1sIiwibWFyZ2luIjp0cnVlLCJpZCI6IkNNN1VDIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC8xZmQ2NTZiYTNiMzlmZTVkZThmZWE3OGVmZGY5OGRkMS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" class="img_ev3q"></p><a name="9UAXN"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="new-features-related-operation-and-maintenance-operations">New features related operation and maintenance operations<a href="#new-features-related-operation-and-maintenance-operations" class="hash-link" aria-label="Direct link to New features related operation and maintenance operations" title="Direct link to New features related operation and maintenance operations">​</a></h3><p>Directly query the data stored in each node&#x27;s derby</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GET /nacos/v1/cs/ops/derby?sql=select * from config_info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return List&lt;Map&lt;String, Object&gt;&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="YcqO2"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="insufficient">insufficient<a href="#insufficient" class="hash-link" aria-label="Direct link to insufficient" title="Direct link to insufficient">​</a></h3><ol><li>Build a distributed data operation synchronization layer on the upper layer of the database, there are restrictions on the operation of the database, such as the first insert operation, then the select operation, and finally the update operation, which is interspersed with query statements in the data modification statement The order of operations is not supported</li><li>Limiting the performance of the database, due to the indirect adjustment of the database transaction isolation level to serialization, the concurrency ability is artificially reduced</li></ol><a name="7dul8"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="future-evolution">Future evolution<a href="#future-evolution" class="hash-link" aria-label="Direct link to Future evolution" title="Direct link to Future evolution">​</a></h3><p>Apache Derby official will try to realize the synchronous replication operation of BingLog based on Raft, and realize the database synchronization capability from the bottom</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/blog/nacos 1.2.0 guide"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Nacos 1.2.0权限控制介绍和使用</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/blog/namespace-endpoint-best-practices"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Namespace,endpoint 最佳实践</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#summarize" class="table-of-contents__link toc-highlight">Summarize</a></li><li><a href="#system-parameters-changes" class="table-of-contents__link toc-highlight">System parameters changes</a><ul><li><a href="#updates" class="table-of-contents__link toc-highlight">Updates</a></li></ul></li><li><a href="#the-future-overall-logical-architecture-of-nacos-and-its-components" class="table-of-contents__link toc-highlight">The future overall logical architecture of Nacos and its components</a></li><li><a href="#nacos-cluster-member-node-addressing-mode" class="table-of-contents__link toc-highlight">Nacos cluster member node addressing mode</a><ul><li><a href="#addressing-mode-details" class="table-of-contents__link toc-highlight">Addressing mode details</a></li><li><a href="#how-node-management-and-addressing-modes-are-combined" class="table-of-contents__link toc-highlight">How node management and addressing modes are combined</a></li></ul></li><li><a href="#nacos-consensus-protocol-protocol-layer-abstraction" class="table-of-contents__link toc-highlight">Nacos consensus protocol protocol layer abstraction</a><ul><li><a href="#consensus-agreement-abstraction" class="table-of-contents__link toc-highlight">Consensus agreement abstraction</a></li><li><a href="#consistent-protocol-layer-workflow" class="table-of-contents__link toc-highlight">Consistent protocol layer workflow</a></li><li><a href="#the-implementation-option-of-cp-protocol-in-nacos-consistency-protocol-layerjraft" class="table-of-contents__link toc-highlight">The implementation option of CP protocol in Nacos consistency protocol layer——JRaft</a></li><li><a href="#jraft-operation-and-maintenance" class="table-of-contents__link toc-highlight">JRaft operation and maintenance</a></li><li><a href="#jraft-protocol-related-configuration-parameters" class="table-of-contents__link toc-highlight">JRaft protocol related configuration parameters</a></li></ul></li><li><a href="#nacos-embedded-distributed-id" class="table-of-contents__link toc-highlight">Nacos embedded distributed ID</a></li><li><a href="#nacos-embedded-lightweight-derby-based-distributed-relational-storage" class="table-of-contents__link toc-highlight">Nacos embedded lightweight Derby-based distributed relational storage</a><ul><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#design-ideas" class="table-of-contents__link toc-highlight">Design ideas</a></li><li><a href="#how-to-use-new-features" class="table-of-contents__link toc-highlight">How to use new features</a></li><li><a href="#new-features-related-operation-and-maintenance-operations" class="table-of-contents__link toc-highlight">New features related operation and maintenance operations</a></li><li><a href="#insufficient" class="table-of-contents__link toc-highlight">insufficient</a></li><li><a href="#future-evolution" class="table-of-contents__link toc-highlight">Future evolution</a></li></ul></li></ul></div></div></div></div></div></div>
<script src="/en/assets/js/runtime~main.f1cec763.js"></script>
<script src="/en/assets/js/main.02fbd811.js"></script>
</body>
</html>