<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Blog | Nacos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://nacos.io/zh-cn/img/nacos_colorful.png"><meta data-rh="true" name="twitter:image" content="https://nacos.io/zh-cn/img/nacos_colorful.png"><meta data-rh="true" property="og:url" content="https://nacos.io/zh-cn/blog/page/3"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="keywords" content="Nacos"><meta data-rh="true" property="og:title" content="Blog | Nacos"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"><link data-rh="true" rel="canonical" href="https://nacos.io/zh-cn/blog/page/3"><link data-rh="true" rel="alternate" href="https://nacos.io/en/blog/page/3" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://nacos.io/zh-cn/blog/page/3" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://nacos.io/blog/page/3" hreflang="default"><link data-rh="true" rel="alternate" href="https://nacos.io/blog/page/3" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://1QV814950M-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Nacos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Nacos Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Nacos" href="/zh-cn/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=nacos">
<meta name="referrer" content="no-referrer">
<link rel="stylesheet" href="//g.alicdn.com/mamba/mse-arc-ui/0.0.21/umd/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/mse-arc-ui/0.0.21/umd/mse-arc-ui.min.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-0YDFJ7LX7F" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.627d44a2.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.d42dcdce.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.e70e6d9a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>



<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="//hm.baidu.com/hm.js?e3a5cec56ef8619cf9d7c2abebd509e3"></script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="/zh-cn/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh-cn/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a href="https://nacos.io/zh-cn/docs/v2/quickstart/quick-start.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"> </a><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="what-is-nacos" href="/zh-cn/docs/what-is-nacos">2.X（推荐）</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-cn/docs/next/what-is-nacos">预览版</a></li><li><a class="dropdown__link" href="/zh-cn/docs/what-is-nacos">2.X（推荐）</a></li><li><a class="dropdown__link" href="/zh-cn/docs/1.X/what-is-nacos">1.X</a></li></ul></div><a class="navbar__item navbar__link" href="/zh-cn/cloud">Nacos Cloud</a><a href="https://developer.aliyun.com/ebook/36?spm=a2c6h.20345107.ebook-index.18.152c2984fsi5ST" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">NACOS架构与原理<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a href="http://console.nacos.io/nacos/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/en/blog/page/3" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog/page/3" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.3.0-beta-release">Nacos 荣获GLCC优秀社区，同时2.3.0-BETA发布，欢迎试用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2023">Nacos开源之夏2023，贡献社区赢取12000奖金</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.2.2-release">Nacos 2.2.2发布，优化启动体验和鉴权提示</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.2.1-release">Nacos 多个新版本发布，rust-sdk完全适配完成</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/announcement-token-secret-key">关于Nacos默认token.secret.key及server.identity风险说明及解决方案公告</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/higress">Higress + Nacos 微服务网关最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-reigster-mechanism">Nacos 的一条注册请求会经历什么？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.2.0-release">Nacos 2.2.0 版本发布，新增多种插件支持</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/212-and-220beta-release">Nacos 2.1.2、2.2.0-BETA及go-sdk 2.1.1 版本同时发布，多语言生态再添大将</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.1.1-release">Nacos 四周年，2.1.1 及 1.4.4 版本同时发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos3.0-is-coming">我们总结了3大使用建议，并首次公开 Nacos3.0 规划图 | Nacos 开源4周年</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/xiaomi-scale">小米Nacos2.0扩缩容最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2022">Nacos开源之夏2022，贡献社区赢取12000奖金</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.1.0-release">Nacos 2.1.0版本发布，支持鉴权及加解密插件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/use-nacos-with-rainbond">在 Rainbond 中一键安装高可用 Nacos 集群</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/apisix">Apache APISIX 基于 Nacos 实现服务发现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/up-to-2w-star">双十一献礼 | Nacos Star破两万的回顾与展望</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.0.3-release">Nacos 2.0.3版本发布，继续提升集群稳定性及升级稳定性</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/performance-compare">Nacos 2.0 升级前后性能对比压测</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/springboot-0.2.10">Nacos-spring-boot0.2.10发布，全面支持Nacos2.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2021">Nacos 开源之夏2021活动 报名正式开启</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.0.1-release">Nacos 2.0.1 + 1.4.2 Release</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/1.4.0-release">双十一购物节，Nacos 1.4.0 + Go SDK 1.0.1发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-distro-mechanism">Nacos 的 Distro 一致性协议</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/csharp-0.5.0">Nacos-sdk-csharp 0.5.0正式发布，功能与Java版本对齐！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-2nd-anniversary">Nacos 两周年献礼，Nacos 1.3.2 + Go SDK 1.0.0发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/feeling-of-ASoC-2019">参与开源，Offer拿到手软 -- 来自一名2019阿里巴巴编程之夏同学的亲述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos 1.2.0 guide">Nacos 1.2.0权限控制介绍和使用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-1.3.0-design">Nacos 1.3.0 全新内核构建过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/namespace-endpoint-best-practices">Namespace,endpoint 最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/pilot mcp">Pilot MCP协议介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos 1.1.4">Nacos 1.1.4发布，业界率先支持Istio MCP协议</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-confd">Nacos整合Confd，支持nginx配置管理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/eureka2">Eureka 2.0 开源工作宣告停止？别担心，ANS 即将 C位强势出道！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos 1.1.0">Nacos 1.1.0发布，支持灰度配置和地址服务器模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-roadmap">Nacos GA后的整体规划</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/cmdb">Nacos打通CMDB实现就近访问</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/address-server">阿里巴巴基于 Nacos 实现环境隔离的实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos1.0.0">Nacos 1.0.0 发布，正式大规模生产可用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.9.0">Nacos 0.9.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.9-intro">Nacos 0.9.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/huya-practice">虎牙直播在微服务改造方面的实践和总结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.8">Nacos 0.8.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/huya-nacos">虎牙直播共建Nacos生态</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/5w1h-where">Nacos 有哪些典型的应用场景？—— 配置管理篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/dynamic-route-zuul-nacos">使用Nacos实现Spring Cloud Zuul的动态路由</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.6">Nacos 0.6版本发布，支持Dubbo生态并且支持Docker部署</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.5">Nacos0.5发布，支持DNS-based Service Discovery，JAVA 11</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos">Nacos 0.1.0 版本Review 活动设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/cncf">Nacos 进入CNCF landscape</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/5w1h-what">Nacos 帮我们解决什么问题？—— 配置管理篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/discovery-console">Nacos服务发现控制台预览</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/chengdu-dubbo">Nacos 计划发布v0.2版本，进一步融合Dubbo和SpringCloud生态</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/consul-k8s">Consul与kubernetes整合公告[翻译]</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/dns-sd">微服务架构中基于DNS的服务注册与发现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-is-coming">支持Dubbo生态发展，阿里巴巴启动新的开源项目 Nacos</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/alibaba-configserver">阿里巴巴服务注册中心产品ConfigServer 10年技术发展回顾</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/iscas2021">Nacos 开源之夏2021活动 报名正式开启</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-05-25T00:00:00.000Z" itemprop="datePublished">2021年5月25日</time> · <!-- -->阅读需 5 分钟</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于nacos">关于Nacos<a href="#关于nacos" class="hash-link" aria-label="关于Nacos的直接链接" title="关于Nacos的直接链接">​</a></h2><p>Nacos（/nɑ:kəʊs/）是Dynamic <u>Na</u>ming and <u>Co</u>nfiguration <u>S</u>ervice的首字母简称，是一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。它孵化于阿里巴巴，成长于十年双十一的洪峰考验，沉淀了简单易用、稳定可靠、性能卓越的核心竞争力。
<img loading="lazy" alt="image.png" src="/zh-cn/assets/images/features-b3ef3792c7e7919ffae4df3ba4bc860d.png" width="680" height="259" class="img_ev3q"></p><p>Nacos经过数年的社区共建，支持诸如Java、Go、Python等主流语言、支持如Dubbo和Spring Cloud Alibaba等主流服务框架和配置管理框架、同时还支持对接了如Istio，CoreDNS等云原生组件，是目前使用最广泛的微服务框架基础设施。
<img loading="lazy" alt="image.png" src="/zh-cn/assets/images/ecology-e71e0177f31a7e7353199e2804e7019d.png" width="680" height="295" class="img_ev3q"></p><p>Nacos开源后快速成为国内首选，被互联网、视频、直播、金融领域公司广泛使用，支撑这国计民生的核心业务系统。
<img loading="lazy" alt="image.png" src="/zh-cn/assets/images/whouse-1ef86c86fcfcd53ed84d325a86b803a1.png" width="680" height="270" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="为什么选择nacos">为什么选择Nacos<a href="#为什么选择nacos" class="hash-link" aria-label="为什么选择Nacos的直接链接" title="为什么选择Nacos的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="社区开放活跃">社区开放活跃<a href="#社区开放活跃" class="hash-link" aria-label="社区开放活跃的直接链接" title="社区开放活跃的直接链接">​</a></h3><p>Nacos在github上有17.6k stars 和 6.9k fork；社区共有28位核心Committer，其中一半来自于阿里巴巴，一半来自于社区各行各业。
​</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="产品功能强大">产品功能强大<a href="#产品功能强大" class="hash-link" aria-label="产品功能强大的直接链接" title="产品功能强大的直接链接">​</a></h3><p>Nacos 提供服务发现和服务健康监测、提供动态配置服务、提供动态 DNS 服务、提供服务及其元数据管理等核心能力，具备简单易用、特性丰富、超高性能、超大容量、高可用等优势。
​</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="生态联系紧密">生态联系紧密<a href="#生态联系紧密" class="hash-link" aria-label="生态联系紧密的直接链接" title="生态联系紧密的直接链接">​</a></h3><p>Nacos支持主流的微服务框架和应用框架，支持云原生生态。选择Nacos能够更容易嵌入和学习整个微服务体系及云原生体系。
​</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参与nacos社区">参与Nacos社区<a href="#参与nacos社区" class="hash-link" aria-label="参与Nacos社区的直接链接" title="参与Nacos社区的直接链接">​</a></h2><p>Nacos主要通过官方网站和Github来进行社区参与，参与内容不仅限于代码提交，还包括文档、翻译、测试、文章分享、社区治理等等。</p><ul><li>Nacos官方网站：<a href="https://nacos.io/zh-cn/index.html" target="_blank" rel="noopener noreferrer">https://nacos.io</a></li><li>Nacos项目地址：<a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/nacos</a></li><li>Nacos生态地址：<a href="https://github.com/nacos-group" target="_blank" rel="noopener noreferrer">https://github.com/nacos-group</a></li></ul><p>Nacos采用Apache 2.0 Lisence作为开源许可证，同时也赞同其<code>社区高于代码</code>的理念，并按照自己的方式践行。通过与生态伙伴积极共建能力、广泛接受来自各类用户的诉求和贡献、参与两届编程之夏活动，为Nacos社区带来和超过200位贡献者和十分合理的Committer构成。我们欢迎更多希望参与开源，从开源中提升技术、分享思考的同学加入到Nacos社区中。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="暑期2021">暑期2021<a href="#暑期2021" class="hash-link" aria-label="暑期2021的直接链接" title="暑期2021的直接链接">​</a></h2><p>Nacos--暑期2021项目已上线，项目申请报名已于5.24日开启，感兴趣的同学可以前往官网查看项目详情，先行了解和沟通并报名参与～。
​
Nacos社区为同学们准备了数个难度不一的题目，可以帮同学们快速了解微服务生态中配置中心和服务管理的相关内容：</p><ul><li>为Nacos Python SDK适配新版本gRPC接口（难度：简单）</li><li>添加配置加解密的插件SPI，并新增一类简单的加解密实现（难度：中等）</li><li>添加鉴权的插件SPI，并将当前的默认鉴权实现转化为插件化实现（难度：中等）</li><li>添加新的可观测性系统（难度：中等）</li><li>构建内嵌的反脆弱体系插件（难度：困难）</li></ul><p>更多详细内容可进入，Nacos官网、Nacos github或ISCAS官网中了解：
​</p><p>Nacos官方网址：<a href="https://nacos.io/zh-cn/index.html" target="_blank" rel="noopener noreferrer">https://nacos.io</a></p><p>Nacos社区相关内容：<a href="https://github.com/alibaba/nacos/issues/5693" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/nacos/issues/5693</a></p><p>ISCAS相关内容：<a href="https://summer.iscas.ac.cn/#/org/orgdetail/nacos?lang=en" target="_blank" rel="noopener noreferrer">https://summer.iscas.ac.cn/#/org/orgdetail/nacos?lang=en</a></p><p>ISCAS学生指南：<a href="https://summer.iscas.ac.cn/help/" target="_blank" rel="noopener noreferrer">https://summer.iscas.ac.cn/help/</a></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/2.0.1-release">Nacos 2.0.1 + 1.4.2 Release</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-05-10T00:00:00.000Z" itemprop="datePublished">2021年5月10日</time> · <!-- -->阅读需 6 分钟</div></header><div class="markdown" itemprop="articleBody"><p>Nacos是阿里巴巴开源的服务发现与配置管理项目，本次同时发布两个版本：</p><ol><li>发布2.0.1版本，主要致力于支持MCP-OVER-XDS协议，解决Nacos与Istio数据服务同步问题。</li><li>发布1.4.2版本，极大增强k8s环境中JRaft集群Leader选举的稳定性。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-201">Nacos 2.0.1<a href="#nacos-201" class="hash-link" aria-label="Nacos 2.0.1的直接链接" title="Nacos 2.0.1的直接链接">​</a></h2><p>2.0.1主要变更为：</p><ol><li>在nacos-istio插件及模块中，支持MCP-OVER-XDS协议，解决Nacos与Istio数据服务同步问题。</li><li>增强了Jraft协议在k8s环境中的Leader选举的稳定性。</li><li>修复了频繁抛出Server is Down错误的问题。</li></ol><p>具体变更为：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[#3484] Support ldap login.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4856] Support mcp over xds.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5137] Support service list add view subscriber.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5367] Support client encryption plugin for nacos 2.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5307] Push support config some parameters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5334] Fix Server is Down problem in k8s environment.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5361] Check isUseGrpcFeatures() when register instance using GRPC protocol.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5486] Refactor Distro Config as singleton and replace GlobalConfig.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5169] Fix instance beat run only by responsible server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5175] Fix publishConfig lost type.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5178] Fix NPE when init server list failed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5182] Fix throw NoSuchFieldException in ConfigController when service connect to nacos.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5204] Fix query error when pageNo is larger than service number.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5268] Fix subscriber app unknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5327] Fix ThreadPool usage problem and add some monitor for distro.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5384] Fix the problem of unable to shutdown NacosConfigService.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5404] Fix frequently udp push for client 1.X.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5419] Fix Nacos 2.0 client auth may invalid for non public namespace.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5442] change state to UP when received status form old version server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5096] Add unit tests in nacos 2.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5171][#5421][#5436][#5450][#5464] Fix IT for nacos 2.0.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-142">Nacos 1.4.2<a href="#nacos-142" class="hash-link" aria-label="Nacos 1.4.2的直接链接" title="Nacos 1.4.2的直接链接">​</a></h2><ol><li>该版本优化了JRaft模块，与最新的nacos-k8s项目配合使用，极大增强集群选主的稳定性。</li><li>另外，该版本了修复有关“Server is Down”问题的提示及众多1.4.1版本中的Bug。</li></ol><p>具体变更为：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[#4452] Add config compare features.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4602] Add new way for export config.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4996] Make log level changeable for nacos-core module.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5367] Add pre-plugin in client for encrypting config.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3922] Method createServiceIfAbsent in ServiceManager require sync.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4274] skip master-select task when db.num is 1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4753] Use SafeConstructor to parse yaml configuration.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4762] Naming health check thread num support user define it by self.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4770] Beta publish: change the way of select betaIps, from input to select.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4778] Make SecurityProxy.accessToken threadsafe in single writer multi reader.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4903] Add securuty hint for login page.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4917] Raft ops interface add auth.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4980] Log4J2NacosLogging.loadConfiguration() return directly When location is blank.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5010] Fix the usage of TemplateUtils.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5190] Add some hint log when login failed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5234] Solve the problem that page can be edited while publishing-config request is processing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5331] Fix the mouse hovers over the margin in a pointer state and cannot be clicked.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5350] Add hint and detail reason for consistence status Down.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5439] Support specified naming UDP push port for client.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5434] Optimize the ConfigType.isValidType method.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3779] Check groupName can&#x27;t be empty.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4661] ConfigServletInner#doGetConfig code optimization.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3610] Fix the press F1 to full screen issue in new config page.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3876] Fix push empty service name.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4306] Fix search service by group error problem.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4573,#4629] Jraft leader status check error.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4672] Fix cloning configuration lost description.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4699] Fix metadata batch operation may delete instance problem.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4756] Fix config list sort and search problem.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4787] Losting member if parsing host throw UnknownHostException.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4806] Fix addListener method comment.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4829] Remove instance when distro and raft remove instances data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4852] Fix main.js is too large problem.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4854] Modify Header to support Keys Ignore Case.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4898] Fix instance list page bug.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4925] Fix member list change will cover member status and metadata problem.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5078] Fix the problem of inconsistent results for querying subscriber list data multiple times.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5026] Fix MetricsHttpAgent metrics twice.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5018] Check group and dataId in groupKey.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5114] ConcurrentHashSet.java is not compatible with jdk1.6 or 1.7.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5253] Fix missing auth identity header error.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5291] Fix Beat task will stop when throw unexpected exception.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5301] Respond all kinds of collections for istio&#x27;s request.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5351] Fix Consistence status can&#x27;t switch to UP after Jraft election.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5390] Fix ip verify error.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5427] Fix NPE if Jraft leader is null in CurcuitFilter.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5437] Fix config beta feature will lost dump event problem.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5451] Fix the tag can&#x27;t be removed problem.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4822][#4823][#4824][#4825][#4979][#5506] Fix dependency security problem.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5277] Subscriber list servername add required.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#5380][#5418] Add and enhance unit test.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="社区">社区<a href="#社区" class="hash-link" aria-label="社区的直接链接" title="社区的直接链接">​</a></h2><p>随着Nacos 2.0.1及1.4.2的发布， Nacos社区又新增了一位Committer：haoyann，这位同学在推进多数据源支持、鉴权及安全性、配置模块优化与完善等内容中作出许多贡献，并积极参与社区讨论。</p><p><img loading="lazy" alt="haoyann_commiter.jpg" src="/zh-cn/assets/images/haoyann_commiter-f24a2de2a7868f5423a554fc13a36ad9.jpg" width="4032" height="3024" class="img_ev3q"></p><p>Nacos社区欢迎更多愿意参与共建的小伙伴加入，包括但不限于：</p><ul><li>源代码</li><li>文档</li><li>社区讨论</li><li>多语言实现</li><li>周边生态产品结合</li></ul><p>积极参与将可以获得Nacos社区赠送的精美小礼品～</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="about-nacos">About Nacos<a href="#about-nacos" class="hash-link" aria-label="About Nacos的直接链接" title="About Nacos的直接链接">​</a></h2><p>Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。</p><p>Nacos 帮助您更敏捷和容易地构建、交付和管理微服务平台。 Nacos 是构建以“服务”为中心的现代应用架构 (例如微服务范式、云原生范式) 的服务基础设施。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/1.4.0-release">双十一购物节，Nacos 1.4.0 + Go SDK 1.0.1发布</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-11-02T00:00:00.000Z" itemprop="datePublished">2020年11月2日</time> · <!-- -->阅读需 7 分钟</div></header><div class="markdown" itemprop="articleBody"><p>一年一度的双十一购物节又来了，不知道小伙伴们有没有抢到想要的商品呢？
无论您是否“剁手”成功，Nacos都为社区的各位奉上礼物庆祝双十一 -- <code>Nacos 1.4.0</code>和<code>nacos-sdk-go 1.0.1</code>正式发布。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-140">Nacos 1.4.0<a href="#nacos-140" class="hash-link" aria-label="Nacos 1.4.0的直接链接" title="Nacos 1.4.0的直接链接">​</a></h2><p>这个版本主要变更为：</p><ol><li>重构了naming模块的distro协议，并且下沉到了nacos-core模块。</li><li>使用了jraft对旧的自实现raft协议进行了替换，提高性能和raft语义的准确性。</li><li>对nacos所使用的http客户端进行了完全地统一，并优化了一些http客户端的使用，减少了连接损耗，特别是CLOSE_WAIT连接的数量。</li><li>添加了一个单独修改服务元数据的BETA接口。</li><li>修复了一些旧版本的bug并优化了控制台使用。</li></ol><p>具体的变更列表如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[#1654] 修复内容高亮在配置详情页面无效的问题.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#2792] 记录操作时的用户信息当打开权限功能后。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#2835] 修复控制台不停loading如果没有该namespace的权限。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#2866] 修复客户端没有访问 /nacos/v1/ns/operator/metrics权限的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3117] 优化内部事件机制并下沉到nacos-common模块。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3192] 统一nacos服务端的http客户端使用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3315] nacos客户端支持https。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3397] 修复一些关于启动脚本的错误。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3384] 修复控制台关于raft信息显示不同步的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3500] 统一控制台中服务治理和配置管理的分页列表。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3509] 修复使用地址服务器模式获取nacos集群地址时无法获取nacos配置文件的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3518] 在绑定角色的时候用户列表改成下拉选中的模式。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3530] 在控制台的页面中添加刷新按钮来刷新列表。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3533] 修改客户端缓存目录配置。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3515][#3536][#3899] 升级依赖修复安全漏洞。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3528] 修复客户端会获取到无效的project.version。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3550] 修复服务端无法创建raft协议的持久化文件的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3560] 修改浏览器标签页上的nacos logo。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3566] 从nacos-config模块中下沉权限相关内容到nacos-auth模块。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3576] 给NamingMaintainService添加生命周期相关接口。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3592] 修复修复访问无权限的名称空间时的错误提示。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3628] 优化客户端更新不存在的订阅服务的频率。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3635] 在nacos-naming模块使用Jraft替换自研raft协议。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3651] 优化nacos服务端对http-client的使用以减少CLOSE_WAI连接的数量。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3661] 优化使用Jraft时更新raft group的更新逻辑。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3671] 移动部分工具类到nacos-common模块复用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3676] 修复还原块在“内容比较”页面中不起作用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3692] 重构nacos-naming模块中的Distro协议。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3687] 校验服务名格式为Group@@ServiceName。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3710] 修复发布服务会导致丢失元数据中带有特殊字符的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3781] 修复服务实例可能间歇性掉线的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3790] 修复客户端可能发生的配置乱码问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3815] 修复当客户端缓存存在中文时可能被截断的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3833] 修复新消息通知系统在没有订阅者的时候抛空指针异常的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3855] 在控制台查看配置详情页面里添加上版本改动的展示。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3904] 支持单独修改服务元数据内容的功能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3909] 修复nacos服务端无法配置域名的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#3973] 修复首次运行时，导入配置失败的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#4110] 修复扩容集群时raft协议服务更新新节点的问题。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-go-sdk-101">Nacos Go SDK 1.0.1<a href="#nacos-go-sdk-101" class="hash-link" aria-label="Nacos Go SDK 1.0.1的直接链接" title="Nacos Go SDK 1.0.1的直接链接">​</a></h2><p>这个版本主要是修复了一些旧版本的bug以及增加客户端对于https的支持等等。</p><p>详细的变更列表请查看 <a href="https://github.com/nacos-group/nacos-sdk-go/releases/tag/v1.0.1" target="_blank" rel="noopener noreferrer">https://github.com/nacos-group/nacos-sdk-go/releases/tag/v1.0.1</a>  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="社区">社区<a href="#社区" class="hash-link" aria-label="社区的直接链接" title="社区的直接链接">​</a></h2><p>随着Nacos 1.4.0的发布， Nacos社区又新增了两位Committer：Maijh97 和 wangweizZZ。
两位分别在统一http client使用，下沉auth模块，客户端的https功能，重构部分服务端线程池和修复bug等内容中作出许多贡献，并积极参与社区讨论。</p><p>Nacos社区欢迎更多愿意参与共建的小伙伴加入，包括但不限于：</p><ul><li>源代码</li><li>文档</li><li>社区讨论</li><li>多语言实现</li><li>周边生态产品结合</li></ul><p>积极参与将可以获得Nacos社区赠送的精美小礼品～</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="结尾">结尾<a href="#结尾" class="hash-link" aria-label="结尾的直接链接" title="结尾的直接链接">​</a></h2><p>Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。</p><p>Nacos 帮助您更敏捷和容易地构建、交付和管理微服务平台。 Nacos 是构建以“服务”为中心的现代应用架构 (例如微服务范式、云原生范式) 的服务基础设施。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/nacos-distro-mechanism">Nacos 的 Distro 一致性协议</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-09-14T00:00:00.000Z" itemprop="datePublished">2020年9月14日</time> · <!-- -->阅读需 18 分钟</div></header><div class="markdown" itemprop="articleBody"><p>转载且编辑自<a href="http://www.passjava.cn/#/13.SpringCloud%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90/07.Nacos%E9%85%8D%E7%BD%AE%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/03.Nacos%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E2%91%A1%EF%BC%9A%E6%8F%AD%E7%A7%98AP%E6%9E%B6%E6%9E%84%E2%80%94%E2%80%94Distro%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener noreferrer">Nacos 的 Distro 一致性协议</a></p><h1>Nacos 的 Distro 一致性协议</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><p>这次我们进入 Nacos 的一致性底层原理，还是先来一张架构图，让大家对 Nacos 的架构有个整体的映像，本篇会主要讲解<strong>一致性模块</strong>中的 <code>Distro</code> 协议。（本图参考的 Nacos 官方图）</p><p><img loading="lazy" alt="参考 Nacos 官方图" src="/zh-cn/assets/images/image-20220504113110811on9pa8-20220530200803828-7a42bd8a9d60dccf494e6cb6fee1cb84.png" width="1062" height="934" class="img_ev3q"></p><p><strong>上篇留了两个知识点</strong>：</p><ul><li>① 服务实例注册到 Nacos 节点后，通过 UDP 方式推送到所有服务实例。让其他服务实例感知到服务列表的变化。</li><li>② 如何复制数据到其他节点：当前 Nacos 节点开启 1s 的延迟任务，将数据同步给其他 Nacos 节点。（分区一致性）</li></ul><p>第 ② 个知识点就是 Nacos 自研的 <code>Distro</code> 一致性协议的核心功能。</p><p>首先这个 Distro 协议是针对集群环境的，比如下面这三个集群节点组成了一个集群。服务 A 和服务 B 会往这个集群进行注册。</p><p><img loading="lazy" alt="Nacos 集群节点" src="/zh-cn/assets/images/image-20220427211513114ErcXkf-20220530200808311-e8a87cdf083c9ca5a20ea5dc1b809f44.png" width="1366" height="582" class="img_ev3q"></p><p><img loading="lazy" alt="Nacos 集群环境" src="/zh-cn/assets/images/image-20220427220632378nCoaA5-d81bade52adad2094467c229419863f1.png" width="1058" height="940" class="img_ev3q"></p><p>我们知道 Nacos 它是支持两种分布式定理的：<code>CP</code>（分区一致性）和 <code>AP</code>（分区可用性） 的，而 AP 是通过 Nacos 自研的 <code>Distro</code> 协议来保证的，CP 是通过 Nacos 的 <code>JRaft</code> 协议来保证的。</p><p>因为注册中心作为系统中很重要的的一个服务，需要尽最大可能对外提供可用的服务，所以选择 AP 来保证服务的高可用，另外 Nacos 还采取了心跳机制来自动完成服务数据补偿的机制，所以说 Distro 协议是弱一致性的。</p><p>如果采用 CP 协议，则需要当前集群可用的节点数过半才能工作。</p><p>关于 CP 和 AP 的理论知识，可以参考这篇：<a href="https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&amp;mid=2451950422&amp;idx=1&amp;sn=7f86457acedbd0853cbcb7dc4377dd54&amp;chksm=8d1c32c9ba6bbbdfd3d8c698addfb13a02589409bdf6a03a777e9afc95249018293d9a9e0a3f&amp;token=203503668&amp;lang=zh_CN#rd" target="_blank" rel="noopener noreferrer">用太极拳讲分布式理论 CAP 和 BASE，真舒服！</a></p><blockquote><p>问题：Nacos 中哪些地方用到了 AP 和 CP？</p></blockquote><ul><li>针对<code>临时服务</code>实例，采用 <code>AP</code> 来保证注册中心的可用性，<code>Distro</code> 协议。</li><li>针对<code>持久化服务</code>实例，采用 <code>CP</code> 来保证各个节点的强一致性，<code>JRaft</code> 协议。（JRaft 是 Nacos 对 Raft 的一种改造）</li><li>针对<code>配置中心</code>，无 Database 作为存储的情况下，Nacos 节点之间的内存数据为了保持一致，采用 <code>CP</code>。Nacos 提供这种模式只是为了方便用户本机运行，降低对存储依赖，生产环境一般都是通过外置存储组件来保证数据一致性。</li><li>针对<code>配置中心</code>，有 Database 作为存储的情况下，Nacos 通过持久化后通知其他节点到数据库拉取数据来保证数据一致性，另外采用读写分离架构来保证高可用，所以这里我认为这里采用的 <code>AP</code>，欢迎探讨。</li><li>针对 <code>异地多活</code>，采用 <code>AP</code> 来保证高可用。</li></ul><p>弦外音：</p><p><strong>临时服务实例</strong>就是我们默认使用的 Nacos 注册中心模式，客户端注册后，客户端需要定时上报心跳进行服务实例续约。这个在注册的时候，可以通过传参设置是否是临时实例。</p><p><strong>持久化服务实例</strong>就是不需要上报心跳的，不会被自动摘除，除非手动移除实例，如果实例宕机了，Nacos 只会将这个客户端标记为不健康。</p><p>本篇会带着大家从源码角度来深入剖析下 Distro 协议。</p><p><strong>知识点预告：</strong></p><ul><li>① Distro 的设计思想和六大机制。</li><li>② Nacos 如何同步数据到其他节点。（异步复制机制，本篇重点讲解）</li><li>③ Nacos 如何保证所有节点的数据一致性。（定期检验；健康检查机制，下一篇重点讲解）</li><li>④ 新加入的 Nacos 节点，如何拉取数据。（新节点同步机制）</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一distro-的设计思想和六大机制">一、Distro 的设计思想和六大机制<a href="#一distro-的设计思想和六大机制" class="hash-link" aria-label="一、Distro 的设计思想和六大机制的直接链接" title="一、Distro 的设计思想和六大机制的直接链接">​</a></h2><p><code>Distro</code> 协议是 Nacos 对于<code>临时实例数据</code>开发的一致性协议。</p><p>Distro 协议是集 Gossip + Eureka 协议的优点并加以优化后出现的。</p><p>关于 Gossip 协议，可以看这篇：<a href="https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&amp;mid=2451951238&amp;idx=1&amp;sn=a0acccbdfed3d3ac9ee8ef4bb349b12b&amp;chksm=8d1c3719ba6bbe0fc42876088a0747d7ca68dbbe9d21a21b2c94ecfc62c3f42ae3710f8acb40&amp;token=203503668&amp;lang=zh_CN#rd" target="_blank" rel="noopener noreferrer">病毒入侵：全靠分布式 Gossip 协议</a></p><p><strong>Gossip 协议有什么坑？</strong>由于随机选取发送的节点，不可避免的存在消息重复发送给同一节点的情况，增加了网络的传输的压力，给消息节点带来额外的处理负载。</p><p><strong>Distro 协议的优化：</strong>每个节点负责一部分数据，然后将数据同步给其他节点，有效的降低了消息冗余的问题。</p><p>关于临时实例数据：临时数据其实是存储在<code>内存缓存</code>中的，并且在其他节点在启动时会进行全量数据同步，然后节点也会定期进行数据校验。</p><p>大家不要被这个协议吓到，其实就是阿里自己实现的一套同步逻辑。</p><p>AP 中的 P 代表网络分区，所以 Distro 在分布式集群环境下才能真正发挥其作用。它保证了在多个 Nacos 节点组成的 Nacos 集群环境中，当其中某个 Nacos 宕机后，整个集群还是能正常工作。</p><p><strong>Distro 的设计机制</strong>：</p><ul><li><strong>平等机制</strong>：Nacos 的每个节点是平等的，都可以处理写请求。（上一讲已经重点讲解了✅）</li><li><strong>异步复制机制</strong>：Nacos 把变更的数据异步复制到其他节点。(⭐️<strong>重点讲解</strong>)</li><li><strong>健康检查机制</strong>：每个节点只存了部分数据，定期检查客户端状态保持数据一致性。</li><li><strong>本地读机制</strong>： 每个节点独立处理读请求，及时从本地发出响应。</li><li><strong>新节点同步机制</strong>： Nacos 启动时，从其他节点同步数据。</li><li><strong>路由转发机制</strong>：客户端发送的写请求，如果属于自己则处理，否则路由转发给其他节点。（上一讲已经重点讲解了✅）</li></ul><p><img loading="lazy" alt="Distro 的设计机制" src="/zh-cn/assets/images/image-20220504220127510ZudbpC-91b0fe6e14c460869ef4fb1672c2ec45.png" width="994" height="786" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二异步复制机制写入数据后如何同步给其他节点">二、异步复制机制：写入数据后如何同步给其他节点<a href="#二异步复制机制写入数据后如何同步给其他节点" class="hash-link" aria-label="二、异步复制机制：写入数据后如何同步给其他节点的直接链接" title="二、异步复制机制：写入数据后如何同步给其他节点的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-核心入口">2.1 核心入口<a href="#21-核心入口" class="hash-link" aria-label="2.1 核心入口的直接链接" title="2.1 核心入口的直接链接">​</a></h3><p>核心源码路径：</p><div class="language-PYTHON codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-PYTHON codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/naming/consistency/ephemeral/distro/DistroConsistencyServiceImpl.java</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个类的名字就说明它是 Distro 一致性协议的接口实现类。</p><p>当注册请求交给 Nacos 节点来处理时，核心入口方法就是 put()，如下图所示：</p><p><img loading="lazy" src="/zh-cn/assets/images/image-20220427075804426upuierjz3uG9-43c1261a8fb73c744e3248310dbe30a0.png" width="1720" height="474" class="img_ev3q"></p><p>上一讲我们已经说过，这里面会做几件事：</p><p><img loading="lazy" alt="添加实例信息的流程" src="/zh-cn/assets/images/image-20220413164932907KHTvVMRZvHBS-1ea8de71447055276f1afbae22199828.png" width="1366" height="1360" class="img_ev3q"></p><ul><li>① 将实例信息存放到内存缓存 concurrentHashMap 里面。</li><li>② 添加一个任务到 BlockingQueue 里面，这个任务就是将最新的实例列表通过 UDP 的方式推送给所有客户端（服务实例），这样客户端就拿到了最新的服务实例列表，缓存到本地。</li><li>③ 开启 1s 的延迟任务，将数据通过给其他 Nacos 节点。</li></ul><p><strong>说明</strong>：第二件事是 Nacos 和 客户端如何保持数据一致性的，第三件事是 Nacos 集群间如何保持数据一致性的，因本篇重点讲解 Nacos 的 AP 原理，所以会针对第三件事来进行阐述。而第二件事，会在后续文章中重点讲解。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-sync-方法的参数说明">2.2 sync 方法的参数说明<a href="#22-sync-方法的参数说明" class="hash-link" aria-label="2.2 sync 方法的参数说明的直接链接" title="2.2 sync 方法的参数说明的直接链接">​</a></h3><p>首先我们来看下 distroProtocol.sync()，这个方法传了哪些参数：</p><ul><li>第一个参数 new DistroKey()，它里面传了 key 和一个常量。</li></ul><p>key：就是客户端的服务名，示例值如下：</p><div class="language-JAVA codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-JAVA codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">com.alibaba.nacos.naming.iplist.ephemeral.public##DEFAULT_GROUP@@nacos.naming.serviceName</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>INSTANCE_LIST_KEY_PREFIX：就是 com.alibaba.nacos.naming.iplist.</p><p>然后这两个参数组装成一个 DistroKey。</p><ul><li><p>第二个参数是同步数据的类型，这里为 change。</p></li><li><p>第三个参数是同步任务的延迟时间，1s。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-sync-的核心逻辑添加任务">2.3 sync 的核心逻辑：添加任务<a href="#23-sync-的核心逻辑添加任务" class="hash-link" aria-label="2.3 sync 的核心逻辑：添加任务的直接链接" title="2.3 sync 的核心逻辑：添加任务的直接链接">​</a></h3><p>先上一张原理图帮助大家理解，流程图如下所示。核心逻辑分为以下几步。</p><ul><li>遍历其他节点，拿到节点信息。</li><li>判断这个任务在 map 中是否存在，如果存在则合并这个 task。</li><li>如果不存在，则加到 map 中。</li><li>后台线程遍历这个 map，拿到任务。</li></ul><p><img loading="lazy" alt="添加任务到 map 中" src="/zh-cn/assets/images/image-202204282252571448WDN2R-42462ac8e943bbd5c4adb3091a4d92f5.png" width="1584" height="1220" class="img_ev3q"></p><p>代码时序图如下所示：</p><p><img loading="lazy" alt="sync 的核心代码时序图" src="/zh-cn/assets/images/image-20220428225403541nvJwU7-6dbafb24fb8221418e4861725f0c5a53.png" width="1794" height="1184" class="img_ev3q"></p><ul><li><p>第一个类 <code>DistroConsistencyServiceImpl</code> 把实例信息加入 map 中，后续通过 <code>UDP</code>方式推送给客户端。</p></li><li><p>第二个类 <code>DistroProtocol</code> 主要就是<strong>循环遍历</strong>其他节点。</p></li><li><p>第三个类 <code>NacosDelayTaskExecuteEngine</code> 是核心类，创建了一个同步的任务到 <code>ConcurrentHashMap</code> 中。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="24-sync-的核心逻辑后台线程异步复制数据">2.4 sync 的核心逻辑：后台线程异步复制数据<a href="#24-sync-的核心逻辑后台线程异步复制数据" class="hash-link" aria-label="2.4 sync 的核心逻辑：后台线程异步复制数据的直接链接" title="2.4 sync 的核心逻辑：后台线程异步复制数据的直接链接">​</a></h3><p>先说下哈，这个核心逻辑极其复杂，我们看的时候需要抓主线，知道其中几个关键点就可以了。</p><p>悟空在画代码逻辑图的时候，内心是崩溃的，Nacos 为什么写这么复杂啊！<strong>大家不用细看，看了也会懵😳，理解核心步骤就可以了。</strong>（图中有个小细节，我对不同的类进行了颜色区分）</p><p><strong>核心步骤</strong>：</p><ul><li><p>遍历其他节点，创建一个同步的任务，加到 map 中。</p></li><li><p>后台线程不断从 map 中拿到 task，然后移除这个 task。</p></li><li><p>把这个 task 加到一个队列里面。</p></li><li><p>有个 worker 专门从队列里面拿到 task 来执行。</p></li><li><p>这个 task 就是发送 http 请求给其他节点，请求参数中包含注册的实例信息（序列化后的二进制数据）。拼接的请求 url 地址为：</p><div class="language-PHP codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-PHP codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">http://192.168.0.101:8858/nacos/v1/ns/distro/datum</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p>Nacos 异步复制数据到其他节点的流程图如下：</p><p><img loading="lazy" alt="Nacos 异步复制数据到其他节点的流程图" src="/zh-cn/assets/images/image-20220428225545543RA3daf-14e118f236769a94e58ccbb0d578769f.png" width="1964" height="2088" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="25-其他节点如何处理同步请求">2.5 其他节点如何处理同步请求<a href="#25-其他节点如何处理同步请求" class="hash-link" aria-label="2.5 其他节点如何处理同步请求的直接链接" title="2.5 其他节点如何处理同步请求的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="251-如何存储注册信息">2.5.1 如何存储注册信息<a href="#251-如何存储注册信息" class="hash-link" aria-label="2.5.1 如何存储注册信息的直接链接" title="2.5.1 如何存储注册信息的直接链接">​</a></h4><p>处理同步请求的逻辑还是比较简单的，就是把注册信息存起来，然后同步到其他客户端。</p><p>注册信息会存放到一个 <code>datum</code> 中，然后 datum 放到一个 <code>dataStore</code> 中。datum 和 dataStore 的数据结构如下图所示：</p><ul><li><p>datum 包含 value、key、timestamp。value 就是注册的客户端信息（是一个 ArrayList）</p></li><li><p>datastore 是一个 ConcurrentHashMap，包含多个 datum。</p></li></ul><p><img loading="lazy" alt="存储注册信息的数据结构" src="/zh-cn/assets/images/image-20220503170049038UscWkk-cd55bbc171516c637ac9741f3abbadf8.png" width="956" height="1534" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="252-源码分析">2.5.2 源码分析<a href="#252-源码分析" class="hash-link" aria-label="2.5.2 源码分析的直接链接" title="2.5.2 源码分析的直接链接">​</a></h4><p>根据 2.4 讲到的请求的 URL：<code>/nacos/v1/ns/distro/datum</code>，处理这个请求的类为</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">com/alibaba/nacos/naming/controllers/DistroController.java</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>入口方法为 <code>onSyncDatum</code>，里面做的主要事情如下：</p><ul><li><p>① 把实例信息放入到一个 datum 内存中，然后又存放到 DataStore 的结构中，而 DataStore 的本质就是一个 <code>ConcurrentHashMap</code>。</p></li><li><p>② 将注册信息通过 UDP 的方式推送给客户端。</p></li></ul><p><img loading="lazy" alt="服务端处理注册请求的源码" src="/zh-cn/assets/images/image-2022050317065873827D1kB-e5efd3c2d32e81f01a9e6486b4138219.png" width="1052" height="752" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三定时同步如何保持数据一致性">三、定时同步：如何保持数据一致性<a href="#三定时同步如何保持数据一致性" class="hash-link" aria-label="三、定时同步：如何保持数据一致性的直接链接" title="三、定时同步：如何保持数据一致性的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-为什么需要定时同步">3.1 为什么需要定时同步<a href="#31-为什么需要定时同步" class="hash-link" aria-label="3.1 为什么需要定时同步的直接链接" title="3.1 为什么需要定时同步的直接链接">​</a></h3><p>在 Nacos 集群模式下，它作为一个完整的注册中心，必须具有高可用特性。</p><p>在集群模式下，客户端只需要和其中一个 Nacos 节点通信就可以了，但是每个节点其实是包含所有客户端信息的，这样做的好处是每个 Nacos 节点只需要负责自己的客户端就可以（分摊压力），而当客户端想要拉取全量注册表到本地时，从任意节点都可以读取到（数据一致性）。</p><p>那么 Nacos 集群之间是如何通过 Distro 协议来保持数据一致性的呢？ </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-定期检验元数据">3.2 定期检验元数据<a href="#32-定期检验元数据" class="hash-link" aria-label="3.2 定期检验元数据的直接链接" title="3.2 定期检验元数据的直接链接">​</a></h3><p>在版本 v1 中 ，采用的是定期检验元信息的方式。元信息就是当前节点包含的客户端信息的 md5 值。</p><p>检验的原理如下图所示：</p><p><img loading="lazy" src="/zh-cn/assets/images/image-20220504202844197LC6a4x-dbc8fc1cdaf183d6065d6ffcf866aecf.png" width="1840" height="916" class="img_ev3q"></p><blockquote><p>Nacos 各个节点会有一个心跳任务，定期向其他机器发送一次数据检验请求，在校验的过程中，当某个节点发现其他机器上的数据的元信息和本地数据的元信息不一致，则会发起一次全量拉取请求，将数据补齐。</p></blockquote><p>请求 URL:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">//</span><span class="token plain">其他 Nacos 节点的 IP</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nacos</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ns</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">distro</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">checksum?source </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 本机的IP地址</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">本机的端口号</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>参数：DistroData，内部包装的是一个Map&lt;服务名称，服务下实例的验证字符串 checksum&gt;</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-关于版本迭代的说明">3.3 关于版本迭代的说明<a href="#33-关于版本迭代的说明" class="hash-link" aria-label="3.3 关于版本迭代的说明的直接链接" title="3.3 关于版本迭代的说明的直接链接">​</a></h3><p>在版本  v2 中，定期校验数据已经不用了，采用的是<code>健康检查机制</code>，来和其他节点来保持数据的同步，由于涉及的内容还挺多，放到下一讲来专门讲解 Nacos 的健康检查机制：</p><ul><li>客户端与 Nacos 节点的健康检查机制。</li><li>集群模式下的健康检查机制。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四新节点同步机制如何保持数据一致性">四、新节点同步机制，如何保持数据一致性<a href="#四新节点同步机制如何保持数据一致性" class="hash-link" aria-label="四、新节点同步机制，如何保持数据一致性的直接链接" title="四、新节点同步机制，如何保持数据一致性的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-原理">4.1 原理<a href="#41-原理" class="hash-link" aria-label="4.1 原理的直接链接" title="4.1 原理的直接链接">​</a></h3><p>新加入的 Distro 节点会进行全量数据拉取，轮询所有的 Distro 节点，向其他节点发送请求拉取全量数据。</p><p>在全量拉取操作完成之后，每台机器上都维护了当前的所有注册上来的非持久化实例数据。（参考 Nacos 官方图）</p><p><img loading="lazy" src="/zh-cn/assets/images/image-202205042119409621211OU-75ae7efa76db5d7a0feec4b19eeee330.png" width="1578" height="486" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-源码分析">4.2 源码分析<a href="#42-源码分析" class="hash-link" aria-label="4.2 源码分析的直接链接" title="4.2 源码分析的直接链接">​</a></h3><p><code>DistroProtocol</code> 类的构造方法会启动一个同步任务，从其他 Nacos 节点全量拉取非持久化实例数据。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/nacos/core/distributed/distro/DistroProtocol.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    startDistroTask();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        startLoadTask();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/nacos/core/distributed/distro/task/load/DistroLoadDataTask.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loadAllDataSnapshotFromRemote();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="五本地读机制">五、本地读机制<a href="#五本地读机制" class="hash-link" aria-label="五、本地读机制的直接链接" title="五、本地读机制的直接链接">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-原理">5.1 原理<a href="#51-原理" class="hash-link" aria-label="5.1 原理的直接链接" title="5.1 原理的直接链接">​</a></h3><p>每个 Nacos 节点虽然只负责属于自己的客户端，但是每个节点都是包含有所有的客户端信息的，所以当客户端想要查询注册信息时，可以直接从请求的 Nacos 的节点拿到全量数据。（参考 Nacos 官方图）</p><p><img loading="lazy" alt="读操作的原理" src="/zh-cn/assets/images/image-20220504214633683iEtFAd-a40289cdd501202c27d7cc9ced941c8c.png" width="1704" height="728" class="img_ev3q"></p><p>这样设计的好处是保证了高可用（AP），分为两个方面：</p><ul><li>① 读操作都能进行及时的响应，不需要到其他节点拿数据。</li><li>② 当脑裂发生时，Nacos 的节点也能正常返回数据，即使数据可能不一致，当网络恢复时，通过健康检查机制或数据检验也能达到数据一致性。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="六总结">六、总结<a href="#六总结" class="hash-link" aria-label="六、总结的直接链接" title="六、总结的直接链接">​</a></h2><p>本篇通过原理图 + 源码的方式讲解了 Distro 协议的原理，其中又分为几个机制，而这几个机制共同保证了 Nacos 的 AP。</p><p>不足之处，本篇未针对源码的设计进行深入剖析，只是把主线捋出来了。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/csharp-0.5.0">Nacos-sdk-csharp 0.5.0正式发布，功能与Java版本对齐！</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-09-03T00:00:00.000Z" itemprop="datePublished">2020年9月3日</time> · <!-- -->阅读需 3 分钟</div></header><div class="markdown" itemprop="articleBody"><p>来自社区的 <a href="https://github.com/nacos-group/nacos-sdk-csharp" target="_blank" rel="noopener noreferrer">nacos-sdk-csharp</a> ，在阿里巴巴编程之夏的推动下，发布了新版本0.5.0。 至此，nacos-sdk-csharp将与nacos的Java-sdk拥有相同的能力。</p><p>感谢Aman，黄文清在此期间对nacos社区的贡献！！！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-sdk-csharp-050版本主要更新内容">nacos-sdk-csharp 0.5.0版本主要更新内容<a href="#nacos-sdk-csharp-050版本主要更新内容" class="hash-link" aria-label="nacos-sdk-csharp 0.5.0版本主要更新内容的直接链接" title="nacos-sdk-csharp 0.5.0版本主要更新内容的直接链接">​</a></h2><ol><li>修复开启认证时请求返回403</li><li>配置的failover方式从内存改成文件</li><li>修复设置负载均衡方式后不能正常返回可用服务地址</li><li>修复不能刷新accesstoken</li><li>支持Yaml和Ini的配置解析器</li><li>支持Naming的订阅和取消订阅</li><li>支持PreferredNetworks，可以让用户自己选择网络适配器</li><li>优化ASP.NET Core集成的小细节</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="近期预告">近期预告<a href="#近期预告" class="hash-link" aria-label="近期预告的直接链接" title="近期预告的直接链接">​</a></h2><p>Nacos社区和阿里巴巴编程之夏的成果远不止此，很快将会有cpp和python的新版本sdk发布哦。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何共建">如何共建<a href="#如何共建" class="hash-link" aria-label="如何共建的直接链接" title="如何共建的直接链接">​</a></h2><p>我们欢迎任何人积极参与Nacos社区。如果您在文档中发现拼写错误，在代码中发现错误，或想要新功能或想要提供建议，您可以<a href="https://github.com/alibaba/Nacos/issues/new" target="_blank" rel="noopener noreferrer">在GitHub上创建一个issues</a> 。</p><p>如果您想开始着手，可以选择github仓库中有以下标签的issues。</p><ul><li><a href="https://github.com/alibaba/nacos/labels/good%20first%20issue" target="_blank" rel="noopener noreferrer">good first issue</a> ：对于新手来说是非常好的入门issues。</li><li><a href="https://github.com/alibaba/nacos/labels/contribution%20%E6%AC%A2%E8%BF%8E" target="_blank" rel="noopener noreferrer">contribution welcome</a> ：非常需要解决的问题和非常重要的模块，但目前缺少贡献者，欢迎贡献者来贡献。</li></ul><p>除了以上的通用标签，还可以关注Nacos的多语言共建，目前我们已经支持各类主流语言：</p><ul><li><a href="https://github.com/nacos-group/nacos-sdk-csharp" target="_blank" rel="noopener noreferrer">csharp</a></li><li><a href="https://github.com/nacos-group/nacos-sdk-go" target="_blank" rel="noopener noreferrer">go</a></li><li><a href="https://github.com/nacos-group/nacos-sdk-cpp" target="_blank" rel="noopener noreferrer">cpp</a></li><li><a href="https://github.com/nacos-group/nacos-sdk-python" target="_blank" rel="noopener noreferrer">python</a></li><li><a href="https://github.com/nacos-group/nacos-sdk-nodejs" target="_blank" rel="noopener noreferrer">nodejs</a></li></ul><p>欢迎大家加入Nacos社区，贡献社区。用Apache的话说，<strong>“社区高于代码”!</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新人时刻---什么是nacos"><a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener noreferrer"></a>新人时刻 - &quot;什么是Nacos？&quot;<a href="#新人时刻---什么是nacos" class="hash-link" aria-label="新人时刻---什么是nacos的直接链接" title="新人时刻---什么是nacos的直接链接">​</a></h2><blockquote><p>还不知道什么是Nacos? 没关系，在github上star一下跟程序猿兄弟打个招呼吧!!</p></blockquote><p><a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener noreferrer">Nacos</a> 是阿里巴巴于2018年7月份新开源的项目，Nacos的主要愿景是期望通过提供易用的 <code>动态服务发现</code>、<code>服务配置管理</code>、<code>服务共享与管理</code> 的基础设施，帮助用户在云原生时代更好的构建、交付、管理自己的微服务平台。</p><p>github项目地址在 <a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener noreferrer">这里</a></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/nacos-2nd-anniversary">Nacos 两周年献礼，Nacos 1.3.2 + Go SDK 1.0.0发布</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-08-05T00:00:00.000Z" itemprop="datePublished">2020年8月5日</time> · <!-- -->阅读需 4 分钟</div></header><div class="markdown" itemprop="articleBody"><p>Nacos自2018年8月5日开源以来，在社区两年的共同努力之下，获得了13400+ stars，发布了30个版本，吸引了 125 位优秀贡献者，积累了上百家企业案例的成绩。在Nacos开源两周年之际，社区同时发布Nacos 1.3.2版本和Go SDK 的1.0.0版本，为Nacos庆生。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-132">Nacos 1.3.2<a href="#nacos-132" class="hash-link" aria-label="Nacos 1.3.2的直接链接" title="Nacos 1.3.2的直接链接">​</a></h2><p>Nacos 1.3.2版本在1.3.1的基础上，继续重构和优化内核功能，主要改进如下：</p><ol><li>重构并统一 nacos-client 中http客户端的内容，增加拓展性和可读性</li><li>回滚在 nacos-client 1.3.1对apache http的使用，以减少依赖冲突和不可控的日志输出</li><li>重构Nacos中的事件通知模块，提高性能和可读性</li><li>修复Nacos服务端在Windows环境下启动失败的问题</li><li>修复Nacos控制台的部分问题</li><li>修复部分文档的描述错误</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-go-sdk-100">Nacos Go SDK 1.0.0<a href="#nacos-go-sdk-100" class="hash-link" aria-label="Nacos Go SDK 1.0.0的直接链接" title="Nacos Go SDK 1.0.0的直接链接">​</a></h2><p>Nacos-sdk-go的v1.0.0版本主要的改进如下：</p><ol><li>支持一个连接监听多个配置</li><li>支持取消配置监听功能</li><li>日志功能重新实现，支持日志轮转和日志实现替换</li><li>提升了实例选择的性能</li><li>文档和示例的完善</li><li>Nacos与dubbo-go、sentinel-golang等go语言微服务生态集成</li></ol><p>随着Go SDK 1.0.0正式版的发布，意味着Nacos在支持所有主流开发语言上更进了一步。目前，社区已经有Java、Golang、Python、Nodejs的语言支持。C++和C#的SDK也通过编程之夏稳步推进中，相信很快就可以和大家见面。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="后期规划">后期规划<a href="#后期规划" class="hash-link" aria-label="后期规划的直接链接" title="后期规划的直接链接">​</a></h2><p>在新的一年中，Nacos将会继续成长、聚焦 Nacos 内核构建，打造一个更稳定、更安全、更高效的微服务引擎
目前核心规划是：</p><ul><li>下沉并统一一致性模型</li><li>下沉并优化鉴权模型</li><li>升级连接通道，提升交互效率</li><li>升级服务数据模型，提升服务端运行效率</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="致谢">致谢<a href="#致谢" class="hash-link" aria-label="致谢的直接链接" title="致谢的直接链接">​</a></h2><p>随着视频、直播及线上教育行业大规模发展，Nacos在 虎牙、爱奇艺、芒果、Zoom、掌门、KK直播 等高速发展的企业中落地，有此成就，离不开社区贡献者和用户们的共同努力。</p><p>在此，感谢所有参与社区共建，为Nacos提供代码，设计以及讨论的贡献者和用户。</p><p>同时欢迎更多的个人及企业，参与到Nacos的共建中，让Nacos变得更加高效、稳定。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="结尾">结尾<a href="#结尾" class="hash-link" aria-label="结尾的直接链接" title="结尾的直接链接">​</a></h2><p>Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。</p><p>Nacos 帮助您更敏捷和容易地构建、交付和管理微服务平台。 Nacos 是构建以“服务”为中心的现代应用架构 (例如微服务范式、云原生范式) 的服务基础设施。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/feeling-of-ASoC-2019">参与开源，Offer拿到手软 -- 来自一名2019阿里巴巴编程之夏同学的亲述</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-07-14T00:00:00.000Z" itemprop="datePublished">2020年7月14日</time> · <!-- -->阅读需 15 分钟</div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="---来自一名2019阿里巴巴编程之夏同学的亲述">-- 来自一名2019阿里巴巴编程之夏同学的亲述<a href="#---来自一名2019阿里巴巴编程之夏同学的亲述" class="hash-link" aria-label="-- 来自一名2019阿里巴巴编程之夏同学的亲述的直接链接" title="-- 来自一名2019阿里巴巴编程之夏同学的亲述的直接链接">​</a></h3><blockquote><p>作者：廖春涛</p></blockquote><p>作者简介：</p><ul><li>阿里巴巴 nacos 项目管理委员会成员</li><li>阿里巴巴 spring-cloud-alibaba 项目提交者</li><li>阿里巴巴 nacos-spring-project 项目维护者</li><li>阿里巴巴 nacos-springboot-project 项目维护者</li><li>spring-cloud/spring-cloud-sleuth 项目贡献者</li><li>阿里巴巴云原生日讲师</li><li>2019年第一季阿里巴巴编程之夏学员</li><li>2018年中国大学生服务外包大赛三等奖（国家级）</li><li>2017年大学生创新创业大赛校级立项</li><li>2017年杭州电子科技大学互联网+大赛二等奖</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="起源">起源<a href="#起源" class="hash-link" aria-label="起源的直接链接" title="起源的直接链接">​</a></h2><p>不知不觉大学四年时光就过去了，而我的毕业，不仅仅是作为一名普通应届毕业生，同时，也是作为一名开源项目的PMC。</p><p>与开源结缘是在大三上的时候，那时与同学承接了一个商业外包，需要使用一个WxJava的开源项目。在项目交接之后，我打算用golang重新翻译此项目，顺便去学习了一下。在学习过程中，我在发现了几个小问题的过程中，贡献了一个优化，由此算正式与开源结缘了。</p><p>真正完全参与开源，是从大三下开始。那个时候经常和学长去参与各种技术讲座，比如Apache Flink、Apache APISIX、Service Mesh、分布式DB、服务治理等等。在四月的一天，学长推给我了一个有关服务治理的开源项目社区群，而我正好打算从理论到实践，将所学真真切切应用在实际当中。从这一天开始，真真切切的开始投入到开源当中。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前进">前进<a href="#前进" class="hash-link" aria-label="前进的直接链接" title="前进的直接链接">​</a></h2><p>参与开源，其过程就好比RPG游戏一般，一路升级打怪。从最开始的在SDK侧新增简单的增删改查功能，到参与维护两个Spring生态组建的维护。这期间，我重新学习了Spring内部的原理。在此期间，我对于Spring的整个设计理解更近了一步，彼时我能够更加灵活地运用Spring提供的各种钩子去实现用户对于组件的需求。</p><p>期间比较自豪的事情是发现了spring-cloud-seluth的bug，提交PR并进行了fix。其实发现这个问题的过程是比较曲折，最开始是有用户反馈zipkin无法与服务治理中心进行整合，于是我带着疑问，通过资料查找和研究源码等路径，发现zipkin从某个版本开始，他们自己写了一个webserver，因此无法使用spring相关的能力将zipkin-server注册到服务治理中心，因此我进行了一个简单的测试，将注册时机进行了简单的调整。但是由于过于定制化，因此没有进行回馈（其实问题的根本原因倒不是这个），只是将方案告诉给有此问题的相关用户。后面再持续跟进此问题时，发现仍然有zipkin与服务治理中心存在整合问题，但是这次是客户端，因此进行长时间的问题跟踪调试，最终确定问题的原因，接着进行反馈，最终提交PR进行修复。这一次的经历，让我学习到解决问题不应该只会埋头谷歌或者百度，而是应该从问题本身出发，去跟踪、观察问题，并成功解决。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="突破">突破<a href="#突破" class="hash-link" aria-label="突破的直接链接" title="突破的直接链接">​</a></h2><p>有了一次的成功经验，我变得更加有信心了。后面，我从客户端转战服务端，真正切入服务治理中心的核心。而此时，我已经成为一名committer了。为了能够更好地参与项目，同时符合committer的身份，我重新开始学习项目的源码、设计，纠正了许多第一次看源码时出现的理解误区，对于某些功能模块代码的设计有了更深的理解。同时，将高可用思想穿插于源码中，令我后面参与实习时，参与项目改造时，能够有更多的思考。
成为committer之后，不知道是不是初生牛犊不怕虎，我接受了内核模块的重构以及去MySQL依赖这两个艰巨的任务。其内核重构设计了一致性协议层的抽象设计、寻址模式的统一、事件机制的统一。其中，最难的莫过于一致性协议层的抽象以及设计了。其实，我对于一致性协议了解的并不是很多，只是知道CAP、BASE理论而已。但即使如此，我在接过任务之后，就开始各种开源项目源码的探究，比如JRaft、Etcd、Memberlist、hashicorp/raft等等，同时下载了各类的电子PDF进行学习，为我后面的工作打下了一定的理论基础。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="探索">探索<a href="#探索" class="hash-link" aria-label="探索的直接链接" title="探索的直接链接">​</a></h2><p>待秋招以及实习结束之后，我正式开始了相关任务的工作，设计文档编写、基础理论支持、相关项目设计学习、代码编写，其实就是一个需求，从成立到最终产出的全过程，综合性挺强的。这个时候的代码设计不再是随心所欲了，将一个单机的关系型存储变为一个分布式强一致性的关系型存储，其必须保证数据的一致性、事务的ACID性质，需要结合大量的资料以及前人项目的设计进行参考，当时提出的思路方案就有四五种。其中，为了从数据库内部解决这个问题，我还去学习了apache derby的源码——了解到插入一条数据的流程是怎么样的以及其master-slave机制的实现。可以说，通过这些的前期准备以及与其他大佬们的交流，令我后面的代码编写变得更加游刃有余。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="感想">感想<a href="#感想" class="hash-link" aria-label="感想的直接链接" title="感想的直接链接">​</a></h2><p>对于应届生的我来说，参与开源项目并且成为committer，也算是我的一项优势吧，也正因如此，我在秋招的时候基本是面试一家，收获一家公司的offer，其中也不乏SP。</p><p>参与开源项目，是一个将理论付诸于生产实践的有效途径，它让你需要考虑各种因素，比如接口设计、新老版本的数据兼容、可扩展性、边界因素的思考等等，同时还会使得自己知识面的横向以及纵向的延伸；不仅如此，参与开源的过程中，你需要和世界不同的开发者进行思想的碰撞交流，有时候通过交流，能够使得自己对于自己的设计有更深的认识，发现设计上的不足，同时也锻炼了自己口述、文字的能力。</p><p>虽然自己没几天就要去某大厂工作了，但是还是希望自己能够保证工作质量同时深入学习工作方向内容的空闲时间，保持对开源参与的热情，从开源中学习，并将自己学习的知识回馈当中。</p><p>最后汇报一下今年阿里巴巴编程之夏的最新进展。经过 3 轮的严格筛选，本次阿里巴巴编程之夏共有 29 名同学突出重围，马上开始 coding 的夏天啦！献上部分同学“开学照”，唯有热爱，可抵岁月漫长，加油，同学们！</p><hr><h1>Nacos 团队招人啦~ 欢迎21年毕业同学加入阿里云，共建云原生！</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一招聘对象">一、招聘对象<a href="#一招聘对象" class="hash-link" aria-label="一、招聘对象的直接链接" title="一、招聘对象的直接链接">​</a></h2><p>2020年11月- 2021年10月毕业的应届毕业生</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二部门介绍">二、部门介绍<a href="#二部门介绍" class="hash-link" aria-label="二、部门介绍的直接链接" title="二、部门介绍的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="我们是谁">我们是谁？<a href="#我们是谁" class="hash-link" aria-label="我们是谁？的直接链接" title="我们是谁？的直接链接">​</a></h3><p>云原生致力于打造世界上最先进、稳定的云原生基础设施，是阿里云最核心的部门之一。
我们的目标是让云成为成本最低，效率最高，稳定性最强的应用运行环境。在这里，我们设计超大规模容器与调度系统，发挥出云的极致弹性能力；我们构建高性能微服务架构，提供云端应用的无限拓展的能力；我们打造标准易用的 PaaS 平台，让云上研发变得简单、可控。
在这里，你会参与到容器、Kubernetes、Service Mesh、Serverless 等最前沿的技术研发与探索中来；你也会与 CNCF TOC 和 SIG 联席主席， etcd 创始人、K8s Operator 创始人等组成的国内最顶尖的云原生技术团队一同工作。
在这里，你会参与到全球最顶级的开源项目（如 Kubernetes、Containerd、OAM、Apache Dubbo、Nacos、Arthas）研发工作中，一同拓展云技术的边界，既赋能阿里巴巴全球经济体，更服务全世界的开发者用户。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="团队大咖">团队大咖<a href="#团队大咖" class="hash-link" aria-label="团队大咖的直接链接" title="团队大咖的直接链接">​</a></h3><ul><li>丁宇（花名：叔同，研究员），云原生应用平台团队负责人。2010 年加入淘宝，9 次参与双 11 作战，阿里高可用架构、双 11 稳定性负责人，阿里容器、调度、集群管理、运维技术负责人，推动和参与了双 11 几代技术架构的演进和升级。</li><li>张瓅玶（花名：谷朴，研究员），负责集群资源管理和利用率优化。之前在 Google 基础设施事业群的集群管理部门工作了 5 年多，并领导了资源管理和优化调度团队，负责了 FlexBorg, Autoscaling 等多个产品。加入 Google 前在加州大学伯克利分校从事智能系统的研究工作，本科和博士毕业于清华大学。</li><li>易立（花名：微垣，资深技术专家），目前负责阿里云区块链服务和容器服务的研发工作。之前曾在IBM中国开发中心工作，担任资深技术专员；作为架构师和主要开发人员负责或参与了一系列在云计算、区块链、Web 2.0，SOA领域的产品研发和创新。本科和硕士毕业于北京大学。</li><li>李响（资深技术专家），基础软件开源方向战略负责人，CNCF 全球 9 位 TOC 之一。前 CoreOS 分布式项目主管，负责 Kubernetes、etcd 等分布式系统相关项目在 CoreOS 的开发工作，他的主要兴趣在于分布式一致协议、分布式存储、分布式系统调度等，开源项目 etcd 作者。</li><li>张磊（高级技术专家），Kubernetes项目资深成员和联合维护者，主要关注容器运行时接口(CRI)、调度、资源管理和基于虚拟化技术的容器运行时等特性，共同负责Kubernetes上游和阿里集团大型集群管理系统的工程工作，曾就职于微软研究院（MSR）和KataContainers团队。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三岗位要求">三、岗位要求<a href="#三岗位要求" class="hash-link" aria-label="三、岗位要求的直接链接" title="三、岗位要求的直接链接">​</a></h2><ul><li>本科及以上学历，计算机、数学、电子工程、通信等相关专业；</li><li>具备扎实的数据结构和计算机系统基础，精通一种开发语言；</li><li>对基础软件充满热情，具备较好的动手能力和技术热情，有成功的研究型或实战型项目技术成果落地者优先；</li><li>关注开源技术，有开源贡献者优先；</li><li>快速学习，不断突破技术瓶颈，乐于探索未知领域，随时准备好去面对新挑战；</li><li>良好的团队合作精神，能够做到严谨、皮实、乐观。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四开放职位">四、开放职位<a href="#四开放职位" class="hash-link" aria-label="四、开放职位的直接链接" title="四、开放职位的直接链接">​</a></h2><ul><li>Golang研发工程师</li><li>JAVA研发工程师</li><li>C/C++研发工程师</li><li>基础平台研发工程师</li><li>前端开发工程师</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五工作地点">五、工作地点<a href="#五工作地点" class="hash-link" aria-label="五、工作地点的直接链接" title="五、工作地点的直接链接">​</a></h2><p>杭州/北京/深圳</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="六投递渠道">六、投递渠道<a href="#六投递渠道" class="hash-link" aria-label="六、投递渠道的直接链接" title="六、投递渠道的直接链接">​</a></h2><p><a href="mailto:water.lyl@alibaba-inc.com" target="_blank" rel="noopener noreferrer">water.lyl@alibaba-inc.com</a></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/nacos 1.2.0 guide">Nacos 1.2.0权限控制介绍和使用</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-03-10T00:00:00.000Z" itemprop="datePublished">2020年3月10日</time> · <!-- -->阅读需 12 分钟</div></header><div class="markdown" itemprop="articleBody"><a name="bc2d5709"></a># Nacos权限控制设计方案<a name="If4qS"></a>## 方案背景 Nacos自开源依赖，权限控制一直需求比较强烈，这也反应了用户需求将Nacos部署到生产环境的需求。最新发布的Nacos 1.2.0版本已经支持了服务发现和配置管理的权限控制，保障用户安全上生产。本文主要介绍Nacos权限控制的设计方案和使用指南。<a name="YBdcs"></a>### 什么是权限控制？ 在分布式服务调用时，需要对未知的或者不受信任的请求来源的请求进行识别和拒绝。权限控制一般分为两个阶段：身份识别（Authentication）和权限识别（Authorization）。身份认证主要确定访问者的身份，权限识别则判断这个访问者是否有对应资源的权限。<p>在Nacos的场景中，配置管理的权限控制指的是设置某个配置能否被某个用户读写，这个比较好理解，没有权限的用户旧无法读取或者写入对应的配置。服务发现的权限控制指的是用户是否有权限进行某个服务的注册或者订阅，这里需要注意的是服务发现的权限控制只能够控制用户是否可以从Nacos获取到服务的地址或者在Nacos上修改服务的地址。但是如果已经获取到了服务的地址，Nacos无法在服务真正调用时进行权限控制，这个时候的权限控制需要由服务框架来完成。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2019/png/333810/1576216016307-2da56934-917f-46ec-b3eb-a221bc91a9e0.png#align=left&amp;display=inline&amp;height=240&amp;name=image.png&amp;originHeight=480&amp;originWidth=1904&amp;size=271408&amp;status=done&amp;style=none&amp;width=952#align=left&amp;display=inline&amp;height=480&amp;originHeight=480&amp;originWidth=1904&amp;status=done&amp;style=none&amp;width=1904" alt="image.png" class="img_ev3q"></p><a name="TvavD"></a>### 常见实现方式<a name="xDBnq"></a>#### 认证（Authentication）<ul><li>用户名+密码</li><li>Cookie（只适用于浏览器）</li><li>Session</li><li>Token（JWT，Oauth，LDAP，SAML，OpenID）</li><li>AK/SK<a name="vqrqi"></a></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="鉴权authorization">鉴权（Authorization）<a href="#鉴权authorization" class="hash-link" aria-label="鉴权（Authorization）的直接链接" title="鉴权（Authorization）的直接链接">​</a></h4><ul><li>ACL： 规定<strong>资源</strong>可以被哪些<strong>主体</strong>进行哪些操作；</li><li>DAC： 规定<strong>资源</strong>可以被哪些<strong>主体</strong>进行哪些操作 同时，<strong>主体</strong>可以将<strong>资源</strong>的权限，授予其他<strong>主体</strong>；</li><li>MAC：a. 规定<strong>资源</strong>可以被哪些类别的<strong>主体</strong>进行哪些<strong>操作</strong> b. 规定<strong>主体</strong>可以对哪些等级的<strong>资源</strong>进行哪些<strong>操作</strong> 当一个<strong>操作</strong>，同时满足a与b时，允许<strong>操作</strong>；</li><li>RBAC： a. 规定<strong>角色</strong>可以对哪些<strong>资源</strong>进行哪些<strong>操作</strong> b. 规定<strong>主体</strong>拥有哪些<strong>角色</strong>当一个操作，同时满足a与b时，允许<strong>操作</strong>；</li><li>ABAC： 规定哪些<strong>属性</strong>的<strong>主体</strong>可以对哪些<strong>属性</strong>的<strong>资源</strong>在哪些<strong>属性</strong>的情况下进行哪些<strong>操作</strong>。</li></ul><a name="liyG7"></a>## 方案详情 Nacos的权限控制，目标是能够满足用户基本的鉴权需求，同时能够保持扩展性，可以支持去对接用户自带的用户管理系统或者鉴权系统，包括后面和K8S生态以及Service Mesh生态能够无缝的融合。基于这样的考虑，目前Nacos权限控制的设计是自带一个基本的实现，然后可以支持用户扩展。具体的设计如下。<a name="H0kp9"></a>### 模块设计 整体的模块设计是尽量将鉴权的逻辑抽象出来，不在服务发现模块或者配置管理模块添加相关的逻辑。通过配置文件可以选择当前使用的鉴权系统。Nacos自带的认证系统使用JWT Token，自带的鉴权系统使用的是RBAC。<p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2019/png/333810/1576219027093-45345003-c583-46ec-a161-01b5f4b3ff47.png#align=left&amp;display=inline&amp;height=450&amp;name=image.png&amp;originHeight=900&amp;originWidth=1744&amp;size=699757&amp;status=done&amp;style=none&amp;width=872#align=left&amp;display=inline&amp;height=900&amp;originHeight=900&amp;originWidth=1744&amp;status=done&amp;style=none&amp;width=1744" alt="image.png" class="img_ev3q"></p><a name="jeLdT"></a>### 认证算法 对于用户来说，不管是在控制台还是在客户端，都是上传用户名和密码来获取一个token，然后后续的每一次到Nacos的请求都会带上这个token来表明身份。这个token会有一个失效时间，对于控制台来说，只需要直接提示用户重新登录即可，对于客户端则需要有一个定期到Nacos刷新token的逻辑。<p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2019/png/333810/1576219050917-51013ce2-49f3-4a86-b5f9-bd07fc88f8e8.png#align=left&amp;display=inline&amp;height=368&amp;name=image.png&amp;originHeight=736&amp;originWidth=1718&amp;size=575605&amp;status=done&amp;style=none&amp;width=859#align=left&amp;display=inline&amp;height=736&amp;originHeight=736&amp;originWidth=1718&amp;status=done&amp;style=none&amp;width=1718" alt="image.png" class="img_ev3q"></p><a name="vSB1T"></a>### 鉴权算法 Nacos自带的鉴权系统使用的是RBAC模型，可以在网上查询相关的资料。<a name="RZZGa"></a>#### 数据模型 鉴权的数据模型也是基于标准的RBAC来设计的，分为用户、角色和权限三部分。用户就是由用户名和密码组成的用户信息，角色则是一个逻辑上的用户组，Nacos启动时会自带一个全局管理员的角色，只有这个全局管理员的角色可以进行添加用户、添加角色、添加授权等操作，保证安全性。而权限则是由资源+动作来组成。<p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2019/png/333810/1576736418792-936a9d1a-5095-47fc-9f87-230abed38384.png#align=left&amp;display=inline&amp;height=451&amp;name=image.png&amp;originHeight=902&amp;originWidth=1834&amp;size=438246&amp;status=done&amp;style=none&amp;width=917#align=left&amp;display=inline&amp;height=902&amp;originHeight=902&amp;originWidth=1834&amp;status=done&amp;style=none&amp;width=1834" alt="image.png" class="img_ev3q"></p><a name="0bd4753c"></a>### 接口设计 以下接口涉及到登录和鉴权的所有逻辑，这些接口除了登录接口，其他接口都只能由全局管理员来调用。<a name="7d94de1c"></a>#### 用户管理<ul><li>创建用户：POST<br>
/nacos/v1/auth/users?username=xx&amp;password=yy</li><li>删除用户：DELETE /nacos/v1/auth/users?username=xx&amp;password=yy</li><li>更新用户：PUT /nacos/v1/auth/users?username=xx&amp;oldPassword=yy&amp;newPassword=zz</li><li>登录：POST<br>
/nacos/v1/auth/users/login?username=xxx&amp;password=yyy</li></ul><a name="3f856ec2"></a>#### 角色管理<ul><li>创建角色/绑定用户到角色：POST /nacos/v1/auth/roles?role=xx&amp;username=yy</li><li>删除某个用户的角色：DELETE /nacos/v1/auth/roles?role=xx&amp;username=yy</li><li>获取用户的所有角色：GET /nacos/v1/auth/roles?username=xxx</li></ul><a name="23bbdd59"></a>#### 权限管理<ul><li>给角色添加权限：POST /nacos/v1/auth/permissions?role=xxx&amp;resource=yyy&amp;action=zzz</li><li>从角色删除权限：DELETE /nacos/v1/auth/permissions?role=xxx&amp;resource=yyy&amp;action=zzz</li><li>获取某个角色的权限：GET /nacos/v1/auth/permissions?role=xxx</li></ul><a name="4Hil5"></a># Nacos权限控制实战<a name="TWc9w"></a>## 安装Nacos 1.2.0<ol><li>部署包准备。可以直接下载安装包：<a href="https://github.com/alibaba/nacos/releases/tag/1.2.0" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/nacos/releases/tag/1.2.0</a>，也可以将Nacos master分支clone下来进行源码编译：</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mvn -Prelease-nacos -Dmaven.test.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -U</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>安装包解压，然后使用distribution/nacos-mysql.sql进行数据库初始化，主要是新增了users, roles, permissions三张表，standalone模式使用distribution/schema.sql进行初始化。</li><li>Server端打开权限控制开关。修改con/application.properties内容：</li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.auth.enabled=</span><span class="token boolean" style="color:#36acaa">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个开关采用了热加载模式，无需重启Server即可生效。因此当权限控制功能使用有异常时，可以直接回滚到不鉴权的模式。</p><p><strong>注意：</strong> Nacos 1.2.0里登录和鉴权是绑定关系，而由于这个开关的默认值为false，因此默认启动时，是没有登录界面的，这点请读者注意。</p><a name="xBJZi"></a>## 使用权限控制<ol><li>使用管理员账号登录Nacos控制台（如果页面提示错误，可以清空浏览器缓存刷新页面）：</li></ol><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333810/1580890674563-4d235fd9-983c-4b03-b45c-b1e164152ac7.png#align=left&amp;display=inline&amp;height=470&amp;name=image.png&amp;originHeight=940&amp;originWidth=2870&amp;size=274455&amp;status=done&amp;style=none&amp;width=1435#align=left&amp;display=inline&amp;height=940&amp;originHeight=940&amp;originWidth=2870&amp;status=done&amp;style=none&amp;width=2870" alt="image.png" class="img_ev3q"></p><p>可以看到，左侧边栏增加了一个父菜单和三个子菜单，分别用于权限控制里的用户创建、角色创建以及权限管         理。这个菜单栏只会在管理员登录的时候显示，也就意味着只有管理员才能进行权限的管理和分配。</p><ol start="2"><li>管理用户。点击“用户列表”，进入用户管理页面，可以进行用户的创建、修改和删除：</li></ol><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333810/1580890674569-a729854e-a72d-4b3b-bc4c-53f9df831f3e.png#align=left&amp;display=inline&amp;height=573&amp;name=image.png&amp;originHeight=1146&amp;originWidth=2872&amp;size=349203&amp;status=done&amp;style=none&amp;width=1436#align=left&amp;display=inline&amp;height=1146&amp;originHeight=1146&amp;originWidth=2872&amp;status=done&amp;style=none&amp;width=2872" alt="image.png" class="img_ev3q"></p><ol start="3"><li>管理角色。因为Nacos的自带的权限是基于角色来进行分配的，因此需要给创建好的用户绑定一些角色：</li></ol><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333810/1580890674603-f69520a1-f53e-4eb7-9186-f2963e7b3d65.png#align=left&amp;display=inline&amp;height=545&amp;name=image.png&amp;originHeight=1090&amp;originWidth=2874&amp;size=346611&amp;status=done&amp;style=none&amp;width=1437#align=left&amp;display=inline&amp;height=1090&amp;originHeight=1090&amp;originWidth=2874&amp;status=done&amp;style=none&amp;width=2874" alt="image.png" class="img_ev3q"></p><ol start="4"><li>管理权限。角色创建好以后，就可以给这个角色赋予特定的权限了：</li></ol><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333810/1580890674580-e22945e1-be3a-46bd-b8f3-11b38eee0786.png#align=left&amp;display=inline&amp;height=581&amp;name=image.png&amp;originHeight=1162&amp;originWidth=2876&amp;size=368264&amp;status=done&amp;style=none&amp;width=1438#align=left&amp;display=inline&amp;height=1162&amp;originHeight=1162&amp;originWidth=2876&amp;status=done&amp;style=none&amp;width=2876" alt="image.png" class="img_ev3q"></p><p>在“添加资源”对话框里，可以选择绑定的角色，命名空间资源以及对应的动作类型，例如在上图中，我们给角色role1绑定命名空间test的读写权限。然后又因为刚刚我们是将user1绑定到了role1上，那么user1这个用户就可以对test这个命名空间的资源进行读写操作了。</p><ol start="5"><li>使用user1登录控制台。点击控制台右上角，退出admin账号，然后用刚才创建的user1进行登录：</li></ol><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333810/1580890674574-ca6eee1f-b749-4275-897d-ab9fba0ebf80.png#align=left&amp;display=inline&amp;height=449&amp;name=image.png&amp;originHeight=898&amp;originWidth=2874&amp;size=340563&amp;status=done&amp;style=none&amp;width=1437#align=left&amp;display=inline&amp;height=898&amp;originHeight=898&amp;originWidth=2874&amp;status=done&amp;style=none&amp;width=2874" alt="image.png" class="img_ev3q"></p><p>如上图所示，首先是左侧的权限管理菜单消失了，因为当前用户不是管理员。其次是会弹出一个鉴权失败的提示框。不用担心，这个提示框意思是user1没有public命名空间的读权限，所以会弹出，但是不影响我们将命名空间切换到test：<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333810/1580890674621-bc16b2ad-4a9e-4ebc-83e8-fa41f4a0cba4.png#align=left&amp;display=inline&amp;height=536&amp;name=image.png&amp;originHeight=1072&amp;originWidth=2876&amp;size=554716&amp;status=done&amp;style=none&amp;width=1438#align=left&amp;display=inline&amp;height=1072&amp;originHeight=1072&amp;originWidth=2876&amp;status=done&amp;style=none&amp;width=2876" alt="image.png" class="img_ev3q"></p><p>如上图所示，我们可以看到test命名空间的配置数据了，下面我们再来介绍客户端的使用。</p><ol start="6"><li>首先依赖最新的nacos 1.2.0客户端，然后在初始化时添加如下代码：</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Properties properties = new Properties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">properties.put(PropertyKeyConst.NAMESPACE, &quot;99a791cf-41c4-4535-9e93-b0141652bad0&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">properties.put(PropertyKeyConst.SERVER_ADDR, &quot;127.0.0.1:8848&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 配置用户名：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">properties.put(PropertyKeyConst.USERNAME, &quot;user1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 配置密码：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">properties.put(PropertyKeyConst.PASSWORD, &quot;pwd1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ConfigService iconfig = NacosFactory.createConfigService(properties);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="7"><li>使用客户端进行正常的读写配置操作。</li></ol><a name="8eF0X"></a># 我们在招人 阿里巴巴云原生基础技术中台是隶属于阿里云基础产品事业部的核心研发团队，致力于打造稳定、标准、先进的云原生应用基础平台，推动行业面向云原生技术升级与革命。在这里，你将与来自云计算、大数据领域的顶尖技术专家亲密合作，在全球独一无二的场景和规模中从事Kubernetes、Service Mesh、Serverless、Open Application Model（OAM）、Cloud Native Microservices、OpenMessaging、Event Streaming等云原生生态核心基础技术及Apache Dubbo、Apache RocketMQ、Nacos、Arthas等顶级开源项目的研发和落地工作。在标杆级的平台上，既服务阿里巴巴全球经济体，更服务全世界的开发者用户。目前在招聘技术专家岗位，详情可参考：[http://www.posterhr.com/html/CkgpBwD6f?from=timeline&amp;isappinstalled=0](http://www.posterhr.com/html/CkgpBwD6f?from=timeline&amp;isappinstalled=0)（可以直接投递，也可以将简历直接发送到dungu.zpf#alibaba-inc.com。#替换为@）</div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/nacos-1.3.0-design">Nacos 1.3.0 全新内核构建过程</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-02-12T00:00:00.000Z" itemprop="datePublished">2020年2月12日</time> · <!-- -->阅读需 35 分钟</div></header><div class="markdown" itemprop="articleBody"><a name="0YIG0"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概述">概述<a href="#概述" class="hash-link" aria-label="概述的直接链接" title="概述的直接链接">​</a></h2><p>本次1.3.0的改动程度很大，涉及两大模块的修改以及新增一个核心模块</p><ol><li>nacos-core模块修改<ol><li>nacos集群节点成员寻址模式的统一管理</li><li>nacos内部事件机制</li><li>nacos一致性协议层</li></ol></li><li>nacos-config模块修改<ol><li>新增内嵌分布式数据存储组件</li><li>内嵌存储与外置存储细分</li><li>内嵌存储简单运维</li></ol></li><li>nacos-consistency模块新增<ol><li>对于AP协议以及CP协议的统一抽象</li></ol></li></ol><br><a name="rnkDY"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="系统参数变化">系统参数变化<a href="#系统参数变化" class="hash-link" aria-label="系统参数变化的直接链接" title="系统参数变化的直接链接">​</a></h2><a name="1Gmg9"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="新增">新增<a href="#新增" class="hash-link" aria-label="新增的直接链接" title="新增的直接链接">​</a></h3><table><thead><tr><th align="center"><strong>core模块</strong></th><th>nacos.watch-file.max-dirs</th><th>JVM参数</th><th>最大可监听目录数量</th></tr></thead><tbody><tr><td align="center"></td><td>nacos.core.notify.ring-buffer-size</td><td>JVM参数</td><td>快速通知队列的最大长度</td></tr><tr><td align="center"></td><td>nacos.core.notify.share-buffer-size</td><td>JVM参数</td><td>慢速通知队列的最大长度</td></tr><tr><td align="center"></td><td>nacos.core.member.fail-access-cnt</td><td>JVM参数、application.properties配置</td><td>集群成员节点最大失败访问次数</td></tr><tr><td align="center"></td><td>nacos.core.address-server.retry</td><td>JVM参数、application.properties配置</td><td>地址服务器寻址模式，首次启动请求重试次数</td></tr></tbody></table><br><a name="kxo8O"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos的未来整体逻辑架构及其组件">Nacos的未来整体逻辑架构及其组件<a href="#nacos的未来整体逻辑架构及其组件" class="hash-link" aria-label="Nacos的未来整体逻辑架构及其组件的直接链接" title="Nacos的未来整体逻辑架构及其组件的直接链接">​</a></h2><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1587129046320-5a286f38-8db4-4e76-9b42-8bd859f51a60.png#align=left&amp;display=inline&amp;height=1184&amp;margin=%5Bobject%20Object%5D&amp;name=1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png&amp;originHeight=1184&amp;originWidth=1608&amp;size=279074&amp;status=done&amp;style=none&amp;width=1608" alt="1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png" class="img_ev3q"></p><a name="Hyc6u"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos集群成员节点寻址模式">Nacos集群成员节点寻址模式<a href="#nacos集群成员节点寻址模式" class="hash-link" aria-label="Nacos集群成员节点寻址模式的直接链接" title="Nacos集群成员节点寻址模式的直接链接">​</a></h2><br>在1.3.0之前，nacos的naming模块以及config模块存在各自的集群成员节点列表管理任务。为了统一nacos集群下成员列表的寻址模式，将集群节点管理的实现从naming模块以及config模块剥离出来，统一下沉到了core模块的寻址模，同时新增命令行参数 **-Dnacos.member.list **进行设置nacos集群节点列表，该参数可以看作是cluster.conf文件的一个替代。目前nacos的寻址模式类别如下<ol><li>单机模式下：StandaloneMemberLookup</li><li>集群模式<ol><li>cluster.conf文件存在：FileConfigMemberLookup</li><li>cluster.conf文件不存在或者 -Dnacos.member.list没有设置：AddressServerMemberLookup</li></ol></li></ol><p>如果说想指定某一种寻址模式，则设置此参数：<strong>nacos.core.member.lookup.type=<!-- -->[file,address-server]</strong></p><p>逻辑图如下
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/e209a677aa8b5ffce23589e987ee5129.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJMb29rdXBGYWN0b3J5LmluaXQoKVwiXG5cbmlmIFwic3RhbmRhbG9uZSBtb2RlXCIgdGhlblxuICAtLT5bdHJ1ZV0gXCJyZXR1cm4gU3RhbmRhbG9uZU1lbWJlckxvb2t1cFwiXG4gIC0tPiBMb29rdXAucnVuKClcbmVsc2VcbiBpZiBcImNsdXN0ZXIuY29uZiBleGlzdHNcIiB0aGVuXG4gICAgLS0-W3RydWVdIFwicmV0dXJuIEZpbGVDb25maWdNZW1iZXJMb29rdXBcIlxuICAgIC0tPiBMb29rdXAucnVuKClcbiBlbHNlXG4gICAgLT5bZmFsc2VdIFwicmV0dXJuIEFkZHJlc3NTZXJ2ZXJNZW1iZXJMb29rdXBcIlxuICAgIC0tPiBMb29rdXAucnVuKClcbiBlbmRpZlxuZW5kaWZcblxuLS0-ICgqKVxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJpZCI6IlplWGtkIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC9lMjA5YTY3N2FhOGI1ZmZjZTIzNTg5ZTk4N2VlNTEyOS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" class="img_ev3q"></p><a name="wqkMp"></a>### 寻址模式详细 接下来介绍除了单机模式下的寻址模式的其他两种寻址模式<br><a name="egl3H"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fileconfigmemberlookup">FileConfigMemberLookup<a href="#fileconfigmemberlookup" class="hash-link" aria-label="FileConfigMemberLookup的直接链接" title="FileConfigMemberLookup的直接链接">​</a></h4><p>该寻址模式是基于cluster.conf文件进行管理的，每个节点会读取各自${nacos.home}/conf下的cluster.conf文件内的成员节点列表，然后组成一个集群。并且在首次读取完${nacos.home}/conf下的cluster.conf文件后，会自动向操作系统的<em><strong>inotify</strong></em>机制注册一个目录监听器，监听${nacos.home}/conf目录下的所有文件变动（注意，这里只会监听文件，对于子目录下的文件变动无法监听）<br>当需要进行集群节点扩缩容时，需要手动去修改每个节点各自${nacos.home}/conf下的cluster.conf的成员节点列表内容。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private FileWatcher watcher = new FileWatcher() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void onChange(FileChangeEvent event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            readClusterConfFromDisk();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public boolean interest(String context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return StringUtils.contains(context, &quot;cluster.conf&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void start() throws NacosException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readClusterConfFromDisk();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (memberManager.getServerList().isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NacosException(NacosException.SERVER_ERROR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;Failed to initialize the member node, is empty&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Use the inotify mechanism to monitor file changes and automatically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // trigger the reading of cluster.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WatchFileCenter.registerWatcher(ApplicationUtils.getConfFilePath(), watcher);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Loggers.CLUSTER.error(&quot;An exception occurred in the launch file monitor : {}&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>首次启动时直接读取cluster.conf文件内的节点列表信息，然后向WatchFileCenter注册一个目录监听器，当cluster.conf文件发生变动时自动触发<em><strong>readClusterConfFromDisk()</strong></em>重新读取cluster.conf文件<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014354207-49c1e934-2aa5-465a-8a2b-0b09902814f8.png#align=left&amp;display=inline&amp;height=531&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=531&amp;originWidth=1169&amp;size=105696&amp;status=done&amp;style=none&amp;width=1169" alt="image.png" class="img_ev3q"></p><a name="yFTCl"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="addressservermemberlookup">AddressServerMemberLookup<a href="#addressservermemberlookup" class="hash-link" aria-label="AddressServerMemberLookup的直接链接" title="AddressServerMemberLookup的直接链接">​</a></h4><p>该寻址模式是基于一个额外的web服务器来管理cluster.conf，每个节点定期向该web服务器请求cluster.conf的文件内容，然后实现集群节点间的寻址，以及扩缩容。<br>当需要进行集群扩缩容时，只需要修改cluster.conf文件即可，然后每个节点向地址服务器请求时会自动的得到最新的cluster.conf文件内容。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void start() throws NacosException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (start.compareAndSet(false, true)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.maxFailCount = Integer.parseInt(ApplicationUtils.getProperty(&quot;maxHealthCheckFailCount&quot;, &quot;12&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        initAddressSys();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void initAddressSys() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String envDomainName = System.getenv(&quot;address_server_domain&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isBlank(envDomainName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        domainName = System.getProperty(&quot;address.server.domain&quot;, &quot;jmenv.tbsite.net&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        domainName = envDomainName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String envAddressPort = System.getenv(&quot;address_server_port&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isBlank(envAddressPort)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addressPort = System.getProperty(&quot;address.server.port&quot;, &quot;8080&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addressPort = envAddressPort;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addressUrl = System.getProperty(&quot;address.server.url&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ApplicationUtils.getContextPath() + &quot;/&quot; + &quot;serverlist&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addressServerUrl = &quot;http://&quot; + domainName + &quot;:&quot; + addressPort + addressUrl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    envIdUrl = &quot;http://&quot; + domainName + &quot;:&quot; + addressPort + &quot;/env&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Loggers.CORE.info(&quot;ServerListService address-server port:&quot; + addressPort);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Loggers.CORE.info(&quot;ADDRESS_SERVER_URL:&quot; + addressServerUrl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SuppressWarnings(&quot;PMD.UndefineMagicConstantRule&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void run() throws NacosException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // With the address server, you need to perform a synchronous member node pull at startup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Repeat three times, successfully jump out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean success = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Throwable ex = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int maxRetry = ApplicationUtils.getProperty(&quot;nacos.core.address-server.retry&quot;, Integer.class, 5);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; maxRetry; i ++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            syncFromAddressUrl();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            success = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ex = e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Loggers.CLUSTER.error(&quot;[serverlist] exception, error : {}&quot;, ExceptionUtil.getAllExceptionMsg(ex));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!success) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NacosException(NacosException.SERVER_ERROR, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GlobalExecutor.scheduleByCommon(new AddressServerSyncTask(), 5_000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在初始化时，会主动去向地址服务器同步当前的集群成员列表信息，如果失败则进行重试，其最大重试次数可通过设置<em><strong>nacos.core.address-server.retry</strong></em>来控制，默认是5次，然后成功之后，将创建定时任务去向地址服务器同步集群成员节点信息<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014362972-004f5338-af0d-4d0d-b769-4f3d5118c08a.png#align=left&amp;display=inline&amp;height=846&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=846&amp;originWidth=1149&amp;size=188886&amp;status=done&amp;style=none&amp;width=1149" alt="image.png" class="img_ev3q"></p><a name="sgOTI"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="节点管理和寻址模式如何结合的">节点管理和寻址模式如何结合的<a href="#节点管理和寻址模式如何结合的" class="hash-link" aria-label="节点管理和寻址模式如何结合的的直接链接" title="节点管理和寻址模式如何结合的的直接链接">​</a></h3><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014400580-39b83aa0-c548-4241-a49e-0d72abda2a95.png#align=left&amp;display=inline&amp;height=715&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=715&amp;originWidth=1189&amp;size=131826&amp;status=done&amp;style=none&amp;width=1189" alt="image.png" class="img_ev3q"><br>MemberLookup在启动之后，会根据不同的寻址模式，执行寻址任务，将收集到集群节点列表信息，调用memberChange，触发集群节点变动，然后发布节点变更事件</p><a name="idHpC"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos一致性协议协议层抽象">Nacos一致性协议协议层抽象<a href="#nacos一致性协议协议层抽象" class="hash-link" aria-label="Nacos一致性协议协议层抽象的直接链接" title="Nacos一致性协议协议层抽象的直接链接">​</a></h2><p>从nacos的未来的整体架构图可以看出，一致性协议层将是作为nacos的最为核心的模块，将服务于构建在core模块之上的各个功能模块，或者服务与core模块本身。而一致性协议因为分区容错性的存在，需要在可用性与一致性之间做选择，因此就存在两大类一致性：最终一致性和强一致性。在nacos中，这两类一致性协议都是可能用到的，比如naming模块，对于服务实例的数据管理分别用到了AP以及CP，而对于config模块，将会涉及使用CP。同时还有如下几个功能需求点</p><ol><li>目前持久化服务使用用了变种版本的raft，并且业务和raft协议耦合，因此需要抽离解耦，同时是选择一个标准的Java版Raft实现</li><li>对于中小用户，配置基本其实不会超级多，独立一个mysql，相对重一些，需要一个轻量化的存储方案，并且支持2.0不依赖mysql和3.0依赖mysql可配置能力</li><li>由于CP或者AP，其存在多种实现，如何对一致性协议层做一次很好的抽象，以便将来可以快速的实现底层一致性协议具体实现的替换，比如Raft协议，目前nacos的选型是JRaft，不排除将来nacos会自己实现一个标准raft协议或者实现Paxos协议</li><li>由于Nacos存在多个独立工作的功能模块，每个功能模块之间不能出现影响，比如A模块处理请求过慢或者出现异常时，不能影响B模块的正常工作，即每个功能模块在使用一致性协议时，如何将每个模块的数据处理进行隔离？</li></ol><p>根据一致协议以及上述功能需求点，本次做了一个抽象的一致协议层以及相关的接口</p><a name="3w8xM"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="一致协议抽象">一致协议抽象<a href="#一致协议抽象" class="hash-link" aria-label="一致协议抽象的直接链接" title="一致协议抽象的直接链接">​</a></h3><a name="p7zRo"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="consistencyprotocol">ConsistencyProtocol<a href="#consistencyprotocol" class="hash-link" aria-label="ConsistencyProtocol的直接链接" title="ConsistencyProtocol的直接链接">​</a></h4><p>所谓一致性，即多个副本之间是否能够保持一致性的特性，而副本的本质就是数据，对数据的操作，不是获取就是修改。同时，一致协议其实是针对分布式情况的，而这必然涉及多个节点，因此，需要有相应的接口能够调整一致性协议的协同工作节点。如果我们要观察一致性协议运行的情况，该怎么办？比如Raft协议，我们希望得知当前集群中的Leader是谁，任期的情况，当前集群中的成员节点有谁？因此，还需要提供一个一致性协议元数据获取。<br>综上所述，ConsistencyProtcol的大致设计可以出来了</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface ConsistencyProtocol&lt;T extends Config, P extends LogProcessor&gt; extends CommandOperations {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Consistency protocol initialization: perform initialization operations based on the incoming Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 一致性协议初始化，根据 Config 实现类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param config {@link Config}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void init(T config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Add a log handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param processors {@link LogProcessor}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void addLogProcessors(Collection&lt;P&gt; processors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Copy of metadata information for this consensus protocol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 该一致性协议的元数据信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return metaData {@link ProtocolMetaData}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ProtocolMetaData protocolMetaData();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Obtain data according to the request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return data {@link Response}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Response getData(GetRequest request) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Get data asynchronously</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return data {@link CompletableFuture&lt;Response&gt;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CompletableFuture&lt;Response&gt; aGetData(GetRequest request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Data operation, returning submission results synchronously</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 同步数据提交，在 Datum 中已携带相应的数据操作信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data {@link Log}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return submit operation result {@link Response}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Response submit(Log data) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Data submission operation, returning submission results asynchronously</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 异步数据提交，在 Datum 中已携带相应的数据操作信息，返回一个Future，自行操作，提交发生的异常会在CompleteFuture中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data {@link Log}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return {@link CompletableFuture&lt;Response&gt;} submit result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception when submit throw Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CompletableFuture&lt;Response&gt; submitAsync(Log data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * New member list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 新的成员节点列表，一致性协议自行处理相应的成员节点是加入还是离开</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param addresses [ip:port, ip:port, ...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void memberChange(Set&lt;String&gt; addresses);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Consistency agreement service shut down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 一致性协议服务关闭</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而针对CP协议，由于存在Leader的概念，因此需要提供一个方法用于获取CP协议当前的Leader是谁</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface CPProtocol&lt;C extends Config&gt; extends ConsistencyProtocol&lt;C&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Returns whether this node is a leader node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param group business module info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return is leader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isLeader(String group) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="oJFpB"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="数据操作请求提交对象loggetrequest">数据操作请求提交对象：Log、GetRequest<a href="#数据操作请求提交对象loggetrequest" class="hash-link" aria-label="数据操作请求提交对象：Log、GetRequest的直接链接" title="数据操作请求提交对象：Log、GetRequest的直接链接">​</a></h4><p>上面说到，一致性协议其实是对于数据操作而言的，数据操作基本分为两大类：数据查询以及数据修改，同时还要满足不同功能模块之间的数据进行隔离。因此这里针对数据修改操作以及数据查询操作分别阐述。</p><ol><li>数据修改<ol><li>数据修改操作，一定要知道本次请求是属于哪一个功能模块的</li><li>数据修改操作，首先一定要知道这个数据的修改操作具体是哪一种修改操作，方便功能模块针对真正的数据修改操作进行相应的逻辑操作</li><li>数据修改操作，一定要知道修改的数据是什么，即请求体，为了使得一致性协议层更为通用，这里对于请求体的数据结构，选择了byte[]数组</li><li>数据的类型，由于我们将真正的数据序列化为了byte[]数组，为了能够正常序列化，我们可能还需要记录这个数据的类型是什么</li><li>本次请求的信息摘要或者标识信息</li><li>本次请求的额外信息，用于将来扩展需要传输的数据</li></ol></li></ol><p>综上，可以得出Log对象的设计如下</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">message Log {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 功能模块分组信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string group = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 摘要或者标识</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string key = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 具体请求数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes data = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string type = 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 更为具体的数据操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string operation = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 额外信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map&lt;string, string&gt; extendInfo = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>数据查询<ol><li>数据查询操作，一定要知道本次请求是由哪一个功能模块发起的</li><li>数据查询的条件是什么，为了兼容各种存储结构的数据查询操作，这里用byte[]进行存储</li><li>本次请求的额外信息，用于将来扩展需要传输的数据</li></ol></li></ol><p>综上，可以得出GetRequest对象的设计如下</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">message GetRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 功能模块分组信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string group = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 具体请求数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes data = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 额外信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map&lt;string, string&gt; extendInfo = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="vBig4"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="功能模块使用一致性协议logprocessor">功能模块使用一致性协议：LogProcessor<a href="#功能模块使用一致性协议logprocessor" class="hash-link" aria-label="功能模块使用一致性协议：LogProcessor的直接链接" title="功能模块使用一致性协议：LogProcessor的直接链接">​</a></h4><p>当数据操作通过一致性协议进行submit之后，每个节点需要去处理这个Log或者GetRequest对象，因此，我们需要抽象出一个Log、GetRequest对象的Processor，不同的功能模块通过实现该处理器，ConsistencyProtocol内部会根据Log、GetRequest的group属性，将Log、GetRequest对象路由到具体的Processor，当然，Processor也需要表明自己是属于哪一个功能模块的。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class LogProcessor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * get data by key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request request {@link GetRequest}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return target type data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract Response onRequest(GetRequest request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Process Submitted Log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param log {@link Log}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return {@link boolean}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract Response onApply(Log log);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Irremediable errors that need to trigger business price cuts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param error {@link Throwable}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onError(Throwable error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * In order for the state machine that handles the transaction to be able to route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * the Log to the correct LogProcessor, the LogProcessor needs to have an identity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return Business unique identification name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract String group();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>针对CP协议，比如Raft协议，存在快照的设计，因此我们需要针对CP协议单独扩展出一个方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class LogProcessor4CP extends LogProcessor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Discovery snapshot handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * It is up to LogProcessor to decide which SnapshotOperate should be loaded and saved by itself</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return {@link List &lt;SnapshotOperate&gt;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;SnapshotOperation&gt; loadSnapshotOperate() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Collections.emptyList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="zbsAE"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="综述">综述<a href="#综述" class="hash-link" aria-label="综述的直接链接" title="综述的直接链接">​</a></h4><p>从上面这几点可以看出来，ConsistencyProtocol是对上层功能模块暴露出来的使用接口，每个ConsistencyProtocol后面有具体的一致性协议实现的Backend，由于Backend无法很好的兼容nacos现有的架构设计，因此额外设计的LogProcessor就是为了解决这个问题。<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015048030-8a4bff4a-20ed-46dd-a7f7-98655b22946f.png#align=left&amp;display=inline&amp;height=591&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=591&amp;originWidth=886&amp;size=93327&amp;status=done&amp;style=none&amp;width=886" alt="image.png" class="img_ev3q"><br>同时，由于在一致性协议层内部的Backend中需要实现对不同业务模块的数据进行隔离处理，而这个一块逻辑由请求对象和LogProcessor的group属性来实现<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015155835-a897262e-8e57-409c-bf94-d57bf765c80b.png#align=left&amp;display=inline&amp;height=591&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=591&amp;originWidth=910&amp;size=118083&amp;status=done&amp;style=none&amp;width=910" alt="image.png" class="img_ev3q"></p><a name="C1yU6"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="一致性协议层工作流程">一致性协议层工作流程<a href="#一致性协议层工作流程" class="hash-link" aria-label="一致性协议层工作流程的直接链接" title="一致性协议层工作流程的直接链接">​</a></h3><p>我们可以通过一个时序图看看，一致性协议层的大致工作流程
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/30b7e270e7aef8bb63136aaffbe5bfbf.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbnBhcnRpY2lwYW50IFwiTWVtYmVyTWFuYWdlclwiIGFzIE5hY29zQ2x1c3RlclxucGFydGljaXBhbnQgXCJCdXNpbmVzc01vZHVsZVwiIGFzIEJpelxucGFydGljaXBhbnQgXCJDb25zaXN0ZW5jeVByb3RvY29sXCIgYXMgUHJvdG9jb2xcbnBhcnRpY2lwYW50IFwiQ0FQQmFja2VuZFwiIGFzIEJhY2tlbmRcbnBhcnRpY2lwYW50IFwiQ29uZmlnXCIgYXMgQ29uZmlnXG5wYXJ0aWNpcGFudCBcIkxvZ1Byb2Nlc3NvclwiIGFzIFByb2Nlc3NvclxucGFydGljaXBhbnQgXCJMb2dcIiBhcyBMb2dcblxuYWN0aXZhdGUgTmFjb3NDbHVzdGVyXG5OYWNvc0NsdXN0ZXIgLT4gTmFjb3NDbHVzdGVyOiBpbml0KCkg5Yid5aeL5YyWTmFjb3Ppm4bnvqRcblxuTmFjb3NDbHVzdGVyIC0-IENvbmZpZzog6I635Y-WQ29uZmln5a-56LGhXG5hY3RpdmF0ZSBDb25maWdcbkNvbmZpZyAtPiBDb25maWc6IOaUtumbhkxvZ1Byb2Nlc3NvcueahOS_oeaBr1xuQ29uZmlnIC0-IE5hY29zQ2x1c3RlclxuZGVhY3RpdmF0ZSBDb25maWdcblxuXG5OYWNvc0NsdXN0ZXIgLT4gUHJvdG9jb2w6IOiOt-WPluaJgOaciUNvbnNpc3RlbmN5UHJvdG9jb2zlrp7njrBcbmFjdGl2YXRlIFByb3RvY29sXG5cbk5hY29zQ2x1c3RlciAtPiBQcm90b2NvbDogaW5pdChDb25maWcpIOaWueazleaJp-ihjFxuXG5kZWFjdGl2YXRlIFByb3RvY29sXG5kZWFjdGl2YXRlIE5hY29zQ2x1c3RlclxuXG5cbkJpeiAtPiBMb2c6IOWIm-W7uuS4gOS4quS6i-WKoeWvueixoVxuYWN0aXZhdGUgQml6XG5hY3RpdmF0ZSBMb2dcblxuXG5Mb2cgLT4gTG9nOiDorr7nva5kYXRhXG5Mb2cgLT4gTG9nOiDorr7nva5rZXlcbkxvZyAtPiBMb2c6IOiuvue9rmNsYXNzTmFtZVxuTG9nIC0-IExvZzog6K6-572uZXh0ZW5kSW5mb1xuTG9nIC0-IEJpelxuZGVhY3RpdmF0ZSBMb2dcblxuQml6IC0-IFByb3RvY29sOiBzdWJtaXQoTG9nKSDosIPnlKjkuIDoh7TmgKfljY_orq7ov5vooYzkuovliqHmj5DkuqRcbmFjdGl2YXRlIFByb3RvY29sXG5cblByb3RvY29sIC0-IEJhY2tlbmQ6IOWGhemDqOS4gOiHtOaAp-WNj-iuruW3peS9nFxuYWN0aXZhdGUgQmFja2VuZFxuXG5CYWNrZW5kIC0-IFByb3RvY29sOiDov5Tlm57lt6XkvZzlpITnkIbnu5PmnpxcbmRlYWN0aXZhdGUgQmFja2VuZFxuXG5Qcm90b2NvbCAtPiBQcm9jZXNzb3I6IOWwhkxvZ-WIhuWPkeWIsOWvueW6lOeahFByb2Nlc3Nvcu-8jOiwg-eUqCBvbkFwcGx5IOaWueazlVxuYWN0aXZhdGUgUHJvdG9jb2xcbmRlYWN0aXZhdGUgUHJvdG9jb2xcblxuUHJvY2Vzc29yIC0-IEJpejog5LqL5Yqh5o-Q5Lqk57uT5p6cXG5cbmRlYWN0aXZhdGUgUHJvY2Vzc29yXG5kZWFjdGl2YXRlIEJpelxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiNFZpMkwiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzMwYjdlMjcwZTdhZWY4YmI2MzEzNmFhZmZiZTViZmJmLnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=" class="img_ev3q"></p><a name="xtBNU"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nacos一致性协议层之cp协议的实现选择jraft">Nacos一致性协议层之CP协议的实现选择——JRaft<a href="#nacos一致性协议层之cp协议的实现选择jraft" class="hash-link" aria-label="Nacos一致性协议层之CP协议的实现选择——JRaft的直接链接" title="Nacos一致性协议层之CP协议的实现选择——JRaft的直接链接">​</a></h3><p>一致性协议层抽象好之后，剩下就是具体一致性协议实现的选择了，这里我们选择了蚂蚁金服开源的JRaft，那么我们如何将JRaft作为CP协议的一个Backend呢？下面的简单流程图描述了当JRaft作为CP协议的一个Backend时的初始化流程</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * A concrete implementation of CP protocol: JRaft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;pre&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                                           ┌──────────────────────┐               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                                           │                      │               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *            ┌──────────────────────┐       │                      ▼               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *            │   ProtocolManager    │       │        ┌───────────────────────────┐ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *            └──────────────────────┘       │        │for p in [LogProcessor4CP] │ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │        └───────────────────────────┘ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │                      │               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      ┌──────────────────────────────────┐ │                      ▼               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      │    discovery LogProcessor4CP     │ │             ┌─────────────────┐      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      └──────────────────────────────────┘ │             │  get p.group()  │      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │             └─────────────────┘      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │                      │               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                 ┌─────────────┐           │                      │               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                 │ RaftConfig  │           │                      ▼               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                 └─────────────┘           │      ┌──────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │      │  create raft group service   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │      └──────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *              ┌──────────────────┐         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *              │  JRaftProtocol   │         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *              └──────────────────┘         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                     init()                │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *               ┌─────────────────┐         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *               │   JRaftServer   │         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *               └─────────────────┘         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *             ┌────────────────────┐        │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *             │JRaftServer.start() │        │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *             └────────────────────┘        │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        └──────────────────┘                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;/pre&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author &lt;a href=&quot;mailto:liaochuntao@live.com&quot;&gt;liaochuntao&lt;/a&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>JRaftProtocol是当JRaft作为CP协议的Backend时的一个ConsistencyProtocol的具体实现，其内部有一个JRaftServer成员属性，JRaftServer分装了JRaft的各种API操作，比如数据操作的提交，数据的查询，成员节点的变更，Leader节点的查询等等。</p><p><em><strong>注意事项：JRaft运行期间产生的数据在${nacos.home}/data/protocol/raft文件目录下。不同的业务模块有不同的文件分组，如果当节点出现crash或者异常关闭时，清空该目录下的文件，重启节点即可</strong></em></p><p>由于JRaft实现了raft group的概念，因此，完全可以利用raft group的设计，为每个功能模块单独创建一个raft group。这里给出部分代码，该代码体现了如何将LogProcessor嵌入到状态机中并为每个LogPrcessor创建一个Raft Group</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">synchronized void createMultiRaftGroup(Collection&lt;LogProcessor4CP&gt; processors) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // There is no reason why the LogProcessor cannot be processed because of the synchronization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!this.isStarted) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.processors.addAll(processors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String parentPath = Paths</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .get(ApplicationUtils.getNacosHome(), &quot;data/protocol/raft&quot;).toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (LogProcessor4CP processor : processors) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String groupName = processor.group();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (multiRaftGroup.containsKey(groupName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new DuplicateRaftGroupException(groupName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Ensure that each Raft Group has its own configuration and NodeOptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Configuration configuration = conf.copy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NodeOptions copy = nodeOptions.copy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JRaftUtils.initDirectory(parentPath, groupName, copy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Here, the LogProcessor is passed into StateMachine, and when the StateMachine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // triggers onApply, the onApply of the LogProcessor is actually called</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NacosStateMachine machine = new NacosStateMachine(this, processor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        copy.setFsm(machine);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        copy.setInitialConf(configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Set snapshot interval, default 1800 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int doSnapshotInterval = ConvertUtils.toInt(raftConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getVal(RaftSysConstants.RAFT_SNAPSHOT_INTERVAL_SECS),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    RaftSysConstants.DEFAULT_RAFT_SNAPSHOT_INTERVAL_SECS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If the business module does not implement a snapshot processor, cancel the snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doSnapshotInterval = CollectionUtils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .isEmpty(processor.loadSnapshotOperate()) ? 0 : doSnapshotInterval;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        copy.setSnapshotIntervalSecs(doSnapshotInterval);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Loggers.RAFT.info(&quot;create raft group : {}&quot;, groupName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RaftGroupService raftGroupService = new RaftGroupService(groupName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    localPeerId, copy, rpcServer, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Because RpcServer has been started before, it is not allowed to start again here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Node node = raftGroupService.start(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        machine.setNode(node);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RouteTable.getInstance().updateConfiguration(groupName, configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RaftExecutor.executeByCommon(() -&gt; registerSelfToCluster(groupName, localPeerId, configuration));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Turn on the leader auto refresh for this group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Random random = new Random();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long period = nodeOptions.getElectionTimeoutMs() + random.nextInt(5 * 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RaftExecutor.scheduleRaftMemberRefreshJob(() -&gt; refreshRouteTable(groupName),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    nodeOptions.getElectionTimeoutMs(), period, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        multiRaftGroup.put(groupName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new RaftGroupTuple(node, processor, raftGroupService, machine));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="4czvB"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="疑问解答为什么要创建多个raft-group">疑问解答：为什么要创建多个raft group<a href="#疑问解答为什么要创建多个raft-group" class="hash-link" aria-label="疑问解答：为什么要创建多个raft group的直接链接" title="疑问解答：为什么要创建多个raft group的直接链接">​</a></h4><p>或许有的人会有疑问，既然之前已经设计出了LogProcessor，完全可以利用一个Raft Group，在状态机appl时，根据Log的group属性进行路由到不同的LogProcessor即可，每个功能模块就创建一个raft group，不是会消耗大量的资源吗？<br>正如之前所说，我们希望独立工作的模块之间相互不存在影响，比如A模块处理Log因为存在Block操作可能使得apply的速度缓慢，亦或者可能中途发生异常，对于Raft协议来说，当日志apply失败时，状态机将不能够继续向前推进，因为如果继续向前推进的话，由于上一步的apply失败，后面的所有apply都可能失败，将会导致这个节点的数据与其他节点的数据永远不一致。如果说我们将所有独立工作的模块，对于数据操作的请求处理放在同一个raft group，即一个状态机中，就不可避免的会出现上述所说的问题，某个模块在apply日志发生不可控的因素时，会影响其他模块的正常工作。</p><a name="2GyRw"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="jraft运维操作">JRaft运维操作<a href="#jraft运维操作" class="hash-link" aria-label="JRaft运维操作的直接链接" title="JRaft运维操作的直接链接">​</a></h3><p>为了使用者能够对JRaft进行相关简单的运维，比如Leader的切换，重置当前Raft集群成员，触发某个节点进行Snapshot操作等等，提供了一个简单的HTTP接口进行操作，并且该接口有一定的限制，即每次只会执行一条运维指令</p><p>1、切换某一个Raft Group的Leader节点</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;transferLeader&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port} or ip:{raft_port},ip:{raft_port},ip:{raft_port}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="Fs7VE"></a><p>2、重置某一个Raft Group的集群成员</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;resetRaftCluster&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port},ip:{raft_port},ip:{raft_port},ip:{raft_port}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意，该操作是一个高危操作，仅仅当Raft集群的 n/2 + 1节点crash之后无法满足过半投票的要求才可以使用该运维命令，用于快速让当前剩余的节点重组Raft集群，对外提供服务，但是这个操作很大程度会造成数据的丢失<br></p><a name="VfG5T"></a><p>3、触发某一个Raft Group执行快照操作</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;doSnapshot&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="m9LfI"></a><p>4、移除某一个Raft Group中的某一成员</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;removePeer&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="ev3MW"></a><p>5、批量移除某一个Raft Group中的多个成员</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;removePeers&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port},ip:{raft_port},ip:{raft_port},...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="GzMuP"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="jraft协议相关配置参数">JRaft协议相关配置参数<a href="#jraft协议相关配置参数" class="hash-link" aria-label="JRaft协议相关配置参数的直接链接" title="JRaft协议相关配置参数的直接链接">​</a></h3><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">### Sets the Raft cluster election timeout, default value is 5 second</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.election_timeout_ms=5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### Sets the amount of time the Raft snapshot will execute periodically, default is 30 minute</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.snapshot_interval_secs=30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### Requested retries, default value is 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.request_failoverRetries=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### raft internal worker threads</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.core_thread_num=8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### Number of threads required for raft business request processing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.cli_service_thread_num=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### raft linear read strategy, defaults to index</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.read_index_type=ReadOnlySafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### rpc request timeout, default 5 seconds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.rpc_request_timeout_ms=5000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="线性读参数解析">线性读参数解析<a href="#线性读参数解析" class="hash-link" aria-label="线性读参数解析的直接链接" title="线性读参数解析的直接链接">​</a></h4><ol><li><strong>ReadOnlySafe</strong><ol><li>该线性读模式，每次Follower进行读请求时，需要和Leader同步日志提交位点信息，而Leader，需要向过半的Follower发起证明自己是Leader的轻量的RPC请求，相当于一个Follower读，至少需要1 + （n/2）+ 1 次的RPC请求。</li></ol></li><li><strong>ReadOnlyLeaseBased</strong><ol><li>该线性读模式，每次Follower进行读请求时，Leader只需要判断自己的Leader租约是否过期了，如果没有过期，直接可以回复Follower自己是Leader，但是该机制对于机器时钟要求很严格，如果有做时钟同步的话，可以考虑使用该线性读模式。</li></ol></li></ol><a name="WiLDa"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos内嵌分布式id">Nacos内嵌分布式ID<a href="#nacos内嵌分布式id" class="hash-link" aria-label="Nacos内嵌分布式ID的直接链接" title="Nacos内嵌分布式ID的直接链接">​</a></h2><p>nacos内嵌的分布式ID为Snakeflower，dataCenterId默认为1，workerId的值计算方式如下</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">InetAddress address;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">try </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    address = InetAddress.getLocalHost();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> catch (final UnknownHostException e) </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new IllegalStateException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;Cannot get LocalHost InetAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> please check your network</span><span class="token tag" style="color:#00009f">!</span><span class="token plain">&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> ipAddressByteArray = address.getAddress();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">workerId = (((ipAddressByteArray</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ipAddressByteArray.length </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> &amp; 0B11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;&lt; Byte.SIZE) + (ipAddressByteArray</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ipAddressByteArray.length </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &amp; 0xFF));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果需要手动指定dataCenterId以及workerId，则在application.properties或者启动时添加命令行参数</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">### set the dataCenterID manually</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># nacos.core.snowflake.data-center=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### set the WorkerID manually</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># nacos.core.snowflake.worker-id=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="ZLp5w"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos内嵌的轻量的基于derby的分布式关系型存储">Nacos内嵌的轻量的基于Derby的分布式关系型存储<a href="#nacos内嵌的轻量的基于derby的分布式关系型存储" class="hash-link" aria-label="Nacos内嵌的轻量的基于Derby的分布式关系型存储的直接链接" title="Nacos内嵌的轻量的基于Derby的分布式关系型存储的直接链接">​</a></h2><a name="1B5KV"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h3><ol><li>如果配置文件数量较少，在集群模式下需要高可用数据库集群作为支撑的成本太大，期望有一个轻量的分布式关系型存储来解决</li><li>nacos内部一些元数据信息存储，比如用户信息，命名空间信息</li><li>思路来源：<a href="https://github.com/rqlite/rqlite" target="_blank" rel="noopener noreferrer">https://github.com/rqlite/rqlite</a></li></ol><a name="Du2qc"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="设计思路">设计思路<a href="#设计思路" class="hash-link" aria-label="设计思路的直接链接" title="设计思路的直接链接">​</a></h3><a name="NzxHa"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="目标">目标<a href="#目标" class="hash-link" aria-label="目标的直接链接" title="目标的直接链接">​</a></h4><p>设计目标，是期望nacos存在两种数据存储模式，一种是现在的方式，数据存储在外置数据源（关系型数据库）；第二种方式是内嵌存储数据源（Apache Derby）。用户能够使用命令行参数配置的方式，随意使用这两种数据存储模式<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015542106-f14d2579-229f-4bfb-a432-e40854e65d6d.png#align=left&amp;display=inline&amp;height=903&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=903&amp;originWidth=1514&amp;size=237497&amp;status=done&amp;style=none&amp;width=1514" alt="image.png" class="img_ev3q"></p><a name="LqUtU"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="总体">总体<a href="#总体" class="hash-link" aria-label="总体的直接链接" title="总体的直接链接">​</a></h4><p>将一次请求操作涉及的SQL上下文按顺序保存起来。然后通过一致协议层将本次请求涉及的SQL上下文进行同步，然后每个节点将其解析并重新按顺序在一次数据库会话中执行。<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1587204104465-2270480a-de25-4c84-a11b-6edd2de99e66.png#align=left&amp;display=inline&amp;height=814&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20%281%29.png&amp;originHeight=814&amp;originWidth=1149&amp;size=130886&amp;status=done&amp;style=none&amp;width=1149" alt="未命名文件 (1).png" class="img_ev3q"></p><a name="yxFYn"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="谁可以处理请求">谁可以处理请求<a href="#谁可以处理请求" class="hash-link" aria-label="谁可以处理请求的直接链接" title="谁可以处理请求的直接链接">​</a></h4><p>当使用者开启1.3.0的新特性——内嵌分布式关系型数据存储时，所有的写操作请求都将路由到Leader节点进行处理；但是，由于Raft状态机的特性，当某一个节点在apply数据库操作请求时发生非SQL逻辑错误引发的异常时，将导致状态机无法继续正常进行工作，此时将会触发配置管理模块的降级操作</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void registerSubscribe() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NotifyCenter.registerSubscribe(new SmartSubscribe() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void onEvent(Event event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (event instanceof RaftDBErrorRecoverEvent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                downgrading = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (event instanceof RaftDBErrorEvent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                downgrading = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public boolean canNotify(Event event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return (event instanceof RaftDBErrorEvent) || (event instanceof RaftDBErrorRecoverEvent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因此，综上所述，可以通过活动图来理解下，什么情况下需要将请求进行转发
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/db53c1ade61235d4c9659607b98ef7c6.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJGaWx0ZXIuZG9GaWx0ZXJcIlxuXG5pZiBcIuacrOiKgueCueaYr0xlYWRlclwiIHRoZW5cbiAgLWxlZnQtPlt0cnVlXSBcIuacrOiKgueCueWkhOeQhlwiXG4gIC0tPiAoKilcbmVsc2VcbiAgICBpZiBcIuezu-e7n-mZjee6p-W8gOWQr1wiIHRoZW5cbiAgICAgICAgLS0-W3RydWVdIFwi6L2s5Y-R57uZTGVhZGVyXCJcbiAgICAgICAgLS0-ICgqKVxuICAgIGVsc2VcbiAgICAgICAgaWYgXCLlhpnmk43kvZzor7fmsYJcIiB0aGVuXG4gICAgICAgICAgICAtLT5bdHJ1ZV0gXCLovazlj5Hnu5lMZWFkZXJcIlxuICAgICAgICAgICAgLS0-ICgqKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICAtLT5bZmFsc2VdIFwi5pys6IqC54K55aSE55CGXCJcbiAgICAgICAgZW5kaWZcbiAgICBlbmRpZlxuZW5kaWZcblxuQGVuZHVtbCIsInR5cGUiOiJwdW1sIiwibWFyZ2luIjp0cnVlLCJpZCI6IjFuWW9HIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC9kYjUzYzFhZGU2MTIzNWQ0Yzk2NTk2MDdiOThlZjdjNi5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" class="img_ev3q"></p><a name="g1buf"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="相关数据承载对象">相关数据承载对象<a href="#相关数据承载对象" class="hash-link" aria-label="相关数据承载对象的直接链接" title="相关数据承载对象的直接链接">​</a></h4><p>数据库的DML语句是select、insert、update、delete，根据SQL语句对于数据操作的性质，可以分为两大类：query以及update，select语句对应的是数据查询，insert、update、delete语句对应的是数据修改。同时在进行数据库操作时，为了避免SQL注入，使用的是PreparedStatement，因此需要SQL语句+参数，因此可以得到两个关于数据库操作的Request对象</p><ol><li>SelectRequest</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectRequest implements Serializable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final long serialVersionUID = 2212052574976898602L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 查询类别，因为目前使用的是JdbcTemplate，查询单个、查询多个，是否使用RowMapper转为对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private byte queryType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // sql语句</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // select * from config_info where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String sql;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Object[] args;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String className;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>ModifyRequest</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ModifyRequest implements Serializable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final long serialVersionUID = 4548851816596520564L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int executeNo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String sql;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Object[] args;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="moKl7"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="配置发布">配置发布<a href="#配置发布" class="hash-link" aria-label="配置发布的直接链接" title="配置发布的直接链接">​</a></h4><p>配置发布操作涉及三个事务：</p><ol><li>config_info保存配置信息</li><li>config_tags_relation保存配置与标签的关联关系</li><li>his_config_info保存一条配置操作历史记录</li></ol><p>这三个事务都在配置发布这个大事务下，如果说我们对每个事务操作进行一个Raft协议提交，假设1、2两个事务通过Raft提交后都成功Apply了，第三个事务在进行Raft提交后apply失败，那么对于这个配置发布的大事务来说，是需要整体回滚的，否则就会违反原子性，那么可能需要说将事务回滚操作又进行一次Raft提交，那么整体的复杂程度上升，并且直接引入了分布式事务的管理，因此为了避免这个问题，我们将这三个事务涉及的SQL上下文进行整合成一个大的SQL上下文，对这大的SQL上下文进行Raft协议提交。保证了三个子事务在同一次数据库会话当中，成功解决原子性的问题，同时由于Raft协议对于事务日志的处理是串行执行的，因此相当于将数据库的事务隔离级别调整为串行化。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void addConfigInfo(final String srcIp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String srcUser, final ConfigInfo configInfo, final Timestamp time,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Map&lt;String, Object&gt; configAdvanceInfo, final boolean notify) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String tenantTmp = StringUtils.isBlank(configInfo.getTenant()) ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StringUtils.EMPTY :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    configInfo.getTenant();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configInfo.setTenant(tenantTmp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 通过雪花ID算法获取数据库主键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long configId = idGeneratorManager.nextId(RESOURCE_CONFIG_INFO_ID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long hisId = idGeneratorManager.nextId(RESOURCE_CONFIG_HISTORY_ID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addConfigInfoAtomic(configId, srcIp, srcUser, configInfo, time,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    configAdvanceInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String configTags = configAdvanceInfo == null ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    null :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    (String) configAdvanceInfo.get(&quot;config_tags&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addConfigTagsRelation(configId, configTags, configInfo.getDataId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    configInfo.getGroup(), configInfo.getTenant());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        insertConfigHistoryAtomic(hisId, configInfo, srcIp, srcUser, time, &quot;I&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EmbeddedStorageContextUtils.onModifyConfigInfo(configInfo, srcIp, time);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        databaseOperate.blockUpdate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EmbeddedStorageContextUtils.cleanAllContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public long addConfigInfoAtomic(final long id, final String srcIp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String srcUser, final ConfigInfo configInfo, final Timestamp time,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, Object&gt; configAdvanceInfo) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 参数处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String sql =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;INSERT INTO config_info(id, data_id, group_id, tenant_id, app_name, content, md5, src_ip, src_user, gmt_create,&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        + &quot;gmt_modified, c_desc, c_use, effect, type, c_schema) VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Object[] args = new Object[] { id, configInfo.getDataId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                configInfo.getGroup(), tenantTmp, appNameTmp, configInfo.getContent(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                md5Tmp, srcIp, srcUser, time, time, desc, use, effect, type, schema, };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SqlContextUtils.addSqlContext(sql, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void addConfigTagRelationAtomic(long configId, String tagName, String dataId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String group, String tenant) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String sql =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;INSERT INTO config_tags_relation(id,tag_name,tag_type,data_id,group_id,tenant_id) &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        + &quot;VALUES(?,?,?,?,?,?)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Object[] args = new Object[] { configId, tagName, null, dataId, group,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tenant };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SqlContextUtils.addSqlContext(sql, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void insertConfigHistoryAtomic(long configHistoryId, ConfigInfo configInfo,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String srcIp, String srcUser, final Timestamp time, String ops) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 参数处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String sql =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;INSERT INTO his_config_info (id,data_id,group_id,tenant_id,app_name,content,md5,&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        + &quot;src_ip,src_user,gmt_modified,op_type) VALUES(?,?,?,?,?,?,?,?,?,?,?)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Object[] args = new Object[] { configHistoryId, configInfo.getDataId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                configInfo.getGroup(), tenantTmp, appNameTmp, configInfo.getContent(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                md5Tmp, srcIp, srcUser, time, ops };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SqlContextUtils.addSqlContext(sql, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Temporarily saves all insert, update, and delete statements under</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * a transaction in the order in which they occur</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author &lt;a href=&quot;mailto:liaochuntao@live.com&quot;&gt;liaochuntao&lt;/a&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SqlContextUtils {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ThreadLocal&lt;ArrayList&lt;ModifyRequest&gt;&gt; SQL_CONTEXT =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadLocal.withInitial(ArrayList::new);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void addSqlContext(String sql, Object... args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ArrayList&lt;ModifyRequest&gt; requests = SQL_CONTEXT.get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ModifyRequest context = new ModifyRequest();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setExecuteNo(requests.size());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setSql(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setArgs(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requests.add(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SQL_CONTEXT.set(requests);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static List&lt;ModifyRequest&gt; getCurrentSqlContext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return SQL_CONTEXT.get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void cleanCurrentSqlContext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SQL_CONTEXT.remove();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过一个时序图来更加直观的理解
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/618e8997395fbc74433ac4a60f67b6b4.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmF1dG9udW1iZXJcblxuYWN0b3IgXCJVc2VyXCIgYXMgVXNlclxuXG5wYXJ0aWNpcGFudCBcIkNvbmZpZ1NlcnZpY2VcIiBhcyBTZXJ2aWNlXG5wYXJ0aWNpcGFudCBcIlBlcnNpc3RlbmNlU2VydmljZVwiIGFzIFJlcG9zaXRvcnlcbnBhcnRpY2lwYW50IFwiRGVyYnlcIiBhcyBEQlxucGFydGljaXBhbnQgXCJTUUxDb250ZXh0VXRpbHNcIiBhcyBTUUxDb250ZXh0XG5wYXJ0aWNpcGFudCBcIkxvZ1Byb2Nlc3NvclwiIGFzIFByb2Nlc3NvclxucGFydGljaXBhbnQgXCJDb25zaXN0ZW5jeVByb3RvY29sXCIgYXMgUHJvdG9jb2xcbnBhcnRpY2lwYW50IFwiTG9nXCIgYXMgTG9nXG5cbmFjdGl2YXRlIFVzZXJcblxuVXNlciAtPiBTZXJ2aWNlOiDlj5HotbfphY3nva7lj5HluIPor7fmsYJcbmFjdGl2YXRlIFNlcnZpY2VcblxuU2VydmljZSAtPiBSZXBvc2l0b3J5OiDphY3nva7lj5HluINcbmFjdGl2YXRlIFJlcG9zaXRvcnlcblxuUmVwb3NpdG9yeSAtPiBTUUxDb250ZXh0OiDmi6bmiKrlvZPliY1TUUzkuIrkuIvmlodcbmFjdGl2YXRlIFNRTENvbnRleHRcblxuUmVwb3NpdG9yeSAtPiBSZXBvc2l0b3J5OiBjb21taXQg5pON5L2cXG5cblNRTENvbnRleHQgLT4gUmVwb3NpdG9yeTog5b2T5YmN6K-35rGC5raJ5Y-K55qE5omA5pyJU1FM5LiK5LiL5paHXG5cbmRlYWN0aXZhdGUgU1FMQ29udGV4dFxuXG5SZXBvc2l0b3J5IC0-IExvZzog5p6E5bu66K-35rGC5L2TXG5cbmFjdGl2YXRlIExvZ1xuZGVhY3RpdmF0ZSBMb2dcblxuUmVwb3NpdG9yeSAtPiBQcm90b2NvbDogc3VibWl0KCkg6L-b6KGM6K-35rGC5o-Q5LqkXG5hY3RpdmF0ZSBQcm90b2NvbFxuZGVhY3RpdmF0ZSBSZXBvc2l0b3J5XG5cblByb3RvY29sIC0-IFByb2Nlc3Nvcjogb25BcHBseSgpIOaWueazle-8jOeKtuaAgeacuuWkjeWItkxvZ1xuYWN0aXZhdGUgUHJvY2Vzc29yXG5cblByb2Nlc3NvciAtPiBSZXBvc2l0b3J5OiDmiafooYzmiYDmnInnmoRTUUzkuIrkuIvmlodcbmFjdGl2YXRlIFJlcG9zaXRvcnlcblxuUmVwb3NpdG9yeSAtPiBEQjog5pWw5o2u6JC95bqTXG5hY3RpdmF0ZSBEQlxuXG5EQiAtPiBSZXBvc2l0b3J5OiDnu5PmnZ_lubbov5Tlm57nu5PmnpxcbmRlYWN0aXZhdGUgREJcblxuUmVwb3NpdG9yeSAtPiBQcm9jZXNzb3I6IOi_lOWbnkxvZ0Z1dHVyZeW5tuiuvue9ruacrOasoeaJp-ihjOeahOe7k-aenFxuZGVhY3RpdmF0ZSBSZXBvc2l0b3J5XG5cblByb2Nlc3NvciAtPiBQcm90b2NvbDog6L-U5ZueTG9nRnV0dXJlXG5kZWFjdGl2YXRlIFByb2Nlc3NvclxuXG5Qcm90b2NvbCAtPiBTZXJ2aWNlOiDmnKzmrKHor7fmsYLnmoTnu5PmnpxcbmRlYWN0aXZhdGUgUHJvdG9jb2xcblxuU2VydmljZSAtPiBVc2VyXG5kZWFjdGl2YXRlIFNlcnZpY2VcbmRlYWN0aXZhdGUgVXNlclxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiVnQxNzciLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzYxOGU4OTk3Mzk1ZmJjNzQ0MzNhYzRhNjBmNjdiNmI0LnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=" class="img_ev3q"></p><a name="AAJTE"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何使用新特性">如何使用新特性<a href="#如何使用新特性" class="hash-link" aria-label="如何使用新特性的直接链接" title="如何使用新特性的直接链接">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./startup.sh -p embedded</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>是否启用内嵌的分布式关系型存储的活动图
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/1fd656ba3b39fe5de8fea78efdf98dd1.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJDb25maWcuc3RhcnQoKVwiXG5cbmlmIFwi5Y2V5py65qih5byPXCIgdGhlblxuICAtcmlnaHQtPlt0cnVlXSBcInJldHVybiDpu5jorqTljZXmnLrlrZjlgqjooYzkuLpcIlxuICAtLT4gKCopXG5lbHNlXG4gaWYgXCLlt7LphY3nva7lpJbnva7lrZjlgqhcIiB0aGVuXG4gICAgLS0-W3RydWVdIFwicmV0dXJuIOWklue9ruaVsOaNruWtmOWCqOihjOS4ulwiXG4gICAgLS0-ICgqKVxuIGVsc2VcbiAgICBpZiBcIuW8gOWQr-WGheW1jOWtmOWCqFwiIHRoZW5cbiAgICAgICAgLS0-W3RydWVdIFwicmV0dXJuIOi9u-mHj-WGheW1jOWIhuW4g-W8j-WtmOWCqOihjOS4ulwiXG4gICAgICAgIC0tPiAoKilcbiAgICBlbHNlXG4gICAgICAgIC0-W2ZhbHNlXSBcInJldHVybiDpu5jorqTlpJbnva7mlbDmja7lrZjlgqjooYzkuLpcIlxuICAgICAgICAtLT4gKCopXG5cdFx0ZW5kaWZcbiBlbmRpZlxuZW5kaWZcblxuQGVuZHVtbCIsInR5cGUiOiJwdW1sIiwibWFyZ2luIjp0cnVlLCJpZCI6IkNNN1VDIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC8xZmQ2NTZiYTNiMzlmZTVkZThmZWE3OGVmZGY5OGRkMS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" class="img_ev3q"></p><a name="9UAXN"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="新特性的相关运维操作">新特性的相关运维操作<a href="#新特性的相关运维操作" class="hash-link" aria-label="新特性的相关运维操作的直接链接" title="新特性的相关运维操作的直接链接">​</a></h3><p>直接查询每个节点的derby存储的数据</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GET /nacos/v1/cs/ops/derby?sql=select * from config_info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return List&lt;Map&lt;String, Object&gt;&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="YcqO2"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="不足">不足<a href="#不足" class="hash-link" aria-label="不足的直接链接" title="不足的直接链接">​</a></h3><ol><li>在数据库上层构建一层分布式数据操作同步层，对数据库的操作存在了限制，比如第一步insert操作，然后select操作，最后在update操作，这种在数据修改语句中穿插着查询语句的操作顺序是不支持的</li><li>限制了数据库的性能，由于间接的将数据库事务隔离级别调整为了串行化，人为的将并发能力降低了</li></ol><a name="7dul8"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="未来演进">未来演进<a href="#未来演进" class="hash-link" aria-label="未来演进的直接链接" title="未来演进的直接链接">​</a></h3><p>将于Apache Derby官方一起尝试基于Raft实现BingLog的同步复制操作，从底层实现数据库同步能力</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/namespace-endpoint-best-practices">Namespace,endpoint 最佳实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-12-06T00:00:00.000Z" itemprop="datePublished">2019年12月6日</time> · <!-- -->阅读需 10 分钟</div></header><div class="markdown" itemprop="articleBody"><p>随着使用 Nacos 的企业越来越多，遇到的最频繁的两个问题就是：如何在我的生产环境正确的来使用 namespace 以及 endpoint。这篇文章主要就是针对这两个问题来聊聊使用 nacos 过程中关于这两个参数配置的最佳实践方式。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="namespce">namespce<a href="#namespce" class="hash-link" aria-label="namespce的直接链接" title="namespce的直接链接">​</a></h2><p>关于 namespace ，以下主要从 <strong>namespace 的设计背景</strong> 和 <strong>namespace 的最佳实践</strong> 两个方面来讨论。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="namespace-的设计背景">namespace 的设计背景<a href="#namespace-的设计背景" class="hash-link" aria-label="namespace 的设计背景的直接链接" title="namespace 的设计背景的直接链接">​</a></h3><p>namespace 的设计是 nacos 基于此做多环境以及多租户数据(<strong>配置和服务</strong>)隔离的。即：</p><ul><li>从一个租户(用户)的角度来看，如果有多套不同的环境，那么这个时候可以根据指定的环境来创建不同的 namespce，以此来实现多环境的隔离。例如，你可能有日常，预发和生产三个不同的环境，那么使用一套 nacos 集群可以分别建以下三个不同的 namespace。如下图所示：</li></ul><p><img loading="lazy" src="http://edas.oss-cn-hangzhou.aliyuncs.com/deshao/pictures/nacos_ingle_tenant_namespace.jpg" class="img_ev3q"></p><ul><li>从多个租户(用户)的角度来看，每个租户(用户)可能会有自己的 namespace,每个租户(用户)的配置数据以及注册的服务数据都会归属到自己的 namespace 下，以此来实现多租户间的数据隔离。例如超级管理员分配了三个租户，分别为张三、李四和王五。分配好了之后，各租户用自己的账户名和密码登录后，创建自己的命名空间。如下图所示：</li></ul><p><img loading="lazy" src="http://edas.oss-cn-hangzhou.aliyuncs.com/deshao/pictures/nacos_multi_tenant_namespace.jpg" class="img_ev3q"></p><p>  <strong>注意:</strong> 该功能还在规划中。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="namespace-的最佳实践">namespace 的最佳实践<a href="#namespace-的最佳实践" class="hash-link" aria-label="namespace 的最佳实践的直接链接" title="namespace 的最佳实践的直接链接">​</a></h3><p>关于 namespace 的最佳实践，这部分主要包含有两个 Action：</p><ul><li>如何来获取 namespace 的值</li><li>namespace 参数初始化方式</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何来获取-namespace-的值">如何来获取 namespace 的值<a href="#如何来获取-namespace-的值" class="hash-link" aria-label="如何来获取 namespace 的值的直接链接" title="如何来获取 namespace 的值的直接链接">​</a></h3><p>无论您是基于 Spring Cloud 或者 Dubbo 来使用 nacos，都会涉及到 namespace 的参数输入，那么这个时候 namespace 的值从哪里可以获取呢？</p><ol><li><p>如果您在使用过程中没有感知到这个参数的输入，那么 nacos 统一会使用一个默认的 namespace 作为输入，nacos naming 会使用 <strong>public</strong> 作为默认的参数来初始化，nacos config 会使用一个<strong>空字符串</strong>作为默认的参数来初始化。</p></li><li><p>如果您需要自定义自己的 namespace，那么这个值该怎么来产生？</p><p>可以在 nacos 的控制台左边功能侧看到有一个 <strong>命名空间</strong> 的功能，点击就可以看到 <strong>新建命名空间</strong> 的按钮，那么这个时候就可以创建自己的命名空间了。创建成功之后，会生成一个<strong>命名空间ID</strong>，主要是用来避免<strong>命名空间名称</strong>有可能会出现重名的情况。因此当您在应用中需要配置指定的 namespace 时，<strong>填入的是命名空间ID</strong>。重要的事情说三遍：</p><ol><li>当您在应用中需要配置指定的 namespace 时，<strong>填入的是命名空间 ID</strong></li><li>当您在应用中需要配置指定的 namespace 时，<strong>填入的是命名空间 ID</strong></li><li>当您在应用中需要配置指定的 namespace 时，<strong>填入的是命名空间 ID</strong></li></ol></li></ol><p>说明: namesace 为 <strong>public</strong> 是 nacos 的一个保留控件，如果您需要创建自己的 namespace，最好不要和 <strong>public</strong> 重名，以一个实际业务场景有具体语义的名字来命名，以免带来字面上不容易区分自己是哪一个 namespace。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="namespace-参数初始化方式">namespace 参数初始化方式<a href="#namespace-参数初始化方式" class="hash-link" aria-label="namespace 参数初始化方式的直接链接" title="namespace 参数初始化方式的直接链接">​</a></h3><p>nacos client 对 namespace 的初始化流程如下图所示:</p><p><img loading="lazy" src="http://edas.oss-cn-hangzhou.aliyuncs.com/deshao/nacos/nacos_namespace.jpg" class="img_ev3q"></p><p>nacos client 对 namespace 的初始化，主要包含两部分：</p><ul><li><p>用户态通过 nacos client 构造实例时通过 properties 参数传入的 namespace。</p></li><li><p>在云环境下(<strong>阿里云下的 EDAS</strong>)的 namespace 参数解析。</p><p>可通过 <strong>-Dnacos.use.cloud.namespace.parsing=true/false</strong> 来控制是否需要在云环境自动解析 namespace 参数，默认为 <strong>true</strong>，是会自动解析，其目的就是方便用户上云时可以以零成本的方式平滑上云。如果用户在云上需要用自建的 nacos 下的 namespace，那这个时候只需将 <strong>-Dnacos.use.cloud.namespace.parsing=false</strong> 即可。</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="endpoint">endpoint<a href="#endpoint" class="hash-link" aria-label="endpoint的直接链接" title="endpoint的直接链接">​</a></h2><p>关于 endpoint ，也主要从 <strong>endpoint 的设计背景</strong> 和 <strong>endpoint 的参数初始化</strong> 两个方面来讨论。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="endpoint-的设计背景">endpoint 的设计背景<a href="#endpoint-的设计背景" class="hash-link" aria-label="endpoint 的设计背景的直接链接" title="endpoint 的设计背景的直接链接">​</a></h3><p>当 nacos server 集群需要扩缩容时，客户端需要有一种能力能够及时感知到集群发生变化。及时感知到集群的变化是通过 endpoint 来实现的。也即客户端会定时的向 endpoint 发送请求来更新客户端内存中的集群列表。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="endpoint-的参数初始化">endpoint 的参数初始化<a href="#endpoint-的参数初始化" class="hash-link" aria-label="endpoint 的参数初始化的直接链接" title="endpoint 的参数初始化的直接链接">​</a></h3><p>Nacos Client 提供一种可以对传入的 endpoint 参数规则解析的能力。即当通过构造函数的 <strong>properties</strong> 来初始化 endpoint 时，指定的 endpoint 值可以是一个具体的值，也可以是一个占位符的形式，如下所示: </p><blockquote><p><strong>\${endpoint.options:defaultValue}</strong>。</p></blockquote><p>说明：</p><ol><li><strong>endpoint.options</strong> 是一个具体的变量。支持从系统属性，系统环境变量中读取。</li><li><strong>defaultValue</strong> 是给出的一个默认值。当从具体的变量中没有被正确初始化时，会使用给出的默认值来初始化。</li></ol><p>整个 endpoint 的解析规则比较复杂，整体的一个解析流程图如下所示:</p><p><img loading="lazy" src="http://edas.oss-cn-hangzhou.aliyuncs.com/deshao/nacos/nacos_endpoint.jpg" class="img_ev3q">	</p><p><strong>注意：</strong> 蓝色特别区分的是支持云环境下(阿里云上的 EDAS)自动从系统环境变量中来读取 endpoint 值，以此来达到用户本地开发或者将应用往云上迁移的时候以零成本的改造方式实现平滑上云。</p><p>说明：</p><ul><li><p>开启 endpoint 参数规则解析</p><ol><li><p>如果在初始化 Nacos Client 的时候，没有通过 properties 来指定 endpoint，这个时候会从系统环境变量中变量名为 <strong>ALIBABA<!-- -->_<!-- -->ALIWARE<!-- -->_<!-- -->ENDPOINT<!-- -->_<!-- -->URL</strong> 指定的值来初始化，如果系统环境变量也没有设置，那么这个时候将会返回一个空字符串。</p></li><li><p>如果设置了 endpoint，</p></li><li><p>设置的 endpoint 是一个指定具体的值。</p><p>这时会先从系统环境变量中变量名为 <strong>ALIBABA<!-- -->_<!-- -->ALIWARE<!-- -->_<!-- -->ENDPOINT<!-- -->_<!-- -->URL</strong> 指定的值来初始化，如果系统环境变量没有设置，那么这个时候用用户态传入的具体值来初始化 endpoint。</p></li><li><p>以占位符的形式输入。</p><p>这时会解析出具体占位符的值，然后:</p><ol><li><p>依次从系统属性和环境变量中来取值。</p><p> 例如，您输入的是 <strong>${nacos.endpoint:defaultValue}</strong>，那么解析出来的占位符是 <strong>nacos.endpoint</strong>。解析出来后，会先读取系统属性中(<strong>即 System.getProperty(&quot;nacos.endpoint&quot;)</strong>)是否设置了 <strong>nacos.endpoint</strong> 变量值，如果没有，则会从系统环境变量中变量名为 <strong>nacos.endpoint</strong> 指定的值来初始化。</p></li><li><p>如果通过解析出来的占位符还没有正确初始化 endpoint，则会从系统环境变量中变量名为 <strong>ALIBABA<!-- -->_<!-- -->ALIWARE<!-- -->_<!-- -->ENDPOINT<!-- -->_<!-- -->URL</strong> 指定的值来初始化。</p></li><li><p>如果经过以上两步还没有被初始化，这时如果您设置了默认值，这个时候就会使用默认值来初始化 endpoint，否则的话以解析出来的占位符返回。	</p></li></ol></li></ol></li><li><p>关闭 endpoint 参数规则解析</p><p>当关闭了 endpoint 参数规则解析的时候，这个时候就以用户态在构造 Nacos Client 时通过 properties 参数输入的 endpoint 值为主。</p></li></ul><p>默认情况下， Nacos Client 是开启 endpoint 参数规则解析的能力。如果你想关闭该能力，有两种方式可以帮您来实现。</p><ol><li>可在 Nacos Client 初始化的时候在传入的 properties 实例中指定 key 为 <strong>isUseEndpointParsingRule</strong>，值为 <strong>false</strong> 即可关闭。</li><li>如果您的应用是 Java 程序的应用，也可以通过 <strong>-Dnacos.use.endpoint.parsing.rule=false</strong> 来关闭。 </li></ol><p><strong>注意</strong>：其中第一种方式的优先级高于第二种方式。</p></div></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/blog/page/2"><div class="pagination-nav__label">较新的博文</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/page/4"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div></div>
<script src="/zh-cn/assets/js/runtime~main.d42dcdce.js"></script>
<script src="/zh-cn/assets/js/main.e70e6d9a.js"></script>
</body>
</html>