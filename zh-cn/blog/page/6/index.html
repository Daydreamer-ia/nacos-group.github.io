<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Blog | Nacos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://nacos.io/zh-cn/img/nacos_colorful.png"><meta data-rh="true" name="twitter:image" content="https://nacos.io/zh-cn/img/nacos_colorful.png"><meta data-rh="true" property="og:url" content="https://nacos.io/zh-cn/blog/page/6"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="keywords" content="Nacos"><meta data-rh="true" property="og:title" content="Blog | Nacos"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"><link data-rh="true" rel="canonical" href="https://nacos.io/zh-cn/blog/page/6"><link data-rh="true" rel="alternate" href="https://nacos.io/en/blog/page/6" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://nacos.io/zh-cn/blog/page/6" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://nacos.io/blog/page/6" hreflang="default"><link data-rh="true" rel="alternate" href="https://nacos.io/blog/page/6" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Nacos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Nacos Atom Feed">




<link rel="stylesheet" href="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.js"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-YHS75WKFBR" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.45670f1e.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.ea169da3.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.b736ec48.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="/zh-cn/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh-cn/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/what-is-nacos" href="/zh-cn/docs/v2/what-is-nacos">2.X（推荐）</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-cn/docs/next/v2/what-is-nacos">用户文档</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v2/what-is-nacos">2.X（推荐）</a></li><li><a class="dropdown__link" href="/zh-cn/docs/1.X/v2/what-is-nacos">1.X</a></li></ul></div><a href="https://cn.aliyun.com/product/aliware/mse?spm=nacos-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">企业版NACOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://developer.aliyun.com/ebook/36?spm=a2c6h.20345107.ebook-index.18.152c2984fsi5ST" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">NACOS架构与原理<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a href="http://console.nacos.io/nacos/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/en/blog/page/6" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog/page/6" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/1.4.0-release">双十一购物节，Nacos 1.4.0 + Go SDK 1.0.1发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.0.1-release">Nacos 2.0.1 + 1.4.2 Release</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.0.3-release">Nacos 2.0.3版本发布，继续提升集群稳定性及升级稳定性</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.1.0-release">Nacos 2.1.0版本发布，支持鉴权及加解密插件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.1.1-release">Nacos 四周年，2.1.1 及 1.4.4 版本同时发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.2.0-release">Nacos 2.2.0 版本发布，新增多种插件支持</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.2.1-release">Nacos 多个新版本发布，rust-sdk完全适配完成</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.2.2-release">Nacos 2.2.2发布，优化启动体验和鉴权提示</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/212-and-220beta-release">Nacos 2.1.2、2.2.0-BETA及go-sdk 2.1.1 版本同时发布，多语言生态再添大将</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/5w1h-what">Nacos 帮我们解决什么问题？—— 配置管理篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/5w1h-where">Nacos 有哪些典型的应用场景？—— 配置管理篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/access control design">Nacos权限控制设计方案</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/address-server">Nacos环境隔离</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/alibaba-configserver">阿里巴巴服务注册中心产品ConfigServer 10年技术发展回顾</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/announcement-token-secret-key">关于Nacos默认token.secret.key及server.identity风险说明及解决方案公告</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/apisix">Apache APISIX 基于 Nacos 实现服务发现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/chengdu-dubbo">Nacos 计划发布v0.2版本，进一步融合Dubbo和SpringCloud生态</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/cmdb">Nacos打通CMDB实现就近访问</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/cncf">Nacos 进入CNCF landscape</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/consul-k8s">Consul与kubernetes整合公告[翻译]</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/csharp-0.5.0">Nacos-sdk-csharp 0.5.0正式发布，功能与Java版本对齐！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/discovery-console">Nacos服务发现控制台预览</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/dns-sd">微服务架构中基于DNS的服务注册与发现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/download">下载页</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/dynamic-route-zuul-nacos">使用Nacos实现Spring Cloud Zuul的动态路由</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/eureka2">Eureka 2.0 开源工作宣告停止？别担心，ANS 即将 C位强势出道！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/feeling-of-ASoC-2019">参与开源，Offer拿到手软 -- 来自一名2019阿里巴巴编程之夏同学的亲述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/huya-nacos">虎牙直播共建Nacos生态</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/huya-practice">虎牙直播在微服务改造方面的实践和总结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2021">Nacos 开源之夏2021活动 报名正式开启</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2022">Nacos开源之夏2022，贡献社区赢取12000奖金</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2023">Nacos开源之夏2023，贡献社区赢取12000奖金</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos 1.1.0">Nacos 1.1.0发布，支持灰度配置和地址服务器模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos 1.1.4">Nacos 1.1.4发布，业界率先支持Istio MCP协议</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos 1.2.0 guide">Nacos 1.2.0 权限控制介绍和使用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-1.3.0-design">Nacos 1.3.0 全新内核构建过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-2nd-anniversary">Nacos 两周年献礼，Nacos 1.3.2 + Go SDK 1.0.0发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-confd">nacos-confd</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-distro-mechanism">Nacos 的 Distro 一致性协议</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-is-coming">支持Dubbo生态发展，阿里巴巴启动新的开源项目 Nacos</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-reigster-mechanism">Nacos 的一条注册请求会经历什么？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-roadmap">Nacos Roadmap：Nacos GA后会有哪些大动作？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos">Nacos 0.1.0 版本Review 活动设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.5">Nacos0.5发布，支持DNS-based Service Discovery，JAVA 11</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.6">Nacos 0.6版本发布，支持Dubbo生态并且支持Docker部署</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.8">Nacos 0.8.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.9-intro">Nacos 0.9.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.9.0">Nacos 0.9.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos1.0.0">Nacos 发布 1.0.0 版本，可大规模投入到生产环境中</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos3.0-is-coming">我们总结了3大使用建议，并首次公开 Nacos3.0 规划图 | Nacos 开源4周年</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/namespace-endpoint-best-practices">Namespace,endpoint 最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/performance-compare">Nacos 2.0 升级前后性能对比压测</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/pilot mcp">Pilot MCP协议介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/springboot-0.2.10">Nacos-spring-boot0.2.10发布，全面支持Nacos2.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/up-to-2w-star">双十一献礼 | Nacos Star破两万的回顾与展望</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/use-nacos-with-rainbond">在 Rainbond 中一键安装高可用 Nacos 集群</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/xiaomi-scale">小米Nacos2.0扩缩容最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/higress">Higress + Nacos 微服务网关最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2021/08/01/mdx-blog-post">mdx-blog-post</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2019/05/29/long-blog-post">long-blog-post</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2019/05/28/first-blog-post">first-blog-post</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="随着使用 Nacos 的企业越来越多，遇到的最频繁的两个问题就是：如何在我的生产环境正确的来使用 namespace 以及 endpoint。"><meta itemprop="keywords" content="namespace,endpoint,最佳实践"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/namespace-endpoint-best-practices">Namespace,endpoint 最佳实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-10T08:15:08.000Z" itemprop="datePublished">2023年10月10日</time> · <!-- -->阅读需 10 分钟</div></header><div class="markdown" itemprop="articleBody"><p>随着使用 Nacos 的企业越来越多，遇到的最频繁的两个问题就是：如何在我的生产环境正确的来使用 namespace 以及 endpoint。这篇文章主要就是针对这两个问题来聊聊使用 nacos 过程中关于这两个参数配置的最佳实践方式。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="namespce">namespce<a href="#namespce" class="hash-link" aria-label="namespce的直接链接" title="namespce的直接链接">​</a></h2><p>关于 namespace ，以下主要从 <strong>namespace 的设计背景</strong> 和 <strong>namespace 的最佳实践</strong> 两个方面来讨论。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="namespace-的设计背景">namespace 的设计背景<a href="#namespace-的设计背景" class="hash-link" aria-label="namespace 的设计背景的直接链接" title="namespace 的设计背景的直接链接">​</a></h3><p>namespace 的设计是 nacos 基于此做多环境以及多租户数据(<strong>配置和服务</strong>)隔离的。即：</p><ul><li>从一个租户(用户)的角度来看，如果有多套不同的环境，那么这个时候可以根据指定的环境来创建不同的 namespce，以此来实现多环境的隔离。例如，你可能有日常，预发和生产三个不同的环境，那么使用一套 nacos 集群可以分别建以下三个不同的 namespace。如下图所示：</li></ul><p><img loading="lazy" src="http://edas.oss-cn-hangzhou.aliyuncs.com/deshao/pictures/nacos_ingle_tenant_namespace.jpg" class="img_ev3q"></p><ul><li>从多个租户(用户)的角度来看，每个租户(用户)可能会有自己的 namespace,每个租户(用户)的配置数据以及注册的服务数据都会归属到自己的 namespace 下，以此来实现多租户间的数据隔离。例如超级管理员分配了三个租户，分别为张三、李四和王五。分配好了之后，各租户用自己的账户名和密码登录后，创建自己的命名空间。如下图所示：</li></ul><p><img loading="lazy" src="http://edas.oss-cn-hangzhou.aliyuncs.com/deshao/pictures/nacos_multi_tenant_namespace.jpg" class="img_ev3q"></p><p>  <strong>注意:</strong> 该功能还在规划中。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="namespace-的最佳实践">namespace 的最佳实践<a href="#namespace-的最佳实践" class="hash-link" aria-label="namespace 的最佳实践的直接链接" title="namespace 的最佳实践的直接链接">​</a></h3><p>关于 namespace 的最佳实践，这部分主要包含有两个 Action：</p><ul><li>如何来获取 namespace 的值</li><li>namespace 参数初始化方式</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何来获取-namespace-的值">如何来获取 namespace 的值<a href="#如何来获取-namespace-的值" class="hash-link" aria-label="如何来获取 namespace 的值的直接链接" title="如何来获取 namespace 的值的直接链接">​</a></h3><p>无论您是基于 Spring Cloud 或者 Dubbo 来使用 nacos，都会涉及到 namespace 的参数输入，那么这个时候 namespace 的值从哪里可以获取呢？</p><ol><li><p>如果您在使用过程中没有感知到这个参数的输入，那么 nacos 统一会使用一个默认的 namespace 作为输入，nacos naming 会使用 <strong>public</strong> 作为默认的参数来初始化，nacos config 会使用一个<strong>空字符串</strong>作为默认的参数来初始化。</p></li><li><p>如果您需要自定义自己的 namespace，那么这个值该怎么来产生？</p><p>可以在 nacos 的控制台左边功能侧看到有一个 <strong>命名空间</strong> 的功能，点击就可以看到 <strong>新建命名空间</strong> 的按钮，那么这个时候就可以创建自己的命名空间了。创建成功之后，会生成一个<strong>命名空间ID</strong>，主要是用来避免<strong>命名空间名称</strong>有可能会出现重名的情况。因此当您在应用中需要配置指定的 namespace 时，<strong>填入的是命名空间ID</strong>。重要的事情说三遍：</p><ol><li>当您在应用中需要配置指定的 namespace 时，<strong>填入的是命名空间 ID</strong></li><li>当您在应用中需要配置指定的 namespace 时，<strong>填入的是命名空间 ID</strong></li><li>当您在应用中需要配置指定的 namespace 时，<strong>填入的是命名空间 ID</strong></li></ol></li></ol><p>说明: namesace 为 <strong>public</strong> 是 nacos 的一个保留控件，如果您需要创建自己的 namespace，最好不要和 <strong>public</strong> 重名，以一个实际业务场景有具体语义的名字来命名，以免带来字面上不容易区分自己是哪一个 namespace。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="namespace-参数初始化方式">namespace 参数初始化方式<a href="#namespace-参数初始化方式" class="hash-link" aria-label="namespace 参数初始化方式的直接链接" title="namespace 参数初始化方式的直接链接">​</a></h3><p>nacos client 对 namespace 的初始化流程如下图所示:</p><p><img loading="lazy" src="http://edas.oss-cn-hangzhou.aliyuncs.com/deshao/nacos/nacos_namespace.jpg" class="img_ev3q"></p><p>nacos client 对 namespace 的初始化，主要包含两部分：</p><ul><li><p>用户态通过 nacos client 构造实例时通过 properties 参数传入的 namespace。</p></li><li><p>在云环境下(<strong>阿里云下的 EDAS</strong>)的 namespace 参数解析。</p><p>可通过 <strong>-Dnacos.use.cloud.namespace.parsing=true/false</strong> 来控制是否需要在云环境自动解析 namespace 参数，默认为 <strong>true</strong>，是会自动解析，其目的就是方便用户上云时可以以零成本的方式平滑上云。如果用户在云上需要用自建的 nacos 下的 namespace，那这个时候只需将 <strong>-Dnacos.use.cloud.namespace.parsing=false</strong> 即可。</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="endpoint">endpoint<a href="#endpoint" class="hash-link" aria-label="endpoint的直接链接" title="endpoint的直接链接">​</a></h2><p>关于 endpoint ，也主要从 <strong>endpoint 的设计背景</strong> 和 <strong>endpoint 的参数初始化</strong> 两个方面来讨论。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="endpoint-的设计背景">endpoint 的设计背景<a href="#endpoint-的设计背景" class="hash-link" aria-label="endpoint 的设计背景的直接链接" title="endpoint 的设计背景的直接链接">​</a></h3><p>当 nacos server 集群需要扩缩容时，客户端需要有一种能力能够及时感知到集群发生变化。及时感知到集群的变化是通过 endpoint 来实现的。也即客户端会定时的向 endpoint 发送请求来更新客户端内存中的集群列表。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="endpoint-的参数初始化">endpoint 的参数初始化<a href="#endpoint-的参数初始化" class="hash-link" aria-label="endpoint 的参数初始化的直接链接" title="endpoint 的参数初始化的直接链接">​</a></h3><p>Nacos Client 提供一种可以对传入的 endpoint 参数规则解析的能力。即当通过构造函数的 <strong>properties</strong> 来初始化 endpoint 时，指定的 endpoint 值可以是一个具体的值，也可以是一个占位符的形式，如下所示: </p><blockquote><p><strong>\${endpoint.options:defaultValue}</strong>。</p></blockquote><p>说明：</p><ol><li><strong>endpoint.options</strong> 是一个具体的变量。支持从系统属性，系统环境变量中读取。</li><li><strong>defaultValue</strong> 是给出的一个默认值。当从具体的变量中没有被正确初始化时，会使用给出的默认值来初始化。</li></ol><p>整个 endpoint 的解析规则比较复杂，整体的一个解析流程图如下所示:</p><p><img loading="lazy" src="http://edas.oss-cn-hangzhou.aliyuncs.com/deshao/nacos/nacos_endpoint.jpg" class="img_ev3q">	</p><p><strong>注意：</strong> 蓝色特别区分的是支持云环境下(阿里云上的 EDAS)自动从系统环境变量中来读取 endpoint 值，以此来达到用户本地开发或者将应用往云上迁移的时候以零成本的改造方式实现平滑上云。</p><p>说明：</p><ul><li><p>开启 endpoint 参数规则解析</p><ol><li><p>如果在初始化 Nacos Client 的时候，没有通过 properties 来指定 endpoint，这个时候会从系统环境变量中变量名为 <strong>ALIBABA<!-- -->_<!-- -->ALIWARE<!-- -->_<!-- -->ENDPOINT<!-- -->_<!-- -->URL</strong> 指定的值来初始化，如果系统环境变量也没有设置，那么这个时候将会返回一个空字符串。</p></li><li><p>如果设置了 endpoint，</p></li><li><p>设置的 endpoint 是一个指定具体的值。</p><p>这时会先从系统环境变量中变量名为 <strong>ALIBABA<!-- -->_<!-- -->ALIWARE<!-- -->_<!-- -->ENDPOINT<!-- -->_<!-- -->URL</strong> 指定的值来初始化，如果系统环境变量没有设置，那么这个时候用用户态传入的具体值来初始化 endpoint。</p></li><li><p>以占位符的形式输入。</p><p>这时会解析出具体占位符的值，然后:</p><ol><li><p>依次从系统属性和环境变量中来取值。</p><p> 例如，您输入的是 <strong>${nacos.endpoint:defaultValue}</strong>，那么解析出来的占位符是 <strong>nacos.endpoint</strong>。解析出来后，会先读取系统属性中(<strong>即 System.getProperty(&quot;nacos.endpoint&quot;)</strong>)是否设置了 <strong>nacos.endpoint</strong> 变量值，如果没有，则会从系统环境变量中变量名为 <strong>nacos.endpoint</strong> 指定的值来初始化。</p></li><li><p>如果通过解析出来的占位符还没有正确初始化 endpoint，则会从系统环境变量中变量名为 <strong>ALIBABA<!-- -->_<!-- -->ALIWARE<!-- -->_<!-- -->ENDPOINT<!-- -->_<!-- -->URL</strong> 指定的值来初始化。</p></li><li><p>如果经过以上两步还没有被初始化，这时如果您设置了默认值，这个时候就会使用默认值来初始化 endpoint，否则的话以解析出来的占位符返回。	</p></li></ol></li></ol></li><li><p>关闭 endpoint 参数规则解析</p><p>当关闭了 endpoint 参数规则解析的时候，这个时候就以用户态在构造 Nacos Client 时通过 properties 参数输入的 endpoint 值为主。</p></li></ul><p>默认情况下， Nacos Client 是开启 endpoint 参数规则解析的能力。如果你想关闭该能力，有两种方式可以帮您来实现。</p><ol><li>可在 Nacos Client 初始化的时候在传入的 properties 实例中指定 key 为 <strong>isUseEndpointParsingRule</strong>，值为 <strong>false</strong> 即可关闭。</li><li>如果您的应用是 Java 程序的应用，也可以通过 <strong>-Dnacos.use.endpoint.parsing.rule=false</strong> 来关闭。 </li></ol><p><strong>注意</strong>：其中第一种方式的优先级高于第二种方式。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="Nacos2.0通过升级通信协议和框架、数据模型的方式将性能提升了约10倍，解决继 Nacos 1.0 发布逐步暴露的性能问题。本文通过压测 Nacos1.0，Nacos1.0升级Nacos2.0过程中，Nacos2.0 进行全面性能对比，直观的展示Nacos2.0所带来的性能提升。"><meta itemprop="keywords" content="2,性能测试,性能对比"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/performance-compare">Nacos 2.0 升级前后性能对比压测</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-10T08:15:08.000Z" itemprop="datePublished">2023年10月10日</time> · <!-- -->阅读需 8 分钟</div></header><div class="markdown" itemprop="articleBody"><p>Nacos2.0通过升级通信协议和框架、数据模型的方式将性能提升了约10倍，解决继 Nacos 1.0 发布逐步暴露的性能问题。本文通过压测 Nacos1.0，Nacos1.0升级Nacos2.0过程中，Nacos2.0 进行全面性能对比，直观的展示Nacos2.0所带来的性能提升。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="压测准备">压测准备<a href="#压测准备" class="hash-link" aria-label="压测准备的直接链接" title="压测准备的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="环境准备">环境准备<a href="#环境准备" class="hash-link" aria-label="环境准备的直接链接" title="环境准备的直接链接">​</a></h3><p>为了方便Nacos部署升级和展示核心性能指标，我们是从<a href="https://cn.aliyun.com/product/aliware/mse" target="_blank" rel="noopener noreferrer">阿里云微服务引擎MSE</a>中购买的一个2核CPU+4G内存的三节点Nacos集群。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="压测模型">压测模型<a href="#压测模型" class="hash-link" aria-label="压测模型的直接链接" title="压测模型的直接链接">​</a></h3><p>为了展示不同规模下的系统表现，我们采用逐步增压的方式进行压测，将压力分为3个批次进行逐步启动，并观察每个批次下集群的运行表现。同时会在压力集群之外，再增加一个Dubbo服务的Demo，并使用Jmeter以100TPS的压力不停的调用，以模拟不同压力下，对实际业务调用存在的可能影响。</p><p>压测过程中，会在适当的时候对服务端和客户端进行升级；服务端的升级将直接使用MSE提供的一键升级功能，客户端的升级会使用分批次轮流重启的方式进行。</p><p><img loading="lazy" alt="压测模型" src="/zh-cn/assets/images/performance_model-97b609e8d29e6ec0b5b084d1da365c25.jpg" width="1550" height="732" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="压测过程">压测过程<a href="#压测过程" class="hash-link" aria-label="压测过程的直接链接" title="压测过程的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nacos1x-server--nacos1x-client">Nacos1.X Server + Nacos1.X Client<a href="#nacos1x-server--nacos1x-client" class="hash-link" aria-label="Nacos1.X Server + Nacos1.X Client的直接链接" title="Nacos1.X Server + Nacos1.X Client的直接链接">​</a></h3><p>首先启动第一批施压集群，对MSE Nacos1.2.1进行施压，在6000个Providers的压力下，集群稳定时CPU大约25%，能够稳定保持6000实例。</p><p><img loading="lazy" alt="1.X6000实例CPU" src="/zh-cn/assets/images/1_6000_cpu-baab16c555248319a7e3751f105cb749.jpg" width="3098" height="508" class="img_ev3q">
<img loading="lazy" alt="1.X6000实例" src="/zh-cn/assets/images/1_6000_instance-aee611f962310aa4be0f35730054ff5f.jpg" width="3096" height="504" class="img_ev3q"></p><p>随后启动第二批施压集群，增加4000个Provider，合集10000个Provider。此时集群峰值CPU已经达到60%，稳定运行时大约在45%左右，集群能够稳定运行。</p><p><img loading="lazy" alt="1.X10000实例CPU" src="/zh-cn/assets/images/1_10000_cpu-a695b8af2bbff9a9109f1724f1d1b74a.jpg" width="3060" height="490" class="img_ev3q">
<img loading="lazy" alt="1.X10000实例" src="/zh-cn/assets/images/1_10000_instance-ce3c6f41290b3243a49d0824d5af1bbb.jpg" width="3024" height="502" class="img_ev3q"></p><p>在前两批的压力下，集群没有出现稳定性问题，所以Dubbo的调用保持正常，没有错误发生。</p><p><img loading="lazy" alt="1.X10000实例Dubbo" src="/zh-cn/assets/images/1_10000_dubbo-da8dd7d0766c57e101626142e0bb3760.png" width="1064" height="481" class="img_ev3q"></p><p>当第三批施压集群启动之后，压力总计14000个Provider。此时集群先是短暂的注册到13000个实例，之后很快出现实例数下跌，CPU跑满的问题。并且缩小时间范围可以看到，下跌后的实例仍然在小范围抖动。</p><p><img loading="lazy" alt="1.X14000实例CPU" src="/zh-cn/assets/images/1_14000_cpu-00b8c49ccf573f6c05ee87135f6af20e.jpg" width="3030" height="496" class="img_ev3q">
<img loading="lazy" alt="1.X14000实例" src="/zh-cn/assets/images/1_14000_instance-a8b02f1b13cf6309300be3004b5ac67c.jpg" width="3018" height="480" class="img_ev3q">
<img loading="lazy" alt="1.X14000实例抖动" src="/zh-cn/assets/images/1_14000_instance_shake-40f671422fd0ee548fedf18251dd90db.jpg" width="3026" height="512" class="img_ev3q"></p><p>同时Dubbo的调用出现错误，从Consumer的日志可以看出，是由于服务端无法支撑这个级别的压力，导致Dubbo Provider被摘除，所以调用的时候出现了<code>No provider</code>的错误。</p><p><img loading="lazy" alt="1.X14000实例Dubbo" src="/zh-cn/assets/images/1_14000_dubbo-5fa816b30338e3e9cd77fe21c416e649.png" width="1064" height="481" class="img_ev3q">
<img loading="lazy" alt="1.X14000实例Dubbo错误" src="/zh-cn/assets/images/1_14000_dubbo_error-dac9eef0c76a5d4b3d53175d66edd504.jpg" width="3566" height="312" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nacos2x-server--nacos1x-client">Nacos2.X Server + Nacos1.X Client<a href="#nacos2x-server--nacos1x-client" class="hash-link" aria-label="Nacos2.X Server + Nacos1.X Client的直接链接" title="Nacos2.X Server + Nacos1.X Client的直接链接">​</a></h3><p>由于服务端升级期间，会进行实例的双写操作，因此在升级过程中服务端存储的实例数会是实际实例值的两倍。根据上述测试结果，需要先将实例数回滚回第一批6000实例之后，或是升级配置扩容机器之后再尝试升级。本文使用回滚压力的方式，先停止后启动的施压集群。让集群恢复正常后再执行升级。</p><p><img loading="lazy" alt="升级前6000实例CPU" src="/zh-cn/assets/images/before_upgrade_cpu-d1c74733549728383a3fa828af094e3a.jpg" width="3088" height="486" class="img_ev3q">
<img loading="lazy" alt="升级前6000实例" src="/zh-cn/assets/images/before_upgrade_instance-2fe6c5eb295715f6124ce8e752d9c4b9.jpg" width="3052" height="482" class="img_ev3q">
<img loading="lazy" alt="升级前6000实例Dubbo" src="/zh-cn/assets/images/before_upgrade_dubbo-aa23e93668a3100461e9857ace56e8b1.png" width="1064" height="481" class="img_ev3q"></p><p>从监控图中可以看出，在停止后两批压力后，集群很快就恢复到了正常，运行稳定，Dubbo调用也恢复正常。之后使用MSE的升级功能，进行升级。升级过程中由于双写的性能损耗，导致CPU有较大的抖动；而且因为双写导致的实例数翻倍，实际上相当于12000实例的极限压力，服务端仍然有一定的抖动，因此导致了些许Dubbo的错误。若是在非极限压力下升级，将不会有此影响。</p><p><img loading="lazy" alt="升级后14000实例CPU" src="/zh-cn/assets/images/upgrading_cpu-8adead39922245f9d0bfb04e163f1a0c.jpg" width="3064" height="464" class="img_ev3q">
<img loading="lazy" alt="升级后14000实例" src="/zh-cn/assets/images/upgrading_instance-73fb6bb6f225e9cd00bc9e248e243661.jpg" width="3040" height="482" class="img_ev3q">
<img loading="lazy" alt="升级后14000实例Dubbo" src="/zh-cn/assets/images/upgrading_dubbo-408e2ea28e28e757151720ab66060edd.png" width="1064" height="481" class="img_ev3q"></p><p>随着服务端升级完成停止双写，消除了双写带来的性能损耗，CPU使用降低并趋于稳定，同时实例数也不再抖动，Dubbo调用完全恢复；如同1.X服务端一样，分两个批次启动施压集群，对比两个版本间在相同压力下的性能表现。</p><p><img loading="lazy" alt="升级后14000实例CPU" src="/zh-cn/assets/images/after_upgrade_cpu-7cafc402fa20692fc047a08a71d96354.jpg" width="3106" height="510" class="img_ev3q">
<img loading="lazy" alt="升级后14000实例" src="/zh-cn/assets/images/after_upgrade_instance-5745811ef8147996d0a3d3e478f492bd.jpg" width="3114" height="512" class="img_ev3q">
<img loading="lazy" alt="升级后14000实例Dubbo" src="/zh-cn/assets/images/after_upgrade_dubbo-7eb99da583572f6351a451c75a4a9ec2.png" width="1064" height="481" class="img_ev3q"></p><p>由于客户端依旧使用的是1.X的客户端，服务端的使用水位依然非常高，在全部压力启动后，CPU几乎达到100%；虽然没有像1.X服务端一样，出现大规模实例下跌，但是运行一段时间后依旧有少量的实例抖动，说明仅升级Nacos服务端到2.0版本能有一定的改善，但是没有彻底解决性能问题。</p><p><img loading="lazy" alt="升级后14000实例抖动" src="/zh-cn/assets/images/after_upgrade_instance_shake-88a15bfc8b3b8156ad61338d622c1e52.jpg" width="3032" height="470" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nacos2x-server--nacos2x-client">Nacos2.X Server + Nacos2.X Client<a href="#nacos2x-server--nacos2x-client" class="hash-link" aria-label="Nacos2.X Server + Nacos2.X Client的直接链接" title="Nacos2.X Server + Nacos2.X Client的直接链接">​</a></h3><p>为了完全释放Nacos2.0的性能，还需要将施压集群的客户端也升级到2.0以上版本。同样将分3个批次进行替换，期间由于Provider进行了重启，服务端有出现实例的下跌再恢复属于正常现象。随着施压集群的升级，可以发现CPU有了非常明显的下降，最终达到稳定时，CPU由最初的接近100%，降低到20%，集群稳定运行14000个实例。</p><p><img loading="lazy" alt="2.X14000实例CPU" src="/zh-cn/assets/images/2_14000_cpu-549f6b56287ca04b59041dfa4b28068f.jpg" width="3114" height="514" class="img_ev3q">
<img loading="lazy" alt="2.X14000实例" src="/zh-cn/assets/images/2_14000_instance-747758b3881f3abb6e1330f1452547a9.jpg" width="3100" height="514" class="img_ev3q">
<img loading="lazy" alt="2.X14000实例Dubbo" src="/zh-cn/assets/images/2_14000_dubbo-24cd3e2e0bbe884335ced04e2cdeb4be.png" width="1064" height="481" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="压测结果">压测结果<a href="#压测结果" class="hash-link" aria-label="压测结果的直接链接" title="压测结果的直接链接">​</a></h2><p>如上所述，我们能够得到<code>2核CPU+4G内存</code>的三节点集群在不同版本下的性能差异：</p><table><thead><tr><th>服务端版本</th><th>客户端版本</th><th>压力规模</th><th>集群稳定性</th><th>CPU使用</th></tr></thead><tbody><tr><td>Nacos1.X</td><td>Nacos1.X</td><td>14000</td><td>完全不稳定</td><td>100%</td></tr><tr><td>Nacos2.X（升级中）</td><td>Nacos1.X</td><td>6000</td><td>有一定抖动</td><td>100%</td></tr><tr><td>Nacos2.X</td><td>Nacos1.X</td><td>14000</td><td>有一定抖动</td><td>100%</td></tr><tr><td>Nacos2.X</td><td>Nacos2.X</td><td>14000</td><td>稳定</td><td>20%</td></tr></tbody></table><p>由此可见，Nacos2.0确实对性能有较大的提升，新用户建议直接全部采用Nacos2.0，老用户建议先升级Server端，然后在逐步升级客户端释放红利。最后从整个压测视角的监控，来直观的感受一下不同版本在不同阶段的性能表现：</p><p><img loading="lazy" alt="监控纵览" src="/zh-cn/assets/images/all-ba420b22959bd95a783dd0e6d843ecd4.jpg" width="1919" height="665" class="img_ev3q"></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="Istio是目前主流的Service Mesh组件。Istio基于Service Mesh的理念，承担着服务发现、服务通信、负载均衡、限流熔断、监控等等功能。让应用不用关心这些底层逻辑，专注于业务的开发和访问即可。软件行业的趋势一定是让业务的开发越来越轻松和简便，所以从这个角度看以Istio为代表的Service Mesh一定会越来越流行。至于目前存在的一些包括性能和设计复杂的问题，一定可以通过技术手段解决。"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/pilot mcp">Pilot MCP协议介绍</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-10T08:15:08.000Z" itemprop="datePublished">2023年10月10日</time> · <!-- -->阅读需 11 分钟</div></header><div class="markdown" itemprop="articleBody"><a name="VRC6c"></a># 背景介绍 Istio是目前主流的Service Mesh组件。Istio基于Service Mesh的理念，承担着服务发现、服务通信、负载均衡、限流熔断、监控等等功能。让应用不用关心这些底层逻辑，专注于业务的开发和访问即可。软件行业的趋势一定是让业务的开发越来越轻松和简便，所以从这个角度看以Istio为代表的Service Mesh一定会越来越流行。至于目前存在的一些包括性能和设计复杂的问题，一定可以通过技术手段解决。<a name="hKDrO"></a># 总体架构<p>MCP协议推出的背后，是Pilot意图重构以解决之前架构带来的代码维护、测试、扩展及稳定性等多方面的问题。在之前的架构中，Pilot内嵌了与K8S的交互逻辑以及其他扩展的注册中心和配置中心的逻辑。这样导致Pilot内部逻辑比较复杂、承担职责不够清晰。同时与各个组件的交互协议也不统一，导致Pilot难以维护这些代码，对于后面的扩展组件接入，也望而却步。在Pilot的重构设计文档中，对于Pilot目前存在的问题是这么总结的<!-- -->[1]<!-- -->：<br>“</p><ul><li>Pilot is more difficult to test than is necessary. It requires a dependency on K8S Apiserver in order to write more complex unit or simple integration tests.</li><li>We have smeared logic for dealing with the vagaries of K8S CRDs across Pilot, Mixer &amp; Citadel. Common concerns like K8S integration, resource validation and API versioning do not share a common implementation. The proposal to resurrect <strong>Galley </strong>is primarily motivated by an obvious need to improve our user-facing API experience.</li><li>Consuming the K8S API client in Pilot is a source of bloat and represents a production risk. Moving that risk to Galley while isolating the network control plane from it should be a performance and stability win.</li><li>The contract between Pilot, Kubernetes and other platforms is under-specified. We implicitly consume the totality of the K8S API surface even if we don’t need it.</li><li>Writing extensions to Pilot requires developers to consume our build process and this has proven to be a barrier to adoption for partners. This is analogous to the recent architectural shift in Mixer to use out-of-process adapters for the same reasons.</li></ul><p>”<br></p><br>Istio在Pilot重构设计文档中，展示了基于MCP协议的内部组件架构。在这个架构中，Pilot与Envoy还是使用Envoy定义的ADS协议，Pilot与Galley、外部的注册中心、配置中心以及其他的Pilot之间，都是通过MCP协议进行通讯：<br><br>![image.png](https://cdn.nlark.com/yuque/0/2019/png/333810/1574243165093-102c6f18-c565-4e0f-a2dc-a374ccc412d4.png#align=left&amp;display=inline&amp;height=383&amp;name=image.png&amp;originHeight=766&amp;originWidth=1256&amp;search=&amp;size=414042&amp;status=done&amp;width=628)<p>这样的设计比较好的定义了Pilot的职责，就是整个Service Mesh的控制面，但是不感知任何Istio以外的组件，即使是K8S也是如此。所有与外部组件包括注册中心和配置中心的交互逻辑，都移到了Pilot进程以外，通过运行特定的MCP Server来与Pilot进行通讯。Galley的职责，我认为是Pilot中默认的配置来源的MCP Server，目前是实现了与K8S数据的对接。这个文档中还定义了Pilot与Pilot之间的数据访问也是通过MCA（基于MCP协议定义的API），但是文档里没有提供更多的细节，会不会是Pilot未来会支持数据的分片以提高Pilot整体的数据容量？</p><a name="GiDba"></a># 协议定义 看完了Pilot的整体演进架构，我们来看一下MCP协议的设计[2]，MCP协议在设计上参考了与Envoy的交互协议xDS。<br>![image.png](https://cdn.nlark.com/yuque/0/2019/png/333810/1574243165174-59e66666-d992-440d-b066-89d1825abc38.png#align=left&amp;display=inline&amp;height=424&amp;name=image.png&amp;originHeight=594&amp;originWidth=944&amp;search=&amp;size=67856&amp;status=done&amp;width=674)<p>在MCP协议中，定义了两个身份：Sink和Source。Sink指代的是数据的接收端，Source指代的是数据的发送端即数据源。MCP协议基于gRPC双向流协议进行定义，Sink端和Source端都可以随时往对端发送数据，相互不会阻塞。从上图的协议交互也可以看出，Sink端可以主动发送RequestResources请求来向Source端要求数据，同时Source端也可以主动将Resources数据发送给Sink端。Sink端在收到数据后会返回一个ACK确认。在RequestResources请求和ACK响应中，主要有两个字段：</p><ul><li>collection：表示此次请求需要的数据类型，目前Istio定义了17种类型（测试得出，实际数据以Istio官方说法为准），其中包含了serviceentries作为服务发现的数据等。</li><li>nonce：类似于请求的ID，用来与响应或者请求进行匹配。</li></ul><p>而在返回的数据中，还有一个字段就是resources字段，里面包含真正的数据，具体的数据格式和collection的类型有关。</p><p>同时MCP协议还定义了增量推送的能力，如下图所示。可以在RequestResouces请求中增加incremental=true字段，这样Sink在收到数据后，会根据增量的形式进行数据的更新。协议的文档中还指出，必须在RequestResouces请求中包含incremental=true的情况下，才能返回给Sink增量的数据，否则Sink端对于该数据的处理将是未知的。目前社区的Pilot还没有支持增量的MCP数据推送，从下一节的源码分析中可以看到，Pilot对于每一个Source（Pilot可以配置多个Source，每个Source之间的数据是隔离的）发送的数据，都是整体替换更新的。目前社区的一个进展是正在进行serviceentries类型数据的增量更新的支持，而且是endpoints粒度的增量更新<!-- -->[3]<!-- -->。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2019/png/333810/1574243165196-05ba5a17-e84b-44cc-89e8-9e7ee00c9fa4.png#align=left&amp;display=inline&amp;height=403&amp;name=image.png&amp;originHeight=594&amp;originWidth=1068&amp;search=&amp;size=75600&amp;status=done&amp;width=724" alt="image.png" class="img_ev3q"></p><a name="C3kOS"></a># Pilot Sink端启动流程<p>Pilot在启动的时候，会根据ConfigMap里的配置，进行MCP Server的初始化。主要的逻辑可以参考下图：</p><a name="rETVj"></a># ![istio mcp.png](https://cdn.nlark.com/yuque/0/2019/png/333810/1574243165184-426a4245-ef40-4c44-9bbe-d36326e3151a.png#align=left&amp;display=inline&amp;height=1151&amp;name=istio%20mcp.png&amp;originHeight=1151&amp;originWidth=951&amp;search=&amp;size=94058&amp;status=done&amp;width=951) Pilot启动时，会调用server.NewServer来新建Pilot Server。在此过程中，会去读取ConfigSource配置里面的address。由于可能会配置多个address，那么Pilot在这里会循环去创建多个Sink客户端①，每一个Sink客户端拥有独立的数据。在这里有一点要注意的是，这个循环中会尝试与每个MCP Server建立gRPC连接，而如果其中一个MCP Server连接不上的话，整个循环就会推出，并返回error。也就是说如果Pilot在启动过程中无法连上每一个MCP Server，那么Pilot就会处于不健康状态，而在运行时没有这个限制②。当Sink客户端都新建完以后，就会再次循环异步调用每个Sink客户端的run方法，进行数据的收发了。<p>Sink端的run方法主要是调用EstablishResouceStream方法来建立双向流连接。在连接建立后，会调用creatIntialRquests请求来创建一次初始请求③，也就是说Pilot不会在启动时阻塞的去从每个MCP Server拉取数据，更新完后再提供服务，而是异步的进行数据的请求。事实上，Pilot也只会主动发这一次数据的请求④，接下来的数据更新都依赖于MCP Server的主动推送。在收到数据后，则进行handleResponse方法进行数据的更新⑤。</p><a name="dWz8x"></a># Pilot Sink端处理流程<p>下面介绍的是Pilot的Sink端在接收到数据的处理逻辑。从下图中可以看出，在接收到数据后，会先判断是否返回了错误，如果返回错误则直接结束数据的更新。如果没有错误，则进入Apply(change)方法。在这个方法中，会先新建一个innerStore的Map来保存更新到的数据。然后会将原来的configStore里对应collection类型的数据直接由这个innerStore进行替换。因此可以看出Pilot目前还不支持增量的MCP数据推送。在更新完数据后，则调用serviceEntryEvents或者ClearDiscoveryServerCache来通知Envoy等组件进行数据的更新。</p><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2019/png/333810/1574243165176-751ae4ee-eaab-4395-a4d1-4c2531b66d4c.png#align=left&amp;display=inline&amp;height=638&amp;name=istio%20mcp2.png&amp;originHeight=771&amp;originWidth=618&amp;search=&amp;size=52868&amp;status=done&amp;width=511" alt="istio mcp2.png" class="img_ev3q"></p><a name="s5oWA"></a># 总结与展望 目前Source端可以参考的代码有Galley，以及Nacos开发的独立MCP Server，用于进行MCP功能的测试和压测[4]，以及和Nacos Server一起部署的Java版本的MCP Server[5]。本文不做详细介绍，有兴趣的同学可以自行阅读相关源代码。<p>整体来看目前Pilot MCP协议还处于快速的更新和迭代阶段，未来可能还会有很多的变化。但是Istio基于MCP协议进行重构的大方向应该是不会跑了。Nacos团队目前也在密切关注着Istio及其他云原生组件的发展方向，同时将会陆续发布相关的功能，敬请期待。</p><p>[1]<!-- --> Pilot重构设计文档 <a href="https://docs.google.com/document/d/1S5ygkxR1alNI8cWGG4O4iV8zp8dA6Oc23zQCvFxr83U/edit#" target="_blank" rel="noopener noreferrer">https://docs.google.com/document/d/1S5ygkxR1alNI8cWGG4O4iV8zp8dA6Oc23zQCvFxr83U/edit#</a><br>[2]<!-- --> MCP协议介绍 <a href="https://github.com/istio/api/tree/master/mcp" target="_blank" rel="noopener noreferrer">https://github.com/istio/api/tree/master/mcp</a><br>[3]<!-- --> Pilot serviceentries增量推送的PR <a href="https://github.com/istio/istio/pull/12276" target="_blank" rel="noopener noreferrer">https://github.com/istio/istio/pull/12276</a><br>[4]<!-- --> Nacos提供的独立的MCP Server，Go语言开发 <a href="https://github.com/nacos-group/nacos-istio" target="_blank" rel="noopener noreferrer">https://github.com/nacos-group/nacos-istio</a><br>[5]<!-- --> Nacos对接Istio的issue，以及相关的commits <a href="https://github.com/alibaba/nacos/issues/1409" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/nacos/issues/1409</a></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="Nacos-spring-boot0.2.10发布，全面支持Nacos2.0"><meta itemprop="keywords" content="Nacos-spring-boot0.2.10,Nacos2.0"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/springboot-0.2.10">Nacos-spring-boot0.2.10发布，全面支持Nacos2.0</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-10T08:15:08.000Z" itemprop="datePublished">2023年10月10日</time> · <!-- -->阅读需 6 分钟</div></header><div class="markdown" itemprop="articleBody"><a name="0YIG0"></a><p>随着Nacos2.0成熟稳定，Nacos-spring-boot发布0.1.10、0.2.10两个核心版本，全面支持了Nacos2.0，同时支持自动识别配置类型注入能力，修复了高并发场景下数据一致性问题。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;groupId&gt;com.alibaba.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;artifactId&gt;nacos-config-spring-boot-starter&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;version&gt;0.2.10&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/dependency&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Nacos-spring-boot老用户，将相关maven依赖进行如下替换，即可快速升级。</p><p>本文将系统介绍新版本增强能力，并且以一次生产环境的配置管理项目构建过程为例，详细描述新版本Nacos Spring Boot0.2.10版本的部署，帮助Spring Boot老用户快速上岸Nacos2.0，感受长连接带来的10倍性能提升。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-spring-boot新版本特性">Nacos-spring-boot新版本特性<a href="#nacos-spring-boot新版本特性" class="hash-link" aria-label="Nacos-spring-boot新版本特性的直接链接" title="Nacos-spring-boot新版本特性的直接链接">​</a></h2><p>新发布的0.1.10版本和0.2.10版本主要feature增强包括以下几个部分：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="全面兼容nacos2体系向长连接时代演进">全面兼容Nacos2体系，向长连接时代演进<a href="#全面兼容nacos2体系向长连接时代演进" class="hash-link" aria-label="全面兼容Nacos2体系，向长连接时代演进的直接链接" title="全面兼容Nacos2体系，向长连接时代演进的直接链接">​</a></h3><p>Nacos1体系中，配置中心的订阅、实时推送功能主要通过长轮训进行。尽管长轮训是HTTP短连接体系中被采用较多的动态刷新解决方案，但也不可避免地存在时延过高等缺陷；在生产实践中暴露了一定问题，如下面这两个链接所示</p><p><a href="https://github.com/alibaba/nacos/issues/6345" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/nacos/issues/6345</a></p><p><a href="https://github.com/alibaba/nacos/issues/2674" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/nacos/issues/2674</a></p><p>Nacos2体系将整个配置中心的订阅、推送功能重构成为了基于gRPC的长连接方案，保证了配置刷新实时推送；迄今为止，已经历了大量的生产环境考验。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="自动识别配置的文件类型">自动识别配置的文件类型<a href="#自动识别配置的文件类型" class="hash-link" aria-label="自动识别配置的文件类型的直接链接" title="自动识别配置的文件类型的直接链接">​</a></h3><p>在使用Nacos-spring-boot新版本之后，即使用户对配置类型未设置的情况下，nacos-spring-boot也会自动识别该配置的文件类型(json/yaml/properties)并给定默认值。</p><p>该机制极大降低了因为文件类型不匹配，业务侧出现配置处理错误的风险。下图为新版本Nacos-spring-boot项目在一次配置文件刷新过程中的工作机制。</p><p><img loading="lazy" alt="springboot1.png" src="/zh-cn/assets/images/springboot1-bb380d42703e4bc5dc0670b5337a17b5.png" width="547" height="624" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nacosvalue注解全面支持spel表达式">@NacosValue注解全面支持Spel表达式<a href="#nacosvalue注解全面支持spel表达式" class="hash-link" aria-label="@NacosValue注解全面支持Spel表达式的直接链接" title="@NacosValue注解全面支持Spel表达式的直接链接">​</a></h3><p>Spel表达式全称为“Spring Expression Language”，是Spring自带的一种动态字符串构建方式表达式）。用户可以方便地使用Spel表达式来定义NacosValue，与Spring功能完美整合，减少SpringBoot用户们的工作量。</p><a name="1Gmg9"></a><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @NacosValue(value = &quot;${app.name}&quot;, autoRefreshed = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String nacosNameAutoRefreshed;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @NacosValue(value = &quot;${app.name:Nacos}&quot;, autoRefreshed = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String nacosNameAutoRefreshedWithDefaultValue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @NacosValue(&quot;${app.name}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String nacosNameNotAutoRefreshed;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @NacosValue(&quot;${app.nacosFieldIntValue:&quot; + VALUE_1 + &quot;}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int nacosFieldIntValue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @NacosValue(value = &quot;${app.nacosFieldIntValueAutoRefreshed}&quot;, autoRefreshed = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int nacosFieldIntValueAutoRefreshed;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="修复了高并发场景下的一致性问题">修复了高并发场景下的一致性问题<a href="#修复了高并发场景下的一致性问题" class="hash-link" aria-label="修复了高并发场景下的一致性问题的直接链接" title="修复了高并发场景下的一致性问题的直接链接">​</a></h3><p>一些用户在使用Nacos-spring-boot项目进行大规模压测的过程中，出现了一些配置读取错误：在大流量频繁修改某些dataId的配置的过程中，客户端可能会拉取到旧版本的配置数据，导致客户端配置数据反复。
Nacos-spring-boot新版本通过增加智能锁、升级Nacos-spring依赖等方式，对于潜在的线程安全风险进行了修复。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="生产演示">生产演示<a href="#生产演示" class="hash-link" aria-label="生产演示的直接链接" title="生产演示的直接链接">​</a></h2><p>在Nacos服务端，为了方便Nacos部署升级和尽可能保证配置信息的信息安全，我们是从<a href="https://cn.aliyun.com/product/aliware/mse?spm=nacos-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer">阿里云微服务引擎MSE</a> 中购买的一个2核CPU+4G内存的三节点Nacos集群。</p><p><img loading="lazy" alt="springboot2" src="/zh-cn/assets/images/springboot2-8c97fd76a3911005a8e7430f532194d0.png" width="1496" height="295" class="img_ev3q"></p><p>在Nacos客户端，在Springboot老用户可以通过下面方式升级到Nacos-spring-boot新版本。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="在-maven-项目的-pomxml-文件中增加或升级以下依赖来获取-starter">在 Maven 项目的 pom.xml 文件中增加（或升级）以下依赖来获取 Starter<a href="#在-maven-项目的-pomxml-文件中增加或升级以下依赖来获取-starter" class="hash-link" aria-label="在 Maven 项目的 pom.xml 文件中增加（或升级）以下依赖来获取 Starter的直接链接" title="在 Maven 项目的 pom.xml 文件中增加（或升级）以下依赖来获取 Starter的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;groupId&gt;com.alibaba.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;nacos-config-spring-boot-starter&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;0.2.10&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/dependency&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注： 使用时请根据自定义构建的Spring Boot版本选择相应的nacos-config-spring-boot-starter版本：nacos-config-spring-boot-starter 版本 0.2.10 对应 Spring Boot 2.x 版本，版本 0.1.10 对应 Spring Boot 1.x 版本。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="在-applicationproperties-文件中配置连接信息">在 application.properties 文件中配置连接信息<a href="#在-applicationproperties-文件中配置连接信息" class="hash-link" aria-label="在 application.properties 文件中配置连接信息的直接链接" title="在 application.properties 文件中配置连接信息的直接链接">​</a></h3><p>nacos.config.server-addr=${nacos_server_address}:8848
注：${nacos_server_address}为占位符，表示Nacos server的地址，可直接填入上文中购买的Nacos集群的公网或内网地址。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-nacospropertysource-加载-dataid-为-example-的配置源并开启自动更新">使用 @NacosPropertySource 加载 dataId 为 example 的配置源，并开启自动更新<a href="#使用-nacospropertysource-加载-dataid-为-example-的配置源并开启自动更新" class="hash-link" aria-label="使用 @NacosPropertySource 加载 dataId 为 example 的配置源，并开启自动更新的直接链接" title="使用 @NacosPropertySource 加载 dataId 为 example 的配置源，并开启自动更新的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootApplication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@NacosPropertySource(dataId = &quot;com.alibaba.nacos.example.properties&quot;, autoRefreshed = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosConfigApplication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         SpringApplication.run(NacosConfigApplication.class, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     } </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-nacosvalue-注解设置属性值">使用 @NacosValue 注解设置属性值。<a href="#使用-nacosvalue-注解设置属性值" class="hash-link" aria-label="使用 @NacosValue 注解设置属性值。的直接链接" title="使用 @NacosValue 注解设置属性值。的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Controller </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;config&quot;) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConfigController { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @NacosValue(value = &quot;${connectTimeoutInMills:5000}&quot;, autoRefreshed = true) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int connectTimeoutInMills;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RequestMapping(value = &quot;/get&quot;, method = GET) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int get() { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return connectTimeoutInMills;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="结果验证">结果验证<a href="#结果验证" class="hash-link" aria-label="结果验证的直接链接" title="结果验证的直接链接">​</a></h2><p>在本地启动客户端项目，并运行以下命令：</p><p><code>curl localhost:8080/config/get</code></p><p>若返回以下信息，则说明 SDK 可正常使用。</p><p><code>3000</code></p><p>在MSE控制台将示例配置 com.alibaba.nacos.example.properties 更改为以下内容并发布。</p><p><code>connectTimeoutInMills=6000</code></p><p>若Console打印出更新的配置内容 ，则说明SDK的配置自动更新功能正常；工程正式跨入高性能配置中心时代。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="双十一献礼 | Nacos Star破两万的回顾与展望"><meta itemprop="keywords" content="Nacos,双十一"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/up-to-2w-star">双十一献礼 | Nacos Star破两万的回顾与展望</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-10T08:15:08.000Z" itemprop="datePublished">2023年10月10日</time> · <!-- -->阅读需 12 分钟</div></header><div class="markdown" itemprop="articleBody"><a name="0YIG0"></a>双十一开启，Nacos Star 也突破 20000，从此迈上了一个新的里程碑。感谢大家的一路支持、信任和帮助！！！<p><img loading="lazy" alt="image1.png" src="/zh-cn/assets/images/image1-541bcc620e9df6a71771bb91bf145abc.png" width="849" height="196" class="img_ev3q"></p><p>Nacos是Nacos团队<a href="https://yqh.aliyun.com/live/detail/26356" target="_blank" rel="noopener noreferrer">三位一体</a>战略的重要一环，它是一个更易于构建云原生生态的动态服务发现、配置管理和服务管理平台，它起源于阿里巴巴内部经过十年双十一洪峰考验的VIPServer/Configserver/Diamond三款产品，沉淀了简单易用、稳定可靠、性能卓越的核心竞争力，为广大开源用户提供了经过经过充分生产验证过的服务注册与配置中心产品。
截止目前，Nacos已发布40个迭代版本，无缝支持Dubbo/Spring-Cloud/服务网格生态。吸引了200多位优秀贡献者，积累了虎牙、好未来、小米等多家企业案例，官网累计获取44w+用户浏览；借此机会，我们代表 Nacos 社区一起回顾开源三年以来的发展历程和未来的发展方向。</p><p><img loading="lazy" alt="image2.png" src="/zh-cn/assets/images/image2-48f4a32906c9b8eb3ac6eff5608f9478.png" width="1500" height="632" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-项目演进">1. 项目演进<a href="#1-项目演进" class="hash-link" aria-label="1. 项目演进的直接链接" title="1. 项目演进的直接链接">​</a></h2><p>自从Nacos1.X版本突破10000 Star后，随着用户深入和大规模使用开始逐渐暴露Nacos1.X的性能问题，借此Nacos开启了2.0的发展阶段，全面升级了通信协议、服务一致性模型、支持服务网格生态和多语言生态，下面我们分别进行介绍。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-长连接">1.1 长连接<a href="#11-长连接" class="hash-link" aria-label="1.1 长连接的直接链接" title="1.1 长连接的直接链接">​</a></h3><p>Nacos1.x版本主要基于HTTP短连接构建服务注册与发现、配置管理系统。随着用户的服务量级的增大，HTTP短连接架构暴露了一些问题。为了克服短连接的固有的技术瓶颈，Nacos社区针对HTTP短连接架构进行了一次基于长连接的重构升级。</p><p><img loading="lazy" alt="image3.png" src="/zh-cn/assets/images/image3-0499ca8c87990bdb974b35d472655d5c.png" width="1500" height="571" class="img_ev3q"></p><p>在Nacos 1.X架构中，配置中心的推送功能通过长轮询构建，周期性地由客户端主动发送HTTP请求并在发生更新时返回变更内容；而服务注册中心的推送则通过UDP推送+HTTP定期对账来实现。然而，配置中心的长轮训、服务注册中心的定期对账，都需要周期性地对于服务端进行一次主动建连和配置传送，增大服务端的内存开销；随着Nacos用户的服务数和配置数规模的增大，服务端的内存泄漏风险也大大增加。
为了更好的支撑用户的性能要求，克服HTTP短连接架构固有的性能瓶颈，Nacos社区在阿里巴巴集团内部充分验证的基础上，进行了一次基于长连接的重构升级。长连接时代的Nacos2.x在原本1.x的架构基础上新增了对gRPC长连接模型的支持，同时保留对旧客户端和OpenAPI的兼容。</p><p><img loading="lazy" alt="image4.png" src="/zh-cn/assets/images/image4-bcf4fce163fe16fdf459ae9304f54cb9.png" width="873" height="460" class="img_ev3q"></p><p>通信层目前通过gRPC实现了长连接RPC调用和推送能力。升级完成之后，服务变化、配置变更等信息会通过gRPC的双向流主动推送给客户端，而客户端只需要针对各个长连接主动发送轻量级的心跳即可。升级后的技术架构极大地减少了服务端处理数据的开销；同时，由于长连接基于可复用TCP的机制，也大大降低了网络堵塞的风险。</p><p><strong>压测验证</strong>：升级长连接之后，我们对Nacos2.0进行了大量压测。压测结果显示，Nacos2.0能够在10W级规模下，稳定运行；相比Nacos1.X版本的1.2W规模，提升约10倍。</p><p><img loading="lazy" alt="image5.png" src="/zh-cn/assets/images/image5-7a152a357aa2e989552c949349315a61.png" width="593" height="352" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-mcp及xds协议支持">1.2 MCP及XDS协议支持<a href="#12-mcp及xds协议支持" class="hash-link" aria-label="1.2 MCP及XDS协议支持的直接链接" title="1.2 MCP及XDS协议支持的直接链接">​</a></h3><p>通过对于MCP协议及XDS协议的支持，目前服务网格生态领域已完全兼容Nacos，为Istio接入Nacos注册中心提供零侵入、高性能的微服务以及网关解决方案，帮助用户在使用非K8S服务发现的情况下，仍然可以无缝享用服务网格的无侵入式的服务治理策略。</p><p><img loading="lazy" alt="image6.png" src="/zh-cn/assets/images/image6-2c7e392d70850a1105ae32e283f811d1.png" width="777" height="362" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-插件化支持">1.3 插件化支持<a href="#13-插件化支持" class="hash-link" aria-label="1.3 插件化支持的直接链接" title="1.3 插件化支持的直接链接">​</a></h3><p>在插件化支持方面，Nacos社区通过为鉴权、配置加解密、多数据源等模块进行了插件化改造，支持用户进行灵活的插件实现和改造。用户可以根据自己的业务需要，通过实现相应的SPI接口和jar包的引入，方便地进行自定义的鉴权、加解密、多数据源等附加功能的实现。
插件化升级之后，Nacos充分实现了多种附加功能与核心功能的解耦合，可扩展性大大加强。</p><p><img loading="lazy" alt="image7.png" src="/zh-cn/assets/images/image7-803e2f0a290ad8dfdf05c688b0ee4238.png" width="1191" height="607" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="14-多语言支持">1.4 多语言支持<a href="#14-多语言支持" class="hash-link" aria-label="1.4 多语言支持的直接链接" title="1.4 多语言支持的直接链接">​</a></h3><p>随着Nacos2.0对于长连接的支持，多语言客户端也迈出了一大步。
当前Golang、Java、Python、C#等主流语言已完全拥抱Nacos2.0，支持通过gRPC协议进行高性能服务注册与发现、配置管理；另外，C++、Node.js、PHP的2.0客户端仍在快速迭代开发、生产验证过程中，同时希望更多社区朋友参与进来，共同构建更加完善的Nacos多语言生态。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-生态构建">2. 生态构建<a href="#2-生态构建" class="hash-link" aria-label="2. 生态构建的直接链接" title="2. 生态构建的直接链接">​</a></h2><p>开源3年以来，Nacos社区沿着<a href="https://yqh.aliyun.com/live/detail/26356" target="_blank" rel="noopener noreferrer"><strong>三位一体</strong></a>战略规划进行生态演进和构建，通过开源、自研、商业化相互融合提供Nacos产品的优异可扩展性。</p><p><strong>自研</strong>：利用阿里巴巴集团内部超高并发的场景，对Nacos开源产品进行性能和高可用的充分验证；具有更高的性能和超强的稳定性。</p><p><img loading="lazy" alt="image8.png" src="/zh-cn/assets/images/image8-22caa434c39a36f8af0babf8e21acadc.png" width="1022" height="857" class="img_ev3q"></p><p><strong>公有云</strong>：Nacos充分在2.X系列版本中充分拥抱了云原生时代核心生态。Nacos团队内部利用公有云技术支持阿里巴巴集团和成千上万家公司大规模上云，为Nacos开源以及<a href="https://cn.aliyun.com/product/aliware/mse?spm=nacos-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer">公有云Nacos</a>产品提供了宝贵的生产实践经验，Nacos用户可以充分享受公有云弹性红利、安全、高可用能力。</p><p><strong>开源</strong>：开源Nacos进行了大量的云原生生态演进。当前Nacos社区开源生态已相对完善：（1）无缝整合Dubbo、Nacos、Spring-cloud-alibaba/Seata/Sentinel阿里微服务DNS框架，并成为国内首选；（2）无缝整合服务网格生态，让用户平滑进入服务网格时代。（3）支持Dapr为用户多语言多一种选择，也为微服务多语言生态多一种探索方向，欢迎感兴趣小伙伴一起推动。</p><p><img loading="lazy" alt="image9.png" src="/zh-cn/assets/images/image9-f61521a6f87278bd4bceba2ce21cfcf2.png" width="1500" height="729" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-未来展望">3. 未来展望<a href="#3-未来展望" class="hash-link" aria-label="3. 未来展望的直接链接" title="3. 未来展望的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-进一步云原生化">3.1 进一步云原生化<a href="#31-进一步云原生化" class="hash-link" aria-label="3.1 进一步云原生化的直接链接" title="3.1 进一步云原生化的直接链接">​</a></h3><p>随着云原生时代的到来，Nacos正在开展进行全面云原生化的探索。Nacos已支持了MCP协议及XDS协议，进行了初步的生产环境实践，为用户未来平滑迁移云原生服务框架做好了准备。
未来，我们将通过开展以下工作来提供云原生支持：
1、提供轻量级的Nacos Sidecar，为用户提供零侵入、轻量级的服务注册与发现能力；
2、支持通过Dapr进行sidecar构建，支持用户通过业务Pod+Dapr的方式构建微服务系统；
3、提供ServiceMesh化支持，将Nacos发展成云原生时代高性能注册中心，接入K8S核心生态。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-更加完善的插件化体系">3.2 更加完善的插件化体系<a href="#32-更加完善的插件化体系" class="hash-link" aria-label="3.2 更加完善的插件化体系的直接链接" title="3.2 更加完善的插件化体系的直接链接">​</a></h3><p>后期Nacos社区将会提供更加灵活的插件化体系，主要思路包括：
1、支持用户根据自己的业务场景，进行自定义的限流、熔断、容灾、多数据源等插件的开发和接入；
2、支持将配置中心和服务注册中心解耦，用户可以根据自己的需要将两者自由接入或删除。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-更活跃的生态">3.3 更活跃的生态<a href="#33-更活跃的生态" class="hash-link" aria-label="3.3 更活跃的生态的直接链接" title="3.3 更活跃的生态的直接链接">​</a></h3><p>Nacos社区将和Spring Cloud、Dubbo、Envoy、Dapr等社区一起推动微服务架构演进和标准化。</p><p><img loading="lazy" alt="image10.png" src="/zh-cn/assets/images/image10-ac902cd25cf97c6d141e8d7cb6790d92.png" width="1372" height="514" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-感谢贡献者">4. 感谢贡献者<a href="#4-感谢贡献者" class="hash-link" aria-label="4. 感谢贡献者的直接链接" title="4. 感谢贡献者的直接链接">​</a></h2><p>随着Nacos2.0的快速发展，Nacos社区产生了一些新晋的Committer：brotherlu-xcq、li-xiao-shuang、haoyann、horizonzy等，这些同学在长连接实现、配置加解密模块实现、多数据源支持、插件化等核心方面作出了大量的贡献。</p><p><img loading="lazy" alt="image11.png" src="/zh-cn/assets/images/image11-ad609e1a9b2091b2916617df90e858ea.jpeg" width="720" height="540" class="img_ev3q"></p><p>另外，Nacos社区参与了由中国科学院软件研究所和openEuler社区托管的<code>开源之夏2021</code>，由Wuyunfan-BUPT、li-xiao-shuang、Holdonbei、newJimmyChu及chenhongjing 5位同学分别完成了鉴权插件、配置加解密插件等5个课题，并取得了不错的进展，相信很快就可以和大家见面。</p><p><img loading="lazy" alt="image11.png" src="/zh-cn/assets/images/image12-0def023f0968214441ec872a26e420ca.png" width="1231" height="928" class="img_ev3q"></p><p>除了这些已经成为Committer和参加了官方活动的贡献者，Nacos 还收获了其他大量作出优秀帮助的贡献者，目前已有200+ Contributors，非常感谢你们的付出！我们一起让Nacos更强大！！！ </p><p><img loading="lazy" alt="image12.png" src="/zh-cn/assets/images/image13-8eb6b6fae284ce121a91057d6f60b964.png" width="360" height="171" class="img_ev3q"></p><p>最后欢迎加入社区贡献者队伍，共同进行Nacos云原生化实践！</p><p><img loading="lazy" alt="image13.png" src="/zh-cn/assets/images/image14-3fbd06b0fd3460e88f56fb4e01313160.png" width="456" height="533" class="img_ev3q"></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="当前文档描述如何通过云原生应用管理平台 Rainbond 一键安装高可用 Nacos 集群。"><meta itemprop="keywords" content="nacos,kubernetes,rainbond,云原生"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/use-nacos-with-rainbond">在 Rainbond 中一键安装高可用 Nacos 集群</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-10T08:15:08.000Z" itemprop="datePublished">2023年10月10日</time> · <!-- -->阅读需 5 分钟</div></header><div class="markdown" itemprop="articleBody"><p>当前文档描述如何通过云原生应用管理平台 <a href="https://www.rainbond.com/?channel=nacos" target="_blank" rel="noopener noreferrer">Rainbond</a> 一键安装高可用 <a href="https://nacos.io" target="_blank" rel="noopener noreferrer">Nacos</a> 集群。这种方式适合不太了解 Kubernetes、容器化等复杂技术的用户使用，降低了在 Kubernetes 中部署 Nacos 的门槛。</p><h1>背景信息</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rainbond-与-nacos-的结合">Rainbond 与 Nacos 的结合<a href="#rainbond-与-nacos-的结合" class="hash-link" aria-label="Rainbond 与 Nacos 的结合的直接链接" title="Rainbond 与 Nacos 的结合的直接链接">​</a></h2><p><a href="https://www.rainbond.com/?channel=nacos" target="_blank" rel="noopener noreferrer">Rainbond</a> 是一款易于使用的开源云原生应用管理平台。借助于它，用户可以在图形化界面中完成微服务的部署与运维。借助 Kubernetes 和容器化技术的能力，将故障自愈、弹性伸缩等自动化运维能力赋能给用户的业务。</p><p>Rainbond 内置原生 Service Mesh 微服务框架，同时与 Spring Cloud、Dubbo 等其他微服务框架也有很好的整合体验。故而大量的 Rainbond 用户也可能是 Nacos 微服务注册中心的用户。这类用户不必再关心如何部署 Nacos 集群，Rainbond 团队将 Nacos 制作成为可以一键部署的应用模版，供开源用户免费下载安装。这种安装方式极大的降低了用户使用 Nacos 集群的部署负担，目前支持 1.4.2 与 2.0.4 版本。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于应用模版">关于应用模版<a href="#关于应用模版" class="hash-link" aria-label="关于应用模版的直接链接" title="关于应用模版的直接链接">​</a></h2><p>应用模版是面向 Rainbond 云原生应用管理平台的安装包，用户可以基于它一键安装业务系统到自己的 Rainbond 中去。无论这个业务系统多么复杂，应用模版都会将其抽象成为一个应用，裹挟着应用内所有组件的镜像、配置信息以及所有组件之间的关联关系一并安装起来。</p><h1>前提条件</h1><ul><li><p>部署好的 Rainbond 云原生应用管理平台，<a href="https://www.rainbond.com/docs/quick-start/quick-install/?channel=nacos" target="_blank" rel="noopener noreferrer">快速体验版本</a> 可以在个人 PC 环境中以启动一个容器的代价运行。</p></li><li><p>互联网连接。</p></li></ul><h1>快速开始</h1><ul><li><strong>访问内置的开源应用商店</strong></li></ul><blockquote><p>选择左侧的 <strong>应用市场</strong> 标签页，在页面中切换到 <strong>开源应用商店</strong> 标签页，搜索关键词 <strong>nacos</strong> 即可找到 Nacos-cluster 应用。</p></blockquote><p><img loading="lazy" src="https://static.goodrain.com/wechat/nacos-cluster/nacos-cluster-1.png" alt="nacos-1" class="img_ev3q"></p><ul><li><strong>一键安装</strong></li></ul><blockquote><p>点击 Nacos-cluster 右侧的 <strong>安装</strong> 可以进入安装页面，填写简单的信息之后，点击 <strong>确定</strong> 即可开始安装，页面自动跳转到拓扑视图。</p></blockquote><p><img loading="lazy" src="https://static.goodrain.com/wechat/nacos-cluster/nacos-cluster-2.png" alt="nacos-2" class="img_ev3q"></p><p>参数说明：</p><table><thead><tr><th>选择项</th><th>说明</th></tr></thead><tbody><tr><td>团队名称</td><td>用户自建的工作空间，以命名空间隔离</td></tr><tr><td>集群名称</td><td>选择 Nacos 被部署到哪一个 K8s 集群</td></tr><tr><td>选择应用</td><td>选择 Nacos 被部署到哪一个应用，应用中包含有若干有关联的组件</td></tr><tr><td>应用版本</td><td>选择 Nacos 的版本，目前可选版本为 1.4.2、2.0.4</td></tr></tbody></table><p>等待几分钟后，Nacos 集群就会安装完成，并运行起来。</p><p><img loading="lazy" src="https://static.goodrain.com/wechat/nacos-cluster/nacos-cluster-3.png" alt="nacos-3" class="img_ev3q"></p><ul><li><strong>测试</strong></li></ul><p>需要执行服务注册的其他微服务组件，可以在建立面向 Nacos 的<a href="https://www.rainbond.com/docs/use-manual/user-manual/component-connection/regist_and_discover" target="_blank" rel="noopener noreferrer">依赖关系</a>后，使用 <code>${NACOS_HOST}:${NACOS_PORT}</code> 来连接到 Nacos 集群。</p><ul><li><p><strong>服务注册</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X PUT </span><span class="token string" style="color:#e3116c">&quot;http://</span><span class="token string variable" style="color:#36acaa">${NACOS_HOST}</span><span class="token string" style="color:#e3116c">:</span><span class="token string variable" style="color:#36acaa">${NACOS_PORT}</span><span class="token string" style="color:#e3116c">/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>服务发现</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X GET </span><span class="token string" style="color:#e3116c">&quot;http://</span><span class="token string variable" style="color:#36acaa">${NACOS_HOST}</span><span class="token string" style="color:#e3116c">:</span><span class="token string variable" style="color:#36acaa">${NACOS_PORT}</span><span class="token string" style="color:#e3116c">/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>发布配置</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X POST </span><span class="token string" style="color:#e3116c">&quot;http://</span><span class="token string variable" style="color:#36acaa">${NACOS_HOST}</span><span class="token string" style="color:#e3116c">:</span><span class="token string variable" style="color:#36acaa">${NACOS_PORT}</span><span class="token string" style="color:#e3116c">/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>获取配置</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X GET </span><span class="token string" style="color:#e3116c">&quot;http://</span><span class="token string variable" style="color:#36acaa">${NACOS_HOST}</span><span class="token string" style="color:#e3116c">:</span><span class="token string variable" style="color:#36acaa">${NACOS_PORT}</span><span class="token string" style="color:#e3116c">/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h1>高级特性</h1><ul><li>一键安装而来的 Nacos 集群中包含 3 个实例，并且通过初始化插件自动完成自组集群并选举的操作。</li></ul><p><img loading="lazy" src="https://static.goodrain.com/wechat/nacos-cluster/nacos-cluster-4.png" alt="nacos-4" class="img_ev3q"></p><ul><li>默认集成了 Mysql 作为数据源。在 <strong>Nacos-server-2.0.4</strong> 组件的环境配置中配置如下环境变量，可以切换到其他外部数据源。</li></ul><table><thead><tr><th>名称</th><th>必要</th><th>描述</th></tr></thead><tbody><tr><td><code>MYSQL_SERVICE_HOST</code></td><td>Y</td><td>数据库地址</td></tr><tr><td><code>MYSQL_SERVICE_PORT</code></td><td>Y</td><td>数据库端口</td></tr><tr><td><code>MYSQL_SERVICE_USER</code></td><td>Y</td><td>数据库用户名</td></tr><tr><td><code>MYSQL_SERVICE_PASSWORD</code></td><td>Y</td><td>数据库密码</td></tr><tr><td><code>MYSQL_SERVICE_DB_NAME</code></td><td>Y</td><td>数据库名</td></tr></tbody></table><ul><li>默认生成了 <strong>Nacos-server-2.0.4</strong> 的数据持久化目录。</li></ul><p><img loading="lazy" src="https://static.goodrain.com/wechat/nacos-cluster/nacos-cluster-5.png" alt="nacos-5" class="img_ev3q"></p><ul><li>默认配置了 <strong>Nacos-server-2.0.4</strong> 的健康检查机制，保障实例故障时自动下线，恢复后自动上线。</li></ul><p><img loading="lazy" src="https://static.goodrain.com/wechat/nacos-cluster/nacos-cluster-6.png" alt="nacos-6" class="img_ev3q"></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="小米集团的Nacos集群升级到了2.0.3版本之后，一直在开启双写的情况下运行稳定，动态的服务发现与分布式配置中心的能力也满足我们的预期，但随着使用我们集群的体量越来越大，需要对集群进行扩容，但在实际操作过程中遇到了一些问题，这篇文章主要总结一下集群扩缩容中遇到问题的解决过程和集群扩缩容步骤。"><meta itemprop="keywords" content="小米、Nacos2.0、扩缩容"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/xiaomi-scale">小米Nacos2.0扩缩容最佳实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-10T08:15:08.000Z" itemprop="datePublished">2023年10月10日</time> · <!-- -->阅读需 14 分钟</div></header><div class="markdown" itemprop="articleBody"><h1>一、背景</h1><p>小米是从1.x版本开始使用Nacos，后来为了性能升级到了2.0.3版本，一直在开启双写的情况下运行稳定，动态的服务发现与分布式配置中心的能力也满足我们的预期，随着使用我们集群的体量越来越大，需要对集群进行扩容，但在实际操作过程中遇到了一些问题，这篇文章主要总结一下集群扩缩容中遇到问题的解决过程和集群扩缩容步骤。</p><h1>二、集群扩缩容出现的问题</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一-发现服务降级问题">(一) 发现服务降级问题<a href="#一-发现服务降级问题" class="hash-link" aria-label="(一) 发现服务降级问题的直接链接" title="(一) 发现服务降级问题的直接链接">​</a></h2><p>我们在进行扩容的过程中发现新部署的节点和原有的一个节点的集群管理中的元数据出现了 readyToUpgrade: false，并且经过测试发现这两个节点无法使用2.x版本的SDK进行注册服务，但是可以使用1.x版本的SDK注册，说明原本2.0.3版本的服务端从功能上降级为了1.x版本。 </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二-服务降级的排查过程">(二) 服务降级的排查过程<a href="#二-服务降级的排查过程" class="hash-link" aria-label="(二) 服务降级的排查过程的直接链接" title="(二) 服务降级的排查过程的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="查看管理后台集群管理元数据">查看管理后台集群管理元数据<a href="#查看管理后台集群管理元数据" class="hash-link" aria-label="查看管理后台集群管理元数据的直接链接" title="查看管理后台集群管理元数据的直接链接">​</a></h3><p>我们发现在集群管理元数据出现readyToUpgrade: false，通过查看readyToUpgrade相关的源码发现：首次启动时，默认处于未升级状态，此时会开启一个定时任务，检查服务数量与实例数量是否与监控一致，并且是否当前不存在双写任务，如果条件满足则将 readyToUpgrade 字段设置成true，并且通知给其他集群。定时任务会定时判断是否所有实例都满足升级条件，如果满足，则执行升级操作。当我们进行扩容操作的时候，因为新节点刚部署的时候，老节点地址列表没有新节点，新节点是无法完成自动升级的，所以集群管理的节点元数据会出现 readyToUpgrade: false。 </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="查看服务端日志">查看服务端日志<a href="#查看服务端日志" class="hash-link" aria-label="查看服务端日志的直接链接" title="查看服务端日志的直接链接">​</a></h3><p>我们在非新节点的日志文件中发现了服务降级的相关日志。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-09 17:51:42,262 INFO Downgrade to 1.X</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根据服务降级日志“Downgrade to 1.X”在代码中全局搜索找到了对应的类UpgradeJudgement。 </p><p>经过分析UpgradeJudgement源码逻辑，只要满足如下其中一个条件便会出现服务降级： </p><ol><li>版本信息存在，但是小于2.x。</li></ol><p>只有手动通过操作部署低版本节点才可能出现该情况，该设计应该是为了防止升级后的集群有问题需要降级，利用该原理需要降级的时候，只要重新部署一个低版本的节点其他节点可自动降级。 </p><ol start="2"><li>UpgradeJudgement收到MembersChangeEvent事件，但是member信息中版本为空。</li></ol><p>老的版本的集群没有收集节点的版本信息，这里版本为空也降级是为了兼容这部分集群，我们之所以出现意料之外的降级也和这个直接相关。 </p><p>关键源码：</p><div class="language-$xslt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-$xslt codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void onEvent(MembersChangeEvent event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!event.hasTriggers()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Loggers.SRV_LOG.info(&quot;Member change without no trigger. &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + &quot;It may be triggered by member lookup on startup. &quot;                + &quot;Skip.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Loggers.SRV_LOG.info(&quot;member change, event: {}&quot;, event);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Member each : event.getTriggers()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object versionStr = each.getExtendVal(MemberMetaDataConstants.VERSION);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // come from below 1.3.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (null == versionStr) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            checkAndDowngrade(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            all20XVersion.set(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Version version = VersionUtil.parseVersion(versionStr.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (version.getMajorVersion() &lt; MAJOR_VERSION) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            checkAndDowngrade(version.getMinorVersion() &gt;= MINOR_VERSION)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">;            all20XVersion.set(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    all20XVersion.set(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="服务降级源码分析">服务降级源码分析<a href="#服务降级源码分析" class="hash-link" aria-label="服务降级源码分析的直接链接" title="服务降级源码分析的直接链接">​</a></h3><p>MemberInfoReportTask每隔5秒调用其他节点的/cluster/report 接口上报自己的member数据。</p><div class="language-$xslt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-$xslt codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    class MemberInfoReportTask extends Task {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final GenericType&lt;RestResult&lt;String&gt;&gt; reference = new GenericType&lt;RestResult&lt;String&gt;&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int cursor = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected void executeBody() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;Member&gt; members = ServerMemberManager.this.allMembersWithoutSelf();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (members.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.cursor = (this.cursor + 1) % members.size();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Member target = members.get(cursor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Loggers.CLUSTER.debug(&quot;report the metadata to the node : {}&quot;, target.getAddress());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String url = HttpUtils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .buildUrl(false, target.getAddress(), EnvUtil.getContextPath(), Commons.NACOS_CORE_CONTEXT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;/cluster/report&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Header header = Header.newInstance().addParam(Constants.NACOS_SERVER_HEADER, VersionUtils.version);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                AuthHeaderUtil.addIdentityToHeader(header);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                asyncRestTemplate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .post(url, header, Query.EMPTY, getSelf(), reference.getType(), new Callback&lt;String&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            public void onReceive(RestResult&lt;String&gt; result) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (result.getCode() == HttpStatus.NOT_IMPLEMENTED.value()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        || result.getCode() == HttpStatus.NOT_FOUND.value()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    Loggers.CLUSTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            .warn(&quot;{} version is too low, it is recommended to upgrade the version : {}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                    target, VersionUtils.version);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    Member memberNew = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    if (target.getExtendVal(MemberMetaDataConstants.VERSION) != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        memberNew = target.copy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        // Clean up remote version info.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        // This value may still stay in extend info when remote server has been downgraded to old version.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        memberNew.delExtendVal(MemberMetaDataConstants.VERSION);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        memberNew.delExtendVal(MemberMetaDataConstants.READY_TO_UPGRADE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        Loggers.CLUSTER.warn(&quot;{} : Clean up version info,&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                + &quot; target has been downgrade to old version.&quot;, memberNew);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    if (target.getAbilities() != null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            &amp;&amp; target.getAbilities().getRemoteAbility() != null &amp;&amp; target.getAbilities()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            .getRemoteAbility().isSupportRemoteConnection()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        if (memberNew == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            memberNew = target.copy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        memberNew.getAbilities().getRemoteAbility().setSupportRemoteConnection(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        Loggers.CLUSTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .warn(&quot;{} : Clear support remote connection flag,target may rollback version &quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        memberNew);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    if (memberNew != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        update(memberNew);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (result.ok()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    MemberUtil.onSuccess(ServerMemberManager.this, target);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    Loggers.CLUSTER.warn(&quot;failed to report new info to target node : {}, result : {}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            target.getAddress(), result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    MemberUtil.onFail(ServerMemberManager.this, target);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            public void onError(Throwable throwable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                Loggers.CLUSTER.error(&quot;failed to report new info to target node : {}, error : {}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        target.getAddress(), ExceptionUtil.getAllExceptionMsg(throwable));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                MemberUtil.onFail(ServerMemberManager.this, target, throwable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            public void onCancel() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Loggers.CLUSTER.error(&quot;failed to report new info to target node : {}, error : {}&quot;, target.getAddress(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ExceptionUtil.getAllExceptionMsg(ex));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected void after() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            GlobalExecutor.scheduleByCommon(this, 2_000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当调用失败时会执行MemberUtil的onFail方法</p><div class="language-$xslt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-$xslt codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public static void onFail(final ServerMemberManager manager, final Member member, Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        manager.getMemberAddressInfos().remove(member.getAddress());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final NodeState old = member.getState();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        member.setState(NodeState.SUSPICIOUS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        member.setFailAccessCnt(member.getFailAccessCnt() + 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int maxFailAccessCnt = EnvUtil.getProperty(MEMBER_FAIL_ACCESS_CNT_PROPERTY, Integer.class, DEFAULT_MEMBER_FAIL_ACCESS_CNT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If the number of consecutive failures to access the target node reaches</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // a maximum, or the link request is rejected, the state is directly down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (member.getFailAccessCnt() &gt; maxFailAccessCnt || StringUtils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .containsIgnoreCase(ex.getMessage(), TARGET_MEMBER_CONNECT_REFUSE_ERRMSG)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            member.setState(NodeState.DOWN);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!Objects.equals(old, member.getState())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            manager.notifyMemberChange(member);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在onFail方法中，会判断节点状态是否发生了改变，比如由UP变为SUSPICIOUS，如果发生了改变，则会执行manager.notifyMemberChange(member)。在前面复现降级的场景下，存在一个节点宕机，所以重启的节点report宕机节点时一定会触发MemberUtil的onFail方法的执行，而当前重启的节点持有的宕机节点状态默认是UP,当执行onFail时，会变成SUSPICIOUS，所以会执行manager.notifyMemberChange(member)，发布MembersChangeEvent事件，由于这个事件是由宕机节点触发的，所以MembersChangeEvent事件中trigger的member版本号为null，UpgradeJudgement收到MembersChangeEvent事件，并且member信息中版本为空，根据第2点的结论，此时会触发当前节点降级</p><div class="language-$xslt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-$xslt codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void notifyMemberChange(Member member) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NotifyCenter.publishEvent(MembersChangeEvent.builder().trigger(member).members(allMembers()).build());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="服务降级过程时序图">服务降级过程时序图<a href="#服务降级过程时序图" class="hash-link" aria-label="服务降级过程时序图的直接链接" title="服务降级过程时序图的直接链接">​</a></h3><p>为了方便理解，画了如下简单的时序图，省略了一些return和异步执行</p><p><img loading="lazy" alt="image_xiaomi_2022.jpg" src="/zh-cn/assets/images/image_xiaomi_2022-812dee3021b05913aa1498eeb4135e7b.png" width="1000" height="389" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="为什么关闭双写后服务不会降级">为什么关闭双写后服务不会降级<a href="#为什么关闭双写后服务不会降级" class="hash-link" aria-label="为什么关闭双写后服务不会降级的直接链接" title="为什么关闭双写后服务不会降级的直接链接">​</a></h3><p>前面已经提到，降级的必要条件是UpgradeJudgement收到MembersChangeEvent，关闭双写后，UpgradeJudgement会取消订阅MembersChangeEvent，并且将双写是否关闭的值通过jraft写入到磁盘，当服务启动时又会重新加载到内存从而取消订阅MembersChangeEvent。</p><div class="language-$xslt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-$xslt codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private class DoubleWriteEnabledChecker extends Thread {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private volatile boolean stillCheck = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Loggers.SRV_LOG.info(&quot;Check whether close double write&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (stillCheck) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TimeUnit.SECONDS.sleep(5);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    stopDoubleWrite = !ApplicationUtils.getBean(SwitchDomain.class).isDoubleWriteEnabled();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (stopDoubleWrite) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        upgradeJudgement.stopAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        stillCheck = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Loggers.SRV_LOG.error(&quot;Close double write failed &quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Loggers.SRV_LOG.info(&quot;Check double write closed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="本地复现服务降级">本地复现服务降级<a href="#本地复现服务降级" class="hash-link" aria-label="本地复现服务降级的直接链接" title="本地复现服务降级的直接链接">​</a></h3><p>在本地以2.0.3版本启动三个节点(node1、node2、node3)的集群模式，等三个节点都运行稳定后，查看其中每个节点数据目录（${nacos.home}/data/upgrade.state）下的升级状态都为true，说明三个节点目前都是2.x版本的状态。此时关闭node3节点，重启node1节点，启动完成后，发现node1此时会发生服务降级。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="服务降级排查结论">服务降级排查结论<a href="#服务降级排查结论" class="hash-link" aria-label="服务降级排查结论的直接链接" title="服务降级排查结论的直接链接">​</a></h3><p>在2.0.3版本默认开启双写，只要nacos集群其中一个节点挂掉，剩余节点如果不将这个节点从地址列表中移除，只要重启便会出现服务降级；另外在并发部署的情况下，也有可能出现服务降级。
关闭双写会关闭运行中服务降级的入口，所以2.x服务运行稳定后一定要关闭双写，我们的服务之所以会降级也是因为运行后未关闭双写。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三-临时解决方案">(三) 临时解决方案<a href="#三-临时解决方案" class="hash-link" aria-label="(三) 临时解决方案的直接链接" title="(三) 临时解决方案的直接链接">​</a></h2><p>由于我们的Nacos集群已经正常升级到了2.0.3，并且稳定运行了一段时间，已经有很多客户端在使用2.x的版本，节点出现降级会导致这部分客户端无法进行注册，所以无论在任何情况下，都不能出现服务降级，决定执行如下方案： </p><ol><li>扩容时新节点启动完成后关闭双写，强制新节点升级到2.x版本。 </li><li>暂时先将服务降级的方法代码逻辑删除，只打印日志。
代码改动如下： </li></ol><div class="language-$xslt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-$xslt codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void checkAndDowngrade(boolean jraftFeature) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Loggers.SRV_LOG.info(&quot;jraftFeature:{} ignore Downgrade to 1.X&quot;, jraftFeature);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四-社区解决方案">(四) 社区解决方案<a href="#四-社区解决方案" class="hash-link" aria-label="(四) 社区解决方案的直接链接" title="(四) 社区解决方案的直接链接">​</a></h2><p>我们将服务降级的问题也反馈给Nacos PMC席翁，在社区Nacos2.1.0正式版中，已经默认关闭了兼容 1.X 服务端升级，所以只要不手动开启，2.x的Nacos不可能在出现服务降级的问题，后续我们也会逐步将所有共有集群升级到2.1.0版本。 </p><p>关闭兼容1.x服务端升级的功能对应PR：<a href="https://github.com/alibaba/nacos/pull/8016" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/nacos/pull/8016</a></p><h1>三、集群扩缩容推荐</h1><p>扩缩容使用的运维接口</p><p>关闭双写 ： </p><div class="language-$xslt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-$xslt codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/nacos/v1/ns/operator/switchesentry=doubleWriteEnabled&amp;value=false </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看节点监控： </p><div class="language-$xslt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-$xslt codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/nacos/v1/ns/upgrade/ops/metrics</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一-集群扩容操作步骤">(一) 集群扩容操作步骤<a href="#一-集群扩容操作步骤" class="hash-link" aria-label="(一) 集群扩容操作步骤的直接链接" title="(一) 集群扩容操作步骤的直接链接">​</a></h2><ol><li>部署新节点。 </li><li>关闭新节点双写，检查日志是否出现如下日志，如果naming-raft出现了如下日志，说明降级入口已自动关闭。 </li></ol><div class="language-$xslt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-$xslt codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">start to close old raft protocol!!!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>通过metrics接口查看双写是否关闭成功</li><li>手动修改老节点集群配置文件 cluster.conf，无须重启。 </li><li>使用metrics接口查看新节点数据是否与老节点一致。 </li><li>测试新节点服务注册与发现，配置添加与查询等基本功能是否正常。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二-集群缩容操作步骤">(二) 集群缩容操作步骤<a href="#二-集群缩容操作步骤" class="hash-link" aria-label="(二) 集群缩容操作步骤的直接链接" title="(二) 集群缩容操作步骤的直接链接">​</a></h2><ol><li>nginx 去掉待移除节点ip。 </li><li>修改保留节点集群配置文件cluster.conf，无须重启，等待所有节点数据一致。 </li><li>观察nginx日志，确保移除merger节点无流量。 </li><li>top待移除节点，检查保留节点状态，模拟注册验证。</li></ol><p>若是操作机器降配，需要先停服，再停机器，不然可能出现raft数据压缩包有问题的情况。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三-扩缩容优化点">(三) 扩缩容优化点<a href="#三-扩缩容优化点" class="hash-link" aria-label="(三) 扩缩容优化点的直接链接" title="(三) 扩缩容优化点的直接链接">​</a></h2><p>目前我们每次进行扩缩容都需要修改每个节点的cluster.conf文件，操作非常繁琐，其实nacos提供了nacos-address 组件，引入nacos-address组件后进行扩缩容时无须一台一台修改地址，只需要修改Nacos-adress服务中的地址即可，可大大提升扩缩容效率。</p><h1>四、总结</h1><p>1.x版本升级到2.1.0之前的版本并且运行稳定后，必须关闭双写。</p><p>新集群统一使用2.1.0版本进行部署，否则在一定的场景下可能出现服务降级导致部分节点不可用。</p><p>对于体量较大的集群，需要引入nacos-address组件管理集群节点，避免手动频繁手动修改文件导致的误操作提升扩缩容效率。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="Higress：Nacos的最佳拍档"><meta itemprop="keywords" content="higress,higress nacos"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/higress">Higress + Nacos 微服务网关最佳实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-01-10T00:00:00.000Z" itemprop="datePublished">2023年1月10日</time> · <!-- -->阅读需 14 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">澄潭</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>在去年11月的云栖大会上，我们开源了云原生网关 Higress，时隔 2 月，Higress 的 Github 项目(<a href="https://github.com/alibaba/higress" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress</a>)已经收获了 700+ star，以及大量社区小伙伴的关注。在社区的交流中我们发现有不少微服务开发者在使用如 Spring Cloud Gateway/Zuul 等微服务网关对接 Nacos 注册中心实现微服务的路由，并且希望了解迁移到 Higress 网关能带来哪些好处。
本文将介绍 Higress 组合 Nacos 作为微服务网关能力，并介绍微服务网关发展的两个趋势，为网关的选型指明道路：</p><ul><li>趋势一：统一 API 标准，向云原生微服务架构演进</li><li>趋势二：合并安全&amp;流量网关，向 DevSecOps 演进</li></ul><h1>Higress：Nacos的最佳拍档</h1><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01Ww9gDw1PwXJUlwwRy_!!6000000001905-2-tps-1200-475.png" alt="image.png" class="img_ev3q">
Higress 和 Nacos 其实是师出同门——阿里中间件团队。在 Higress 支撑阿里内部业务的阶段，Higress 就已经搭配 Nacos 作为微服务网关使用，凭借高性能支撑了双十一的洪峰流量；到了云产品商业化阶段，Higress 和 Nacos 继续基于阿里云 MSE（Microservices Engine）产品，紧密协作演进产品功能；Higress 开源之后，如果想要自建微服务网关，选择 Higress 配合 Nacos 使用，具备以下优势：</p><ol><li>对比 Spring Cloud Gateway/Zuul 等传统 Java 微服务网关性能高出 2-4 倍，可以显著降低资源成本</li><li>作为云原生网关，实现了 Ingress/Gateway API 标准，兼容 Nginx Ingress 大部分注解，支持业务渐进式向基于 K8s 的微服务架构演进</li><li>与 Dubbo/OpenSergo/Sentinel 等开源微服务生态深度整合，提供最佳实践</li></ol><p>这里默认已经安装好 Higress，搭配 Nacos 使用的具体方式如下：</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置服务来源">配置服务来源<a href="#配置服务来源" class="hash-link" aria-label="配置服务来源的直接链接" title="配置服务来源的直接链接">​</a></h2><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> McpBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 定义一个名为 “production” 的服务来源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册中心类型是 Nacos 2.x，支持 gRPC 协议</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nacos2  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册中心的访问地址，可以是域名或者IP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.xxx.xx.32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册中心的访问端口，Nacos 默认都是 8848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Nacos 命名空间 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nacosNamespaceId</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> d8ac64f3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">47a814ecf358    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Nacos 服务分组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nacosGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> DEFAULT_GROUP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 定义一个名为 “uat” 的服务来源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> uat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册中心类型是 Nacos 1.x，只支持 HTTP 协议</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册中心的访问地址，可以是域名或者IP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.xxx.xx.31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册中心的访问端口，Nacos 默认都是 8848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Nacos 命名空间 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nacosNamespaceId</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 98ac6df3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ab98115dfde4    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Nacos 服务分组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nacosGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> DEFAULT_GROUP    </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们通过 McpBridge 资源配置了两个服务来源，分别取名 “production”和“uat”，需要注意的是 Higress 对接 Nacos 同时支持 HTTP 和 gRPC 两种协议，建议将 Nacos 升级到 2.x 版本，这样可以在上述配置的 type 中指定 “nacos2” 使用 gRPC 协议，从而更快速地感知到服务变化，并消耗更少的 Nacos 服务端资源。
基于 McpBridge 中的 registries 数组配置，Higress 可以轻松对接多个且不同类型的服务来源（Nacos/Zookeeper/Eureka/Consul/...），这里对于 Nacos 类型的服务来源，支持配置多个不同命名空间，从而实现不同命名空间的微服务可以共用一个网关，降低自建微服务网关的资源成本开销。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置-ingress">配置 Ingress<a href="#配置-ingress" class="hash-link" aria-label="配置 Ingress的直接链接" title="配置 Ingress的直接链接">​</a></h2><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">higress.io/destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">provider.DEFAULT</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">GROUP.d8ac64f3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">47a814ecf358.nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> McpBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">pathType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Prefix</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>和常见的 Ingress 在 backend 中定义 service 不同，这里基于 Ingress 的 resource backend 将上面定义服务来源的 McpBridge 进行关联。并通过注解<code>higress.io/destination</code>指定路由最终要转发到的目标服务。对于 Nacos 来源的服务，这里的目标服务格式为：“服务名称.服务分组.命名空间ID.nacos”，注意这里需要遵循 DNS 域名格式，因此服务分组中的下划线&#x27;_&#x27;被转换成了横杠&#x27;-&#x27;。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="丰富的微服务网关能力">丰富的微服务网关能力<a href="#丰富的微服务网关能力" class="hash-link" aria-label="丰富的微服务网关能力的直接链接" title="丰富的微服务网关能力的直接链接">​</a></h2><p>Higress 在微服务发现的基础上，提供了多种实用的微服务网关能力，这里以“灰度发布”和“自定义扩展”进行举例，更多能力可以点击原文参考 Higress 官网文档进行了解。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="灰度发布">灰度发布<a href="#灰度发布" class="hash-link" aria-label="灰度发布的直接链接" title="灰度发布的直接链接">​</a></h3><p>Higress 完全兼容了 Nginx Ingress 的金丝雀（Canary）相关注解，如下所示，可以将带有HTTP Header为x-user-id: 100的请求流量路由到灰度服务中。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">higress.io/destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">provider.DEFAULT</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">GROUP.98ac6df3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ab98115dfde4.nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nginx.ingress.kubernetes.io/canary</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;true&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nginx.ingress.kubernetes.io/canary-by-header</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nginx.ingress.kubernetes.io/canary-by-header-value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;100&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">uat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> McpBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">pathType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Prefix</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>您还可以基于 OpenKruise Rollout 让灰度发布和服务部署过程联动，从而实现渐进式交付，具体可以参考这篇文章<a href="https://mp.weixin.qq.com/s/vqwAUITNq9_twYHWX_5ZDg" target="_blank" rel="noopener noreferrer">《Higress &amp; Kruise Rollout: 渐进式交付为应用发布保驾护航》</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="自定义扩展">自定义扩展<a href="#自定义扩展" class="hash-link" aria-label="自定义扩展的直接链接" title="自定义扩展的直接链接">​</a></h3><p>作为微服务网关，需要在微服务架构中承担部分通用逻辑的处理，例如认证鉴权，安全防护等。通用的逻辑无法满足多样性的业务场景，Higress 可以支持开发者添加自定义处理逻辑。与 Spring Cloud Gateway 等传统微服务网关需要开发者自己在 Gateway 代码中加 Filter 不同，Higress 支持开发者使用多种语言编写 Wasm 插件，并动态加载生效，插件生效过程无需重启网关，变更插件逻辑对流量完全无损。
下例是一个屏蔽特定请求的 Wasm 插件，当请求 url 中出现 “swagger.html” 时将被直接拒绝访问，插件实现代码参考：<a href="https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/request-block" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/request-block</a></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> extensions.istio.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WasmPlugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">higress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pluginConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">block_urls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;swagger.html&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oci</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry.cn</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hangzhou.cr.aliyuncs.com/plugins/request</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">block</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.0.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Wasm 插件的开发&amp;编译&amp;镜像推送方式可以参考这篇文章<a href="https://mp.weixin.qq.com/s/eoPlaOgRm7u5wJAxhbVGGg" target="_blank" rel="noopener noreferrer">《Higress 实战：30 行代码写一个 Wasm Go插件》</a></p><h1>微服务网关发展趋势</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="趋势一统一-api-标准向云原生微服务架构演进">趋势一：统一 API 标准，向云原生微服务架构演进<a href="#趋势一统一-api-标准向云原生微服务架构演进" class="hash-link" aria-label="趋势一：统一 API 标准，向云原生微服务架构演进的直接链接" title="趋势一：统一 API 标准，向云原生微服务架构演进的直接链接">​</a></h2><p>基于一套 API 可以有不同的实现，既让用户不被具体实现锁定，又桥接了技术演进的鸿沟。API 可以说是整个云原生架构的基石，或许有一天 K8s 会消失，但是面向抽象的 API 标准定会长存。在流量网关领域，Ingress API 已经成为标准。而对于微服务网关等更复杂的使用场景，Ingress 受限于其简单的协议字段，需要通过 Ingress 注解等方式进行能力扩展，难以被标准化。因此诸如 Contour、Emissary、Kong、APISIX 等都定义了自己的 HTTP 路由等 CRD，网关的 API 定义开始呈现碎片化。
这一背景之下，Gateway API 应运而生，并且在过去的一年里从 alpha 演进到了 beta 阶段。虽然目前 Gateway API 还未定稿，协议仍会发生变动，不建议用于生产，但 API 统一趋势已经不可阻挡，只是时间的问题。下图是 Gateway API 的一个用例场景，不同于 Ingress API，将集群运维和业务运维的职责进行了划分，这样业务开发人员不再需要关心网站证书等集群级的细节，只专注于业务本身的 DevOps，集群运维任务可以交给 SRE 人员进行统一处理。
<img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01jDsDrv1zaqj82YkYP_!!6000000006731-2-tps-2735-1519.png" alt="image.png" class="img_ev3q">
Higress 目前采用 Ingress 注解的能力来实现能力扩展，并兼容了 Nginx Ingress 大部分常用注解，且具备平滑迁移到 Gateway API 的能力。
Higress 为传统微服务架构，提供了渐进式的方式，向基于 K8s 的云原生微服务架构演进：可以通过 Nacos 发现部署在 K8s 之外的服务，从而实现了网关后端微服务可以和 K8s 解耦，业务团队可以将微服务逐个迁移至 K8s，而不用担心网关层的流量影响。
从传统微服务网关迁移到 Higress，再渐进式完成整个微服务架构的云原生化，是一个明智的选择。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="趋势二合并安全流量网关向-devsecops-演进">趋势二：合并安全&amp;流量网关，向 DevSecOps 演进<a href="#趋势二合并安全流量网关向-devsecops-演进" class="hash-link" aria-label="趋势二：合并安全&amp;流量网关，向 DevSecOps 演进的直接链接" title="趋势二：合并安全&amp;流量网关，向 DevSecOps 演进的直接链接">​</a></h2><p>Higress 提出了将安全、流量、微服务网关三合一的概念，首先来看一个典型的多层网关架构：
<img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN0178hdNj25QDDnqmISC_!!6000000007520-2-tps-1318-198.png" class="img_ev3q">
在这个架构中，用 WAF 网关实现安全能力，Ingress 网关实现集群入口网关能力（非 K8s 场景或会部署一层 Nginx），SCG（Spring Cloud Gateway） 实现微服务网关能力。这样的架构下，需要对每一层网关都进行容量评估，每一层网关都是潜在的瓶颈点，都可能需要进行扩容。这样造成的资源成本和运维人力成本都是巨大的。并且每多一层网关，就多一层可用性风险。一旦出现可用性问题，多层网关会导致问题定位复杂度显著上升，对应的平均故障恢复时间（MTTR）将大幅增加。
<img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01BnAVqH1SCE73I5l85_!!6000000002210-2-tps-1318-198.png" class="img_ev3q">
采用三合一的架构中，可以显著降低成本，并提高系统整体可用性。同时这也符合 DevSecOps 的微服务演进趋势，微服务开发者可以更多地从业务接口视角关注安全性，而不是采用所有路由一刀切的 WAF 防护模式。
技术架构演进的背后是组织架构演进，这也是微服务 DevOps 一直在强调的，要围绕开发者为核心，从而提升微服务开发效率。向 DevSecOps 演进并没有捷径，依然需要开发角色和运维角色之间的双向奔赴，打破传统开发与运维之间的壁垒，形成从开发、部署、安全运营这样一个全功能化的敏捷团队。
通过 Higress 将网关合并作为向 DevSecOps 演进的抓手，是一个明智的选择。</p><h1>参与 Higress 社区</h1><p>Higress 开源贡献小组正在火热招募贡献者。如果您有时间，有热情，有意愿，欢迎联系社区加入开源贡献小组，一起共同完善 Higress，一起主导下一代云原生网关的设计和实现。
社区官网（点击“阅读原文”跳转）: <a href="https://higress.io" target="_blank" rel="noopener noreferrer">https://higress.io</a>
社区开发者群：
<img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01Zc7yGt1p0zYq3OCwj_!!6000000005299-2-tps-979-1280.png" alt="image.png" class="img_ev3q">
社区交流群：
<img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01Ebh7P021yKGBaP35B_!!6000000007053-2-tps-720-405.png" alt="higress-comm.png" class="img_ev3q"></p><h1>实战演示直播</h1><p>1月12号（本周四）将在线直播 Higress 通过 Nacos 实现微服务网关能力的实战演示，可以扫描图中二维码，预约观看，将在直播开始前收到短信通知。
<img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01fZzh1e1EQVqOnw415_!!6000000000346-2-tps-1500-2044.png" alt="image.png" class="img_ev3q"></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="Placeholder. DO NOT DELETE."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/2021/08/01/mdx-blog-post">mdx-blog-post</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-08-01T00:00:00.000Z" itemprop="datePublished">2021年8月1日</time> · <!-- -->阅读需 1 分钟</div></header><div class="markdown" itemprop="articleBody"><p>Placeholder. DO NOT DELETE.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="Placeholder. DO NOT DELETE."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/2019/05/29/long-blog-post">long-blog-post</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-05-29T00:00:00.000Z" itemprop="datePublished">2019年5月29日</time> · <!-- -->阅读需 1 分钟</div></header><div class="markdown" itemprop="articleBody"><p>Placeholder. DO NOT DELETE.</p></div></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/blog/page/5"><div class="pagination-nav__label">较新的博文</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/page/7"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div></div>
<script src="/zh-cn/assets/js/runtime~main.ea169da3.js"></script>
<script src="/zh-cn/assets/js/main.b736ec48.js"></script>
</body>
</html>