<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Nacos 的 Distro 一致性协议 | Nacos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://nacos.io/zh-cn/img/nacos_colorful.png"><meta data-rh="true" name="twitter:image" content="https://nacos.io/zh-cn/img/nacos_colorful.png"><meta data-rh="true" property="og:url" content="https://nacos.io/zh-cn/blog/nacos-distro-mechanism"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Nacos 的 Distro 一致性协议 | Nacos"><meta data-rh="true" name="description" content="详解Nacos 的 Distro 一致性协议"><meta data-rh="true" property="og:description" content="详解Nacos 的 Distro 一致性协议"><meta data-rh="true" name="keywords" content="Nacos,Distro,一致性协议,AP"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-09-14T00:00:00.000Z"><link data-rh="true" rel="icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"><link data-rh="true" rel="canonical" href="https://nacos.io/zh-cn/blog/nacos-distro-mechanism"><link data-rh="true" rel="alternate" href="https://nacos.io/en/blog/nacos-distro-mechanism" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://nacos.io/zh-cn/blog/nacos-distro-mechanism" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://nacos.io/blog/nacos-distro-mechanism" hreflang="default"><link data-rh="true" rel="alternate" href="https://nacos.io/blog/nacos-distro-mechanism" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://1QV814950M-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Nacos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Nacos Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Nacos" href="/zh-cn/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=nacos">
<meta name="referrer" content="no-referrer">
<link rel="stylesheet" href="//g.alicdn.com/mamba/mse-arc-ui/0.0.21/umd/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/mse-arc-ui/0.0.21/umd/mse-arc-ui.min.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-0YDFJ7LX7F" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.4eb69c24.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.3c6f9500.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.d28718da.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>



<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="//hm.baidu.com/hm.js?e3a5cec56ef8619cf9d7c2abebd509e3"></script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="/zh-cn/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh-cn/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a href="https://nacos.io/zh-cn/docs/v2/quickstart/quick-start.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"> </a><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="what-is-nacos" href="/zh-cn/docs/what-is-nacos">2.X（推荐）</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-cn/docs/next/what-is-nacos">用户文档</a></li><li><a class="dropdown__link" href="/zh-cn/docs/what-is-nacos">2.X（推荐）</a></li><li><a class="dropdown__link" href="/zh-cn/docs/1.X/what-is-nacos">1.X</a></li></ul></div><a class="navbar__item navbar__link" href="/zh-cn/cloud">Nacos Cloud</a><a href="https://developer.aliyun.com/ebook/36?spm=a2c6h.20345107.ebook-index.18.152c2984fsi5ST" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">NACOS架构与原理<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a href="http://console.nacos.io/nacos/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/en/blog/nacos-distro-mechanism" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog/nacos-distro-mechanism" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.3.0-beta-release">Nacos 荣获GLCC优秀社区，同时2.3.0-BETA发布，欢迎试用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2023">Nacos开源之夏2023，贡献社区赢取12000奖金</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.2.2-release">Nacos 2.2.2发布，优化启动体验和鉴权提示</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.2.1-release">Nacos 多个新版本发布，rust-sdk完全适配完成</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/announcement-token-secret-key">关于Nacos默认token.secret.key及server.identity风险说明及解决方案公告</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/higress">Higress + Nacos 微服务网关最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-reigster-mechanism">Nacos 的一条注册请求会经历什么？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.2.0-release">Nacos 2.2.0 版本发布，新增多种插件支持</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/212-and-220beta-release">Nacos 2.1.2、2.2.0-BETA及go-sdk 2.1.1 版本同时发布，多语言生态再添大将</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.1.1-release">Nacos 四周年，2.1.1 及 1.4.4 版本同时发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos3.0-is-coming">我们总结了3大使用建议，并首次公开 Nacos3.0 规划图 | Nacos 开源4周年</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/xiaomi-scale">小米Nacos2.0扩缩容最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2022">Nacos开源之夏2022，贡献社区赢取12000奖金</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.1.0-release">Nacos 2.1.0版本发布，支持鉴权及加解密插件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/use-nacos-with-rainbond">在 Rainbond 中一键安装高可用 Nacos 集群</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/apisix">Apache APISIX 基于 Nacos 实现服务发现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/up-to-2w-star">双十一献礼 | Nacos Star破两万的回顾与展望</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.0.3-release">Nacos 2.0.3版本发布，继续提升集群稳定性及升级稳定性</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/performance-compare">Nacos 2.0 升级前后性能对比压测</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/springboot-0.2.10">Nacos-spring-boot0.2.10发布，全面支持Nacos2.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2021">Nacos 开源之夏2021活动 报名正式开启</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.0.1-release">Nacos 2.0.1 + 1.4.2 Release</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/1.4.0-release">双十一购物节，Nacos 1.4.0 + Go SDK 1.0.1发布</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/zh-cn/blog/nacos-distro-mechanism">Nacos 的 Distro 一致性协议</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/csharp-0.5.0">Nacos-sdk-csharp 0.5.0正式发布，功能与Java版本对齐！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-2nd-anniversary">Nacos 两周年献礼，Nacos 1.3.2 + Go SDK 1.0.0发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/feeling-of-ASoC-2019">参与开源，Offer拿到手软 -- 来自一名2019阿里巴巴编程之夏同学的亲述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos 1.2.0 guide">Nacos 1.2.0权限控制介绍和使用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-1.3.0-design">Nacos 1.3.0 全新内核构建过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/namespace-endpoint-best-practices">Namespace,endpoint 最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/pilot mcp">Pilot MCP协议介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos 1.1.4">Nacos 1.1.4发布，业界率先支持Istio MCP协议</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-confd">Nacos整合Confd，支持nginx配置管理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/eureka2">Eureka 2.0 开源工作宣告停止？别担心，ANS 即将 C位强势出道！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos 1.1.0">Nacos 1.1.0发布，支持灰度配置和地址服务器模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-roadmap">Nacos GA后的整体规划</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/cmdb">Nacos打通CMDB实现就近访问</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/address-server">阿里巴巴基于 Nacos 实现环境隔离的实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos1.0.0">Nacos 1.0.0 发布，正式大规模生产可用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.9.0">Nacos 0.9.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.9-intro">Nacos 0.9.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/huya-practice">虎牙直播在微服务改造方面的实践和总结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.8">Nacos 0.8.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/huya-nacos">虎牙直播共建Nacos生态</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/5w1h-where">Nacos 有哪些典型的应用场景？—— 配置管理篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/dynamic-route-zuul-nacos">使用Nacos实现Spring Cloud Zuul的动态路由</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.6">Nacos 0.6版本发布，支持Dubbo生态并且支持Docker部署</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.5">Nacos0.5发布，支持DNS-based Service Discovery，JAVA 11</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos">Nacos 0.1.0 版本Review 活动设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/cncf">Nacos 进入CNCF landscape</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/5w1h-what">Nacos 帮我们解决什么问题？—— 配置管理篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/discovery-console">Nacos服务发现控制台预览</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/chengdu-dubbo">Nacos 计划发布v0.2版本，进一步融合Dubbo和SpringCloud生态</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/consul-k8s">Consul与kubernetes整合公告[翻译]</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/dns-sd">微服务架构中基于DNS的服务注册与发现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-is-coming">支持Dubbo生态发展，阿里巴巴启动新的开源项目 Nacos</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/alibaba-configserver">阿里巴巴服务注册中心产品ConfigServer 10年技术发展回顾</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="详解Nacos 的 Distro 一致性协议"><meta itemprop="keywords" content="Nacos,Distro,一致性协议,AP"><header><h1 class="title_f1Hy" itemprop="headline">Nacos 的 Distro 一致性协议</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-09-14T00:00:00.000Z" itemprop="datePublished">2020年9月14日</time> · <!-- -->阅读需 18 分钟</div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>转载且编辑自<a href="http://www.passjava.cn/#/13.SpringCloud%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90/07.Nacos%E9%85%8D%E7%BD%AE%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/03.Nacos%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E2%91%A1%EF%BC%9A%E6%8F%AD%E7%A7%98AP%E6%9E%B6%E6%9E%84%E2%80%94%E2%80%94Distro%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener noreferrer">Nacos 的 Distro 一致性协议</a></p><h1>Nacos 的 Distro 一致性协议</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><p>这次我们进入 Nacos 的一致性底层原理，还是先来一张架构图，让大家对 Nacos 的架构有个整体的映像，本篇会主要讲解<strong>一致性模块</strong>中的 <code>Distro</code> 协议。（本图参考的 Nacos 官方图）</p><p><img loading="lazy" alt="参考 Nacos 官方图" src="/zh-cn/assets/images/image-20220504113110811on9pa8-20220530200803828-7a42bd8a9d60dccf494e6cb6fee1cb84.png" width="1062" height="934" class="img_ev3q"></p><p><strong>上篇留了两个知识点</strong>：</p><ul><li>① 服务实例注册到 Nacos 节点后，通过 UDP 方式推送到所有服务实例。让其他服务实例感知到服务列表的变化。</li><li>② 如何复制数据到其他节点：当前 Nacos 节点开启 1s 的延迟任务，将数据同步给其他 Nacos 节点。（分区一致性）</li></ul><p>第 ② 个知识点就是 Nacos 自研的 <code>Distro</code> 一致性协议的核心功能。</p><p>首先这个 Distro 协议是针对集群环境的，比如下面这三个集群节点组成了一个集群。服务 A 和服务 B 会往这个集群进行注册。</p><p><img loading="lazy" alt="Nacos 集群节点" src="/zh-cn/assets/images/image-20220427211513114ErcXkf-20220530200808311-e8a87cdf083c9ca5a20ea5dc1b809f44.png" width="1366" height="582" class="img_ev3q"></p><p><img loading="lazy" alt="Nacos 集群环境" src="/zh-cn/assets/images/image-20220427220632378nCoaA5-d81bade52adad2094467c229419863f1.png" width="1058" height="940" class="img_ev3q"></p><p>我们知道 Nacos 它是支持两种分布式定理的：<code>CP</code>（分区一致性）和 <code>AP</code>（分区可用性） 的，而 AP 是通过 Nacos 自研的 <code>Distro</code> 协议来保证的，CP 是通过 Nacos 的 <code>JRaft</code> 协议来保证的。</p><p>因为注册中心作为系统中很重要的的一个服务，需要尽最大可能对外提供可用的服务，所以选择 AP 来保证服务的高可用，另外 Nacos 还采取了心跳机制来自动完成服务数据补偿的机制，所以说 Distro 协议是弱一致性的。</p><p>如果采用 CP 协议，则需要当前集群可用的节点数过半才能工作。</p><p>关于 CP 和 AP 的理论知识，可以参考这篇：<a href="https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&amp;mid=2451950422&amp;idx=1&amp;sn=7f86457acedbd0853cbcb7dc4377dd54&amp;chksm=8d1c32c9ba6bbbdfd3d8c698addfb13a02589409bdf6a03a777e9afc95249018293d9a9e0a3f&amp;token=203503668&amp;lang=zh_CN#rd" target="_blank" rel="noopener noreferrer">用太极拳讲分布式理论 CAP 和 BASE，真舒服！</a></p><blockquote><p>问题：Nacos 中哪些地方用到了 AP 和 CP？</p></blockquote><ul><li>针对<code>临时服务</code>实例，采用 <code>AP</code> 来保证注册中心的可用性，<code>Distro</code> 协议。</li><li>针对<code>持久化服务</code>实例，采用 <code>CP</code> 来保证各个节点的强一致性，<code>JRaft</code> 协议。（JRaft 是 Nacos 对 Raft 的一种改造）</li><li>针对<code>配置中心</code>，无 Database 作为存储的情况下，Nacos 节点之间的内存数据为了保持一致，采用 <code>CP</code>。Nacos 提供这种模式只是为了方便用户本机运行，降低对存储依赖，生产环境一般都是通过外置存储组件来保证数据一致性。</li><li>针对<code>配置中心</code>，有 Database 作为存储的情况下，Nacos 通过持久化后通知其他节点到数据库拉取数据来保证数据一致性，另外采用读写分离架构来保证高可用，所以这里我认为这里采用的 <code>AP</code>，欢迎探讨。</li><li>针对 <code>异地多活</code>，采用 <code>AP</code> 来保证高可用。</li></ul><p>弦外音：</p><p><strong>临时服务实例</strong>就是我们默认使用的 Nacos 注册中心模式，客户端注册后，客户端需要定时上报心跳进行服务实例续约。这个在注册的时候，可以通过传参设置是否是临时实例。</p><p><strong>持久化服务实例</strong>就是不需要上报心跳的，不会被自动摘除，除非手动移除实例，如果实例宕机了，Nacos 只会将这个客户端标记为不健康。</p><p>本篇会带着大家从源码角度来深入剖析下 Distro 协议。</p><p><strong>知识点预告：</strong></p><ul><li>① Distro 的设计思想和六大机制。</li><li>② Nacos 如何同步数据到其他节点。（异步复制机制，本篇重点讲解）</li><li>③ Nacos 如何保证所有节点的数据一致性。（定期检验；健康检查机制，下一篇重点讲解）</li><li>④ 新加入的 Nacos 节点，如何拉取数据。（新节点同步机制）</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一distro-的设计思想和六大机制">一、Distro 的设计思想和六大机制<a href="#一distro-的设计思想和六大机制" class="hash-link" aria-label="一、Distro 的设计思想和六大机制的直接链接" title="一、Distro 的设计思想和六大机制的直接链接">​</a></h2><p><code>Distro</code> 协议是 Nacos 对于<code>临时实例数据</code>开发的一致性协议。</p><p>Distro 协议是集 Gossip + Eureka 协议的优点并加以优化后出现的。</p><p>关于 Gossip 协议，可以看这篇：<a href="https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&amp;mid=2451951238&amp;idx=1&amp;sn=a0acccbdfed3d3ac9ee8ef4bb349b12b&amp;chksm=8d1c3719ba6bbe0fc42876088a0747d7ca68dbbe9d21a21b2c94ecfc62c3f42ae3710f8acb40&amp;token=203503668&amp;lang=zh_CN#rd" target="_blank" rel="noopener noreferrer">病毒入侵：全靠分布式 Gossip 协议</a></p><p><strong>Gossip 协议有什么坑？</strong>由于随机选取发送的节点，不可避免的存在消息重复发送给同一节点的情况，增加了网络的传输的压力，给消息节点带来额外的处理负载。</p><p><strong>Distro 协议的优化：</strong>每个节点负责一部分数据，然后将数据同步给其他节点，有效的降低了消息冗余的问题。</p><p>关于临时实例数据：临时数据其实是存储在<code>内存缓存</code>中的，并且在其他节点在启动时会进行全量数据同步，然后节点也会定期进行数据校验。</p><p>大家不要被这个协议吓到，其实就是阿里自己实现的一套同步逻辑。</p><p>AP 中的 P 代表网络分区，所以 Distro 在分布式集群环境下才能真正发挥其作用。它保证了在多个 Nacos 节点组成的 Nacos 集群环境中，当其中某个 Nacos 宕机后，整个集群还是能正常工作。</p><p><strong>Distro 的设计机制</strong>：</p><ul><li><strong>平等机制</strong>：Nacos 的每个节点是平等的，都可以处理写请求。（上一讲已经重点讲解了✅）</li><li><strong>异步复制机制</strong>：Nacos 把变更的数据异步复制到其他节点。(⭐️<strong>重点讲解</strong>)</li><li><strong>健康检查机制</strong>：每个节点只存了部分数据，定期检查客户端状态保持数据一致性。</li><li><strong>本地读机制</strong>： 每个节点独立处理读请求，及时从本地发出响应。</li><li><strong>新节点同步机制</strong>： Nacos 启动时，从其他节点同步数据。</li><li><strong>路由转发机制</strong>：客户端发送的写请求，如果属于自己则处理，否则路由转发给其他节点。（上一讲已经重点讲解了✅）</li></ul><p><img loading="lazy" alt="Distro 的设计机制" src="/zh-cn/assets/images/image-20220504220127510ZudbpC-91b0fe6e14c460869ef4fb1672c2ec45.png" width="994" height="786" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二异步复制机制写入数据后如何同步给其他节点">二、异步复制机制：写入数据后如何同步给其他节点<a href="#二异步复制机制写入数据后如何同步给其他节点" class="hash-link" aria-label="二、异步复制机制：写入数据后如何同步给其他节点的直接链接" title="二、异步复制机制：写入数据后如何同步给其他节点的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-核心入口">2.1 核心入口<a href="#21-核心入口" class="hash-link" aria-label="2.1 核心入口的直接链接" title="2.1 核心入口的直接链接">​</a></h3><p>核心源码路径：</p><div class="language-PYTHON codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-PYTHON codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/naming/consistency/ephemeral/distro/DistroConsistencyServiceImpl.java</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个类的名字就说明它是 Distro 一致性协议的接口实现类。</p><p>当注册请求交给 Nacos 节点来处理时，核心入口方法就是 put()，如下图所示：</p><p><img loading="lazy" src="/zh-cn/assets/images/image-20220427075804426upuierjz3uG9-43c1261a8fb73c744e3248310dbe30a0.png" width="1720" height="474" class="img_ev3q"></p><p>上一讲我们已经说过，这里面会做几件事：</p><p><img loading="lazy" alt="添加实例信息的流程" src="/zh-cn/assets/images/image-20220413164932907KHTvVMRZvHBS-1ea8de71447055276f1afbae22199828.png" width="1366" height="1360" class="img_ev3q"></p><ul><li>① 将实例信息存放到内存缓存 concurrentHashMap 里面。</li><li>② 添加一个任务到 BlockingQueue 里面，这个任务就是将最新的实例列表通过 UDP 的方式推送给所有客户端（服务实例），这样客户端就拿到了最新的服务实例列表，缓存到本地。</li><li>③ 开启 1s 的延迟任务，将数据通过给其他 Nacos 节点。</li></ul><p><strong>说明</strong>：第二件事是 Nacos 和 客户端如何保持数据一致性的，第三件事是 Nacos 集群间如何保持数据一致性的，因本篇重点讲解 Nacos 的 AP 原理，所以会针对第三件事来进行阐述。而第二件事，会在后续文章中重点讲解。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-sync-方法的参数说明">2.2 sync 方法的参数说明<a href="#22-sync-方法的参数说明" class="hash-link" aria-label="2.2 sync 方法的参数说明的直接链接" title="2.2 sync 方法的参数说明的直接链接">​</a></h3><p>首先我们来看下 distroProtocol.sync()，这个方法传了哪些参数：</p><ul><li>第一个参数 new DistroKey()，它里面传了 key 和一个常量。</li></ul><p>key：就是客户端的服务名，示例值如下：</p><div class="language-JAVA codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-JAVA codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">com.alibaba.nacos.naming.iplist.ephemeral.public##DEFAULT_GROUP@@nacos.naming.serviceName</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>INSTANCE_LIST_KEY_PREFIX：就是 com.alibaba.nacos.naming.iplist.</p><p>然后这两个参数组装成一个 DistroKey。</p><ul><li><p>第二个参数是同步数据的类型，这里为 change。</p></li><li><p>第三个参数是同步任务的延迟时间，1s。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-sync-的核心逻辑添加任务">2.3 sync 的核心逻辑：添加任务<a href="#23-sync-的核心逻辑添加任务" class="hash-link" aria-label="2.3 sync 的核心逻辑：添加任务的直接链接" title="2.3 sync 的核心逻辑：添加任务的直接链接">​</a></h3><p>先上一张原理图帮助大家理解，流程图如下所示。核心逻辑分为以下几步。</p><ul><li>遍历其他节点，拿到节点信息。</li><li>判断这个任务在 map 中是否存在，如果存在则合并这个 task。</li><li>如果不存在，则加到 map 中。</li><li>后台线程遍历这个 map，拿到任务。</li></ul><p><img loading="lazy" alt="添加任务到 map 中" src="/zh-cn/assets/images/image-202204282252571448WDN2R-42462ac8e943bbd5c4adb3091a4d92f5.png" width="1584" height="1220" class="img_ev3q"></p><p>代码时序图如下所示：</p><p><img loading="lazy" alt="sync 的核心代码时序图" src="/zh-cn/assets/images/image-20220428225403541nvJwU7-6dbafb24fb8221418e4861725f0c5a53.png" width="1794" height="1184" class="img_ev3q"></p><ul><li><p>第一个类 <code>DistroConsistencyServiceImpl</code> 把实例信息加入 map 中，后续通过 <code>UDP</code>方式推送给客户端。</p></li><li><p>第二个类 <code>DistroProtocol</code> 主要就是<strong>循环遍历</strong>其他节点。</p></li><li><p>第三个类 <code>NacosDelayTaskExecuteEngine</code> 是核心类，创建了一个同步的任务到 <code>ConcurrentHashMap</code> 中。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="24-sync-的核心逻辑后台线程异步复制数据">2.4 sync 的核心逻辑：后台线程异步复制数据<a href="#24-sync-的核心逻辑后台线程异步复制数据" class="hash-link" aria-label="2.4 sync 的核心逻辑：后台线程异步复制数据的直接链接" title="2.4 sync 的核心逻辑：后台线程异步复制数据的直接链接">​</a></h3><p>先说下哈，这个核心逻辑极其复杂，我们看的时候需要抓主线，知道其中几个关键点就可以了。</p><p>悟空在画代码逻辑图的时候，内心是崩溃的，Nacos 为什么写这么复杂啊！<strong>大家不用细看，看了也会懵😳，理解核心步骤就可以了。</strong>（图中有个小细节，我对不同的类进行了颜色区分）</p><p><strong>核心步骤</strong>：</p><ul><li><p>遍历其他节点，创建一个同步的任务，加到 map 中。</p></li><li><p>后台线程不断从 map 中拿到 task，然后移除这个 task。</p></li><li><p>把这个 task 加到一个队列里面。</p></li><li><p>有个 worker 专门从队列里面拿到 task 来执行。</p></li><li><p>这个 task 就是发送 http 请求给其他节点，请求参数中包含注册的实例信息（序列化后的二进制数据）。拼接的请求 url 地址为：</p><div class="language-PHP codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-PHP codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">http://192.168.0.101:8858/nacos/v1/ns/distro/datum</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p>Nacos 异步复制数据到其他节点的流程图如下：</p><p><img loading="lazy" alt="Nacos 异步复制数据到其他节点的流程图" src="/zh-cn/assets/images/image-20220428225545543RA3daf-14e118f236769a94e58ccbb0d578769f.png" width="1964" height="2088" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="25-其他节点如何处理同步请求">2.5 其他节点如何处理同步请求<a href="#25-其他节点如何处理同步请求" class="hash-link" aria-label="2.5 其他节点如何处理同步请求的直接链接" title="2.5 其他节点如何处理同步请求的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="251-如何存储注册信息">2.5.1 如何存储注册信息<a href="#251-如何存储注册信息" class="hash-link" aria-label="2.5.1 如何存储注册信息的直接链接" title="2.5.1 如何存储注册信息的直接链接">​</a></h4><p>处理同步请求的逻辑还是比较简单的，就是把注册信息存起来，然后同步到其他客户端。</p><p>注册信息会存放到一个 <code>datum</code> 中，然后 datum 放到一个 <code>dataStore</code> 中。datum 和 dataStore 的数据结构如下图所示：</p><ul><li><p>datum 包含 value、key、timestamp。value 就是注册的客户端信息（是一个 ArrayList）</p></li><li><p>datastore 是一个 ConcurrentHashMap，包含多个 datum。</p></li></ul><p><img loading="lazy" alt="存储注册信息的数据结构" src="/zh-cn/assets/images/image-20220503170049038UscWkk-cd55bbc171516c637ac9741f3abbadf8.png" width="956" height="1534" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="252-源码分析">2.5.2 源码分析<a href="#252-源码分析" class="hash-link" aria-label="2.5.2 源码分析的直接链接" title="2.5.2 源码分析的直接链接">​</a></h4><p>根据 2.4 讲到的请求的 URL：<code>/nacos/v1/ns/distro/datum</code>，处理这个请求的类为</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">com/alibaba/nacos/naming/controllers/DistroController.java</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>入口方法为 <code>onSyncDatum</code>，里面做的主要事情如下：</p><ul><li><p>① 把实例信息放入到一个 datum 内存中，然后又存放到 DataStore 的结构中，而 DataStore 的本质就是一个 <code>ConcurrentHashMap</code>。</p></li><li><p>② 将注册信息通过 UDP 的方式推送给客户端。</p></li></ul><p><img loading="lazy" alt="服务端处理注册请求的源码" src="/zh-cn/assets/images/image-2022050317065873827D1kB-e5efd3c2d32e81f01a9e6486b4138219.png" width="1052" height="752" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三定时同步如何保持数据一致性">三、定时同步：如何保持数据一致性<a href="#三定时同步如何保持数据一致性" class="hash-link" aria-label="三、定时同步：如何保持数据一致性的直接链接" title="三、定时同步：如何保持数据一致性的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-为什么需要定时同步">3.1 为什么需要定时同步<a href="#31-为什么需要定时同步" class="hash-link" aria-label="3.1 为什么需要定时同步的直接链接" title="3.1 为什么需要定时同步的直接链接">​</a></h3><p>在 Nacos 集群模式下，它作为一个完整的注册中心，必须具有高可用特性。</p><p>在集群模式下，客户端只需要和其中一个 Nacos 节点通信就可以了，但是每个节点其实是包含所有客户端信息的，这样做的好处是每个 Nacos 节点只需要负责自己的客户端就可以（分摊压力），而当客户端想要拉取全量注册表到本地时，从任意节点都可以读取到（数据一致性）。</p><p>那么 Nacos 集群之间是如何通过 Distro 协议来保持数据一致性的呢？ </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-定期检验元数据">3.2 定期检验元数据<a href="#32-定期检验元数据" class="hash-link" aria-label="3.2 定期检验元数据的直接链接" title="3.2 定期检验元数据的直接链接">​</a></h3><p>在版本 v1 中 ，采用的是定期检验元信息的方式。元信息就是当前节点包含的客户端信息的 md5 值。</p><p>检验的原理如下图所示：</p><p><img loading="lazy" src="/zh-cn/assets/images/image-20220504202844197LC6a4x-dbc8fc1cdaf183d6065d6ffcf866aecf.png" width="1840" height="916" class="img_ev3q"></p><blockquote><p>Nacos 各个节点会有一个心跳任务，定期向其他机器发送一次数据检验请求，在校验的过程中，当某个节点发现其他机器上的数据的元信息和本地数据的元信息不一致，则会发起一次全量拉取请求，将数据补齐。</p></blockquote><p>请求 URL:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">//</span><span class="token plain">其他 Nacos 节点的 IP</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nacos</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ns</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">distro</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">checksum?source </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 本机的IP地址</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">本机的端口号</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>参数：DistroData，内部包装的是一个Map&lt;服务名称，服务下实例的验证字符串 checksum&gt;</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-关于版本迭代的说明">3.3 关于版本迭代的说明<a href="#33-关于版本迭代的说明" class="hash-link" aria-label="3.3 关于版本迭代的说明的直接链接" title="3.3 关于版本迭代的说明的直接链接">​</a></h3><p>在版本  v2 中，定期校验数据已经不用了，采用的是<code>健康检查机制</code>，来和其他节点来保持数据的同步，由于涉及的内容还挺多，放到下一讲来专门讲解 Nacos 的健康检查机制：</p><ul><li>客户端与 Nacos 节点的健康检查机制。</li><li>集群模式下的健康检查机制。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四新节点同步机制如何保持数据一致性">四、新节点同步机制，如何保持数据一致性<a href="#四新节点同步机制如何保持数据一致性" class="hash-link" aria-label="四、新节点同步机制，如何保持数据一致性的直接链接" title="四、新节点同步机制，如何保持数据一致性的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-原理">4.1 原理<a href="#41-原理" class="hash-link" aria-label="4.1 原理的直接链接" title="4.1 原理的直接链接">​</a></h3><p>新加入的 Distro 节点会进行全量数据拉取，轮询所有的 Distro 节点，向其他节点发送请求拉取全量数据。</p><p>在全量拉取操作完成之后，每台机器上都维护了当前的所有注册上来的非持久化实例数据。（参考 Nacos 官方图）</p><p><img loading="lazy" src="/zh-cn/assets/images/image-202205042119409621211OU-75ae7efa76db5d7a0feec4b19eeee330.png" width="1578" height="486" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-源码分析">4.2 源码分析<a href="#42-源码分析" class="hash-link" aria-label="4.2 源码分析的直接链接" title="4.2 源码分析的直接链接">​</a></h3><p><code>DistroProtocol</code> 类的构造方法会启动一个同步任务，从其他 Nacos 节点全量拉取非持久化实例数据。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/nacos/core/distributed/distro/DistroProtocol.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    startDistroTask();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        startLoadTask();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/nacos/core/distributed/distro/task/load/DistroLoadDataTask.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loadAllDataSnapshotFromRemote();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="五本地读机制">五、本地读机制<a href="#五本地读机制" class="hash-link" aria-label="五、本地读机制的直接链接" title="五、本地读机制的直接链接">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-原理">5.1 原理<a href="#51-原理" class="hash-link" aria-label="5.1 原理的直接链接" title="5.1 原理的直接链接">​</a></h3><p>每个 Nacos 节点虽然只负责属于自己的客户端，但是每个节点都是包含有所有的客户端信息的，所以当客户端想要查询注册信息时，可以直接从请求的 Nacos 的节点拿到全量数据。（参考 Nacos 官方图）</p><p><img loading="lazy" alt="读操作的原理" src="/zh-cn/assets/images/image-20220504214633683iEtFAd-a40289cdd501202c27d7cc9ced941c8c.png" width="1704" height="728" class="img_ev3q"></p><p>这样设计的好处是保证了高可用（AP），分为两个方面：</p><ul><li>① 读操作都能进行及时的响应，不需要到其他节点拿数据。</li><li>② 当脑裂发生时，Nacos 的节点也能正常返回数据，即使数据可能不一致，当网络恢复时，通过健康检查机制或数据检验也能达到数据一致性。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="六总结">六、总结<a href="#六总结" class="hash-link" aria-label="六、总结的直接链接" title="六、总结的直接链接">​</a></h2><p>本篇通过原理图 + 源码的方式讲解了 Distro 协议的原理，其中又分为几个机制，而这几个机制共同保证了 Nacos 的 AP。</p><p>不足之处，本篇未针对源码的设计进行深入剖析，只是把主线捋出来了。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/blog/1.4.0-release"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">双十一购物节，Nacos 1.4.0 + Go SDK 1.0.1发布</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/csharp-0.5.0"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">Nacos-sdk-csharp 0.5.0正式发布，功能与Java版本对齐！</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#一distro-的设计思想和六大机制" class="table-of-contents__link toc-highlight">一、Distro 的设计思想和六大机制</a></li><li><a href="#二异步复制机制写入数据后如何同步给其他节点" class="table-of-contents__link toc-highlight">二、异步复制机制：写入数据后如何同步给其他节点</a><ul><li><a href="#21-核心入口" class="table-of-contents__link toc-highlight">2.1 核心入口</a></li><li><a href="#22-sync-方法的参数说明" class="table-of-contents__link toc-highlight">2.2 sync 方法的参数说明</a></li><li><a href="#23-sync-的核心逻辑添加任务" class="table-of-contents__link toc-highlight">2.3 sync 的核心逻辑：添加任务</a></li><li><a href="#24-sync-的核心逻辑后台线程异步复制数据" class="table-of-contents__link toc-highlight">2.4 sync 的核心逻辑：后台线程异步复制数据</a></li><li><a href="#25-其他节点如何处理同步请求" class="table-of-contents__link toc-highlight">2.5 其他节点如何处理同步请求</a></li></ul></li><li><a href="#三定时同步如何保持数据一致性" class="table-of-contents__link toc-highlight">三、定时同步：如何保持数据一致性</a><ul><li><a href="#31-为什么需要定时同步" class="table-of-contents__link toc-highlight">3.1 为什么需要定时同步</a></li><li><a href="#32-定期检验元数据" class="table-of-contents__link toc-highlight">3.2 定期检验元数据</a></li><li><a href="#33-关于版本迭代的说明" class="table-of-contents__link toc-highlight">3.3 关于版本迭代的说明</a></li></ul></li><li><a href="#四新节点同步机制如何保持数据一致性" class="table-of-contents__link toc-highlight">四、新节点同步机制，如何保持数据一致性</a><ul><li><a href="#41-原理" class="table-of-contents__link toc-highlight">4.1 原理</a></li><li><a href="#42-源码分析" class="table-of-contents__link toc-highlight">4.2 源码分析</a></li><li><a href="#五本地读机制" class="table-of-contents__link toc-highlight">五、本地读机制</a></li><li><a href="#51-原理" class="table-of-contents__link toc-highlight">5.1 原理</a></li></ul></li><li><a href="#六总结" class="table-of-contents__link toc-highlight">六、总结</a></li></ul></div></div></div></div></div></div>
<script src="/zh-cn/assets/js/runtime~main.3c6f9500.js"></script>
<script src="/zh-cn/assets/js/main.d28718da.js"></script>
</body>
</html>