<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Nacos 1.3.0 全新内核构建过程 | Nacos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://nacos.io/zh-cn/img/nacos_colorful.png"><meta data-rh="true" name="twitter:image" content="https://nacos.io/zh-cn/img/nacos_colorful.png"><meta data-rh="true" property="og:url" content="https://nacos.io/zh-cn/blog/nacos-1.3.0-design"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Nacos 1.3.0 全新内核构建过程 | Nacos"><meta data-rh="true" name="description" content="Nacos 1.3.0 全新内核构建过程"><meta data-rh="true" property="og:description" content="Nacos 1.3.0 全新内核构建过程"><meta data-rh="true" name="keywords" content="nacos1.3.0,内核"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-02-12T00:00:00.000Z"><link data-rh="true" rel="icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"><link data-rh="true" rel="canonical" href="https://nacos.io/zh-cn/blog/nacos-1.3.0-design"><link data-rh="true" rel="alternate" href="https://nacos.io/en/blog/nacos-1.3.0-design" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://nacos.io/zh-cn/blog/nacos-1.3.0-design" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://nacos.io/blog/nacos-1.3.0-design" hreflang="default"><link data-rh="true" rel="alternate" href="https://nacos.io/blog/nacos-1.3.0-design" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://1QV814950M-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Nacos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Nacos Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Nacos" href="/zh-cn/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=nacos">
<meta name="referrer" content="no-referrer">
<link rel="stylesheet" href="//g.alicdn.com/mamba/mse-arc-ui/0.0.21/umd/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/mse-arc-ui/0.0.21/umd/mse-arc-ui.min.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-0YDFJ7LX7F" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.d254cbd7.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.cb902e17.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.3f9f7e5f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>



<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="//hm.baidu.com/hm.js?e3a5cec56ef8619cf9d7c2abebd509e3"></script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="/zh-cn/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh-cn/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a href="https://nacos.io/zh-cn/docs/v2/quickstart/quick-start.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"> </a><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/what-is-nacos" href="/zh-cn/docs/v2/what-is-nacos">2.X（推荐）</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-cn/docs/next/v2/what-is-nacos">用户文档</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v2/what-is-nacos">2.X（推荐）</a></li><li><a class="dropdown__link" href="/zh-cn/docs/1.X/v2/what-is-nacos">1.X</a></li></ul></div><a class="navbar__item navbar__link" href="/zh-cn/cloud">Nacos Cloud</a><a href="https://developer.aliyun.com/ebook/36?spm=a2c6h.20345107.ebook-index.18.152c2984fsi5ST" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">NACOS架构与原理<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a href="http://console.nacos.io/nacos/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/en/blog/nacos-1.3.0-design" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog/nacos-1.3.0-design" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2023">Nacos开源之夏2023，贡献社区赢取12000奖金</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.2.2-release">Nacos 2.2.2发布，优化启动体验和鉴权提示</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.2.1-release">Nacos 多个新版本发布，rust-sdk完全适配完成</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/announcement-token-secret-key">关于Nacos默认token.secret.key及server.identity风险说明及解决方案公告</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/higress">Higress + Nacos 微服务网关最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-reigster-mechanism">Nacos 的一条注册请求会经历什么？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.2.0-release">Nacos 2.2.0 版本发布，新增多种插件支持</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/212-and-220beta-release">Nacos 2.1.2、2.2.0-BETA及go-sdk 2.1.1 版本同时发布，多语言生态再添大将</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.1.1-release">Nacos 四周年，2.1.1 及 1.4.4 版本同时发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos3.0-is-coming">我们总结了3大使用建议，并首次公开 Nacos3.0 规划图 | Nacos 开源4周年</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/xiaomi-scale">小米Nacos2.0扩缩容最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2022">Nacos开源之夏2022，贡献社区赢取12000奖金</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.1.0-release">Nacos 2.1.0版本发布，支持鉴权及加解密插件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/use-nacos-with-rainbond">在 Rainbond 中一键安装高可用 Nacos 集群</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/apisix">Apache APISIX 基于 Nacos 实现服务发现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/up-to-2w-star">双十一献礼 | Nacos Star破两万的回顾与展望</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.0.3-release">Nacos 2.0.3版本发布，继续提升集群稳定性及升级稳定性</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/performance-compare">Nacos 2.0 升级前后性能对比压测</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/springboot-0.2.10">Nacos-spring-boot0.2.10发布，全面支持Nacos2.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2021">Nacos 开源之夏2021活动 报名正式开启</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2.0.1-release">Nacos 2.0.1 + 1.4.2 Release</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/1.4.0-release">双十一购物节，Nacos 1.4.0 + Go SDK 1.0.1发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-distro-mechanism">Nacos 的 Distro 一致性协议</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/csharp-0.5.0">Nacos-sdk-csharp 0.5.0正式发布，功能与Java版本对齐！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-2nd-anniversary">Nacos 两周年献礼，Nacos 1.3.2 + Go SDK 1.0.0发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/feeling-of-ASoC-2019">参与开源，Offer拿到手软 -- 来自一名2019阿里巴巴编程之夏同学的亲述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos 1.2.0 guide">Nacos 1.2.0权限控制介绍和使用</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/zh-cn/blog/nacos-1.3.0-design">Nacos 1.3.0 全新内核构建过程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/namespace-endpoint-best-practices">Namespace,endpoint 最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/pilot mcp">Pilot MCP协议介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos 1.1.4">Nacos 1.1.4发布，业界率先支持Istio MCP协议</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-confd">Nacos整合Confd，支持nginx配置管理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/eureka2">Eureka 2.0 开源工作宣告停止？别担心，ANS 即将 C位强势出道！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos 1.1.0">Nacos 1.1.0发布，支持灰度配置和地址服务器模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-roadmap">Nacos GA后的整体规划</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/cmdb">Nacos打通CMDB实现就近访问</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/address-server">阿里巴巴基于 Nacos 实现环境隔离的实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos1.0.0">Nacos 1.0.0 发布，正式大规模生产可用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.9.0">Nacos 0.9.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.9-intro">Nacos 0.9.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/huya-practice">虎牙直播在微服务改造方面的实践和总结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.8">Nacos 0.8.0版本进行发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/huya-nacos">虎牙直播共建Nacos生态</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/5w1h-where">Nacos 有哪些典型的应用场景？—— 配置管理篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/dynamic-route-zuul-nacos">使用Nacos实现Spring Cloud Zuul的动态路由</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.6">Nacos 0.6版本发布，支持Dubbo生态并且支持Docker部署</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos0.5">Nacos0.5发布，支持DNS-based Service Discovery，JAVA 11</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos">Nacos 0.1.0 版本Review 活动设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/cncf">Nacos 进入CNCF landscape</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/5w1h-what">Nacos 帮我们解决什么问题？—— 配置管理篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/discovery-console">Nacos服务发现控制台预览</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/chengdu-dubbo">Nacos 计划发布v0.2版本，进一步融合Dubbo和SpringCloud生态</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/consul-k8s">Consul与kubernetes整合公告[翻译]</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/dns-sd">微服务架构中基于DNS的服务注册与发现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos-is-coming">支持Dubbo生态发展，阿里巴巴启动新的开源项目 Nacos</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/alibaba-configserver">阿里巴巴服务注册中心产品ConfigServer 10年技术发展回顾</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="Nacos 1.3.0 全新内核构建过程"><meta itemprop="keywords" content="nacos1.3.0,内核"><header><h1 class="title_f1Hy" itemprop="headline">Nacos 1.3.0 全新内核构建过程</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-02-12T00:00:00.000Z" itemprop="datePublished">2020年2月12日</time> · <!-- -->阅读需 35 分钟</div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><a name="0YIG0"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概述">概述<a href="#概述" class="hash-link" aria-label="概述的直接链接" title="概述的直接链接">​</a></h2><p>本次1.3.0的改动程度很大，涉及两大模块的修改以及新增一个核心模块</p><ol><li>nacos-core模块修改<ol><li>nacos集群节点成员寻址模式的统一管理</li><li>nacos内部事件机制</li><li>nacos一致性协议层</li></ol></li><li>nacos-config模块修改<ol><li>新增内嵌分布式数据存储组件</li><li>内嵌存储与外置存储细分</li><li>内嵌存储简单运维</li></ol></li><li>nacos-consistency模块新增<ol><li>对于AP协议以及CP协议的统一抽象</li></ol></li></ol><br><a name="rnkDY"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="系统参数变化">系统参数变化<a href="#系统参数变化" class="hash-link" aria-label="系统参数变化的直接链接" title="系统参数变化的直接链接">​</a></h2><a name="1Gmg9"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="新增">新增<a href="#新增" class="hash-link" aria-label="新增的直接链接" title="新增的直接链接">​</a></h3><table><thead><tr><th align="center"><strong>core模块</strong></th><th>nacos.watch-file.max-dirs</th><th>JVM参数</th><th>最大可监听目录数量</th></tr></thead><tbody><tr><td align="center"></td><td>nacos.core.notify.ring-buffer-size</td><td>JVM参数</td><td>快速通知队列的最大长度</td></tr><tr><td align="center"></td><td>nacos.core.notify.share-buffer-size</td><td>JVM参数</td><td>慢速通知队列的最大长度</td></tr><tr><td align="center"></td><td>nacos.core.member.fail-access-cnt</td><td>JVM参数、application.properties配置</td><td>集群成员节点最大失败访问次数</td></tr><tr><td align="center"></td><td>nacos.core.address-server.retry</td><td>JVM参数、application.properties配置</td><td>地址服务器寻址模式，首次启动请求重试次数</td></tr></tbody></table><br><a name="kxo8O"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos的未来整体逻辑架构及其组件">Nacos的未来整体逻辑架构及其组件<a href="#nacos的未来整体逻辑架构及其组件" class="hash-link" aria-label="Nacos的未来整体逻辑架构及其组件的直接链接" title="Nacos的未来整体逻辑架构及其组件的直接链接">​</a></h2><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1587129046320-5a286f38-8db4-4e76-9b42-8bd859f51a60.png#align=left&amp;display=inline&amp;height=1184&amp;margin=%5Bobject%20Object%5D&amp;name=1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png&amp;originHeight=1184&amp;originWidth=1608&amp;size=279074&amp;status=done&amp;style=none&amp;width=1608" alt="1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png" class="img_ev3q"></p><a name="Hyc6u"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos集群成员节点寻址模式">Nacos集群成员节点寻址模式<a href="#nacos集群成员节点寻址模式" class="hash-link" aria-label="Nacos集群成员节点寻址模式的直接链接" title="Nacos集群成员节点寻址模式的直接链接">​</a></h2><br>在1.3.0之前，nacos的naming模块以及config模块存在各自的集群成员节点列表管理任务。为了统一nacos集群下成员列表的寻址模式，将集群节点管理的实现从naming模块以及config模块剥离出来，统一下沉到了core模块的寻址模，同时新增命令行参数 **-Dnacos.member.list **进行设置nacos集群节点列表，该参数可以看作是cluster.conf文件的一个替代。目前nacos的寻址模式类别如下<ol><li>单机模式下：StandaloneMemberLookup</li><li>集群模式<ol><li>cluster.conf文件存在：FileConfigMemberLookup</li><li>cluster.conf文件不存在或者 -Dnacos.member.list没有设置：AddressServerMemberLookup</li></ol></li></ol><p>如果说想指定某一种寻址模式，则设置此参数：<strong>nacos.core.member.lookup.type=<!-- -->[file,address-server]</strong></p><p>逻辑图如下
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/e209a677aa8b5ffce23589e987ee5129.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJMb29rdXBGYWN0b3J5LmluaXQoKVwiXG5cbmlmIFwic3RhbmRhbG9uZSBtb2RlXCIgdGhlblxuICAtLT5bdHJ1ZV0gXCJyZXR1cm4gU3RhbmRhbG9uZU1lbWJlckxvb2t1cFwiXG4gIC0tPiBMb29rdXAucnVuKClcbmVsc2VcbiBpZiBcImNsdXN0ZXIuY29uZiBleGlzdHNcIiB0aGVuXG4gICAgLS0-W3RydWVdIFwicmV0dXJuIEZpbGVDb25maWdNZW1iZXJMb29rdXBcIlxuICAgIC0tPiBMb29rdXAucnVuKClcbiBlbHNlXG4gICAgLT5bZmFsc2VdIFwicmV0dXJuIEFkZHJlc3NTZXJ2ZXJNZW1iZXJMb29rdXBcIlxuICAgIC0tPiBMb29rdXAucnVuKClcbiBlbmRpZlxuZW5kaWZcblxuLS0-ICgqKVxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJpZCI6IlplWGtkIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC9lMjA5YTY3N2FhOGI1ZmZjZTIzNTg5ZTk4N2VlNTEyOS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" class="img_ev3q"></p><a name="wqkMp"></a>### 寻址模式详细 接下来介绍除了单机模式下的寻址模式的其他两种寻址模式<br><a name="egl3H"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fileconfigmemberlookup">FileConfigMemberLookup<a href="#fileconfigmemberlookup" class="hash-link" aria-label="FileConfigMemberLookup的直接链接" title="FileConfigMemberLookup的直接链接">​</a></h4><p>该寻址模式是基于cluster.conf文件进行管理的，每个节点会读取各自${nacos.home}/conf下的cluster.conf文件内的成员节点列表，然后组成一个集群。并且在首次读取完${nacos.home}/conf下的cluster.conf文件后，会自动向操作系统的<em><strong>inotify</strong></em>机制注册一个目录监听器，监听${nacos.home}/conf目录下的所有文件变动（注意，这里只会监听文件，对于子目录下的文件变动无法监听）<br>当需要进行集群节点扩缩容时，需要手动去修改每个节点各自${nacos.home}/conf下的cluster.conf的成员节点列表内容。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private FileWatcher watcher = new FileWatcher() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void onChange(FileChangeEvent event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            readClusterConfFromDisk();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public boolean interest(String context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return StringUtils.contains(context, &quot;cluster.conf&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void start() throws NacosException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readClusterConfFromDisk();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (memberManager.getServerList().isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NacosException(NacosException.SERVER_ERROR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;Failed to initialize the member node, is empty&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Use the inotify mechanism to monitor file changes and automatically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // trigger the reading of cluster.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WatchFileCenter.registerWatcher(ApplicationUtils.getConfFilePath(), watcher);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Loggers.CLUSTER.error(&quot;An exception occurred in the launch file monitor : {}&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>首次启动时直接读取cluster.conf文件内的节点列表信息，然后向WatchFileCenter注册一个目录监听器，当cluster.conf文件发生变动时自动触发<em><strong>readClusterConfFromDisk()</strong></em>重新读取cluster.conf文件<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014354207-49c1e934-2aa5-465a-8a2b-0b09902814f8.png#align=left&amp;display=inline&amp;height=531&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=531&amp;originWidth=1169&amp;size=105696&amp;status=done&amp;style=none&amp;width=1169" alt="image.png" class="img_ev3q"></p><a name="yFTCl"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="addressservermemberlookup">AddressServerMemberLookup<a href="#addressservermemberlookup" class="hash-link" aria-label="AddressServerMemberLookup的直接链接" title="AddressServerMemberLookup的直接链接">​</a></h4><p>该寻址模式是基于一个额外的web服务器来管理cluster.conf，每个节点定期向该web服务器请求cluster.conf的文件内容，然后实现集群节点间的寻址，以及扩缩容。<br>当需要进行集群扩缩容时，只需要修改cluster.conf文件即可，然后每个节点向地址服务器请求时会自动的得到最新的cluster.conf文件内容。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void start() throws NacosException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (start.compareAndSet(false, true)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.maxFailCount = Integer.parseInt(ApplicationUtils.getProperty(&quot;maxHealthCheckFailCount&quot;, &quot;12&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        initAddressSys();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void initAddressSys() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String envDomainName = System.getenv(&quot;address_server_domain&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isBlank(envDomainName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        domainName = System.getProperty(&quot;address.server.domain&quot;, &quot;jmenv.tbsite.net&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        domainName = envDomainName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String envAddressPort = System.getenv(&quot;address_server_port&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isBlank(envAddressPort)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addressPort = System.getProperty(&quot;address.server.port&quot;, &quot;8080&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addressPort = envAddressPort;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addressUrl = System.getProperty(&quot;address.server.url&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ApplicationUtils.getContextPath() + &quot;/&quot; + &quot;serverlist&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addressServerUrl = &quot;http://&quot; + domainName + &quot;:&quot; + addressPort + addressUrl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    envIdUrl = &quot;http://&quot; + domainName + &quot;:&quot; + addressPort + &quot;/env&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Loggers.CORE.info(&quot;ServerListService address-server port:&quot; + addressPort);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Loggers.CORE.info(&quot;ADDRESS_SERVER_URL:&quot; + addressServerUrl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SuppressWarnings(&quot;PMD.UndefineMagicConstantRule&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void run() throws NacosException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // With the address server, you need to perform a synchronous member node pull at startup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Repeat three times, successfully jump out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean success = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Throwable ex = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int maxRetry = ApplicationUtils.getProperty(&quot;nacos.core.address-server.retry&quot;, Integer.class, 5);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; maxRetry; i ++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            syncFromAddressUrl();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            success = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ex = e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Loggers.CLUSTER.error(&quot;[serverlist] exception, error : {}&quot;, ExceptionUtil.getAllExceptionMsg(ex));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!success) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NacosException(NacosException.SERVER_ERROR, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GlobalExecutor.scheduleByCommon(new AddressServerSyncTask(), 5_000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在初始化时，会主动去向地址服务器同步当前的集群成员列表信息，如果失败则进行重试，其最大重试次数可通过设置<em><strong>nacos.core.address-server.retry</strong></em>来控制，默认是5次，然后成功之后，将创建定时任务去向地址服务器同步集群成员节点信息<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014362972-004f5338-af0d-4d0d-b769-4f3d5118c08a.png#align=left&amp;display=inline&amp;height=846&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=846&amp;originWidth=1149&amp;size=188886&amp;status=done&amp;style=none&amp;width=1149" alt="image.png" class="img_ev3q"></p><a name="sgOTI"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="节点管理和寻址模式如何结合的">节点管理和寻址模式如何结合的<a href="#节点管理和寻址模式如何结合的" class="hash-link" aria-label="节点管理和寻址模式如何结合的的直接链接" title="节点管理和寻址模式如何结合的的直接链接">​</a></h3><p><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014400580-39b83aa0-c548-4241-a49e-0d72abda2a95.png#align=left&amp;display=inline&amp;height=715&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=715&amp;originWidth=1189&amp;size=131826&amp;status=done&amp;style=none&amp;width=1189" alt="image.png" class="img_ev3q"><br>MemberLookup在启动之后，会根据不同的寻址模式，执行寻址任务，将收集到集群节点列表信息，调用memberChange，触发集群节点变动，然后发布节点变更事件</p><a name="idHpC"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos一致性协议协议层抽象">Nacos一致性协议协议层抽象<a href="#nacos一致性协议协议层抽象" class="hash-link" aria-label="Nacos一致性协议协议层抽象的直接链接" title="Nacos一致性协议协议层抽象的直接链接">​</a></h2><p>从nacos的未来的整体架构图可以看出，一致性协议层将是作为nacos的最为核心的模块，将服务于构建在core模块之上的各个功能模块，或者服务与core模块本身。而一致性协议因为分区容错性的存在，需要在可用性与一致性之间做选择，因此就存在两大类一致性：最终一致性和强一致性。在nacos中，这两类一致性协议都是可能用到的，比如naming模块，对于服务实例的数据管理分别用到了AP以及CP，而对于config模块，将会涉及使用CP。同时还有如下几个功能需求点</p><ol><li>目前持久化服务使用用了变种版本的raft，并且业务和raft协议耦合，因此需要抽离解耦，同时是选择一个标准的Java版Raft实现</li><li>对于中小用户，配置基本其实不会超级多，独立一个mysql，相对重一些，需要一个轻量化的存储方案，并且支持2.0不依赖mysql和3.0依赖mysql可配置能力</li><li>由于CP或者AP，其存在多种实现，如何对一致性协议层做一次很好的抽象，以便将来可以快速的实现底层一致性协议具体实现的替换，比如Raft协议，目前nacos的选型是JRaft，不排除将来nacos会自己实现一个标准raft协议或者实现Paxos协议</li><li>由于Nacos存在多个独立工作的功能模块，每个功能模块之间不能出现影响，比如A模块处理请求过慢或者出现异常时，不能影响B模块的正常工作，即每个功能模块在使用一致性协议时，如何将每个模块的数据处理进行隔离？</li></ol><p>根据一致协议以及上述功能需求点，本次做了一个抽象的一致协议层以及相关的接口</p><a name="3w8xM"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="一致协议抽象">一致协议抽象<a href="#一致协议抽象" class="hash-link" aria-label="一致协议抽象的直接链接" title="一致协议抽象的直接链接">​</a></h3><a name="p7zRo"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="consistencyprotocol">ConsistencyProtocol<a href="#consistencyprotocol" class="hash-link" aria-label="ConsistencyProtocol的直接链接" title="ConsistencyProtocol的直接链接">​</a></h4><p>所谓一致性，即多个副本之间是否能够保持一致性的特性，而副本的本质就是数据，对数据的操作，不是获取就是修改。同时，一致协议其实是针对分布式情况的，而这必然涉及多个节点，因此，需要有相应的接口能够调整一致性协议的协同工作节点。如果我们要观察一致性协议运行的情况，该怎么办？比如Raft协议，我们希望得知当前集群中的Leader是谁，任期的情况，当前集群中的成员节点有谁？因此，还需要提供一个一致性协议元数据获取。<br>综上所述，ConsistencyProtcol的大致设计可以出来了</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface ConsistencyProtocol&lt;T extends Config, P extends LogProcessor&gt; extends CommandOperations {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Consistency protocol initialization: perform initialization operations based on the incoming Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 一致性协议初始化，根据 Config 实现类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param config {@link Config}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void init(T config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Add a log handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param processors {@link LogProcessor}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void addLogProcessors(Collection&lt;P&gt; processors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Copy of metadata information for this consensus protocol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 该一致性协议的元数据信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return metaData {@link ProtocolMetaData}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ProtocolMetaData protocolMetaData();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Obtain data according to the request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return data {@link Response}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Response getData(GetRequest request) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Get data asynchronously</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return data {@link CompletableFuture&lt;Response&gt;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CompletableFuture&lt;Response&gt; aGetData(GetRequest request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Data operation, returning submission results synchronously</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 同步数据提交，在 Datum 中已携带相应的数据操作信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data {@link Log}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return submit operation result {@link Response}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Response submit(Log data) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Data submission operation, returning submission results asynchronously</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 异步数据提交，在 Datum 中已携带相应的数据操作信息，返回一个Future，自行操作，提交发生的异常会在CompleteFuture中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data {@link Log}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return {@link CompletableFuture&lt;Response&gt;} submit result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception when submit throw Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CompletableFuture&lt;Response&gt; submitAsync(Log data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * New member list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 新的成员节点列表，一致性协议自行处理相应的成员节点是加入还是离开</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param addresses [ip:port, ip:port, ...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void memberChange(Set&lt;String&gt; addresses);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Consistency agreement service shut down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 一致性协议服务关闭</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而针对CP协议，由于存在Leader的概念，因此需要提供一个方法用于获取CP协议当前的Leader是谁</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface CPProtocol&lt;C extends Config&gt; extends ConsistencyProtocol&lt;C&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Returns whether this node is a leader node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param group business module info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return is leader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isLeader(String group) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="oJFpB"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="数据操作请求提交对象loggetrequest">数据操作请求提交对象：Log、GetRequest<a href="#数据操作请求提交对象loggetrequest" class="hash-link" aria-label="数据操作请求提交对象：Log、GetRequest的直接链接" title="数据操作请求提交对象：Log、GetRequest的直接链接">​</a></h4><p>上面说到，一致性协议其实是对于数据操作而言的，数据操作基本分为两大类：数据查询以及数据修改，同时还要满足不同功能模块之间的数据进行隔离。因此这里针对数据修改操作以及数据查询操作分别阐述。</p><ol><li>数据修改<ol><li>数据修改操作，一定要知道本次请求是属于哪一个功能模块的</li><li>数据修改操作，首先一定要知道这个数据的修改操作具体是哪一种修改操作，方便功能模块针对真正的数据修改操作进行相应的逻辑操作</li><li>数据修改操作，一定要知道修改的数据是什么，即请求体，为了使得一致性协议层更为通用，这里对于请求体的数据结构，选择了byte[]数组</li><li>数据的类型，由于我们将真正的数据序列化为了byte[]数组，为了能够正常序列化，我们可能还需要记录这个数据的类型是什么</li><li>本次请求的信息摘要或者标识信息</li><li>本次请求的额外信息，用于将来扩展需要传输的数据</li></ol></li></ol><p>综上，可以得出Log对象的设计如下</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">message Log {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 功能模块分组信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string group = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 摘要或者标识</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string key = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 具体请求数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes data = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string type = 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 更为具体的数据操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string operation = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 额外信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map&lt;string, string&gt; extendInfo = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>数据查询<ol><li>数据查询操作，一定要知道本次请求是由哪一个功能模块发起的</li><li>数据查询的条件是什么，为了兼容各种存储结构的数据查询操作，这里用byte[]进行存储</li><li>本次请求的额外信息，用于将来扩展需要传输的数据</li></ol></li></ol><p>综上，可以得出GetRequest对象的设计如下</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">message GetRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 功能模块分组信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string group = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 具体请求数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes data = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 额外信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map&lt;string, string&gt; extendInfo = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="vBig4"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="功能模块使用一致性协议logprocessor">功能模块使用一致性协议：LogProcessor<a href="#功能模块使用一致性协议logprocessor" class="hash-link" aria-label="功能模块使用一致性协议：LogProcessor的直接链接" title="功能模块使用一致性协议：LogProcessor的直接链接">​</a></h4><p>当数据操作通过一致性协议进行submit之后，每个节点需要去处理这个Log或者GetRequest对象，因此，我们需要抽象出一个Log、GetRequest对象的Processor，不同的功能模块通过实现该处理器，ConsistencyProtocol内部会根据Log、GetRequest的group属性，将Log、GetRequest对象路由到具体的Processor，当然，Processor也需要表明自己是属于哪一个功能模块的。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class LogProcessor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * get data by key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request request {@link GetRequest}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return target type data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract Response onRequest(GetRequest request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Process Submitted Log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param log {@link Log}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return {@link boolean}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract Response onApply(Log log);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Irremediable errors that need to trigger business price cuts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param error {@link Throwable}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onError(Throwable error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * In order for the state machine that handles the transaction to be able to route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * the Log to the correct LogProcessor, the LogProcessor needs to have an identity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return Business unique identification name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract String group();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>针对CP协议，比如Raft协议，存在快照的设计，因此我们需要针对CP协议单独扩展出一个方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class LogProcessor4CP extends LogProcessor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Discovery snapshot handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * It is up to LogProcessor to decide which SnapshotOperate should be loaded and saved by itself</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return {@link List &lt;SnapshotOperate&gt;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;SnapshotOperation&gt; loadSnapshotOperate() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Collections.emptyList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="zbsAE"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="综述">综述<a href="#综述" class="hash-link" aria-label="综述的直接链接" title="综述的直接链接">​</a></h4><p>从上面这几点可以看出来，ConsistencyProtocol是对上层功能模块暴露出来的使用接口，每个ConsistencyProtocol后面有具体的一致性协议实现的Backend，由于Backend无法很好的兼容nacos现有的架构设计，因此额外设计的LogProcessor就是为了解决这个问题。<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015048030-8a4bff4a-20ed-46dd-a7f7-98655b22946f.png#align=left&amp;display=inline&amp;height=591&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=591&amp;originWidth=886&amp;size=93327&amp;status=done&amp;style=none&amp;width=886" alt="image.png" class="img_ev3q"><br>同时，由于在一致性协议层内部的Backend中需要实现对不同业务模块的数据进行隔离处理，而这个一块逻辑由请求对象和LogProcessor的group属性来实现<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015155835-a897262e-8e57-409c-bf94-d57bf765c80b.png#align=left&amp;display=inline&amp;height=591&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=591&amp;originWidth=910&amp;size=118083&amp;status=done&amp;style=none&amp;width=910" alt="image.png" class="img_ev3q"></p><a name="C1yU6"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="一致性协议层工作流程">一致性协议层工作流程<a href="#一致性协议层工作流程" class="hash-link" aria-label="一致性协议层工作流程的直接链接" title="一致性协议层工作流程的直接链接">​</a></h3><p>我们可以通过一个时序图看看，一致性协议层的大致工作流程
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/30b7e270e7aef8bb63136aaffbe5bfbf.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbnBhcnRpY2lwYW50IFwiTWVtYmVyTWFuYWdlclwiIGFzIE5hY29zQ2x1c3RlclxucGFydGljaXBhbnQgXCJCdXNpbmVzc01vZHVsZVwiIGFzIEJpelxucGFydGljaXBhbnQgXCJDb25zaXN0ZW5jeVByb3RvY29sXCIgYXMgUHJvdG9jb2xcbnBhcnRpY2lwYW50IFwiQ0FQQmFja2VuZFwiIGFzIEJhY2tlbmRcbnBhcnRpY2lwYW50IFwiQ29uZmlnXCIgYXMgQ29uZmlnXG5wYXJ0aWNpcGFudCBcIkxvZ1Byb2Nlc3NvclwiIGFzIFByb2Nlc3NvclxucGFydGljaXBhbnQgXCJMb2dcIiBhcyBMb2dcblxuYWN0aXZhdGUgTmFjb3NDbHVzdGVyXG5OYWNvc0NsdXN0ZXIgLT4gTmFjb3NDbHVzdGVyOiBpbml0KCkg5Yid5aeL5YyWTmFjb3Ppm4bnvqRcblxuTmFjb3NDbHVzdGVyIC0-IENvbmZpZzog6I635Y-WQ29uZmln5a-56LGhXG5hY3RpdmF0ZSBDb25maWdcbkNvbmZpZyAtPiBDb25maWc6IOaUtumbhkxvZ1Byb2Nlc3NvcueahOS_oeaBr1xuQ29uZmlnIC0-IE5hY29zQ2x1c3RlclxuZGVhY3RpdmF0ZSBDb25maWdcblxuXG5OYWNvc0NsdXN0ZXIgLT4gUHJvdG9jb2w6IOiOt-WPluaJgOaciUNvbnNpc3RlbmN5UHJvdG9jb2zlrp7njrBcbmFjdGl2YXRlIFByb3RvY29sXG5cbk5hY29zQ2x1c3RlciAtPiBQcm90b2NvbDogaW5pdChDb25maWcpIOaWueazleaJp-ihjFxuXG5kZWFjdGl2YXRlIFByb3RvY29sXG5kZWFjdGl2YXRlIE5hY29zQ2x1c3RlclxuXG5cbkJpeiAtPiBMb2c6IOWIm-W7uuS4gOS4quS6i-WKoeWvueixoVxuYWN0aXZhdGUgQml6XG5hY3RpdmF0ZSBMb2dcblxuXG5Mb2cgLT4gTG9nOiDorr7nva5kYXRhXG5Mb2cgLT4gTG9nOiDorr7nva5rZXlcbkxvZyAtPiBMb2c6IOiuvue9rmNsYXNzTmFtZVxuTG9nIC0-IExvZzog6K6-572uZXh0ZW5kSW5mb1xuTG9nIC0-IEJpelxuZGVhY3RpdmF0ZSBMb2dcblxuQml6IC0-IFByb3RvY29sOiBzdWJtaXQoTG9nKSDosIPnlKjkuIDoh7TmgKfljY_orq7ov5vooYzkuovliqHmj5DkuqRcbmFjdGl2YXRlIFByb3RvY29sXG5cblByb3RvY29sIC0-IEJhY2tlbmQ6IOWGhemDqOS4gOiHtOaAp-WNj-iuruW3peS9nFxuYWN0aXZhdGUgQmFja2VuZFxuXG5CYWNrZW5kIC0-IFByb3RvY29sOiDov5Tlm57lt6XkvZzlpITnkIbnu5PmnpxcbmRlYWN0aXZhdGUgQmFja2VuZFxuXG5Qcm90b2NvbCAtPiBQcm9jZXNzb3I6IOWwhkxvZ-WIhuWPkeWIsOWvueW6lOeahFByb2Nlc3Nvcu-8jOiwg-eUqCBvbkFwcGx5IOaWueazlVxuYWN0aXZhdGUgUHJvdG9jb2xcbmRlYWN0aXZhdGUgUHJvdG9jb2xcblxuUHJvY2Vzc29yIC0-IEJpejog5LqL5Yqh5o-Q5Lqk57uT5p6cXG5cbmRlYWN0aXZhdGUgUHJvY2Vzc29yXG5kZWFjdGl2YXRlIEJpelxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiNFZpMkwiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzMwYjdlMjcwZTdhZWY4YmI2MzEzNmFhZmZiZTViZmJmLnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=" class="img_ev3q"></p><a name="xtBNU"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nacos一致性协议层之cp协议的实现选择jraft">Nacos一致性协议层之CP协议的实现选择——JRaft<a href="#nacos一致性协议层之cp协议的实现选择jraft" class="hash-link" aria-label="Nacos一致性协议层之CP协议的实现选择——JRaft的直接链接" title="Nacos一致性协议层之CP协议的实现选择——JRaft的直接链接">​</a></h3><p>一致性协议层抽象好之后，剩下就是具体一致性协议实现的选择了，这里我们选择了蚂蚁金服开源的JRaft，那么我们如何将JRaft作为CP协议的一个Backend呢？下面的简单流程图描述了当JRaft作为CP协议的一个Backend时的初始化流程</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * A concrete implementation of CP protocol: JRaft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;pre&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                                           ┌──────────────────────┐               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                                           │                      │               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *            ┌──────────────────────┐       │                      ▼               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *            │   ProtocolManager    │       │        ┌───────────────────────────┐ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *            └──────────────────────┘       │        │for p in [LogProcessor4CP] │ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │        └───────────────────────────┘ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │                      │               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      ┌──────────────────────────────────┐ │                      ▼               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      │    discovery LogProcessor4CP     │ │             ┌─────────────────┐      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *      └──────────────────────────────────┘ │             │  get p.group()  │      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │             └─────────────────┘      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │                      │               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                 ┌─────────────┐           │                      │               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                 │ RaftConfig  │           │                      ▼               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                 └─────────────┘           │      ┌──────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │      │  create raft group service   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │      └──────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *              ┌──────────────────┐         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *              │  JRaftProtocol   │         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *              └──────────────────┘         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                     init()                │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *               ┌─────────────────┐         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *               │   JRaftServer   │         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *               └─────────────────┘         │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        ▼                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *             ┌────────────────────┐        │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *             │JRaftServer.start() │        │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *             └────────────────────┘        │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        │                  │                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                        └──────────────────┘                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;/pre&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author &lt;a href=&quot;mailto:liaochuntao@live.com&quot;&gt;liaochuntao&lt;/a&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>JRaftProtocol是当JRaft作为CP协议的Backend时的一个ConsistencyProtocol的具体实现，其内部有一个JRaftServer成员属性，JRaftServer分装了JRaft的各种API操作，比如数据操作的提交，数据的查询，成员节点的变更，Leader节点的查询等等。</p><p><em><strong>注意事项：JRaft运行期间产生的数据在${nacos.home}/data/protocol/raft文件目录下。不同的业务模块有不同的文件分组，如果当节点出现crash或者异常关闭时，清空该目录下的文件，重启节点即可</strong></em></p><p>由于JRaft实现了raft group的概念，因此，完全可以利用raft group的设计，为每个功能模块单独创建一个raft group。这里给出部分代码，该代码体现了如何将LogProcessor嵌入到状态机中并为每个LogPrcessor创建一个Raft Group</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">synchronized void createMultiRaftGroup(Collection&lt;LogProcessor4CP&gt; processors) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // There is no reason why the LogProcessor cannot be processed because of the synchronization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!this.isStarted) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.processors.addAll(processors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String parentPath = Paths</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .get(ApplicationUtils.getNacosHome(), &quot;data/protocol/raft&quot;).toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (LogProcessor4CP processor : processors) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String groupName = processor.group();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (multiRaftGroup.containsKey(groupName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new DuplicateRaftGroupException(groupName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Ensure that each Raft Group has its own configuration and NodeOptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Configuration configuration = conf.copy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NodeOptions copy = nodeOptions.copy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JRaftUtils.initDirectory(parentPath, groupName, copy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Here, the LogProcessor is passed into StateMachine, and when the StateMachine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // triggers onApply, the onApply of the LogProcessor is actually called</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NacosStateMachine machine = new NacosStateMachine(this, processor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        copy.setFsm(machine);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        copy.setInitialConf(configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Set snapshot interval, default 1800 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int doSnapshotInterval = ConvertUtils.toInt(raftConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getVal(RaftSysConstants.RAFT_SNAPSHOT_INTERVAL_SECS),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    RaftSysConstants.DEFAULT_RAFT_SNAPSHOT_INTERVAL_SECS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If the business module does not implement a snapshot processor, cancel the snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doSnapshotInterval = CollectionUtils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .isEmpty(processor.loadSnapshotOperate()) ? 0 : doSnapshotInterval;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        copy.setSnapshotIntervalSecs(doSnapshotInterval);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Loggers.RAFT.info(&quot;create raft group : {}&quot;, groupName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RaftGroupService raftGroupService = new RaftGroupService(groupName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    localPeerId, copy, rpcServer, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Because RpcServer has been started before, it is not allowed to start again here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Node node = raftGroupService.start(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        machine.setNode(node);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RouteTable.getInstance().updateConfiguration(groupName, configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RaftExecutor.executeByCommon(() -&gt; registerSelfToCluster(groupName, localPeerId, configuration));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Turn on the leader auto refresh for this group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Random random = new Random();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long period = nodeOptions.getElectionTimeoutMs() + random.nextInt(5 * 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RaftExecutor.scheduleRaftMemberRefreshJob(() -&gt; refreshRouteTable(groupName),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    nodeOptions.getElectionTimeoutMs(), period, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        multiRaftGroup.put(groupName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new RaftGroupTuple(node, processor, raftGroupService, machine));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="4czvB"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="疑问解答为什么要创建多个raft-group">疑问解答：为什么要创建多个raft group<a href="#疑问解答为什么要创建多个raft-group" class="hash-link" aria-label="疑问解答：为什么要创建多个raft group的直接链接" title="疑问解答：为什么要创建多个raft group的直接链接">​</a></h4><p>或许有的人会有疑问，既然之前已经设计出了LogProcessor，完全可以利用一个Raft Group，在状态机appl时，根据Log的group属性进行路由到不同的LogProcessor即可，每个功能模块就创建一个raft group，不是会消耗大量的资源吗？<br>正如之前所说，我们希望独立工作的模块之间相互不存在影响，比如A模块处理Log因为存在Block操作可能使得apply的速度缓慢，亦或者可能中途发生异常，对于Raft协议来说，当日志apply失败时，状态机将不能够继续向前推进，因为如果继续向前推进的话，由于上一步的apply失败，后面的所有apply都可能失败，将会导致这个节点的数据与其他节点的数据永远不一致。如果说我们将所有独立工作的模块，对于数据操作的请求处理放在同一个raft group，即一个状态机中，就不可避免的会出现上述所说的问题，某个模块在apply日志发生不可控的因素时，会影响其他模块的正常工作。</p><a name="2GyRw"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="jraft运维操作">JRaft运维操作<a href="#jraft运维操作" class="hash-link" aria-label="JRaft运维操作的直接链接" title="JRaft运维操作的直接链接">​</a></h3><p>为了使用者能够对JRaft进行相关简单的运维，比如Leader的切换，重置当前Raft集群成员，触发某个节点进行Snapshot操作等等，提供了一个简单的HTTP接口进行操作，并且该接口有一定的限制，即每次只会执行一条运维指令</p><p>1、切换某一个Raft Group的Leader节点</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;transferLeader&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port} or ip:{raft_port},ip:{raft_port},ip:{raft_port}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="Fs7VE"></a><p>2、重置某一个Raft Group的集群成员</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;resetRaftCluster&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port},ip:{raft_port},ip:{raft_port},ip:{raft_port}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意，该操作是一个高危操作，仅仅当Raft集群的 n/2 + 1节点crash之后无法满足过半投票的要求才可以使用该运维命令，用于快速让当前剩余的节点重组Raft集群，对外提供服务，但是这个操作很大程度会造成数据的丢失<br></p><a name="VfG5T"></a><p>3、触发某一个Raft Group执行快照操作</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;doSnapshot&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="m9LfI"></a><p>4、移除某一个Raft Group中的某一成员</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;removePeer&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="ev3MW"></a><p>5、批量移除某一个Raft Group中的多个成员</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /nacos/v1/core/ops/raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;groupId&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;command&quot;: &quot;removePeers&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: &quot;ip:{raft_port},ip:{raft_port},ip:{raft_port},...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="GzMuP"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="jraft协议相关配置参数">JRaft协议相关配置参数<a href="#jraft协议相关配置参数" class="hash-link" aria-label="JRaft协议相关配置参数的直接链接" title="JRaft协议相关配置参数的直接链接">​</a></h3><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">### Sets the Raft cluster election timeout, default value is 5 second</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.election_timeout_ms=5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### Sets the amount of time the Raft snapshot will execute periodically, default is 30 minute</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.snapshot_interval_secs=30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### Requested retries, default value is 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.request_failoverRetries=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### raft internal worker threads</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.core_thread_num=8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### Number of threads required for raft business request processing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.cli_service_thread_num=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### raft linear read strategy, defaults to index</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.read_index_type=ReadOnlySafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### rpc request timeout, default 5 seconds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.core.protocol.raft.data.rpc_request_timeout_ms=5000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="线性读参数解析">线性读参数解析<a href="#线性读参数解析" class="hash-link" aria-label="线性读参数解析的直接链接" title="线性读参数解析的直接链接">​</a></h4><ol><li><strong>ReadOnlySafe</strong><ol><li>该线性读模式，每次Follower进行读请求时，需要和Leader同步日志提交位点信息，而Leader，需要向过半的Follower发起证明自己是Leader的轻量的RPC请求，相当于一个Follower读，至少需要1 + （n/2）+ 1 次的RPC请求。</li></ol></li><li><strong>ReadOnlyLeaseBased</strong><ol><li>该线性读模式，每次Follower进行读请求时，Leader只需要判断自己的Leader租约是否过期了，如果没有过期，直接可以回复Follower自己是Leader，但是该机制对于机器时钟要求很严格，如果有做时钟同步的话，可以考虑使用该线性读模式。</li></ol></li></ol><a name="WiLDa"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos内嵌分布式id">Nacos内嵌分布式ID<a href="#nacos内嵌分布式id" class="hash-link" aria-label="Nacos内嵌分布式ID的直接链接" title="Nacos内嵌分布式ID的直接链接">​</a></h2><p>nacos内嵌的分布式ID为Snakeflower，dataCenterId默认为1，workerId的值计算方式如下</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">InetAddress address;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">try </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    address = InetAddress.getLocalHost();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> catch (final UnknownHostException e) </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new IllegalStateException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;Cannot get LocalHost InetAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> please check your network</span><span class="token tag" style="color:#00009f">!</span><span class="token plain">&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> ipAddressByteArray = address.getAddress();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">workerId = (((ipAddressByteArray</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ipAddressByteArray.length </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> &amp; 0B11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;&lt; Byte.SIZE) + (ipAddressByteArray</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ipAddressByteArray.length </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &amp; 0xFF));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果需要手动指定dataCenterId以及workerId，则在application.properties或者启动时添加命令行参数</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">### set the dataCenterID manually</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># nacos.core.snowflake.data-center=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### set the WorkerID manually</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># nacos.core.snowflake.worker-id=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="ZLp5w"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos内嵌的轻量的基于derby的分布式关系型存储">Nacos内嵌的轻量的基于Derby的分布式关系型存储<a href="#nacos内嵌的轻量的基于derby的分布式关系型存储" class="hash-link" aria-label="Nacos内嵌的轻量的基于Derby的分布式关系型存储的直接链接" title="Nacos内嵌的轻量的基于Derby的分布式关系型存储的直接链接">​</a></h2><a name="1B5KV"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h3><ol><li>如果配置文件数量较少，在集群模式下需要高可用数据库集群作为支撑的成本太大，期望有一个轻量的分布式关系型存储来解决</li><li>nacos内部一些元数据信息存储，比如用户信息，命名空间信息</li><li>思路来源：<a href="https://github.com/rqlite/rqlite" target="_blank" rel="noopener noreferrer">https://github.com/rqlite/rqlite</a></li></ol><a name="Du2qc"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="设计思路">设计思路<a href="#设计思路" class="hash-link" aria-label="设计思路的直接链接" title="设计思路的直接链接">​</a></h3><a name="NzxHa"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="目标">目标<a href="#目标" class="hash-link" aria-label="目标的直接链接" title="目标的直接链接">​</a></h4><p>设计目标，是期望nacos存在两种数据存储模式，一种是现在的方式，数据存储在外置数据源（关系型数据库）；第二种方式是内嵌存储数据源（Apache Derby）。用户能够使用命令行参数配置的方式，随意使用这两种数据存储模式<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015542106-f14d2579-229f-4bfb-a432-e40854e65d6d.png#align=left&amp;display=inline&amp;height=903&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=903&amp;originWidth=1514&amp;size=237497&amp;status=done&amp;style=none&amp;width=1514" alt="image.png" class="img_ev3q"></p><a name="LqUtU"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="总体">总体<a href="#总体" class="hash-link" aria-label="总体的直接链接" title="总体的直接链接">​</a></h4><p>将一次请求操作涉及的SQL上下文按顺序保存起来。然后通过一致协议层将本次请求涉及的SQL上下文进行同步，然后每个节点将其解析并重新按顺序在一次数据库会话中执行。<br><img loading="lazy" src="https://cdn.nlark.com/yuque/0/2020/png/333972/1587204104465-2270480a-de25-4c84-a11b-6edd2de99e66.png#align=left&amp;display=inline&amp;height=814&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20%281%29.png&amp;originHeight=814&amp;originWidth=1149&amp;size=130886&amp;status=done&amp;style=none&amp;width=1149" alt="未命名文件 (1).png" class="img_ev3q"></p><a name="yxFYn"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="谁可以处理请求">谁可以处理请求<a href="#谁可以处理请求" class="hash-link" aria-label="谁可以处理请求的直接链接" title="谁可以处理请求的直接链接">​</a></h4><p>当使用者开启1.3.0的新特性——内嵌分布式关系型数据存储时，所有的写操作请求都将路由到Leader节点进行处理；但是，由于Raft状态机的特性，当某一个节点在apply数据库操作请求时发生非SQL逻辑错误引发的异常时，将导致状态机无法继续正常进行工作，此时将会触发配置管理模块的降级操作</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void registerSubscribe() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NotifyCenter.registerSubscribe(new SmartSubscribe() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void onEvent(Event event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (event instanceof RaftDBErrorRecoverEvent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                downgrading = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (event instanceof RaftDBErrorEvent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                downgrading = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public boolean canNotify(Event event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return (event instanceof RaftDBErrorEvent) || (event instanceof RaftDBErrorRecoverEvent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因此，综上所述，可以通过活动图来理解下，什么情况下需要将请求进行转发
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/db53c1ade61235d4c9659607b98ef7c6.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJGaWx0ZXIuZG9GaWx0ZXJcIlxuXG5pZiBcIuacrOiKgueCueaYr0xlYWRlclwiIHRoZW5cbiAgLWxlZnQtPlt0cnVlXSBcIuacrOiKgueCueWkhOeQhlwiXG4gIC0tPiAoKilcbmVsc2VcbiAgICBpZiBcIuezu-e7n-mZjee6p-W8gOWQr1wiIHRoZW5cbiAgICAgICAgLS0-W3RydWVdIFwi6L2s5Y-R57uZTGVhZGVyXCJcbiAgICAgICAgLS0-ICgqKVxuICAgIGVsc2VcbiAgICAgICAgaWYgXCLlhpnmk43kvZzor7fmsYJcIiB0aGVuXG4gICAgICAgICAgICAtLT5bdHJ1ZV0gXCLovazlj5Hnu5lMZWFkZXJcIlxuICAgICAgICAgICAgLS0-ICgqKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICAtLT5bZmFsc2VdIFwi5pys6IqC54K55aSE55CGXCJcbiAgICAgICAgZW5kaWZcbiAgICBlbmRpZlxuZW5kaWZcblxuQGVuZHVtbCIsInR5cGUiOiJwdW1sIiwibWFyZ2luIjp0cnVlLCJpZCI6IjFuWW9HIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC9kYjUzYzFhZGU2MTIzNWQ0Yzk2NTk2MDdiOThlZjdjNi5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" class="img_ev3q"></p><a name="g1buf"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="相关数据承载对象">相关数据承载对象<a href="#相关数据承载对象" class="hash-link" aria-label="相关数据承载对象的直接链接" title="相关数据承载对象的直接链接">​</a></h4><p>数据库的DML语句是select、insert、update、delete，根据SQL语句对于数据操作的性质，可以分为两大类：query以及update，select语句对应的是数据查询，insert、update、delete语句对应的是数据修改。同时在进行数据库操作时，为了避免SQL注入，使用的是PreparedStatement，因此需要SQL语句+参数，因此可以得到两个关于数据库操作的Request对象</p><ol><li>SelectRequest</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectRequest implements Serializable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final long serialVersionUID = 2212052574976898602L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 查询类别，因为目前使用的是JdbcTemplate，查询单个、查询多个，是否使用RowMapper转为对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private byte queryType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // sql语句</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // select * from config_info where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String sql;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Object[] args;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String className;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>ModifyRequest</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ModifyRequest implements Serializable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final long serialVersionUID = 4548851816596520564L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int executeNo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String sql;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Object[] args;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="moKl7"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="配置发布">配置发布<a href="#配置发布" class="hash-link" aria-label="配置发布的直接链接" title="配置发布的直接链接">​</a></h4><p>配置发布操作涉及三个事务：</p><ol><li>config_info保存配置信息</li><li>config_tags_relation保存配置与标签的关联关系</li><li>his_config_info保存一条配置操作历史记录</li></ol><p>这三个事务都在配置发布这个大事务下，如果说我们对每个事务操作进行一个Raft协议提交，假设1、2两个事务通过Raft提交后都成功Apply了，第三个事务在进行Raft提交后apply失败，那么对于这个配置发布的大事务来说，是需要整体回滚的，否则就会违反原子性，那么可能需要说将事务回滚操作又进行一次Raft提交，那么整体的复杂程度上升，并且直接引入了分布式事务的管理，因此为了避免这个问题，我们将这三个事务涉及的SQL上下文进行整合成一个大的SQL上下文，对这大的SQL上下文进行Raft协议提交。保证了三个子事务在同一次数据库会话当中，成功解决原子性的问题，同时由于Raft协议对于事务日志的处理是串行执行的，因此相当于将数据库的事务隔离级别调整为串行化。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void addConfigInfo(final String srcIp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String srcUser, final ConfigInfo configInfo, final Timestamp time,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Map&lt;String, Object&gt; configAdvanceInfo, final boolean notify) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String tenantTmp = StringUtils.isBlank(configInfo.getTenant()) ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StringUtils.EMPTY :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    configInfo.getTenant();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configInfo.setTenant(tenantTmp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 通过雪花ID算法获取数据库主键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long configId = idGeneratorManager.nextId(RESOURCE_CONFIG_INFO_ID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long hisId = idGeneratorManager.nextId(RESOURCE_CONFIG_HISTORY_ID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addConfigInfoAtomic(configId, srcIp, srcUser, configInfo, time,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    configAdvanceInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String configTags = configAdvanceInfo == null ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    null :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    (String) configAdvanceInfo.get(&quot;config_tags&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addConfigTagsRelation(configId, configTags, configInfo.getDataId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    configInfo.getGroup(), configInfo.getTenant());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        insertConfigHistoryAtomic(hisId, configInfo, srcIp, srcUser, time, &quot;I&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EmbeddedStorageContextUtils.onModifyConfigInfo(configInfo, srcIp, time);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        databaseOperate.blockUpdate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EmbeddedStorageContextUtils.cleanAllContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public long addConfigInfoAtomic(final long id, final String srcIp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String srcUser, final ConfigInfo configInfo, final Timestamp time,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, Object&gt; configAdvanceInfo) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 参数处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String sql =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;INSERT INTO config_info(id, data_id, group_id, tenant_id, app_name, content, md5, src_ip, src_user, gmt_create,&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        + &quot;gmt_modified, c_desc, c_use, effect, type, c_schema) VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Object[] args = new Object[] { id, configInfo.getDataId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                configInfo.getGroup(), tenantTmp, appNameTmp, configInfo.getContent(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                md5Tmp, srcIp, srcUser, time, time, desc, use, effect, type, schema, };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SqlContextUtils.addSqlContext(sql, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void addConfigTagRelationAtomic(long configId, String tagName, String dataId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String group, String tenant) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String sql =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;INSERT INTO config_tags_relation(id,tag_name,tag_type,data_id,group_id,tenant_id) &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        + &quot;VALUES(?,?,?,?,?,?)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Object[] args = new Object[] { configId, tagName, null, dataId, group,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tenant };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SqlContextUtils.addSqlContext(sql, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void insertConfigHistoryAtomic(long configHistoryId, ConfigInfo configInfo,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String srcIp, String srcUser, final Timestamp time, String ops) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 参数处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String sql =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;INSERT INTO his_config_info (id,data_id,group_id,tenant_id,app_name,content,md5,&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        + &quot;src_ip,src_user,gmt_modified,op_type) VALUES(?,?,?,?,?,?,?,?,?,?,?)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Object[] args = new Object[] { configHistoryId, configInfo.getDataId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                configInfo.getGroup(), tenantTmp, appNameTmp, configInfo.getContent(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                md5Tmp, srcIp, srcUser, time, ops };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SqlContextUtils.addSqlContext(sql, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Temporarily saves all insert, update, and delete statements under</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * a transaction in the order in which they occur</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author &lt;a href=&quot;mailto:liaochuntao@live.com&quot;&gt;liaochuntao&lt;/a&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SqlContextUtils {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ThreadLocal&lt;ArrayList&lt;ModifyRequest&gt;&gt; SQL_CONTEXT =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadLocal.withInitial(ArrayList::new);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void addSqlContext(String sql, Object... args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ArrayList&lt;ModifyRequest&gt; requests = SQL_CONTEXT.get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ModifyRequest context = new ModifyRequest();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setExecuteNo(requests.size());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setSql(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setArgs(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requests.add(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SQL_CONTEXT.set(requests);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static List&lt;ModifyRequest&gt; getCurrentSqlContext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return SQL_CONTEXT.get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void cleanCurrentSqlContext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SQL_CONTEXT.remove();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过一个时序图来更加直观的理解
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/618e8997395fbc74433ac4a60f67b6b4.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmF1dG9udW1iZXJcblxuYWN0b3IgXCJVc2VyXCIgYXMgVXNlclxuXG5wYXJ0aWNpcGFudCBcIkNvbmZpZ1NlcnZpY2VcIiBhcyBTZXJ2aWNlXG5wYXJ0aWNpcGFudCBcIlBlcnNpc3RlbmNlU2VydmljZVwiIGFzIFJlcG9zaXRvcnlcbnBhcnRpY2lwYW50IFwiRGVyYnlcIiBhcyBEQlxucGFydGljaXBhbnQgXCJTUUxDb250ZXh0VXRpbHNcIiBhcyBTUUxDb250ZXh0XG5wYXJ0aWNpcGFudCBcIkxvZ1Byb2Nlc3NvclwiIGFzIFByb2Nlc3NvclxucGFydGljaXBhbnQgXCJDb25zaXN0ZW5jeVByb3RvY29sXCIgYXMgUHJvdG9jb2xcbnBhcnRpY2lwYW50IFwiTG9nXCIgYXMgTG9nXG5cbmFjdGl2YXRlIFVzZXJcblxuVXNlciAtPiBTZXJ2aWNlOiDlj5HotbfphY3nva7lj5HluIPor7fmsYJcbmFjdGl2YXRlIFNlcnZpY2VcblxuU2VydmljZSAtPiBSZXBvc2l0b3J5OiDphY3nva7lj5HluINcbmFjdGl2YXRlIFJlcG9zaXRvcnlcblxuUmVwb3NpdG9yeSAtPiBTUUxDb250ZXh0OiDmi6bmiKrlvZPliY1TUUzkuIrkuIvmlodcbmFjdGl2YXRlIFNRTENvbnRleHRcblxuUmVwb3NpdG9yeSAtPiBSZXBvc2l0b3J5OiBjb21taXQg5pON5L2cXG5cblNRTENvbnRleHQgLT4gUmVwb3NpdG9yeTog5b2T5YmN6K-35rGC5raJ5Y-K55qE5omA5pyJU1FM5LiK5LiL5paHXG5cbmRlYWN0aXZhdGUgU1FMQ29udGV4dFxuXG5SZXBvc2l0b3J5IC0-IExvZzog5p6E5bu66K-35rGC5L2TXG5cbmFjdGl2YXRlIExvZ1xuZGVhY3RpdmF0ZSBMb2dcblxuUmVwb3NpdG9yeSAtPiBQcm90b2NvbDogc3VibWl0KCkg6L-b6KGM6K-35rGC5o-Q5LqkXG5hY3RpdmF0ZSBQcm90b2NvbFxuZGVhY3RpdmF0ZSBSZXBvc2l0b3J5XG5cblByb3RvY29sIC0-IFByb2Nlc3Nvcjogb25BcHBseSgpIOaWueazle-8jOeKtuaAgeacuuWkjeWItkxvZ1xuYWN0aXZhdGUgUHJvY2Vzc29yXG5cblByb2Nlc3NvciAtPiBSZXBvc2l0b3J5OiDmiafooYzmiYDmnInnmoRTUUzkuIrkuIvmlodcbmFjdGl2YXRlIFJlcG9zaXRvcnlcblxuUmVwb3NpdG9yeSAtPiBEQjog5pWw5o2u6JC95bqTXG5hY3RpdmF0ZSBEQlxuXG5EQiAtPiBSZXBvc2l0b3J5OiDnu5PmnZ_lubbov5Tlm57nu5PmnpxcbmRlYWN0aXZhdGUgREJcblxuUmVwb3NpdG9yeSAtPiBQcm9jZXNzb3I6IOi_lOWbnkxvZ0Z1dHVyZeW5tuiuvue9ruacrOasoeaJp-ihjOeahOe7k-aenFxuZGVhY3RpdmF0ZSBSZXBvc2l0b3J5XG5cblByb2Nlc3NvciAtPiBQcm90b2NvbDog6L-U5ZueTG9nRnV0dXJlXG5kZWFjdGl2YXRlIFByb2Nlc3NvclxuXG5Qcm90b2NvbCAtPiBTZXJ2aWNlOiDmnKzmrKHor7fmsYLnmoTnu5PmnpxcbmRlYWN0aXZhdGUgUHJvdG9jb2xcblxuU2VydmljZSAtPiBVc2VyXG5kZWFjdGl2YXRlIFNlcnZpY2VcbmRlYWN0aXZhdGUgVXNlclxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiVnQxNzciLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzYxOGU4OTk3Mzk1ZmJjNzQ0MzNhYzRhNjBmNjdiNmI0LnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=" class="img_ev3q"></p><a name="AAJTE"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何使用新特性">如何使用新特性<a href="#如何使用新特性" class="hash-link" aria-label="如何使用新特性的直接链接" title="如何使用新特性的直接链接">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./startup.sh -p embedded</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>是否启用内嵌的分布式关系型存储的活动图
<img loading="lazy" src="https://cdn.nlark.com/yuque/__puml/1fd656ba3b39fe5de8fea78efdf98dd1.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJDb25maWcuc3RhcnQoKVwiXG5cbmlmIFwi5Y2V5py65qih5byPXCIgdGhlblxuICAtcmlnaHQtPlt0cnVlXSBcInJldHVybiDpu5jorqTljZXmnLrlrZjlgqjooYzkuLpcIlxuICAtLT4gKCopXG5lbHNlXG4gaWYgXCLlt7LphY3nva7lpJbnva7lrZjlgqhcIiB0aGVuXG4gICAgLS0-W3RydWVdIFwicmV0dXJuIOWklue9ruaVsOaNruWtmOWCqOihjOS4ulwiXG4gICAgLS0-ICgqKVxuIGVsc2VcbiAgICBpZiBcIuW8gOWQr-WGheW1jOWtmOWCqFwiIHRoZW5cbiAgICAgICAgLS0-W3RydWVdIFwicmV0dXJuIOi9u-mHj-WGheW1jOWIhuW4g-W8j-WtmOWCqOihjOS4ulwiXG4gICAgICAgIC0tPiAoKilcbiAgICBlbHNlXG4gICAgICAgIC0-W2ZhbHNlXSBcInJldHVybiDpu5jorqTlpJbnva7mlbDmja7lrZjlgqjooYzkuLpcIlxuICAgICAgICAtLT4gKCopXG5cdFx0ZW5kaWZcbiBlbmRpZlxuZW5kaWZcblxuQGVuZHVtbCIsInR5cGUiOiJwdW1sIiwibWFyZ2luIjp0cnVlLCJpZCI6IkNNN1VDIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC8xZmQ2NTZiYTNiMzlmZTVkZThmZWE3OGVmZGY5OGRkMS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" class="img_ev3q"></p><a name="9UAXN"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="新特性的相关运维操作">新特性的相关运维操作<a href="#新特性的相关运维操作" class="hash-link" aria-label="新特性的相关运维操作的直接链接" title="新特性的相关运维操作的直接链接">​</a></h3><p>直接查询每个节点的derby存储的数据</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GET /nacos/v1/cs/ops/derby?sql=select * from config_info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return List&lt;Map&lt;String, Object&gt;&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="YcqO2"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="不足">不足<a href="#不足" class="hash-link" aria-label="不足的直接链接" title="不足的直接链接">​</a></h3><ol><li>在数据库上层构建一层分布式数据操作同步层，对数据库的操作存在了限制，比如第一步insert操作，然后select操作，最后在update操作，这种在数据修改语句中穿插着查询语句的操作顺序是不支持的</li><li>限制了数据库的性能，由于间接的将数据库事务隔离级别调整为了串行化，人为的将并发能力降低了</li></ol><a name="7dul8"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="未来演进">未来演进<a href="#未来演进" class="hash-link" aria-label="未来演进的直接链接" title="未来演进的直接链接">​</a></h3><p>将于Apache Derby官方一起尝试基于Raft实现BingLog的同步复制操作，从底层实现数据库同步能力</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/blog/nacos 1.2.0 guide"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">Nacos 1.2.0权限控制介绍和使用</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/namespace-endpoint-best-practices"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">Namespace,endpoint 最佳实践</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#概述" class="table-of-contents__link toc-highlight">概述</a></li><li><a href="#系统参数变化" class="table-of-contents__link toc-highlight">系统参数变化</a><ul><li><a href="#新增" class="table-of-contents__link toc-highlight">新增</a></li></ul></li><li><a href="#nacos的未来整体逻辑架构及其组件" class="table-of-contents__link toc-highlight">Nacos的未来整体逻辑架构及其组件</a></li><li><a href="#nacos集群成员节点寻址模式" class="table-of-contents__link toc-highlight">Nacos集群成员节点寻址模式</a><ul><li><a href="#节点管理和寻址模式如何结合的" class="table-of-contents__link toc-highlight">节点管理和寻址模式如何结合的</a></li></ul></li><li><a href="#nacos一致性协议协议层抽象" class="table-of-contents__link toc-highlight">Nacos一致性协议协议层抽象</a><ul><li><a href="#一致协议抽象" class="table-of-contents__link toc-highlight">一致协议抽象</a></li><li><a href="#一致性协议层工作流程" class="table-of-contents__link toc-highlight">一致性协议层工作流程</a></li><li><a href="#nacos一致性协议层之cp协议的实现选择jraft" class="table-of-contents__link toc-highlight">Nacos一致性协议层之CP协议的实现选择——JRaft</a></li><li><a href="#jraft运维操作" class="table-of-contents__link toc-highlight">JRaft运维操作</a></li><li><a href="#jraft协议相关配置参数" class="table-of-contents__link toc-highlight">JRaft协议相关配置参数</a></li></ul></li><li><a href="#nacos内嵌分布式id" class="table-of-contents__link toc-highlight">Nacos内嵌分布式ID</a></li><li><a href="#nacos内嵌的轻量的基于derby的分布式关系型存储" class="table-of-contents__link toc-highlight">Nacos内嵌的轻量的基于Derby的分布式关系型存储</a><ul><li><a href="#背景" class="table-of-contents__link toc-highlight">背景</a></li><li><a href="#设计思路" class="table-of-contents__link toc-highlight">设计思路</a></li><li><a href="#如何使用新特性" class="table-of-contents__link toc-highlight">如何使用新特性</a></li><li><a href="#新特性的相关运维操作" class="table-of-contents__link toc-highlight">新特性的相关运维操作</a></li><li><a href="#不足" class="table-of-contents__link toc-highlight">不足</a></li><li><a href="#未来演进" class="table-of-contents__link toc-highlight">未来演进</a></li></ul></li></ul></div></div></div></div></div></div>
<script src="/zh-cn/assets/js/runtime~main.cb902e17.js"></script>
<script src="/zh-cn/assets/js/main.3f9f7e5f.js"></script>
</body>
</html>