<!doctype html>
<html lang="default" dir="ltr" class="docs-wrapper docs-doc-page docs-version-2.X plugin-docs plugin-id-default docs-doc-id-v2/plugin/control-plugin" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">反脆弱 | Nacos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://nacos.io/img/nacos_colorful.png"><meta data-rh="true" name="twitter:image" content="https://nacos.io/img/nacos_colorful.png"><meta data-rh="true" property="og:url" content="https://nacos.io/docs/v2/plugin/control-plugin"><meta data-rh="true" name="docusaurus_locale" content="default"><meta data-rh="true" name="docsearch:language" content="default"><meta data-rh="true" name="docusaurus_version" content="2.X"><meta data-rh="true" name="docusaurus_tag" content="docs-default-2.X"><meta data-rh="true" name="docsearch:version" content="2.X"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-2.X"><meta data-rh="true" property="og:title" content="反脆弱 | Nacos"><meta data-rh="true" name="description" content="Nacos 支持反脆弱插件，避免高压下的集群容量问题。"><meta data-rh="true" property="og:description" content="Nacos 支持反脆弱插件，避免高压下的集群容量问题。"><meta data-rh="true" name="keywords" content="反脆弱,限流,连接数限制,TPS"><link data-rh="true" rel="icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"><link data-rh="true" rel="canonical" href="https://nacos.io/docs/v2/plugin/control-plugin"><link data-rh="true" rel="alternate" href="https://nacos.io/en/docs/v2/plugin/control-plugin" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://nacos.io/zh-cn/docs/v2/plugin/control-plugin" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://nacos.io/docs/v2/plugin/control-plugin" hreflang="default"><link data-rh="true" rel="alternate" href="https://nacos.io/docs/v2/plugin/control-plugin" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://1QV814950M-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Nacos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Nacos Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Nacos" href="/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=nacos">
<meta name="referrer" content="no-referrer">
<link rel="stylesheet" href="//dev.g.alicdn.com/mamba/mse-arc-ui/0.0.20/umd/mse-arc-ui.min.css">
<script src="//dev.g.alicdn.com/mamba/mse-arc-ui/0.0.20/umd/mse-arc-ui.min.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-0YDFJ7LX7F" async></script><link rel="stylesheet" href="/assets/css/styles.ada177ca.css">
<link rel="preload" href="/assets/js/runtime~main.784285e7.js" as="script">
<link rel="preload" href="/assets/js/main.06faebea.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>



<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="//hm.baidu.com/hm.js?e3a5cec56ef8619cf9d7c2abebd509e3"></script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/what-is-nacos" href="/docs/v2/what-is-nacos">2.X</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/v2/plugin/control-plugin">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/v2/plugin/control-plugin">2.X</a></li><li><a class="dropdown__link" href="/docs/1.X/v2/what-is-nacos">1.X</a></li></ul></div><a class="navbar__item navbar__link" href="/cloud">NACOS CLOUD</a><a href="https://developer.aliyun.com/ebook/36?spm=a2c6h.20345107.ebook-index.18.152c2984fsi5ST" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">E-BOOK-NACOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a class="navbar__item navbar__link" href="/blog">BLOG</a><a class="navbar__item navbar__link" href="/community">COMMUNITY</a><a href="http://console.nacos.io/nacos/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">DEMO-CONSOLE<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>Default</a><ul class="dropdown__menu"><li><a href="/en/docs/v2/plugin/control-plugin" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/docs/v2/plugin/control-plugin" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><span class="theme-doc-version-badge badge badge--secondary">Version: 2.X</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>反脆弱插件</h1><p>Nacos 从2.3.0版本开始，支持通过<a href="https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html" target="_blank" rel="noopener noreferrer">SPI</a>的方式注入反脆弱相关插件，并在<code>application.properties</code>配置文件中选择某一种插件实现作为实际反脆弱能力。本文档会详细介绍如何实现一个反脆弱插件和如何使其生效。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="反脆弱插件中的概念">反脆弱插件中的概念<a href="#反脆弱插件中的概念" class="hash-link" aria-label="Direct link to 反脆弱插件中的概念" title="Direct link to 反脆弱插件中的概念">​</a></h2><p>反脆弱是对访问服务端的<strong>某种资源</strong>的<strong>频率和次数</strong>达到一定程度时进行的限制访问的策略，用于保护服务端在高压情况下能快速拒绝请求，防止过多的资源访问导致服务端资源耗尽引起的大面积不可用；Nacos反脆弱插件，将信息主要抽象为<code>监控点</code>和<code>反脆弱规则</code>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="监控点controlpoint">监控点（ControlPoint）<a href="#监控点controlpoint" class="hash-link" aria-label="Direct link to 监控点（ControlPoint）" title="Direct link to 监控点（ControlPoint）">​</a></h3><p>监控点对应的请求服务端时所占用的资源的映射，目前主要针对的是<code>连接(Connection)</code>以及<code>每秒请求数(TPS)</code>。</p><ul><li>连接(Connection)监控点主要监控Nacos 服务端中使用Nacos2.X客户端的长连接数量以及使用Nacos1.X客户端的配置长轮询数量，两者独立监控。</li><li>每秒请求数(TPS)监控点主要是监控Nacos 服务端中各核心接口被访问的频率，同类型的操作接口会被视为相同的监控点，如注册服务的v1接口和v2接口，具体的每秒请求数(TPS)监控点可查看本文档下文<a href="#1.1">监控点名称</a>。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="反脆弱规则controlrule">反脆弱规则（ControlRule）<a href="#反脆弱规则controlrule" class="hash-link" aria-label="Direct link to 反脆弱规则（ControlRule）" title="Direct link to 反脆弱规则（ControlRule）">​</a></h3><p>反脆弱规则是针对每个监控点而执行的不同的限制规则，具体又分为<code>连接数规则（ConnectionControlRule）</code>和<code>每秒请求数规则（TpsControlRule）</code></p><p><code>连接数规则（ConnectionControlRule）</code>主要包含如下内容：</p><table><thead><tr><th>字段名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>countLimit</td><td>int</td><td>连接数总数限制，默认为-1，不限制</td></tr><tr><td>monitorIpList</td><td>Set<!-- -->&lt;<!-- -->String<!-- -->&gt;</td><td>trace监控的Ip列表，用于详细观察对应ip的连接做了哪些操作，添加后，对应ip的连接请求会被详细打印在remote-digest.log日志中</td></tr></tbody></table><p><code>每秒请求数规则（TpsControlRule）</code>主要包含如下内容：</p><table><thead><tr><th>字段名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>pointName</td><td>String</td><td>规则所对应的监控点名称</td></tr><tr><td>pointRule</td><td>RuleDetail</td><td>规则内容的具体细节</td></tr></tbody></table><p>其中<code>RuleDetail</code>又包含如下内容：</p><table><thead><tr><th>字段名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>ruleName</td><td>String</td><td>规则的名称，区别于监控点名称，同一个监控点可以有多个规则名</td></tr><tr><td>maxCount</td><td>int</td><td>TPS总数限制，默认为-1，不限制</td></tr><tr><td>period</td><td>TimeUnit</td><td>规则生效的周期，即统计到秒级/分钟级等，默认<code>TimeUnit.SECONDS</code>秒级</td></tr><tr><td>monitorType</td><td>String</td><td>监控类型，取值为<code>monitor</code>或<code>intercept</code>，对应为监控模式（只统计和打印tps，即使触发规则也不拦截）和拦截模式</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="插件开发">插件开发<a href="#插件开发" class="hash-link" aria-label="Direct link to 插件开发" title="Direct link to 插件开发">​</a></h2><p>开发Nacos服务端反脆弱插件，首先需要依赖反脆弱插件的相关API</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.alibaba.nacos</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">nacos-control-plugin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>${project.version}</code> 为您开发插件所对应的Nacos版本，<code>2.3.0</code>及以上。</p><p>随后继承<code>com.alibaba.nacos.plugin.control.connection.ConnectionControlManager</code>抽象类和<code>com.alibaba.nacos.plugin.control.tps.TpsControlManager</code>抽象类，实现缺失的方法；然后实现<code>com.alibaba.nacos.plugin.control.spi.ControlManagerBuilder</code> 接口，创建上述实现的两个抽象类；最后将您的实现添加到SPI的services当中。</p><p><code>com.alibaba.nacos.plugin.control.connection.ConnectionControlManager</code>需要实现的方法如下：</p><table><thead><tr><th>方法名</th><th>入参内容</th><th>返回内容</th><th>描述</th></tr></thead><tbody><tr><td>applyConnectionLimitRule</td><td>ConnectionControlRule</td><td>void</td><td>应用新的连接数规则</td></tr><tr><td>check</td><td>ConnectionCheckRequest</td><td>ConnectionCheckResponse</td><td>判断是否命中连接数规则，如果ConnectionCheckResponse中的sucess为false，将会拒绝新连接的建立</td></tr></tbody></table><p><code>com.alibaba.nacos.plugin.control.tps.TpsControlManager</code>需要实现的方法如下：</p><table><thead><tr><th>方法名</th><th>入参内容</th><th>返回内容</th><th>描述</th></tr></thead><tbody><tr><td>registerTpsPoint</td><td>String</td><td>void</td><td>注册TPS监控点，Nacos服务会在启动时向插件注册当前的TPS监控买点，入参为TPS监控点的名字，具体的监控点名称可查看本文档下文<a href="#1.1">监控点名称</a>；插件需要在方法内，维护一个用于记录TPS和规则内容的<code>TpsBarrier</code>，详情查看<a href="#1.2">自定义TPS时间窗口</a>。</td></tr><tr><td>applyTpsRule</td><td>String,TpsControlRule</td><td>void</td><td>应用新的TPS规则，根据TPS监控点名称关联及更新。</td></tr><tr><td>check</td><td>TpsCheckRequest</td><td>TpsCheckResponse</td><td>判断是否命中TPS规则，如果TpsCheckResponse中的sucess为false，将会拒绝新的请求。</td></tr></tbody></table><p><code>com.alibaba.nacos.plugin.control.spi.ControlManagerBuilder</code> 需要实现的方法如下：</p><table><thead><tr><th>方法名</th><th>入参内容</th><th>返回内容</th><th>描述</th></tr></thead><tbody><tr><td>getName</td><td>void</td><td>String</td><td>插件的名称，和配置文件中指定的类型进行匹配，使用命中的的插件。</td></tr><tr><td>buildConnectionControlManager</td><td>void</td><td>ConnectionControlManager</td><td>创建插件对应的<code>ConnectionControlManager </code>实现，为null时会使用<code>no limit</code>实现。</td></tr><tr><td>buildTpsControlManager</td><td>void</td><td>TpsControlManager</td><td>创建插件对应的<code>TpsControlManager</code>实现，为null时会使用<code>no limit</code>实现。</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="加载插件">加载插件<a href="#加载插件" class="hash-link" aria-label="Direct link to 加载插件" title="Direct link to 加载插件">​</a></h3><p>插件开发完成后，需要打包成jar/zip，放置到nacos服务端的classpath中，如果您不知道如何修改classpath，请直接放置到<code>${nacos-server.path}/plugins</code>下</p><p>放置后，需要修改<code>${nacos-server.path}/conf/application.properties</code>中的以下配置</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">### 所启用的Nacos的反脆弱插件的名称，与com.alibaba.nacos.plugin.control.spi.ControlManagerBuilder 的getName 返回值对应</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.plugin.control.manager.type=${controlPluginName}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>随后重启nacos集群，启动完成后，可以从<code>${nacos-server.path}/logs/plugin-control.log</code>中看到如下日志：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Found control manager plugin of name=${controlPluginName}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Build connection control manager, class=${your plugin ConnectionControlManager class}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Build tps control manager, class=${your plugin TpsControlManager class}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用nacos自带的反脆弱插件">使用Nacos自带的反脆弱插件<a href="#使用nacos自带的反脆弱插件" class="hash-link" aria-label="Direct link to 使用Nacos自带的反脆弱插件" title="Direct link to 使用Nacos自带的反脆弱插件">​</a></h2><p>Nacos2.3.0版本起，自带一个简易的反脆弱插件实现，可以做到对Nacos服务端的连接数及指定接口TPS进行限制。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="启用nacos自带的反脆弱插件">启用Nacos自带的反脆弱插件<a href="#启用nacos自带的反脆弱插件" class="hash-link" aria-label="Direct link to 启用Nacos自带的反脆弱插件" title="Direct link to 启用Nacos自带的反脆弱插件">​</a></h3><p>需要修改<code>${nacos-server.path}/conf/application.properties</code>中的以下配置</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nacos.plugin.control.manager.type=nacos</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="设置反脆弱规则">设置反脆弱规则<a href="#设置反脆弱规则" class="hash-link" aria-label="Direct link to 设置反脆弱规则" title="Direct link to 设置反脆弱规则">​</a></h3><p>可通过创建和修改反脆弱规则文件的方式，修改和设置反脆弱规则，默认反脆弱插件的规则是通过json格式定义的；例如想要设置连接限制为100，可执行如下操作:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p </span><span class="token variable" style="color:#36acaa">${nacos.home}</span><span class="token plain">/data/connection/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{&quot;countLimit&quot;: 100}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${nacos.home}</span><span class="token plain">/data/connection/limitRule</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>随后重启Nacos节点即可。</p><p>又例如想要设置配置查询接口的TPS为100，可执行如下操作：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p </span><span class="token variable" style="color:#36acaa">${nacos.home}</span><span class="token plain">/data/tps/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ConfigQuery 为配置查询接口的监控点名称（pointName)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{&quot;pointName&quot;:&quot;ConfigQuery&quot;,&quot;pointRule&quot;:{&quot;maxCount&quot;:100,&quot;monitorType&quot;:&quot;intercept&quot;}}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${nacos.home}</span><span class="token plain">/data/tps/ConfigQuery </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>随后重启Nacos节点即可。</p><p>其他更多反脆弱规则，以及具体的反脆弱监控点名称，请查看下文<a href="#1.1">监控点名称</a>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="反脆弱规则存储位置">反脆弱规则存储位置<a href="#反脆弱规则存储位置" class="hash-link" aria-label="Direct link to 反脆弱规则存储位置" title="Direct link to 反脆弱规则存储位置">​</a></h3><p>Nacos自带的简易反脆弱插件实现，Nacos服务端会通过本地文件系统，存储和读取反脆弱规则，默认所在目录的为<code>${nacos.home}/data/connection</code>及<code>${nacos.home}/data/tps</code>中，如果想将规则文件更换目录存储，可以在<code>${nacos-server.path}/conf/application.properties</code>中修改以下配置:</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nacos.plugin.control.rule.local.basedir=${expectedDir}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样规则将会被存储在<code>${expectedDir}/data/connection</code>及<code>${expectedDir}/data/tps</code>中。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1.1"><a href="#1.1" class="hash-link" aria-label="Direct link to 1.1" title="Direct link to 1.1">​</a></h4><h2 class="anchor anchorWithStickyNavbar_LWe7" id="当前支持的监控点名称">当前支持的监控点名称<a href="#当前支持的监控点名称" class="hash-link" aria-label="Direct link to 当前支持的监控点名称" title="Direct link to 当前支持的监控点名称">​</a></h2><table><thead><tr><th>监控点名称</th><th>对应内容</th><th>描述</th><th>起始版本</th></tr></thead><tbody><tr><td>connection</td><td>节点总连接数</td><td>指定节点最大可支持连接数限制</td><td>2.3.0</td></tr><tr><td>ConfigPublish</td><td>配置发布接口TPS</td><td>指定节点最大可支持配置发布的TPS限制，同时包含了通过http访问和grpc访问的来源</td><td>2.3.0</td></tr><tr><td>ConfigQuery</td><td>配置查询接口TPS</td><td>指定节点最大可支持配置查询的TPS限制，同时包含了通过http访问和grpc访问的来源</td><td>2.3.0</td></tr><tr><td>ConfigRemove</td><td>配置移除接口TPS</td><td>指定节点最大可支持配置移除的TPS限制，同时包含了通过http访问和grpc访问的来源</td><td>2.3.0</td></tr><tr><td>ConfigListen</td><td>配置监听接口TPS</td><td>指定节点最大可支持配置监听的TPS限制，仅包含通过grpc访问的来源</td><td>2.3.0</td></tr><tr><td>RemoteNamingInstanceRegisterDeregister</td><td>服务实例注册及注销接口TPS</td><td>服务实例注册或注销的TPS限制，仅包含通过grpc访问的来源</td><td>2.3.0</td></tr><tr><td>RemoteNamingInstanceBatchRegister</td><td>服务实例批量注册接口TPS</td><td>服务实例批量注册的TPS限制，仅包含通过grpc访问的来源</td><td>2.3.0</td></tr><tr><td>RemoteNamingServiceListQuery</td><td>服务列表查询接口TPS</td><td>服务列表查询的TPS限制，仅包含通过grpc访问的来源</td><td>2.3.0</td></tr><tr><td>RemoteNamingServiceQuery</td><td>服务查询接口TPS</td><td>服务查询的TPS限制，仅包含通过grpc访问的来源</td><td>2.3.0</td></tr><tr><td>RemoteNamingServiceSubscribeUnSubscribe</td><td>服务订阅和取消订阅接口TPS</td><td>服务订阅和取消订阅的TPS限制，仅包含通过grpc访问的来源</td><td>2.3.0</td></tr><tr><td>NamingInstanceRegister</td><td>服务实例注册接口TPS</td><td>服务实例注册的TPS限制，仅包含通过http访问的来源</td><td>2.3.0</td></tr><tr><td>NamingInstanceDeregister</td><td>服务实例注销接口TPS</td><td>服务实例注销的TPS限制，仅包含通过http访问的来源</td><td>2.3.0</td></tr><tr><td>NamingInstanceUpdate</td><td>服务实例元数据更新接口TPS</td><td>服务实例更新的TPS限制，仅包含通过http访问的来源</td><td>2.3.0</td></tr><tr><td>NamingInstanceMetadataUpdate</td><td>服务实例元数据批量更新接口TPS</td><td>服务实例元数据批量更新的TPS限制，仅包含通过http访问的来源</td><td>2.3.0</td></tr><tr><td>NamingServiceSubscribe</td><td>服务实例查询及订阅接口TPS</td><td>服务订阅及查询的TPS限制，仅包含通过http访问的来源</td><td>2.3.0</td></tr><tr><td>NamingInstanceQuery</td><td>单个服务实例查询接口TPS</td><td>单个服务实例查询的TPS限制，仅包含通过http访问的来源</td><td>2.3.0</td></tr><tr><td>HttpHealthCheck</td><td>服务实例心跳续约接口TPS</td><td>服务实例心跳续约的TPS限制，仅包含通过http访问的来源</td><td>2.3.0</td></tr><tr><td>NamingServiceRegister</td><td>服务创建接口TPS</td><td>服务创建的TPS限制，与<code>NamingInstanceRegister</code>不同，此监控点表示的是创建空服务接口所对应的TPS，仅包含通过http访问的来源</td><td>2.3.0</td></tr><tr><td>NamingServiceDeregister</td><td>服务删除接口TPS</td><td>服务删除的TPS限制，与<code>NamingInstanceDeregister </code>不同，此监控点表示的是删除服务接口所对应的TPS，仅包含通过http访问的来源</td><td>2.3.0</td></tr><tr><td>NamingServiceQuery</td><td>服务查询接口TPS</td><td>服务查询的TPS限制，与<code>NamingInstanceQuery </code>不同，此监控点表示的是查询服务信息接口所对应的TPS，仅包含通过http访问的来源</td><td>2.3.0</td></tr><tr><td>NamingServiceListQuery</td><td>服务列表查询接口TPS</td><td>服务列表查询的TPS限制，与<code>NamingServiceSubscribe </code>不同，此监控点表示的是服务列表查询接口所对应的TPS，仅包含通过http访问的来源</td><td>2.3.0</td></tr><tr><td>NamingServiceUpdate</td><td>服务元数据更新接口TPS</td><td>服务元数据更新的TPS限制，与<code>NamingInstanceUpdate </code>不同，此监控点表示的是服务元数据更新接口所对应的TPS，仅包含通过http访问的来源</td><td>2.3.0</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="反脆弱插件进阶开发">反脆弱插件进阶开发<a href="#反脆弱插件进阶开发" class="hash-link" aria-label="Direct link to 反脆弱插件进阶开发" title="Direct link to 反脆弱插件进阶开发">​</a></h2><p>Nacos反脆弱插件还支持一些进阶式的拓展，以满足对此方面有更高要求的开发者和用户。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="反脆弱规则外部存储">反脆弱规则外部存储<a href="#反脆弱规则外部存储" class="hash-link" aria-label="Direct link to 反脆弱规则外部存储" title="Direct link to 反脆弱规则外部存储">​</a></h3><p>Nacos反脆弱插件的默认情况下，仅支持通过本地文件系统来存储和修改单节点的反脆弱规则，对于一些集群规模较大或集群较多的用户，逐个节点进行调整会消耗大量时间和操作；同时本地文件系统在许多容器化环境中，存在磁盘挂载和持久化的问题。因此Nacos反脆弱插件允许增加一个可选的外部存储进行反脆弱规则的统一存储和下发，外部存储可有插件自行实现对接，例如<code>数据库</code>,<code>配置中心</code>等。</p><p>要实现反脆弱规则的外部存储，需要在开发插件时，实现<code>com.alibaba.nacos.plugin.control.spi.ExternalRuleStorageBuilder</code>接口，并随插件jar文件一起放置在<code>${nacos-server.path}/plugins</code>下。</p><p>放置后，需要修改<code>${nacos-server.path}/conf/application.properties</code>中的以下配置</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nacos.plugin.control.rule.external.storage=${controlPluginName}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>随后重启Nacos节点即可。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="动态加载反脆弱规则">动态加载反脆弱规则<a href="#动态加载反脆弱规则" class="hash-link" aria-label="Direct link to 动态加载反脆弱规则" title="Direct link to 动态加载反脆弱规则">​</a></h3><p>在自定义插件实现中，可以通过两种方式进行反脆弱规则的动态加载：</p><ol><li>调用<code>com.alibaba.nacos.plugin.control.ControlManagerCenter#reloadTpsControlRule</code>方法或<code>com.alibaba.nacos.plugin.control.ControlManagerCenter#reloadConnectionControlRule</code>方法。</li><li>通过<code>NotifyCenter.publishEvent()</code>发布<code>ConnectionLimitRuleChangeEvent</code> 或<code>TpsControlRuleChangeEvent</code>事件。</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="反脆弱规则的自定义格式解析">反脆弱规则的自定义格式解析<a href="#反脆弱规则的自定义格式解析" class="hash-link" aria-label="Direct link to 反脆弱规则的自定义格式解析" title="Direct link to 反脆弱规则的自定义格式解析">​</a></h3><p>Nacos 默认使用<code>Json</code>格式作为反脆弱规则的文本格式，插件开发者也可以使用其他的格式，如<code>Yaml</code>或其他自定义格式进行解析。</p><p>重写<code>com.alibaba.nacos.plugin.control.connection.ConnectionControlManager#buildConnectionControlRuleParser</code>及<code>com.alibaba.nacos.plugin.control.tps.TpsControlManager#buildTpsControlRuleParser</code>，实现自定义格式规则解析器<code>RuleParser</code>，Nacos将使用自定义的规则解析器<code>RuleParser</code>进行规则文本的解析。</p><p>同时，也可以解析成默认自定义规则的增强规则，配合自定义插件的定制逻辑实现更高程度的反脆弱控制。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1.2"><a href="#1.2" class="hash-link" aria-label="Direct link to 1.2" title="Direct link to 1.2">​</a></h4><h3 class="anchor anchorWithStickyNavbar_LWe7" id="自定义tps时间窗口">自定义TPS时间窗口<a href="#自定义tps时间窗口" class="hash-link" aria-label="Direct link to 自定义TPS时间窗口" title="Direct link to 自定义TPS时间窗口">​</a></h3><p>众所周知，在统计TPS时，存在时间窗口算法的区别，不同的时间窗口对TPS的统计结果会有较大的区别。</p><p>Nacos默认使用简单的同秒统计方式，即按照时钟的秒来进行统计。对于大多数场景来说是足够使用的，但对于一些精确度要求高的用户而言，可能需要使用滑动窗口等更精确的方式进行统计。</p><p>此时需要插件开发者，继承<code>com.alibaba.nacos.plugin.control.tps.barrier.TpsBarrier</code>和<code>com.alibaba.nacos.plugin.control.tps.barrier.RuleBarrier</code>，自定义实现TPS的时间窗口和统计方式。并重写<code>com.alibaba.nacos.plugin.control.tps.TpsControlManager#buildTpsBarrierCreator</code>，在初始化插件和动态加载反脆弱规则时，生成对应的自定义实现。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#反脆弱插件中的概念" class="table-of-contents__link toc-highlight">反脆弱插件中的概念</a><ul><li><a href="#监控点controlpoint" class="table-of-contents__link toc-highlight">监控点（ControlPoint）</a></li><li><a href="#反脆弱规则controlrule" class="table-of-contents__link toc-highlight">反脆弱规则（ControlRule）</a></li></ul></li><li><a href="#插件开发" class="table-of-contents__link toc-highlight">插件开发</a><ul><li><a href="#加载插件" class="table-of-contents__link toc-highlight">加载插件</a></li></ul></li><li><a href="#使用nacos自带的反脆弱插件" class="table-of-contents__link toc-highlight">使用Nacos自带的反脆弱插件</a><ul><li><a href="#启用nacos自带的反脆弱插件" class="table-of-contents__link toc-highlight">启用Nacos自带的反脆弱插件</a></li><li><a href="#设置反脆弱规则" class="table-of-contents__link toc-highlight">设置反脆弱规则</a></li><li><a href="#反脆弱规则存储位置" class="table-of-contents__link toc-highlight">反脆弱规则存储位置</a></li></ul></li><li><a href="#当前支持的监控点名称" class="table-of-contents__link toc-highlight">当前支持的监控点名称</a></li><li><a href="#反脆弱插件进阶开发" class="table-of-contents__link toc-highlight">反脆弱插件进阶开发</a><ul><li><a href="#反脆弱规则外部存储" class="table-of-contents__link toc-highlight">反脆弱规则外部存储</a></li><li><a href="#动态加载反脆弱规则" class="table-of-contents__link toc-highlight">动态加载反脆弱规则</a></li><li><a href="#反脆弱规则的自定义格式解析" class="table-of-contents__link toc-highlight">反脆弱规则的自定义格式解析</a></li><li><a href="#自定义tps时间窗口" class="table-of-contents__link toc-highlight">自定义TPS时间窗口</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.784285e7.js"></script>
<script src="/assets/js/main.06faebea.js"></script>
</body>
</html>